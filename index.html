<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可爱茶铺 - 统一版本</title>
    <link rel="stylesheet" href="unified-styles.css">
    <style>
        /* 动画提示样式 */
        .floating-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 9999;
            animation: floatingMessage 2s ease-out forwards;
            pointer-events: none;
        }

        .floating-message.success {
            background: rgba(76, 175, 80, 0.9);
        }

        .floating-message.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .floating-message.cost {
            background: rgba(255, 152, 0, 0.9);
        }

        @keyframes floatingMessage {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.9);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面标题 -->
        <div class="header">
            <h1>可爱茶铺 - 古风经营小游戏</h1>
            <div class="subtitle">统一版本 v2.0 | 数据完全同步</div>
        </div>

        <!-- 导航栏 -->
        <div class="nav-bar">
            <button class="nav-btn" onclick="location.reload()">茶铺</button>
            <button class="nav-btn" onclick="goToRiceVillage()" id="rice-village-btn" disabled>稻香村</button>
            <button class="nav-btn" onclick="showInventory()">背包</button>
            <button class="nav-btn" onclick="showRecipeUnlockStatus()">配方解锁</button>
            <button class="nav-btn" onclick="showSettings()">设置</button>
            <button class="nav-btn" onclick="showHelp()">帮助</button>
        </div>

        <!-- 状态栏 -->
        <div class="section">
            <div class="section-title">游戏状态</div>
            <table class="status-table">
                <tr>
                    <th>金币</th>
                    <th>等级</th>
                    <th>经验</th>
                    <th>天气</th>
                    <th>当前位置</th>
                    <th>游戏时间</th>
                </tr>
                <tr>
                    <td id="funds-display">1000 🪙</td>
                    <td id="level-display">1级</td>
                    <td id="exp-display">0/100</td>
                    <td id="weather-display">☀️ 晴天</td>
                    <td>茶铺</td>
                    <td id="game-time">第1天</td>
                </tr>
            </table>
        </div>

        <!-- 快速测试按钮 -->
        <div class="section">
            <div class="section-title">快速测试</div>
            <div class="top-menu-bar">
                <button class="menu-btn" onclick="quickTestGrill()">测试烤肉</button>
                <button class="menu-btn" onclick="quickTestCat()">测试猫咪</button>
                <button class="menu-btn" onclick="quickTestCustomer()">测试顾客</button>
                <button class="menu-btn" onclick="addTestItems()">添加测试物品</button>
                <button class="menu-btn" onclick="quickTestPlanting()">测试种植</button>
                <button class="menu-btn" onclick="unlockRiceVillage()">解锁稻香村</button>
                <button class="menu-btn" onclick="forceCreateCustomer()">生成顾客</button>
                <button class="menu-btn" onclick="showVipTestPanel()" style="background: #ff6b6b; color: white;">VIP顾客测试</button>
                <button class="menu-btn" onclick="forceCatVisit()">召唤猫咪</button>
                <button class="menu-btn" onclick="resetCatStatus()">重置猫咪状态</button>
                <button class="menu-btn" onclick="debugCatData()">查看猫咪数据</button>
                <button class="menu-btn" onclick="triggerNaming()">重新触发命名</button>
                <button class="menu-btn" onclick="testGifts()">测试礼物系统</button>
            </div>
        </div>

        <!-- 种植区域 -->
        <div class="section">
            <div class="section-title">种植区域 (2块地)</div>
            <div class="farm-grid" id="farm-grid">
                <!-- 动态生成种植地块 -->
            </div>
        </div>

        <!-- 厨房工作区 -->
        <div class="section">
            <div class="section-title">厨房工作区</div>
            
            <!-- 炉灶区 -->
            <div style="margin-bottom: 15px;">
                <h4 style="font-size: 12px; margin-bottom: 8px;">炉灶制茶区 (2个炉灶)</h4>
                <table class="workspace-table">
                    <thead>
                        <tr>
                            <th>炉灶</th>
                            <th>状态</th>
                            <th>配方</th>
                            <th>进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="stoves-table">
                        <!-- 动态生成炉灶状态 -->
                    </tbody>
                </table>
            </div>

            <!-- 案板区 -->
            <div style="margin-bottom: 15px;">
                <h4 style="font-size: 12px; margin-bottom: 8px;">案板加工区 (2个案板)</h4>
                <table class="workspace-table">
                    <thead>
                        <tr>
                            <th>案板</th>
                            <th>状态</th>
                            <th>配方</th>
                            <th>进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="boards-table">
                        <!-- 动态生成案板状态 -->
                    </tbody>
                </table>
            </div>

            <!-- 烤肉架区 -->
            <div id="grill-section" style="display: none;">
                <h4 style="font-size: 12px; margin-bottom: 8px;">烤肉架 (解锁后可用)</h4>
                <table class="workspace-table">
                    <thead>
                        <tr>
                            <th>烤肉架</th>
                            <th>状态</th>
                            <th>配方</th>
                            <th>进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="grill-table">
                        <!-- 动态生成烤肉架状态 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 顾客服务区 -->
        <div class="section">
            <div class="section-title">顾客服务区</div>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>当前顾客</th>
                        <th>订单详情</th>
                        <th>耐心值</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="customer-table">
                    <tr>
                        <td colspan="4">等待顾客到来...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 猫咪系统 -->
        <div class="section">
            <div class="section-title">猫咪系统</div>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>猫咪</th>
                        <th>亲密度</th>
                        <th>状态</th>
                        <th>喂食次数</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="cats-table">
                    <!-- 动态生成猫咪状态 -->
                </tbody>
            </table>
        </div>

        <!-- 制作好的茶饮 -->
        <div class="section">
            <div class="section-title">制作好的茶饮</div>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>茶饮名称</th>
                        <th>数量</th>
                        <th>制作时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="made-teas-table">
                    <tr>
                        <td colspan="4">暂无制作好的茶饮</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 背包快速查看 -->
        <div class="section">
            <div class="section-title">背包快速查看</div>
            <div class="top-menu-bar">
                <button class="menu-btn" onclick="toggleInventorySection('seeds')">种子</button>
                <button class="menu-btn" onclick="toggleInventorySection('ingredients')">原料</button>
                <button class="menu-btn" onclick="toggleInventorySection('toppings')">小料</button>
                <button class="menu-btn" onclick="toggleInventorySection('meats')">肉类</button>
            </div>
            
            <div id="inventory-display" style="margin-top: 10px;">
                <div class="collapsible-section" id="seeds-section">
                    <table class="inventory-table">
                        <thead><tr><th>种子名称</th><th>数量</th><th>价格</th><th>操作</th></tr></thead>
                        <tbody id="seeds-inventory"></tbody>
                    </table>
                </div>
                
                <div class="collapsible-section" id="ingredients-section">
                    <table class="inventory-table">
                        <thead><tr><th>原料名称</th><th>数量</th><th>用途</th><th>操作</th></tr></thead>
                        <tbody id="ingredients-inventory"></tbody>
                    </table>
                </div>
                
                <div class="collapsible-section" id="toppings-section">
                    <table class="inventory-table">
                        <thead><tr><th>小料名称</th><th>数量</th><th>来源</th><th>操作</th></tr></thead>
                        <tbody id="toppings-inventory"></tbody>
                    </table>
                </div>
                
                <div class="collapsible-section" id="meats-section">
                    <table class="inventory-table">
                        <thead><tr><th>肉类名称</th><th>数量</th><th>烤制价格</th><th>操作</th></tr></thead>
                        <tbody id="meats-inventory"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 悬浮调试面板 -->
    <div class="debug-panel" id="debug-panel" onclick="toggleDebugPanel()">
        🛠
        <div class="debug-content" id="debug-content" style="display: none;">
            <div class="debug-header">
                <span>🛠 调试面板</span>
                <button class="modal-close" onclick="toggleDebugPanel()">×</button>
            </div>
            <div style="padding: 10px; font-size: 11px;">
                <div id="debug-log" style="max-height: 200px; overflow-y: auto; background: #f9fafb; padding: 8px; border: 1px solid #e5e7eb; margin-bottom: 8px;"></div>
                <button class="action-btn" onclick="clearDebugLog()" style="font-size: 11px;">清空日志</button>
            </div>
        </div>
    </div>

    <!-- 模态框容器 -->
    <div id="modal-container"></div>

    <!-- JavaScript文件 -->
            <script src="unified-weather-system.js"></script>
        <script src="unified-inventory-system.js"></script>
        <script src="unified-core-system.js"></script>
    <script src="tea-shop-manager.js"></script>
    <script>
        // 全局茶铺管理器变量
        window.teaShopManager = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🍵 茶铺页面加载完成');

            try {
                // 直接创建茶铺管理器实例
                if (typeof TeaShopManager !== 'undefined') {
                    window.teaShopManager = new TeaShopManager();
                    window.teaShopManager.init();
                    console.log('✅ 茶铺管理器初始化成功');
                } else {
                    console.error('❌ TeaShopManager 类未定义');
                }
            } catch (error) {
                console.error('❌ 茶铺管理器初始化失败:', error);
            }

            // 不再在页面加载时自动检查命名需求
            // 命名窗口现在由亲密度达到3000时触发
        });

        // 检查是否需要猫咪命名
        function checkCatNamingRequired() {
            console.log('🐱 开始检查猫咪命名需求');

            if (!teaShopManager || !teaShopManager.core.initialized) {
                console.log('茶铺管理器未初始化，延迟检查猫咪命名');
                setTimeout(checkCatNamingRequired, 500);
                return;
            }

            const gameData = teaShopManager.core.gameData;
            const cats = gameData.teaShop.cats;

            console.log('🐱 游戏数据:', {
                hasShownCatNaming: gameData.meta.hasShownCatNaming,
                catsIntimacy: cats.intimacy,
                currentCat: cats.currentCat
            });

            // 检查是否已经给猫咪起过名字 - 更严格的判断
            const hasNamedCat = cats.currentCat && cats.currentCat !== '等待猫咪到来' && cats.currentCat.trim() !== '';

            console.log('🐱 详细检查:', {
                currentCat: cats.currentCat,
                intimacyKeys: Object.keys(cats.intimacy),
                hasNamedCat: hasNamedCat
            });

            console.log('🐱 检查结果:', {
                hasShownCatNaming: gameData.meta.hasShownCatNaming,
                hasNamedCat: hasNamedCat,
                shouldShowModal: !gameData.meta.hasShownCatNaming && !hasNamedCat
            });

            // 检查是否设置过"已弹出命名窗口"标记
            if (!gameData.meta.hasShownCatNaming && !hasNamedCat) {
                console.log('🐱 首次进入游戏，弹出猫咪命名窗口');
                showCatNamingModal();
                gameData.meta.hasShownCatNaming = true;
                teaShopManager.core.saveGameData();
            } else {
                console.log('🐱 不需要弹出命名窗口');
            }
        }

        // 显示猫咪命名模态框
        function showCatNamingModal(originalCatName) {
            window.currentNamingCat = originalCatName; // 保存当前要命名的猫咪
            const modalContent = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); max-width: 450px; text-align: center;">
                        <h3 style="margin-top: 0; color: #333;">🎉 恭喜开启神秘地图稻香村！</h3>
                        <p style="margin: 20px 0; line-height: 1.6; color: #666;">
                            你的 <strong>${originalCatName}</strong> 亲密度达到了3000！<br>
                            神秘的稻香村大门为你敞开了...<br>
                            请给这只猫猫起个名字，然后就可以带着你的猫猫伙伴去游玩了！
                        </p>
                        <div style="margin: 20px 0;">
                            <input type="text" id="cat-name-input" placeholder="请输入猫咪名字"
                                   style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 200px; font-size: 14px;"
                                   maxlength="10">
                        </div>
                        <div>
                            <button onclick="confirmCatNameAndGoToVillage()"
                                    style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                确认并前往稻香村
                            </button>
                            <button onclick="confirmCatNameOnly()"
                                    style="background: #ccc; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                暂时不去
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);

            // 聚焦到输入框
            setTimeout(() => {
                const input = document.getElementById('cat-name-input');
                if (input) input.focus();
            }, 100);
        }

        // 确认猫咪名字并前往稻香村
        function confirmCatNameAndGoToVillage() {
            const input = document.getElementById('cat-name-input');
            let catName = input.value.trim();

            if (!catName) {
                alert('请输入猫咪名字！');
                return;
            }

            applyCatName(catName);
            // 前往稻香村
            setTimeout(() => {
                window.open('rice-village.html', '_blank');
            }, 500);
        }

        // 确认猫咪名字但不前往稻香村
        function confirmCatNameOnly() {
            const input = document.getElementById('cat-name-input');
            let catName = input.value.trim();

            if (!catName) {
                alert('请输入猫咪名字！');
                return;
            }

            applyCatName(catName);
        }

        // 确认猫咪名字（兼容旧版本）
        function confirmCatName() {
            confirmCatNameOnly();
        }

        // 跳过命名（随机命名）
        function skipCatNaming() {
            const randomNames = ['小白', '小黑', '小花', '小橘', '小灰', '咪咪', '喵喵', '团子', '布丁', '奶茶'];
            const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
            applyCatName(randomName);
        }

        // 应用猫咪名字
        function applyCatName(catName) {
            if (teaShopManager && teaShopManager.core.initialized) {
                const cats = teaShopManager.core.gameData.teaShop.cats;
                const originalName = window.currentNamingCat;

                if (!originalName) {
                    console.log('🐱 错误：没有找到要命名的猫咪');
                    return;
                }

                console.log(`🐱 开始命名: ${originalName} → ${catName}`);

                // 保存自定义名字
                cats.customNames[originalName] = catName;

                // 生成随机战斗属性和类型
                const catType = Math.random() < 0.5 ? 'tank' : 'damage';
                cats.combatStats[originalName] = {
                    type: catType,
                    baseHp: Math.floor(Math.random() * 51) + 100,   // 100-150基础血量
                    baseAttack: Math.floor(Math.random() * 11) + 10, // 10-20基础攻击
                    level: 1,
                    hp: 0, // 将在下面计算
                    attack: 0, // 将在下面计算
                    currentHp: 0 // 当前血量
                };

                // 计算1级时的属性
                const stats = cats.combatStats[originalName];
                if (catType === 'tank') {
                    stats.hp = stats.baseHp + 20; // 坦克型+20血量
                    stats.attack = stats.baseAttack + 1; // 坦克型+1攻击
                } else {
                    stats.hp = stats.baseHp + 3; // 输出型+3血量
                    stats.attack = stats.baseAttack + 5; // 输出型+5攻击
                }
                stats.currentHp = stats.hp;

                console.log(`🐱 生成战斗属性:`, cats.combatStats[originalName]);

                // 如果这只猫咪正在访问，需要更新显示但不改变currentCat
                // currentCat保持原始名字，显示时用自定义名字

                teaShopManager.core.saveGameData();
                teaShopManager.renderCatsTable();
                teaShopManager.addDebugLog(`🐱 ${originalName} 现在叫 ${catName} 了！战斗属性已生成！`);

                console.log('🐱 命名完成，最终数据:', {
                    customNames: cats.customNames,
                    combatStats: cats.combatStats
                });
            }

            // 关闭模态框
            const modal = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            if (modal) {
                modal.remove();
            }
        }

        // 测试猫咪命名功能












        // 强制生成顾客用于测试
        function forceCreateCustomer() {
            console.log('🔍 强制生成顾客');

            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            // 调用生成顾客的方法
            window.teaShopManager.generateCustomer();
            window.teaShopManager.updateCustomerDisplay();
            console.log('🔍 顾客已生成');
        }

        // 强制猫咪访问用于测试
        function forceCatVisit() {
            console.log('🔍 强制召唤猫咪');

            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            // 强制触发猫咪访问
            const cats = window.teaShopManager.core.gameData.teaShop.cats;
            const availableCats = Object.keys(cats.intimacy || {});
            if (availableCats.length === 0) {
                console.log('❌ 没有可访问的猫咪数据');
                return;
            }
            const randomCat = availableCats[Math.floor(Math.random() * availableCats.length)];

            cats.currentCat = randomCat;
            cats.visitStartTime = Date.now();
            cats.visitDuration = 10000; // 停留10秒

            window.teaShopManager.addDebugLog(`🐱 强制召唤: ${randomCat} 来访了！`);
            window.teaShopManager.renderCatsTable();
            console.log('🔍 猫咪已召唤:', randomCat);
        }

        // 重置猫咪状态
        function resetCatStatus() {
            console.log('🔍 重置猫咪状态');

            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            const cats = window.teaShopManager.core.gameData.teaShop.cats;

            // 重置访问状态
            cats.currentCat = '等待猫咪到来';
            cats.visitStartTime = null;
            cats.visitDuration = null;

            console.log('🔍 猫咪状态已重置:', {
                currentCat: cats.currentCat,
                visitStartTime: cats.visitStartTime,
                intimacyData: cats.intimacy
            });

            window.teaShopManager.renderCatsTable();
            window.teaShopManager.addDebugLog('🐱 猫咪访问状态已重置');
        }

        // 查看猫咪数据
        function debugCatData() {
            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            const cats = window.teaShopManager.core.gameData.teaShop.cats;
            console.log('🔍 === 猫咪数据详情 ===');
            console.log('当前访问猫咪:', cats.currentCat);
            console.log('访问开始时间:', cats.visitStartTime);
            console.log('访问持续时间:', cats.visitDuration);
            console.log('亲密度数据:', cats.intimacy);
            console.log('喂食次数:', cats.feedCount);
            console.log('可用猫咪列表:', Object.keys(cats.intimacy || {}));

            // 检查是否有"邹许"这只猫
            if (cats.intimacy['邹许']) {
                console.log('🐱 找到邹许! 亲密度:', cats.intimacy['邹许']);
            } else {
                console.log('🐱 没有找到邹许');
            }
        }



        // 重新触发命名检查
        function triggerNaming() {
            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            console.log('🔍 手动触发命名检查...');
            window.teaShopManager.checkAllCatsForNaming();
        }

        // 关闭礼物弹窗
        function closeGiftModal() {
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('🎁')) {
                    modal.remove();
                }
            });
        }

        // 测试礼物系统
        function testGifts() {
            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            const cats = window.teaShopManager.core.gameData.teaShop.cats;
            console.log('🎁 测试礼物系统...');

            // 找到第一只猫咪进行测试
            const firstCat = Object.keys(cats.intimacy)[0];
            if (firstCat) {
                console.log(`🎁 为 ${firstCat} 测试500亲密度礼物`);
                window.teaShopManager.giveCatGift(firstCat, 500);
            } else {
                console.log('❌ 没有找到猫咪');
            }
        }

        // 显示配方解锁状态
        function showRecipeUnlockStatus() {
            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            window.teaShopManager.showRecipeUnlockStatus();
        }

        // 关闭配方解锁状态窗口
        function closeRecipeUnlockStatus() {
            // 首先尝试通过ID查找
            const modal = document.getElementById('recipe-unlock-modal');
            if (modal) {
                modal.remove();
                return;
            }
            
            // 备用方法：查找所有固定定位的元素
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('配方解锁状态')) {
                    modal.remove();
                }
            });
        }

        // VIP顾客测试面板
        function showVipTestPanel() {
            if (!window.teaShopManager) {
                alert('❌ 茶铺管理器未加载，请刷新页面');
                return;
            }

            const manager = window.teaShopManager;
            const gameData = manager.core.gameData;
            const customerVisits = gameData.teaShop.customerVisits || {};
            const unlockedRecipes = gameData.teaShop.unlockedRecipes || [];

            // VIP顾客配置
            const vipCustomers = [
                { name: '凌小路', recipe: '洛神玫瑰饮', visits: 1, chance: 100 },
                { name: '花花', recipe: '桂圆红枣茶', visits: 1, chance: 100 },
                { name: '江飞飞', recipe: '焦香大麦茶', visits: 2, chance: 100 },
                { name: '江三', recipe: '三花决明茶', visits: 2, chance: 100 },
                { name: '江四', recipe: '薄荷甘草凉茶', visits: 2, chance: 100 },
                { name: '池云旗', recipe: '陈皮姜米茶', visits: 2, chance: 50, guaranteed: 3 },
                { name: '江潮', recipe: '冬瓜荷叶饮', visits: 3, chance: 60, guaranteed: 4 },
                { name: '池惊暮', recipe: '古法酸梅汤', visits: 2, chance: 30, guaranteed: 3 },
                { name: '江敕封', recipe: '小吊梨汤', visits: 3, chance: 40, guaranteed: 5 },
                { name: '姬别情', recipe: '神秘功能1', visits: 6, chance: 0, guaranteed: 6 },
                { name: '池九信', recipe: '神秘功能2', visits: 6, chance: 0, guaranteed: 6 },
                { name: '狸怒', recipe: '神秘功能3', visits: 6, chance: 0, guaranteed: 6 }
            ];

            // 创建模态框
            const modal = document.createElement('div');
            modal.id = 'vip-test-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 2000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;

            const panel = document.createElement('div');
            panel.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                max-width: 90vw;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;

            let customerRows = '';
            vipCustomers.forEach(customer => {
                const currentVisits = customerVisits[customer.name] || 0;
                const isUnlocked = unlockedRecipes.includes(customer.recipe);
                const progressText = customer.guaranteed ? 
                    `${currentVisits}/${customer.guaranteed}次 (${customer.chance}%概率, 第${customer.guaranteed}次必定)` :
                    `${currentVisits}/${customer.visits}次 (${customer.chance}%概率)`;
                
                const statusIcon = isUnlocked ? '✅' : '❌';
                const statusText = isUnlocked ? '已解锁' : '未解锁';
                const statusColor = isUnlocked ? '#4CAF50' : '#F44336';

                customerRows += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${customer.name}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${customer.recipe}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${progressText}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor};">
                            ${statusIcon} ${statusText}
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <button onclick="generateSpecificVip('${customer.name}')" 
                                    style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                                生成
                            </button>
                            ${!isUnlocked ? `<button onclick="forceUnlockRecipe('${customer.recipe}')" 
                                    style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                强制解锁
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            });

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">🎯 VIP顾客测试面板</h2>
                    <button onclick="closeVipTestPanel()" style="background: #F44336; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">✕</button>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px;">
                    <h3 style="margin-top: 0; color: #333;">📊 当前统计</h3>
                    <p><strong>已解锁配方数量:</strong> ${unlockedRecipes.length}/17</p>
                    <p><strong>已服务顾客:</strong> ${gameData.teaShop.servedCustomers || 0} 人</p>
                    <p><strong>当前顾客:</strong> ${gameData.teaShop.customer.active ? gameData.teaShop.customer.name : '无'}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <button onclick="generateRandomVip()" style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        🎲 随机生成VIP顾客
                    </button>
                    <button onclick="clearCurrentCustomer()" style="background: #9E9E9E; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        🚫 清除当前顾客
                    </button>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">VIP顾客</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">解锁配方</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">解锁进度</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">状态</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${customerRows}
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">
                    <strong>💡 使用说明：</strong><br>
                    • 点击"生成"按钮可以强制生成指定的VIP顾客（跳过30秒冷却）<br>
                    • 生成的VIP顾客会正常触发配方解锁检查<br>
                    • "强制解锁"按钮可以直接解锁配方，无需满足条件<br>
                    • 神秘顾客功能暂未开放，仅用于测试访问记录
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);
        }

        // 生成特定VIP顾客
        function generateSpecificVip(customerName) {
            if (!window.teaShopManager) {
                alert('❌ 茶铺管理器未加载');
                return;
            }

            const manager = window.teaShopManager;
            const gameData = manager.core.gameData;
            
            // 强制重置冷却时间，允许立即生成新顾客
            gameData.teaShop.lastCustomerTime = 0;
            
            // 强制生成指定的VIP顾客
            const customer = gameData.teaShop.customer;
            
            // 如果当前有顾客，先清除
            if (customer.active) {
                manager.resetCustomer();
            }

            // 生成指定VIP顾客
            customer.active = true;
            customer.customerType = 'vip';
            customer.isVIP = true;
            customer.name = customerName;
            customer.teaChoice = manager.getRandomAvailableTea();
            customer.toppingChoice = Math.random() < 0.8 ? manager.getRandomAvailableTopping() : null;
            customer.orderType = customer.toppingChoice ? 'tea_with_topping' : 'tea_only';
            customer.arrivalTime = Date.now();
            customer.patience = 240000; // VIP 4分钟
            customer.maxPatience = 240000;

            // 订单需求
            customer.requirements = {
                needsTea: true,
                needsTopping: !!customer.toppingChoice
            };

            // 订单进度
            customer.progress = {
                teaAdded: false,
                toppingAdded: false
            };

            const orderDesc = customer.requirements.needsTopping
                ? `${customer.teaChoice} + ${customer.toppingChoice}`
                : `${customer.teaChoice} (无小料)`;

            manager.addDebugLog(`🎯 测试生成VIP顾客: ${customerName} - 想要 ${orderDesc}`);
            manager.updateCustomerDisplay();
            
            // 关闭面板
            closeVipTestPanel();
            
            alert(`✅ 已生成VIP顾客：${customerName}\n要求：${orderDesc}`);
        }

        // 生成随机VIP顾客
        function generateRandomVip() {
            const vipNames = ['凌小路', '花花', '江飞飞', '江三', '江四', '池云旗', '江潮', '池惊暮', '江敕封', '姬别情', '池九信', '狸怒'];
            const randomName = vipNames[Math.floor(Math.random() * vipNames.length)];
            generateSpecificVip(randomName);
        }

        // 清除当前顾客
        function clearCurrentCustomer() {
            if (!window.teaShopManager) {
                alert('❌ 茶铺管理器未加载');
                return;
            }

            const manager = window.teaShopManager;
            manager.resetCustomer();
            manager.addDebugLog('🧹 手动清除当前顾客');
            alert('✅ 当前顾客已清除');
        }

        // 强制解锁配方
        function forceUnlockRecipe(recipeName) {
            if (!window.teaShopManager) {
                alert('❌ 茶铺管理器未加载');
                return;
            }

            const manager = window.teaShopManager;
            const gameData = manager.core.gameData;
            
            if (!gameData.teaShop.unlockedRecipes.includes(recipeName)) {
                gameData.teaShop.unlockedRecipes.push(recipeName);
                manager.core.saveGameData();
                manager.addDebugLog(`🔓 强制解锁配方: ${recipeName}`);
                alert(`✅ 已强制解锁配方：${recipeName}`);
                
                // 刷新面板显示
                closeVipTestPanel();
                showVipTestPanel();
            } else {
                alert(`ℹ️ 配方 ${recipeName} 已经解锁`);
            }
        }

        // 关闭VIP测试面板
        function closeVipTestPanel() {
            const modal = document.getElementById('vip-test-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 重置配方解锁状态
        function resetRecipeUnlockStatus() {
            if (!window.teaShopManager) {
                console.log('❌ teaShopManager 不存在');
                return;
            }

            // 重置所有VIP访问计数
            const vipCustomers = ['凌小路', '花花', '江飞飞', '江三', '江四', '池云旗', '池惊暮', '江潮', '江敕封', '姬别情', '池九信', '狸怒'];
            const data = window.teaShopManager.core.gameData.teaShop;
            
            // 重置访问计数（使用正确的字段名）
            data.customerVisits = {};
            if (data.vipUnlockAttempts) {
                data.vipUnlockAttempts = {};
            }
            
            // 重置服务总数（使用正确的字段名）
            data.servedCustomers = 0;
            
            // 重置配方解锁状态（使用数组格式，保留基础配方）
            data.unlockedRecipes = ["五味子饮", "柠檬茶", "解暑茶"];
            
            // 重置茶饮配方对象（只保留基础配方）
            data.teaRecipes = {
                "五味子饮": ["五味子"],
                "柠檬茶": ["柠檬"],
                "解暑茶": ["甘草"]
            };
            
            // 保存数据
            window.teaShopManager.core.saveGameData();
            
            // 更新菜单显示
            window.teaShopManager.updateAllDisplays();
            
            // 刷新解锁状态页面
            window.teaShopManager.showRecipeUnlockStatus();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯çˆ±èŒ¶é“º - å†œåœºç®¡ç†ç³»ç»Ÿ (GitHub Pagesç‰ˆ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #374151;
            line-height: 1.4;
            font-size: 12px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 16px; color: #374151; margin-bottom: 8px; font-weight: 500; }
        .section { margin-bottom: 25px; }
        .section-title { font-size: 12px; font-weight: 500; margin-bottom: 10px; color: #374151; }
        
        /* è°ƒè¯•çª—å£æ ·å¼ */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 1000;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        /* è°ƒè¯•é¢æ¿æŠ˜å çŠ¶æ€ */
        .debug-panel.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            bottom: 20px;
            top: auto;
            right: 20px;
        }

        .debug-panel.collapsed:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        .debug-header {
            background: #3b82f6;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
        }

        /* æŠ˜å çŠ¶æ€ä¸‹çš„headeræ ·å¼ */
        .debug-panel.collapsed .debug-header {
            background: transparent;
            padding: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            justify-content: center;
        }

        .debug-panel.collapsed .debug-header span {
            font-size: 24px;
            color: white;
        }

        /* åœ†çƒçŠ¶æ€ä¸‹åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªemoji */
        .debug-panel.collapsed .debug-header span::before {
            content: 'ğŸ› ';
            font-size: 24px;
        }

        .debug-panel.collapsed .debug-header span {
            text-indent: -9999px;
            position: relative;
        }

        .debug-panel.collapsed .debug-header span::before {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-indent: 0;
        }
        .debug-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        /* æŠ˜å çŠ¶æ€ä¸‹éšè—å†…å®¹å’ŒtoggleæŒ‰é’® */
        .debug-panel.collapsed .debug-content,
        .debug-panel.collapsed .debug-toggle {
            display: none;
        }
        .debug-content {
            padding: 15px;
            font-size: 12px;
        }
        .debug-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .debug-section:last-child {
            border-bottom: none;
        }
        .debug-section h4 {
            color: #6b7280;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .debug-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .debug-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-connected { background: #e5e7eb; color: #6b7280; }
        .status-disconnected { background: #e5e7eb; color: #6b7280; }
        .status-loading { background: #e5e7eb; color: #6b7280; }
        .debug-actions {
            display: flex;
            flex-wrap: nowrap;
            gap: 5px;
            margin-top: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 5px;
            white-space: nowrap;
            max-width: 100%;
        }

        .debug-actions::-webkit-scrollbar {
            height: 6px;
        }

        .debug-actions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .debug-actions::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .debug-actions::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .debug-btn {
            padding: 5px 10px;
            background: #e5e7eb;
            color: #4b5563;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .debug-btn:hover {
            background: #f3f4f6;
        }

        /* GitHub Pagesç‰ˆæœ¬æ ‡è¯† */
        .github-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .debug-log {
            max-height: 100px;
            overflow-y: auto;
            background: #f9fafb;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            line-height: 1.4;
        }
        
        /* åŸºç¡€æ•°æ®è¡¨æ ¼ */
        .basic-info-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            background: #ffffff;
        }
        .basic-info-table th, .basic-info-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
            color: #374151;
            font-size: 12px;
        }
        .basic-info-table th { background-color: #f9fafb; font-weight: 500; }
        
        /* ç§æ¤åŒºåŸŸ */
        .farm-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .plot-card {
            border: 1px solid #e5e7eb;
            background: #ffffff;
            padding: 15px;
            border-radius: 6px;
        }
        .plot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .plot-title { font-weight: 500; color: #374151; font-size: 12px; }
        .plot-status {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 400;
        }
        .status-empty { background-color: #f3f4f6; color: #6b7280; }
        .status-growing { background-color: #e5e7eb; color: #6b7280; }
        .status-ready { background-color: #e5e7eb; color: #6b7280; }
        
        .conditions-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        .conditions-table td {
            padding: 6px;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background-color: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .moisture-fill { background-color: #d1d5db; }
        .fertility-fill { background-color: #d1d5db; }
        .growth-fill { background-color: #9ca3af; }
        
        .plot-actions { display: flex; gap: 8px; margin-top: 12px; }
        .action-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .action-btn:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .action-btn.primary { background-color: #f3f4f6; color: #374151; border-color: #d1d5db; }
        .action-btn.primary:hover { background-color: #e5e7eb; }
        
        /* å·¥ä½œåŒºåŸŸè¡¨æ ¼ */
        .workspace-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
        }
        .workspace-table th, .workspace-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        .workspace-table th { background-color: #f9fafb; font-weight: 500; color: #374151; }
        
        /* å°æ–™å•†åº—æ ·å¼ */
        .toppings-shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .topping-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            background: #ffffff;
            text-align: center;
            transition: all 0.2s ease;
        }
        .topping-item:hover {
            border-color: #9ca3af;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }
        .topping-icon {
            display: none;
        }
        .topping-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
            font-size: 12px;
        }
        .topping-price {
            color: #6b7280;
            font-weight: 400;
            margin-bottom: 4px;
            font-size: 12px;
        }
        .topping-stock {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .topping-description {
            color: #9ca3af;
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .buy-btn {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .buy-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        .buy-btn:disabled {
            background: #f3f4f6;
            border-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* åº“å­˜è¡¨æ ¼ */
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
        }
        .inventory-table th, .inventory-table td {
            border: 1px solid #e5e7eb;
            padding: 6px;
            text-align: center;
            font-size: 12px;
        }
        .inventory-table th { background-color: #f9fafb; font-weight: 500; color: #374151; }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 12px;
        }
        .close {
            color: #9ca3af;
            float: right;
            font-size: 18px;
            font-weight: normal;
            cursor: pointer;
        }
        .close:hover { color: #374151; }
        
        .seed-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .seed-option {
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        .seed-option:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .seed-name { font-weight: 500; margin-bottom: 3px; color: #374151; font-size: 12px; }
        .seed-info { font-size: 12px; color: #6b7280; }

        /* é¡¾å®¢ç³»ç»Ÿæ ·å¼ */
        .customer-visit-area {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .current-customer-display {
            background-color: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            min-height: 80px;
            font-size: 12px;
        }

        .customer-avatar {
            display: none;
        }

        /* é¡¶éƒ¨èœå•æ æ ·å¼ */
        .top-menu-bar {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
        }

        .menu-item {
            position: relative;
            display: inline-block;
        }

        .menu-btn {
            background: #3b82f6;
            border: 1px solid #2563eb;
            color: #ffffff;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .menu-btn:hover {
            background: #2563eb;
            border-color: #1d4ed8;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            z-index: 1000;
            top: 100%;
            left: 0;
            margin-top: 2px;
        }

        .dropdown-content a {
            color: #374151;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: #f9fafb;
            color: #374151;
        }

        .dropdown-content.show {
            display: block;
        }

        /* è¡Œåˆ—å¸ƒå±€ */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .col-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 10px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .col-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .container {
                padding: 10px;
            }

            .debug-panel {
                width: 90%;
                right: 5%;
                top: 5px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .debug-content {
                max-height: 70vh;
                overflow-y: auto;
                padding: 10px;
            }

            .debug-panel.collapsed {
                width: 50px;
                height: 50px;
                right: 15px;
                bottom: 15px;
            }

            .github-badge {
                font-size: 10px;
                padding: 6px 12px;
                top: 5px;
                left: 5px;
            }

            .basic-info-table th,
            .basic-info-table td {
                padding: 6px 8px;
                font-size: 11px;
            }

            .workspace-table th,
            .workspace-table td {
                padding: 6px 8px;
                font-size: 11px;
            }

            .inventory-table th,
            .inventory-table td {
                padding: 6px 8px;
                font-size: 11px;
            }

            .action-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .top-menu-bar {
                flex-wrap: wrap;
                gap: 8px;
            }

            .menu-btn {
                font-size: 11px;
                padding: 6px 12px;
            }

            /* ç§»åŠ¨ç«¯è°ƒè¯•æŒ‰é’®ä¼˜åŒ– */
            .debug-actions {
                flex-wrap: wrap !important;
                max-height: 200px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .debug-btn {
                flex: 0 0 calc(50% - 3px);
                margin-bottom: 6px;
                font-size: 10px;
                padding: 8px 6px;
                text-align: center;
            }

            /* è°ƒè¯•é¢æ¿æ»šåŠ¨æ¡æ ·å¼ */
            .debug-content::-webkit-scrollbar,
            .debug-actions::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            .debug-content::-webkit-scrollbar-track,
            .debug-actions::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }

            .debug-content::-webkit-scrollbar-thumb,
            .debug-actions::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            .debug-content::-webkit-scrollbar-thumb:hover,
            .debug-actions::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        }

        /* å¤©æ°”å›¾æ ‡ç°è‰²æ ·å¼ */
        .weather-icon {
            filter: grayscale(100%);
            opacity: 0.7;
        }

        /* å­˜æ¡£æ§½ä½æ ·å¼ */
        .save-slot {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .save-slot:hover {
            background-color: #f3f4f6;
        }

        .save-slot:last-child {
            border-bottom: none;
        }

        .save-slot-header {
            font-weight: 600;
            color: #374151;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .save-slot-time {
            font-size: 10px;
            color: #6b7280;
        }

        /* å¯æŠ˜å è¡¨æ ¼æ ·å¼ */
        .collapsible-section {
            display: none;
        }

        .collapsible-section.active {
            display: block;
            /* å°†æ´»åŠ¨çš„æŠ˜å åŒºåŸŸç§»åŠ¨åˆ°é¡¶éƒ¨ */
            order: -1;
        }

        .main-content-wrapper {
            display: flex;
            flex-direction: column;
        }



        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #f3f4f6;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #e5e7eb;
            border-radius: 9px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 500;
            color: #374151;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            z-index: 1;
        }

        .progress-bar.cooking {
            background: #e5e7eb;
        }

        .progress-bar.processing {
            background: #e5e7eb;
        }

        /* ç§æ¤åŒºåŸŸå°è¿›åº¦æ¡æ ·å¼ */
        .plot-progress-container {
            width: 100%;
            height: 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            position: relative;
            margin: 2px 0;
        }

        .plot-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }

        .plot-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: 500;
            color: #374151;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            z-index: 1;
            line-height: 1;
        }

        .moisture-progress {
            background: #e5e7eb;
        }

        .fertility-progress {
            background: #e5e7eb;
        }

        .growth-progress {
            background: #e5e7eb;
        }

        .customer-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .customer-status {
            font-size: 12px;
            color: #6c757d;
        }

        /* çŒ«å’ªç³»ç»Ÿæ ·å¼ */
        .cat-interaction-area {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .selected-cat-display {
            background-color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            min-height: 120px;
        }

        .cat-avatar {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .cat-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .cat-intimacy {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .intimacy-bar {
            width: 100%;
            height: 10px;
            background-color: #f3f4f6;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
            border: 1px solid #d1d5db;
        }

        /* Badge æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 4px;
        }
        .bg-warning { background-color: #e5e7eb; color: #6b7280; }
        .bg-success { background-color: #e5e7eb; color: #4b5563; }
        .bg-info { background-color: #e5e7eb; color: #6b7280; }
        .bg-secondary { background-color: #e5e7eb; color: #6b7280; }

        /* Progress æ ·å¼ */
        .progress {
            display: flex;
            height: 8px;
            overflow: hidden;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: white;
            text-align: center;
            background-color: #e5e7eb;
            transition: width 0.6s ease;
        }
        .progress-bar.bg-warning {
            background-color: #6b7280; /* ç°è‰² */
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }
        .progress-bar.bg-success {
            background-color: #6b7280; /* ç°è‰² */
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        /* Alert æ ·å¼ */
        .alert {
            position: relative;
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .alert-info { color: #6b7280; background-color: #e5e7eb; border-color: #d1d5db; }
        .alert-warning { color: #6b7280; background-color: #e5e7eb; border-color: #d1d5db; }
        .alert-secondary { color: #6b7280; background-color: #e5e7eb; border-color: #d1d5db; }

        /* å·¥å…·ç±» */
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .text-muted { color: #6c757d; }
        .mt-3 { margin-top: 16px; }

        .intimacy-progress {
            height: 100%;
            background-color: #6b7280; /* ç°è‰² */
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .cat-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .cat-actions .action-btn {
            flex: 1;
        }

        /* Win95é£æ ¼å¼¹çª—ç³»ç»Ÿ */
        .win95-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .win95-modal {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 500px;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }

        .win95-modal-header {
            background: linear-gradient(90deg, #0080ff 0%, #0040c0 100%);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
        }

        .win95-modal-title {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .win95-modal-close {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 16px;
            height: 14px;
            font-size: 9px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
        }

        .win95-modal-close:hover {
            background: #e0e0e0;
        }

        .win95-modal-close:active {
            border: 1px inset #c0c0c0;
        }

        .win95-modal-content {
            background: #c0c0c0;
            padding: 12px;
            border-top: 1px solid #808080;
            color: #000;
            line-height: 1.4;
        }

        .win95-modal-buttons {
            background: #c0c0c0;
            padding: 8px 12px;
            border-top: 1px solid #808080;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .win95-button {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            padding: 2px 16px;
            font-size: 11px;
            font-family: 'MS Sans Serif', sans-serif;
            cursor: pointer;
            min-width: 60px;
            height: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .win95-button:hover {
            background: #e0e0e0;
        }

        .win95-button:active {
            border: 1px inset #c0c0c0;
        }

        .win95-button.primary {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- GitHub Pagesç‰ˆæœ¬æ ‡è¯† -->
    <div class="github-badge">
        ğŸš€ GitHub Pagesç‰ˆ
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel collapsed" id="debug-panel">
        <div class="debug-header" onclick="toggleDebugContent()">
            <span>ğŸ”§ è°ƒè¯•æ§åˆ¶å° <small style="opacity: 0.7;">(å¯æ»šåŠ¨)</small></span>
            <button class="debug-toggle" onclick="event.stopPropagation(); toggleDebugContent()">âˆ’</button>
        </div>
        <div class="debug-content" id="debug-content">
            <div class="debug-section">
                <h4>å­˜å‚¨çŠ¶æ€ (GitHub Pagesç‰ˆ)</h4>
                <div class="debug-item">
                    <span>æœ¬åœ°å­˜å‚¨:</span>
                    <span class="debug-status status-connected" id="db-status">localStorage</span>
                </div>
                <div class="debug-item">
                    <span>äº‘ç«¯å­˜æ¡£:</span>
                    <span class="debug-status status-loading" id="cloud-status">æœªè®¾ç½®</span>
                </div>
                <div class="debug-item">
                    <span>æœ€åä¿å­˜:</span>
                    <span id="last-save">æœªä¿å­˜</span>
                </div>
                <div class="debug-item">
                    <span>ç‰ˆæœ¬:</span>
                    <span>GitHub Pages v1.0</span>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>æ¸¸æˆæ•°æ®æ¦‚è§ˆ</h4>
                <div class="debug-item">
                    <span>æ¸¸æˆå¤©æ•°:</span>
                    <span id="debug-day">ç¬¬1å¤©</span>
                </div>
                <div class="debug-item">
                    <span>å½“å‰å­£èŠ‚:</span>
                    <span id="debug-season">ğŸŒ¸ æ˜¥å¤© (ç¬¬1å¤©)</span>
                </div>
                <div class="debug-item">
                    <span>å½“å‰å¤©æ°”:</span>
                    <span id="debug-weather">â˜€ï¸ æ™´å¤©</span>
                </div>
                <div class="debug-item">
                    <span>èµ„é‡‘:</span>
                    <span id="debug-funds">100</span>
                </div>
                <div class="debug-item">
                    <span>ç§å­æ€»æ•°:</span>
                    <span id="debug-seeds">0</span>
                </div>
                <div class="debug-item">
                    <span>ææ–™æ€»æ•°:</span>
                    <span id="debug-materials">0</span>
                </div>
                <div class="debug-item">
                    <span>æœåŠ¡é¡¾å®¢æ•°:</span>
                    <span id="debug-served-customers">0</span>
                </div>
                <div class="debug-item">
                    <span>å°æ–™æ€»æ•°:</span>
                    <span id="debug-toppings">0</span>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>ç§æ¤çŠ¶æ€</h4>
                <div id="debug-plots">
                    <!-- ç§æ¤çŠ¶æ€åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="debug-section">
                <h4>æ“ä½œæ—¥å¿—</h4>
                <div class="debug-log" id="debug-log">
                    ç³»ç»Ÿåˆå§‹åŒ–...<br>
                </div>
            </div>
            
                                        <div class="debug-actions">
                                <button class="debug-btn" onclick="testLocalStorage()">æµ‹è¯•æœ¬åœ°å­˜å‚¨</button>
                                <button class="debug-btn" onclick="forceSaveGame()">å¼ºåˆ¶ä¿å­˜</button>
                                <button class="debug-btn" onclick="forceLoadGame()">å¼ºåˆ¶åŠ è½½</button>
                                <button class="debug-btn" onclick="clearDebugLog()">æ¸…ç©ºæ—¥å¿—</button>
                                <button class="debug-btn" onclick="forceSpawnCustomer()">ç«‹å³ç”Ÿæˆé¡¾å®¢</button>
                                <button class="debug-btn" onclick="addTestMaterials()">æ·»åŠ æµ‹è¯•ææ–™</button>
                                <button class="debug-btn" onclick="forceAdvanceDay()">æ¨è¿›ä¸€å¤©</button>
                                <button class="debug-btn" onclick="changeWeather()">æ”¹å˜å¤©æ°”</button>
                                <button class="debug-btn" onclick="debugCustomerUnlock()">è°ƒè¯•é…æ–¹è§£é”</button>
                                <button class="debug-btn" onclick="syncCustomerStatsFromDatabase()">åŒæ­¥é¡¾å®¢ç»Ÿè®¡</button>
                                <button class="debug-btn" onclick="testGrillUnlock()">æµ‹è¯•çƒ¤è‚‰æ¶è§£é”</button>
                                <button class="debug-btn" onclick="showCloudSaveSettings()" style="background: #3b82f6; color: white;">â˜ï¸ äº‘ç«¯å­˜æ¡£è®¾ç½®</button>
                                <button class="debug-btn" onclick="resetGameData()" style="background: #ef4444; color: white;">é‡ç½®æ•°æ®</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸµ å¯çˆ±èŒ¶é“º - å†œåœºç®¡ç†ç³»ç»Ÿ</h1>
            <p>GitHub Pagesç‰ˆ - æ”¯æŒäº‘ç«¯å­˜æ¡£åŒæ­¥ â˜ï¸</p>
        </div>
        
        <!-- é¡¶éƒ¨èœå•æ  -->
        <div class="top-menu-bar">
            <div class="menu-item dropdown">
                <button class="menu-btn" onclick="toggleDropdown('inventory-dropdown')">åº“å­˜ç®¡ç† â–¼</button>
                <div id="inventory-dropdown" class="dropdown-content">
                    <a href="#" onclick="toggleInventoryTable('materials'); closeDropdown('inventory-dropdown')">åŸæ–™åº“å­˜</a>
                    <a href="#" onclick="toggleInventoryTable('toppings'); closeDropdown('inventory-dropdown')">å°æ–™åº“å­˜ç®¡ç†</a>
                    <a href="#" onclick="openToppingsShop(); closeDropdown('inventory-dropdown')">å°æ–™å•†åº—</a>
                </div>
            </div>
            <div class="menu-item dropdown">
                <button class="menu-btn" onclick="toggleDropdown('customer-dropdown')">å®¢æˆ·ç®¡ç† â–¼</button>
                <div id="customer-dropdown" class="dropdown-content">
                    <a href="#" onclick="toggleCustomerTable(); closeDropdown('customer-dropdown')">èŒ¶åº—é¡¾å®¢ç®¡ç†è¡¨</a>
                    <a href="#" onclick="showRecipeUnlockStatus(); closeDropdown('customer-dropdown')">æŸ¥çœ‹é…æ–¹è§£é”çŠ¶æ€</a>
                </div>
            </div>
            <div class="menu-item dropdown">
                <button class="menu-btn" onclick="toggleDropdown('save-dropdown')">å­˜æ¡£ç®¡ç† â–¼</button>
                <div id="save-dropdown" class="dropdown-content" style="min-width: 220px;">
                    <div class="save-slot" onclick="saveToDatabaseNow(); closeDropdown('save-dropdown')" style="background: #e8f5e8; border: 2px solid #22c55e; margin-bottom: 8px;">
                        <div class="save-slot-header" style="color: #16a34a; font-weight: bold;">ğŸ’¾ ç«‹å³ä¿å­˜</div>
                        <div class="save-slot-time" style="color: #16a34a; font-size: 10px;">ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨+äº‘ç«¯åŒæ­¥</div>
                    </div>
                    <div class="save-slot" onclick="loadSaveSlot(1); closeDropdown('save-dropdown')">
                        <div class="save-slot-header">æ§½ä½1 - è‡ªåŠ¨å­˜æ¡£</div>
                        <div class="save-slot-time" id="save-time-1">æœªä¿å­˜</div>
                    </div>
                    <div class="save-slot" onclick="handleSaveSlot(2); closeDropdown('save-dropdown')">
                        <div class="save-slot-header">æ§½ä½2</div>
                        <div class="save-slot-time" id="save-time-2">ç©ºæ§½ä½</div>
                    </div>
                    <div class="save-slot" onclick="handleSaveSlot(3); closeDropdown('save-dropdown')">
                        <div class="save-slot-header">æ§½ä½3</div>
                        <div class="save-slot-time" id="save-time-3">ç©ºæ§½ä½</div>
                    </div>
                    <div class="save-slot" onclick="handleSaveSlot(4); closeDropdown('save-dropdown')">
                        <div class="save-slot-header">æ§½ä½4</div>
                        <div class="save-slot-time" id="save-time-4">ç©ºæ§½ä½</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <!-- åŸºç¡€è¿è¥æ•°æ® -->
            <div class="section">
                <h2 class="section-title">åŸºç¡€è¿è¥æ•°æ®</h2>
                <table class="basic-info-table">
                    <tr>
                        <th>è¿è¥å¤©æ•°</th>
                        <td id="current-day">1</td>
                        <th>å½“å‰å­£èŠ‚</th>
                        <td id="current-season">æ˜¥å¤©</td>
                        <th>å¤©æ°”çŠ¶å†µ</th>
                        <td id="current-weather">æ™´å¤©</td>
                        <th>è¿è¥èµ„é‡‘</th>
                        <td id="current-funds">100 é‡‘å¸</td>
                    </tr>
                </table>
            </div>

        <!-- é¡¾å®¢ç³»ç»Ÿ -->
        <div id="customer-section" class="section collapsible-section">
            <h2 class="section-title">èŒ¶åº—é¡¾å®¢ç®¡ç†</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>é¡¾å®¢å§“å</th>
                        <th>æ¥è®¿æ¬¡æ•°</th>
                        <th>è§£é”é…æ–¹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="customers-table">
                    <!-- é¡¾å®¢æ•°æ® -->
                </tbody>
            </table>
        </div>

        <!-- å½“å‰è®¿å®¢çŠ¶æ€ - å§‹ç»ˆæ˜¾ç¤º -->
        <div class="section">
            <h2 class="section-title">å½“å‰è®¿å®¢çŠ¶æ€</h2>
            <div class="customer-visit-area">
                <table class="workspace-table">
                    <thead>
                        <tr>
                            <th>è®¿å®¢</th>
                            <th>éœ€æ±‚</th>
                            <th>å‰©ä½™æ—¶é—´</th>
                            <th>è€å¿ƒå€¼</th>
                        </tr>
                    </thead>
                    <tbody id="current-customer">
                        <tr>
                            <td colspan="4" class="text-center text-muted">æš‚æ— è®¿å®¢</td>
                        </tr>
                    </tbody>
                </table>
                <div id="customer-status" class="mt-3">
                    <div class="alert alert-secondary">ç­‰å¾…é¡¾å®¢åˆ°æ¥...</div>
                </div>
            </div>
        </div>

        <!-- ç§æ¤åŒºåŸŸç®¡ç† -->
        <div class="section">
            <h2 class="section-title">ç§æ¤åŒºåŸŸç®¡ç†</h2>
            <div class="farm-grid" id="farm-grid">
                <!-- ç§æ¤åŒºåŸŸå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç‚‰ç¶åˆ¶èŒ¶åŒºåŸŸå’Œæ¡ˆæ¿åŠ å·¥åŒºåŸŸ -->
        <div class="section">
            <div class="row">
                <div class="col-6">
                    <h2 class="section-title">ç‚‰ç¶åˆ¶èŒ¶åŒºåŸŸ</h2>
                    <table class="workspace-table">
                        <thead>
                            <tr>
                                <th>ç‚‰ç¶ç¼–å·</th>
                                <th>åˆ¶ä½œé…æ–¹</th>
                                <th>åˆ¶ä½œè¿›åº¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="stoves-table">
                            <!-- ç‚‰ç¶æ•°æ®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <div class="col-6">
                    <h2 class="section-title">æ¡ˆæ¿åŠ å·¥åŒºåŸŸ</h2>
                    <table class="workspace-table">
                        <thead>
                            <tr>
                                <th>æ¡ˆæ¿ç¼–å·</th>
                                <th>å½“å‰é…æ–¹</th>
                                <th>åŠ å·¥è¿›åº¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="processing-table">
                            <!-- åŠ å·¥å°æ•°æ®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- çƒ¤è‚‰æ¶åŒºåŸŸ -->
        <div class="section" id="grill-section" style="display: none;">
            <h2 class="section-title">çƒ¤è‚‰æ¶</h2>
            <table class="workspace-table">
                <thead>
                    <tr>
                        <th>çƒ¤è‚‰æ¶</th>
                        <th>çƒ¤åˆ¶é…æ–¹</th>
                        <th>çƒ¤åˆ¶è¿›åº¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="grill-table">
                    <!-- çƒ¤è‚‰æ¶æ•°æ®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </tbody>
            </table>
        </div>

        <!-- æ‰“çŒåŒºåŸŸ -->
        <div class="section" id="hunting-section" style="display: none;">
            <h2 class="section-title">æ‰“çŒç³»ç»Ÿ</h2>

            <!-- åå±±æ‰“çŒ -->
            <div class="hunting-area" style="padding: 15px; margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px;">
                <h3 style="margin: 0 0 15px 0; color: #228b22;">ğŸ¹ åå±±æ‰“çŒ</h3>
                <div class="hunting-status" id="hunting-status" style="margin-bottom: 15px;">
                    <div class="alert alert-secondary">å‡†å¤‡æ‰“çŒ...</div>
                </div>
                <div class="hunting-controls" style="margin-bottom: 15px;">
                    <button class="action-btn primary" onclick="startHunting()" id="hunt-btn">
                        ğŸ¹ å¼€å§‹æ‰“çŒ (15ç§’)
                    </button>
                </div>
                <div class="hunting-stats">
                    <span>æ‰“çŒæ¬¡æ•°: <span id="hunt-count">0</span></span>
                    <span style="margin-left: 20px;">è§£é”é«˜çº§çŒç‰©: <span id="advanced-hunt-status">éœ€è¦50æ¬¡</span></span>
                </div>
            </div>

            <!-- å±±æ´æ‰“çŒ -->
            <div class="cave-hunting-area" id="cave-hunting-section" style="padding: 15px; border: 2px solid #8b4513; border-radius: 8px; display: none;">
                <h3 style="margin: 0 0 15px 0; color: #8b4513;">ğŸ”ï¸ å±±æ´æ‰“çŒ</h3>
                <div class="cave-hunting-status" id="cave-hunting-status" style="margin-bottom: 15px;">
                    <div class="alert alert-secondary">å‡†å¤‡æ¢ç´¢å±±æ´...</div>
                </div>
                <div class="cave-hunting-controls" style="margin-bottom: 15px;">
                    <button class="action-btn primary" onclick="startCaveHunting()" id="cave-hunt-btn">
                        ğŸ”ï¸ æ¢ç´¢å±±æ´ (20ç§’)
                    </button>
                </div>
                <div class="cave-hunting-stats">
                    <span>å±±æ´æ¢ç´¢æ¬¡æ•°: <span id="cave-hunt-count">0</span></span>
                    <span style="margin-left: 20px; color: #8b4513;">ç‰¹äº§ï¼šé“¶è€³</span>
                </div>
            </div>
        </div>

        <!-- ç¨»é¦™æ‘å…¥å£ -->
        <div class="section" id="rice-village-section" style="display: none;">
            <h2 class="section-title">ç¨»é¦™æ‘</h2>
            <div style="padding: 20px; text-align: center;">
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <strong>ğŸ® ç¨»é¦™æ‘å·²è§£é”ï¼</strong><br>
                    ä¸çŒ«å’ªä¼™ä¼´ä¸€èµ·è¸ä¸Šå†’é™©ä¹‹æ—…
                </div>
                <button class="action-btn primary" onclick="enterRiceVillage()" style="font-size: 16px; padding: 12px 24px;">
                    å‰å¾€ç¨»é¦™æ‘
                </button>
            </div>
        </div>

        <!-- èŒ¶é¥®ç®¡ç†åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">èŒ¶é¥®åº“å­˜ç®¡ç†</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>èŒ¶é¥®åç§°</th>
                        <th>æ¸©åº¦çŠ¶æ€</th>
                        <th>åˆ¶ä½œæ—¶é—´</th>
                        <th>æ•°é‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tea-inventory">
                    <!-- èŒ¶é¥®åº“å­˜æ•°æ® -->
                </tbody>
            </table>
        </div>

        <!-- åŸæ–™åº“å­˜ç®¡ç†ï¼ˆæ•´åˆç‰ˆï¼‰ -->
        <div id="materials-section" class="section collapsible-section">
            <h2 class="section-title">åŸæ–™åº“å­˜ç®¡ç†</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>åŸæ–™åç§°</th>
                        <th>ç§å­åº“å­˜</th>
                        <th>ææ–™åº“å­˜</th>
                        <th>ç§å­ä»·æ ¼</th>
                        <th>ç”Ÿé•¿æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="materials-inventory">
                    <!-- åŸæ–™åº“å­˜æ•°æ® -->
                </tbody>
            </table>
        </div>

        <!-- å°æ–™åº“å­˜ç®¡ç† -->
        <div id="toppings-section" class="section collapsible-section">
            <h2 class="section-title">å°æ–™åº“å­˜ç®¡ç†</h2>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>å°æ–™åç§°</th>
                        <th>å½“å‰åº“å­˜</th>
                        <th>è·å–æ–¹å¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="toppings-inventory">
                    <!-- å°æ–™åº“å­˜æ•°æ® -->
                </tbody>
            </table>
        </div>

        <!-- çŒ«å’ªç³»ç»Ÿ -->
        <div class="section">
            <div class="row">
                <div class="col-6">
                    <h2 class="section-title">èŒ¶åº—çŒ«å’ªç®¡ç†</h2>
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>çŒ«å’ªåç§°</th>
                                <th>äº²å¯†åº¦</th>
                                <th>ç­‰çº§</th>
                                <th>ç¤¼ç‰©èµ é€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cats-table">
                            <tr><td colspan="5" class="text-center text-muted">çŒ«å’ªæ•°æ®åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-6">
                    <h2 class="section-title">çŒ«å’ªäº’åŠ¨</h2>
                    <div class="cat-interaction-area">
                        <div id="selected-cat" class="selected-cat-display">
                            <p>é€‰æ‹©ä¸€åªçŒ«å’ªè¿›è¡Œäº’åŠ¨</p>
                        </div>
                        <div class="cat-actions">
                            <button class="action-btn" onclick="feedCat()">å–‚é£ŸèŒ¶é¥®</button>
                            <button class="action-btn" onclick="feedCatWithFish()">å–‚å°é±¼å¹²</button>
                            <button class="action-btn" onclick="petCat()">æ’¸çŒ«</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•æ§åˆ¶å°æµ®åŠ¨çƒ -->




    <!-- ç§å­è´­ä¹°æ¨¡æ€æ¡† -->
    <div id="seed-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>é€‰æ‹©ç§å­ç§æ¤</h2>
            <div id="seed-grid" class="seed-grid">
                <!-- ç§å­é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- èŒ¶é¥®é…æ–¹é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="recipe-modal" class="modal">
        <div class="modal-content">
            <span class="close-recipe">&times;</span>
            <h2>é€‰æ‹©èŒ¶é¥®é…æ–¹</h2>
            <div id="recipe-grid" class="seed-grid">
                <!-- èŒ¶é¥®é…æ–¹é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- åŠ å·¥é…æ–¹é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="processing-modal" class="modal">
        <div class="modal-content">
            <span class="close-processing">&times;</span>
            <h2 style="font-size: 14px; font-weight: 500; margin-bottom: 10px;">é€‰æ‹©åŠ å·¥é…æ–¹</h2>
            <div id="processing-grid" class="seed-grid">
                <!-- åŠ å·¥é…æ–¹é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å°æ–™å•†åº—æ¨¡æ€æ¡† -->
    <div id="toppings-shop-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-toppings-shop">&times;</span>
            <h2 style="font-size: 14px; font-weight: 500; margin-bottom: 10px;">å°æ–™å•†åº—</h2>
                            <p style="margin-bottom: 15px; color: #6b7280; font-size: 12px;">å½“å‰èµ„é‡‘: <span id="shop-funds" style="color: #374151; font-weight: 500;">1000</span> é‡‘å¸</p>
            <div class="toppings-shop-grid" id="toppings-shop-grid">
                <!-- å°æ–™å•†å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- Win95é£æ ¼å¼¹çª— -->
    <div class="win95-modal-overlay" id="win95-modal-overlay">
        <div class="win95-modal" id="win95-modal">
            <div class="win95-modal-header">
                <div class="win95-modal-title">
                    <span id="win95-modal-icon">â„¹ï¸</span>
                    <span id="win95-modal-title-text">ç³»ç»Ÿæ¶ˆæ¯</span>
                </div>
                <div class="win95-modal-close" onclick="closeWin95Modal()">Ã—</div>
            </div>
            <div class="win95-modal-content" id="win95-modal-content">
                æ¶ˆæ¯å†…å®¹
            </div>
            <div class="win95-modal-buttons" id="win95-modal-buttons">
                <button class="win95-button primary" onclick="closeWin95Modal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // GitHub Pagesç‰ˆæœ¬æ ‡è¯†
        const GITHUB_PAGES_VERSION = true;
        const VERSION_INFO = {
            version: "1.0.0-github",
            build: "github-pages-optimized",
            buildTime: new Date().toISOString(),
            features: ["cloud-save", "local-storage", "multi-device", "optimized"],
            backend: false // æ ‡è¯†æ— åç«¯ä¾èµ–
        };

        console.log('ğŸš€ å¯çˆ±èŒ¶é“º GitHub Pagesç‰ˆæœ¬å¯åŠ¨');
        console.log('ç‰ˆæœ¬ä¿¡æ¯:', VERSION_INFO);

        // æ¸¸æˆæ•°æ®ç»“æ„
        const gameData = {
            currentDay: 1,
            seasonDay: 1,
            season: 0, // 0=æ˜¥å¤©, 1=å¤å¤©, 2=ç§‹å¤©, 3=å†¬å¤©
            weather: 0, // 0=æ™´å¤©, 1=å¤šäº‘, 2=é›¨å¤©, 3=æš´é£é›¨
            currentSeason: "æ˜¥å¤©",
            currentWeather: "æ™´å¤©",
            lastDayChange: Date.now(),
            funds: 1000,
            
            // ç§æ¤åŒºåŸŸï¼ˆ4å—åœ°ï¼‰
            plots: [
                { id: 0, state: 'empty', moisture: 50, fertility: 50, plantType: null, growthStage: 0, stageStartTime: 0 },
                { id: 1, state: 'empty', moisture: 50, fertility: 50, plantType: null, growthStage: 0, stageStartTime: 0 },
                { id: 2, state: 'empty', moisture: 50, fertility: 50, plantType: null, growthStage: 0, stageStartTime: 0 },
                { id: 3, state: 'empty', moisture: 50, fertility: 50, plantType: null, growthStage: 0, stageStartTime: 0 }
            ],
            
            // ç‚‰ç¶ï¼ˆ2ä¸ªï¼‰
            stoves: [
                { id: 0, state: 'idle', recipe: null, startTime: 0, duration: 8000 }, // 8ç§’åˆ¶èŒ¶
                { id: 1, state: 'idle', recipe: null, startTime: 0, duration: 8000 }  // 8ç§’åˆ¶èŒ¶
            ],
            
            // æ¡ˆæ¿åŠ å·¥å°ï¼ˆ2ä¸ªï¼‰
            processingBoards: [
                { id: 0, state: 'idle', recipe: null, startTime: 0, duration: 0 },
                { id: 1, state: 'idle', recipe: null, startTime: 0, duration: 0 }
            ],
            
            // åº“å­˜ç³»ç»Ÿ
            seeds: {}, // ç§å­åº“å­˜
            inventory: {}, // æ”¶è·ææ–™åº“å­˜
            toppings: {}, // å°æ–™åº“å­˜
            madeTeas: [], // åˆ¶ä½œå¥½çš„èŒ¶é¥®
            
            // èŒ¶é¥®é…æ–¹
            teaRecipes: {
                'äº”å‘³å­é¥®': ['äº”å‘³å­'],
                'æŸ æª¬èŒ¶': ['æŸ æª¬'],
                'æ´›ç¥ç«ç‘°é¥®': ['æ´›ç¥èŠ±', 'ç«ç‘°èŠ±', 'å±±æ¥‚'],
                'æ¡‚åœ†çº¢æ£èŒ¶': ['æ¡‚åœ†', 'çº¢æ£', 'æ¸æ'],
                'ç„¦é¦™å¤§éº¦èŒ¶': ['å¤§éº¦'],
                'ä¸‰èŠ±å†³æ˜èŒ¶': ['èŠèŠ±', 'é‡‘é“¶èŠ±', 'å†³æ˜å­', 'æ¸æ'],
                'è–„è·ç”˜è‰å‡‰èŒ¶': ['è–„è·', 'ç”˜è‰'],
                'é™ˆçš®å§œç±³èŒ¶': ['é™ˆçš®', 'ç”Ÿå§œ'],
                'å†¬ç“œè·å¶é¥®': ['å†¬ç“œ', 'è·å¶', 'è–ç±³'],
                'å¤æ³•é…¸æ¢…æ±¤': ['ä¹Œæ¢…', 'å±±æ¥‚', 'é™ˆçš®', 'ç”˜è‰', 'æ¡‚èŠ±'],
                'å°åŠæ¢¨æ±¤': ['é›ªèŠ±æ¢¨', 'é“¶è€³', 'è¯æ¢…', 'æ¸æ'],
                'ç™½æ°´ç…®é±¼': ['å°é±¼å¹²'] // çŒ«å’ªä¸“ç”¨é…æ–¹
            },
            
            // åŠ å·¥é…æ–¹
            processingRecipes: {
                // èŒ¶é¥®å°æ–™åŠ å·¥
                'çº¢ç³–': { ingredients: ['ç”˜è”—'], time: 10000, output: 3 },
                'è–„è·å¶': { ingredients: ['è–„è·'], time: 10000, output: 3 },
                'å§œä¸': { ingredients: ['ç”Ÿå§œ'], time: 10000, output: 3 },
                'æŸšå­ä¸': { ingredients: ['æŸšå­'], time: 10000, output: 3 },
                'é“¶è€³ä¸': { ingredients: ['é“¶è€³'], time: 15000, output: 3 },
                'æŸ æª¬ç‰‡': { ingredients: ['æŸ æª¬'], time: 10000, output: 3 },
                'æ°´èœœæ¡ƒæœè‚‰': { ingredients: ['æ°´èœœæ¡ƒ'], time: 12000, output: 3 },
                'é»„èŠªç‰‡': { ingredients: ['é»„èŠª'], time: 12000, output: 3 },
                'å¹²æ¡‚èŠ±': { ingredients: ['æ¡‚èŠ±'], time: 10000, output: 3 },
                'å°åœ†å­': { ingredients: ['ç³¯ç±³'], time: 15000, output: 3 },
                'é…’é…¿': { ingredients: ['ç±³'], time: 18000, output: 3 },

                // åŠ¨ç‰©åˆ†è§£é…æ–¹
                'å…”å­åˆ†è§£': {
                    ingredients: ['å…”å­'],
                    time: 30000,
                    outputs: [
                        { name: 'å…”è‚‰', quantity: 1 },
                        { name: 'å…”æ¯›', quantity: 2 },
                        { name: 'å…”çš®', quantity: 1 }
                    ],
                    description: "å°†å…”å­åˆ†è§£æˆè‚‰ã€æ¯›ã€çš®"
                },
                'é¸¡åˆ†è§£': {
                    ingredients: ['é¸¡'],
                    time: 35000,
                    outputs: [
                        { name: 'é¸¡è‚‰', quantity: 2 },
                        { name: 'é¸¡æ¯›', quantity: 3 },
                        { name: 'é¸¡çš®', quantity: 1 }
                    ],
                    description: "å°†é¸¡åˆ†è§£æˆè‚‰ã€æ¯›ã€çš®"
                },
                'å±±ç¾Šåˆ†è§£': {
                    ingredients: ['å±±ç¾Š'],
                    time: 60000,
                    outputs: [
                        { name: 'å±±ç¾Šè‚‰', quantity: 8 },
                        { name: 'å±±ç¾Šæ¯›', quantity: 5 },
                        { name: 'å±±ç¾Šçš®', quantity: 2 }
                    ],
                    description: "å°†å±±ç¾Šåˆ†è§£æˆè‚‰ã€æ¯›ã€çš®"
                },
                'é‡çŒªåˆ†è§£': {
                    ingredients: ['é‡çŒª'],
                    time: 90000,
                    outputs: [
                        { name: 'é‡çŒªè‚‰', quantity: 20 },
                        { name: 'é‡çŒªæ¯›', quantity: 8 },
                        { name: 'é‡çŒªçš®', quantity: 3 }
                    ],
                    description: "å°†é‡çŒªåˆ†è§£æˆè‚‰ã€æ¯›ã€çš®"
                }
            },

            // é¡¾å®¢å’Œè®¿å®¢ç®¡ç†
            customer: {
                active: false,
                name: "ç­‰å¾…é¡¾å®¢åˆ°æ¥",
                isVIP: false,
                teaChoice: null,
                toppingChoices: [],
                arrivalTime: 0,
                patience: 120000, // æ™®é€šé¡¾å®¢120ç§’
                maxPatience: 120000,
                served: false
            },
            customerSpawnCooldown: 10000, // 10ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦ç”Ÿæˆæ–°é¡¾å®¢ï¼ˆä¾¿äºæµ‹è¯•ï¼‰
            lastCustomerTime: 0,
            customerNames: ['æ± æƒŠæš®', 'å‡Œå°è·¯', 'æ±Ÿé£é£', 'æ±Ÿä¸‰', 'æ±Ÿå››', 'æ± äº‘æ——', 'æ±Ÿæ½®', 'æ±Ÿæ••å°', 'èŠ±èŠ±', 'å§¬åˆ«æƒ…', 'æ± ä¹ä¿¡', 'ç‹¸æ€’'],
            customerVisits: {},
            servedCustomers: 0,

            // çŒ«å’ªç³»ç»Ÿ
            cats: {
                lastCatTime: Date.now(),
                catCooldown: 259200000,   // 3å¤©å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                currentCat: null,
                todayVisited: false,
                lastCatDay: 0,
                intimacy: {
                    'å¤§æ©˜çŒ«': 0,
                    'ç‹¸èŠ±çŒ«': 0,
                    'é»‘çŒ«å°æ‰‹å¥—': 0,
                    'å°ç™½çŒ«': 0,
                    'å¤§çŒ«çŒ«': 0
                },
                feedCount: {
                    'å¤§æ©˜çŒ«': 0,
                    'ç‹¸èŠ±çŒ«': 0,
                    'é»‘çŒ«å°æ‰‹å¥—': 0,
                    'å°ç™½çŒ«': 0,
                    'å¤§çŒ«çŒ«': 0
                },
                lastSeen: {},
                gifts: []
            },

            // é…æ–¹è§£é”è§„åˆ™
            recipeUnlockRules: {
                "æ´›ç¥ç«ç‘°é¥®": { customer: "å‡Œå°è·¯", visitsRequired: 1, chance: 1.0, guaranteedOnVisit: 1 },
                "æ¡‚åœ†çº¢æ£èŒ¶": { customer: "èŠ±èŠ±", visitsRequired: 1, chance: 1.0, guaranteedOnVisit: 1 },
                "ç„¦é¦™å¤§éº¦èŒ¶": { customer: "æ±Ÿé£é£", visitsRequired: 2, chance: 1.0, guaranteedOnVisit: 2 },
                "ä¸‰èŠ±å†³æ˜èŒ¶": { customer: "æ±Ÿä¸‰", visitsRequired: 2, chance: 1.0, guaranteedOnVisit: 2 },
                "è–„è·ç”˜è‰å‡‰èŒ¶": { customer: "æ±Ÿå››", visitsRequired: 2, chance: 1.0, guaranteedOnVisit: 2 },
                "é™ˆçš®å§œç±³èŒ¶": { customer: "æ± äº‘æ——", visitsRequired: 2, chance: 0.5, guaranteedOnVisit: 3 },
                "å†¬ç“œè·å¶é¥®": { customer: "æ±Ÿæ½®", visitsRequired: 3, chance: 0.6, guaranteedOnVisit: 4 },
                "å¤æ³•é…¸æ¢…æ±¤": { customer: "æ± æƒŠæš®", visitsRequired: 2, chance: 0.3, guaranteedOnVisit: 3 },
                "å°åŠæ¢¨æ±¤": { customer: "æ±Ÿæ••å°", visitsRequired: 3, chance: 0.4, guaranteedOnVisit: 5 },
                // ç¥ç§˜é¡¾å®¢é…æ–¹
                "é«˜çº§èŒ¶é¥®": { customer: "å§¬åˆ«æƒ…", visitsRequired: 3, chance: 0.8, guaranteedOnVisit: 4 },
                "ç‰¹åˆ¶èŒ¶é¥®": { customer: "æ± ä¹ä¿¡", visitsRequired: 2, chance: 0.7, guaranteedOnVisit: 3 },
                "åŠ¨ç‰©èŒ¶é¥®": { customer: "ç‹¸æ€’", visitsRequired: 1, chance: 1.0, guaranteedOnVisit: 1 },
            },

            // é¡¾å®¢æ•…äº‹ç³»ç»Ÿ
            customerStories: {
                "å‡Œå°è·¯": {
                    title: "ã€Šæœ±ç ‚ã€‹",
                    content: "å‡Œå°è·¯è¢–ä¸­è—ç€ä¸€ç›æ¸©çƒ­çš„æ´›ç¥ç«ç‘°é¥®ã€‚'ç–è‚è§£éƒçš„ï¼Œå¥½å¥½å­¦å­¦ï¼Œé£é£æ¥äº†å°±åšç»™ä»–ã€‚è·Ÿä»–è¯´å°±è¯´å…»é¢œçš„èŒ¶æ–¹å­'æŒ‘çœ‰ç¬‘æ—¶ï¼Œçœ¼åº•å´æ˜ ç€åˆ€å…‰ï¼Œè¢è§’è¿˜æ²¾ç€è¡€ã€‚",
                    effect: "ç–è‚è§£éƒï¼Œç¾ç™½å…»é¢œï¼Œæ´»è¡€è°ƒç»ï¼Œé€‚åˆå¥³å­æ—¥å¸¸é¥®ç”¨ã€‚",
                    character: "ç¥ç§˜çš„å¥³åˆºå®¢ï¼Œå¤–è¡¨æ¸©å’Œå†…å¿ƒå±é™©ï¼Œå¯¹æ±Ÿé£é£æœ‰ç‰¹æ®Šæ„Ÿæƒ…"
                },
                "èŠ±èŠ±": {
                    title: "ã€Šæ— å½’ã€‹",
                    content: "èŠ±èŠ±å»å‡Œé›ªåŸå‰æ‰«å¢“ï¼Œæ‰‹é‡Œæ‹¿ç€ä»–æœ€å–œæ¬¢å¥¹ç»™ä»–åšçš„èŒ¶ã€‚åªæ˜¯è¿™ä¸€æ¬¡åªèƒ½è‡ªå·±åšäº†ã€‚'è‡ªå·±ç»™è‡ªå·±ä½œèŒ¶æ€ä¹ˆè¡Œï¼Œè¿™æ–¹å­ç»™ä½ ä»¬ï¼Œä»¥åæˆ‘å°±æ¥è¿™é‡Œå–å§'",
                    effect: "è¡¥è¡€ç›Šæ°”ï¼Œå®‰ç¥å…»å¿ƒï¼Œæ»‹é˜´æ¶¦ç‡¥ï¼Œé€‚åˆä½“å¼±æˆ–ç†¬å¤œè€…é¥®ç”¨ã€‚",
                    character: "æ¸©æŸ”çš„å¥³å­ï¼Œå¤±å»äº†çˆ±äººå‡Œé›ªï¼Œç‹¬è‡ªæ‰¿å—ç—›è‹¦"
                },
                "æ±Ÿé£é£": {
                    title: "ã€Šé›ªå¤œã€‹",
                    content: "é•¿å®‰å†¬å¤œï¼Œæ±Ÿé£é£èœ·åœ¨å‡Œé›ªé˜çš„å±‹æªä¸Šï¼ŒæŒ‡å°–å†»å¾—å‘åƒµã€‚æ±Ÿä¸‰ç¿»ä¸Šå±‹é¡¶ï¼Œæ‰”æ¥ä¸€å£¶æ»šçƒ«çš„å¤§éº¦èŒ¶ï¼š'æ€‚æ ·ï¼Œå–ä¸¤å£ã€‚'èŒ¶é›¾æ°¤æ°²é‡Œï¼Œä»–å¿½ç„¶æƒ³èµ·å¹¼æ—¶ç¬¬ä¸€æ¬¡æ¡åˆ€ï¼Œä¹Ÿæ˜¯è¿™ç„¦è‹¦çš„ç”œé¦™å‹ä½äº†é¢¤æŠ–ã€‚",
                    effect: "æš–èƒƒæ¶ˆé£Ÿï¼Œç¼“è§£ç„¦è™‘ï¼Œå®‰å®šå¿ƒç¥ï¼Œé€‚åˆç§‹å†¬é¥®ç”¨ã€‚",
                    character: "å¹´è½»çš„åˆºå®¢ï¼Œå®¹æ˜“ç´§å¼ ï¼Œå’Œæ±Ÿä¸‰æœ‰å…„å¼Ÿæƒ…ä¹‰"
                },
                "æ±Ÿä¸‰": {
                    title: "ã€Šå¤œç‹©ã€‹",
                    content: "æ±Ÿå››æ‰§åˆ€å½’æ¥ï¼Œè§æ±Ÿä¸‰ä¼æ¡ˆçŒç¡ï¼Œæ‰‹è¾¹ä¸€ç›å‡‰é€çš„ä¸‰èŠ±å†³æ˜èŒ¶ã€‚ä»–è½»å¹ï¼Œå°†å¤–è¢æŠ«ä¸Šå…„é•¿è‚©å¤´â€”â€”å´ä¸çŸ¥æ˜¨å¤œè‡ªå·±ä»»åŠ¡å•ä¸Šé‚£ä¸‰ä¸ªåå­—ï¼Œæ—©å·²è¢«æ±Ÿä¸‰çš„è¡€åˆƒåˆ’å»ã€‚èŒ¶æ¸£æ²‰åº•ï¼Œå¦‚æœªæ„ˆçš„æ—§ä¼¤ã€‚",
                    effect: "æ¸…è‚æ˜ç›®ï¼Œæ¸…çƒ­è§£æ¯’ï¼Œç¼“è§£çœ¼ç–²åŠ³ï¼Œé€‚åˆé•¿æœŸä¼æ¡ˆæˆ–å¤œè§†è€…é¥®ç”¨ã€‚",
                    character: "æ±Ÿå››çš„å…„é•¿ï¼Œé»˜é»˜ä¿æŠ¤å¼Ÿå¼Ÿï¼Œæ‰¿æ‹…æ›´å¤šå±é™©ä»»åŠ¡"
                },
                "æ±Ÿå››": {
                    title: "ã€Šä¸‰å“¥ã€‹",
                    content: "æ±Ÿå››ç»™æ±Ÿä¸‰æ³¡çš„èŒ¶ï¼Œæ¸…æ¸…å‡‰å‡‰çš„ï¼Œä»–é‚£ä¹ˆçˆ±å‡ºæ±—ï¼Œè‚¯å®šå–œæ¬¢ã€‚èŒ¶å¶åˆšæ”¾ä¸‹ï¼Œå°±å¬åˆ°ä¸‰å“¥åœ¨é™¢å­é‡Œè®­ç»ƒçš„åˆ€å£°ï¼Œä»–æ‚„æ‚„æ¢å¤´çœ‹äº†ä¸€çœ¼ï¼Œå†³å®šåŠ å¤šä¸€ç‰‡è–„è·å¶ã€‚",
                    effect: "æ¸…çƒ­è§£æš‘ï¼Œæ¶¦å–‰æ­¢å’³ï¼Œæç¥é†’è„‘ï¼Œé€‚åˆå¤å­£é¥®ç”¨ã€‚",
                    character: "æ±Ÿä¸‰çš„å¼Ÿå¼Ÿï¼Œç»†å¿ƒä½“è´´ï¼Œå…³å¿ƒå…„é•¿çš„èº«ä½“"
                },
                "æ± äº‘æ——": {
                    title: "ã€Šå¸ˆå¾’ã€‹",
                    content: "æ± äº‘æ——å¿ƒç–¼é‚£å°å®¶ä¼™ï¼Œä»¥å‰ä¹Ÿä¸æ‡‚è‡ªå·±ç…§é¡¾è‡ªå·±ï¼Œè¿™èŒ¶æ˜¯å¥¹ä¸“é—¨ç»™ä»–æ‰¾åŒ»å¸ˆæŠ„çš„æ–¹å­ã€‚'åˆ«æ€»åƒé‚£äº›ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼Œèƒƒç–¼äº†å¯åˆ«æ¥æ‰¾å¸ˆçˆ¶'è™½ç„¶å˜´ä¸Šè¿™ä¹ˆè¯´ï¼Œå¥¹è¿˜æ˜¯æ‚„æ‚„åœ¨èŒ¶é‡Œå¤šåŠ äº†ä¸€ç‰‡é™ˆçš®ã€‚",
                    effect: "å¥è„¾å’Œèƒƒï¼Œç†æ°”åŒ–ç—°ï¼Œæ¸©ä¸­æ•£å¯’ï¼Œé€‚åˆæ¶ˆåŒ–ä¸è‰¯æˆ–èƒƒå¯’è€…é¥®ç”¨ã€‚",
                    character: "æ±Ÿæ½®çš„å¸ˆçˆ¶ï¼Œè¡¨é¢ä¸¥å‰å†…å¿ƒæ…ˆç¥¥ï¼Œå…³å¿ƒå¾’å¼Ÿçš„å¥åº·"
                },
                "æ±Ÿæ½®": {
                    title: "ã€Šå¸ˆå¾’2ã€‹",
                    content: "æ±Ÿæ½®ç»™å¸ˆçˆ¶å¼„çš„æ¶ˆæš‘èŒ¶ï¼Œè·å¶æ˜¯è‡ªå·±è¶´åœ¨æ± å¡˜è¾¹é‡‡çš„ï¼Œå†¬ç“œä¹Ÿæ˜¯è‡ªå·±ç§çš„ã€‚'å¸ˆçˆ¶ï¼Œæ‚¨å°å°ï¼Œæˆ‘æŒ‰ç…§æ‚¨è¯´çš„æ–¹æ³•åšçš„'ä»–å°å¿ƒç¿¼ç¿¼åœ°ç«¯ç€èŒ¶ï¼Œç”Ÿæ€•å¸ˆçˆ¶ä¸å–œæ¬¢ï¼Œå´ä¸çŸ¥é“æ± äº‘æ——æ—©å·²æ¬£æ…°åœ°ç¬‘äº†ã€‚",
                    effect: "æ¸…çƒ­åˆ©æ¹¿ï¼Œæ¶ˆè‚¿å‡è„‚ï¼Œç¾å®¹å…»é¢œï¼Œé€‚åˆå¤å­£æ¶ˆæš‘æˆ–å‡è‚¥è€…é¥®ç”¨ã€‚",
                    character: "æ± äº‘æ——çš„å¾’å¼Ÿï¼ŒåŠªåŠ›ä¸Šè¿›ï¼Œå­é¡ºå¸ˆçˆ¶"
                },
                "æ± æƒŠæš®": {
                    title: "ã€Šæ¢…é¦™ã€‹",
                    content: "é•¿å®‰æš‘å¤œï¼Œæ± æƒŠæš®æ‰§å‰‘ä¼äºå±‹è„Šã€‚ç›®æ ‡å‡ºç°æ—¶ï¼Œå¥¹æ­£é¥®å°½æœ€åä¸€æ»´é…¸æ¢…æ±¤ã€‚ç“·ç¢—å åœ°ç¢å“æ··ç€å–‰éª¨æ–­è£‚å£°ï¼Œæ¢…å¦ƒæ•™çš„å°æ–¹å­â€”â€”æ€äººæ—¶å”‡é½¿é—´è¯¥ç•™ç€ç”œå‘³ï¼Œæ‰ä¸è‹¦ã€‚",
                    effect: "ç”Ÿæ´¥æ­¢æ¸´ï¼Œæ¶ˆæš‘è§£è…»ï¼Œå¥è„¾å¼€èƒƒï¼Œç¼“è§£ç‡¥çƒ­ï¼Œå”ä»£å·²æ˜¯å®«å»·æ¶ˆæš‘ä½³é¥®ã€‚",
                    character: "å†·è¡€æ€æ‰‹ï¼Œå‡ºèº«å®«å»·ï¼Œæœ‰ç€ä¼˜é›…çš„æ€æˆ®ç¾å­¦"
                },
                "æ±Ÿæ••å°": {
                    title: "ã€Šç´å¿ƒã€‹",
                    content: "æ±Ÿæ••å°æŠšç´æ—¶æ€»çˆ±åœ¨èº«è¾¹æ”¾ä¸€ç›å°åŠæ¢¨æ±¤ï¼Œç´å£°æ‚ æ‰¬ï¼ŒèŒ¶é¦™è¢…è¢…ã€‚ä»–è¯´ç´å¦‚äººç”Ÿï¼Œéœ€è¦æ…¢æ…¢è°ƒæ•™ï¼›èŒ¶å¦‚å¿ƒå¢ƒï¼Œéœ€è¦ç»†ç»†å“å‘³ã€‚ä¸€æ›²ç»ˆäº†ï¼Œä¸€ç›èŒ¶å°½ï¼Œéƒ½æ˜¯è¿™ä¸–é—´æœ€æ¸©æŸ”çš„æ—¶å…‰ã€‚",
                    effect: "æ¶¦è‚ºæ­¢å’³ï¼Œæ¸…çƒ­é™ç«ï¼Œæ»‹é˜´ç¾å®¹ï¼Œå®«å»·ä¼ ç»Ÿæ»‹è¡¥ä½³å“ã€‚",
                    character: "æ–‡é›…çš„ç´å¸ˆï¼Œçƒ­çˆ±éŸ³ä¹ï¼Œè¿½æ±‚ç²¾ç¥å¢ƒç•Œ"
                },
                // ç¥ç§˜é¡¾å®¢æ²¡æœ‰è¯¦ç»†æ•…äº‹ï¼Œåªæœ‰åŸºæœ¬äººç‰©ç‰¹å¾
                // æ ¹æ®README.mdè®¾å®šï¼Œç¥ç§˜é¡¾å®¢ä¿æŒç¥ç§˜æ„Ÿï¼Œä¸å±•ç¤ºå®Œæ•´æ•…äº‹
            },

            // äººæ•°è§£é”é…æ–¹ç³»ç»Ÿ
            customerCountUnlockRules: {
                "æ¡‘èŠæ¶¦ç‡¥èŒ¶": { customersRequired: 30, ingredients: ['æ¡‘å¶', 'æ­ç™½èŠ'] },
                "æ¡‚èŠ±é…’é…¿é¥®": { customersRequired: 60, ingredients: ['æ¡‚èŠ±', 'é…’é…¿'] },
                "èœœæ¡ƒä¹Œé¾™å†·èƒ": { customersRequired: 90, ingredients: ['æ°´èœœæ¡ƒ', 'ä¹Œé¾™èŒ¶åŒ…'] },
                "é»„èŠªæ¸æèŒ¶": { customersRequired: 120, ingredients: ['é»„èŠª', 'æ¸æ'] },
                "ç«¹è”—èŒ…æ ¹é©¬è¹„æ°´": { customersRequired: 150, ingredients: ['ç”˜è”—', 'ç™½èŒ…æ ¹', 'é©¬è¹„'] }
            },

            // çƒ¤è‚‰æ¶ç³»ç»Ÿ
            grillSystem: {
                unlocked: false,
                isGrilling: false,
                grillStartTime: 0,
                grillDuration: 0,
                currentRecipe: null,
                currentProduct: null,
                recipes: {
                    "çƒ¤å…”è‚‰": {
                        ingredients: ['å…”è‚‰'],
                        cookTime: 30000,
                        price: 25,
                        description: "é¦™å«©çš„çƒ¤å…”è‚‰"
                    },
                    "çƒ¤é¸¡è‚‰": {
                        ingredients: ['é¸¡è‚‰'],
                        cookTime: 35000,
                        price: 30,
                        description: "ç¾å‘³çš„çƒ¤é¸¡è‚‰"
                    },
                    "çƒ¤å±±ç¾Šè‚‰": {
                        ingredients: ['å±±ç¾Šè‚‰'],
                        cookTime: 45000,
                        price: 50,
                        description: "é²œç¾çš„çƒ¤å±±ç¾Šè‚‰"
                    },
                    "çƒ¤é‡çŒªè‚‰": {
                        ingredients: ['é‡çŒªè‚‰'],
                        cookTime: 60000,
                        price: 80,
                        description: "æµ“éƒçš„çƒ¤é‡çŒªè‚‰"
                    }
                },
                sellOptions: {
                    "ç›´æ¥å”®å–": {
                        description: "ç«‹å³è·å¾—é‡‘å¸",
                        priceMultiplier: 1.0
                    },
                    "æœåŠ¡é¡¾å®¢": {
                        description: "ç­‰å¾…é¡¾å®¢ç‚¹é¤",
                        priceMultiplier: 1.2
                    }
                }
            },

            // æ‰“çŒç³»ç»Ÿ
            huntingSystem: {
                // åå±±æ‰“çŒ
                backMountain: {
                    unlocked: false,
                    huntCount: 0,
                    isHunting: false,
                    huntStartTime: 0,
                    huntDuration: 15000, // 15ç§’
                    huntResults: {
                        // åŸºç¡€çŒç‰© (0-49æ¬¡)
                        basic: [
                            { name: 'å…”å­', chance: 0.25, firstTimeRecipe: null },
                            { name: 'æµ†æœ', chance: 0.2, firstTimeRecipe: 'æµ†æœæ±' },
                            { name: 'å°é±¼å¹²', chance: 0.2, firstTimeRecipe: null },
                            { name: 'é¸¡', chance: 0.2, firstTimeRecipe: null },
                            { name: 'ç°ªå­', chance: 0.03, firstTimeRecipe: null },
                            { name: 'æ¢³å­', chance: 0.03, firstTimeRecipe: null },
                            { name: 'çŸ³å¤´', chance: 0.05, firstTimeRecipe: null },
                            { name: 'èŠ±æœµ', chance: 0.04, firstTimeRecipe: null },
                            { name: 'é‡‘å¸', chance: 0.06, firstTimeRecipe: null, value: 15 },
                            { name: 'åœ°å›¾', chance: 0.05, firstTimeRecipe: null, special: 'unlock_cave' }
                        ],
                        // é«˜çº§çŒç‰© (50æ¬¡å)
                        advanced: [
                            { name: 'å±±ç¾Š', chance: 0.08, firstTimeRecipe: null },
                            { name: 'é‡çŒª', chance: 0.04, firstTimeRecipe: null },
                            { name: 'é‡è‘±', chance: 0.08, firstTimeRecipe: null },
                            { name: 'å±±å§œ', chance: 0.08, firstTimeRecipe: null },
                            { name: 'é¦™èœ', chance: 0.08, firstTimeRecipe: null }
                        ]
                    }
                },
                // å±±æ´æ‰“çŒ
                cave: {
                    unlocked: false,
                    huntCount: 0,
                    isHunting: false,
                    huntStartTime: 0,
                    huntDuration: 20000, // 20ç§’
                    huntResults: {
                        // åŸºç¡€çŒç‰©
                        basic: [
                            { name: 'å…”å­', chance: 0.25, firstTimeRecipe: null },
                            { name: 'æµ†æœ', chance: 0.18, firstTimeRecipe: null },
                            { name: 'å°é±¼å¹²', chance: 0.18, firstTimeRecipe: null },
                            { name: 'é¸¡', chance: 0.2, firstTimeRecipe: null },
                            { name: 'é“¶è€³', chance: 0.15, firstTimeRecipe: null }, // å±±æ´ç‰¹æœ‰
                            { name: 'ç°ªå­', chance: 0.04, firstTimeRecipe: null },
                            { name: 'æ¢³å­', chance: 0.04, firstTimeRecipe: null },
                            { name: 'çŸ³å¤´', chance: 0.06, firstTimeRecipe: null },
                            { name: 'èŠ±æœµ', chance: 0.03, firstTimeRecipe: null },
                            { name: 'é‡‘å¸', chance: 0.08, firstTimeRecipe: null, value: 20 }
                        ],
                        // é«˜çº§çŒç‰© (50æ¬¡å)
                        advanced: [
                            { name: 'å±±ç¾Š', chance: 0.08, firstTimeRecipe: null },
                            { name: 'é‡çŒª', chance: 0.04, firstTimeRecipe: null },
                            { name: 'é‡è‘±', chance: 0.08, firstTimeRecipe: null },
                            { name: 'å±±å§œ', chance: 0.08, firstTimeRecipe: null },
                            { name: 'é¦™èœ', chance: 0.08, firstTimeRecipe: null }
                        ]
                    }
                }
            }
        };

        // å°æ–™å•†åº—é…ç½®
        const toppingsShop = {
            "å†°ç³–": { price: 3, description: "åˆ¶ä½œç”œèŒ¶çš„å¥½é€‰æ‹©" },
            "èœ‚èœœ": { price: 5, description: "å¤©ç„¶ç”œå‘³å‰‚ï¼Œè¥å…»ä¸°å¯Œ" },
            "ä¹Œé¾™èŒ¶åŒ…": { price: 8, description: "é«˜çº§èŒ¶åŒ…ï¼Œæå‡èŒ¶é¥®å“è´¨" },
            "å°é±¼å¹²": { price: 6, description: "çŒ«å’ªæœ€çˆ±çš„é›¶é£Ÿ" },
            "çŒ«è–„è·": { price: 10, description: "çŒ«å’ªçš„ç¥å¥‡è‰è¯" },
            "å¹²æ¡‚èŠ±": { price: 4, description: "å¢åŠ èŠ±é¦™çš„å°æ–™" },
            "å°åœ†å­": { price: 3, description: "Qå¼¹è½¯ç³¯çš„å°é…èœ" },
            "é…’é…¿": { price: 6, description: "ä¼ ç»Ÿå‘é…µå°æ–™" },
            "è¯æ¢…": { price: 4, description: "é…¸ç”œè§£è…»çš„æœè„¯" },
            "é™ˆçš®ä¸": { price: 5, description: "ç†æ°”åŒ–ç—°çš„ä¸­è¯æ" },
            "æ¡‚åœ†è‚‰": { price: 7, description: "è¡¥è¡€å®‰ç¥çš„æ»‹è¡¥å“" },
            "è²å­": { price: 6, description: "æ¸…å¿ƒå®‰ç¥çš„å¤©ç„¶é£Ÿæ" }
        };

        // åŠ¨ç‰©å‰¯äº§å“å”®å–é…ç½®
        const animalByproducts = {
            "å…”æ¯›": { price: 5, description: "æŸ”è½¯çš„å…”æ¯›ï¼Œå¯ä»¥å”®å–" },
            "å…”çš®": { price: 8, description: "ä¼˜è´¨å…”çš®ï¼Œå¯ä»¥å”®å–" },
            "é¸¡æ¯›": { price: 3, description: "è½»ç›ˆçš„é¸¡æ¯›ï¼Œå¯ä»¥å”®å–" },
            "é¸¡çš®": { price: 6, description: "é¸¡çš®ï¼Œå¯ä»¥å”®å–" },
            "å±±ç¾Šæ¯›": { price: 12, description: "æ¸©æš–çš„å±±ç¾Šæ¯›ï¼Œå¯ä»¥å”®å–" },
            "å±±ç¾Šçš®": { price: 25, description: "åšå®çš„å±±ç¾Šçš®ï¼Œå¯ä»¥å”®å–" },
            "é‡çŒªæ¯›": { price: 8, description: "ç²—ç³™çš„é‡çŒªæ¯›ï¼Œå¯ä»¥å”®å–" },
            "é‡çŒªçš®": { price: 40, description: "åšéŸ§çš„é‡çŒªçš®ï¼Œå¯ä»¥å”®å–" }
        };

        // äº‘ç«¯å­˜å‚¨é…ç½®
        const cloudSaveConfig = {
            githubToken: localStorage.getItem('githubToken') || '',
            gistId: localStorage.getItem('gistId') || '',
            autoSyncInterval: 5 * 60 * 1000, // 5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥
            lastSyncTime: 0,
            isOnline: navigator.onLine,
            syncInProgress: false
        };

        // ç§å­ä¿¡æ¯é…ç½® - ç¼©çŸ­ç”Ÿé•¿æ—¶é—´ä»¥ä¾¿å¿«é€Ÿä½“éªŒæ¸¸æˆ
        const seedsInfo = {
            "äº”å‘³å­": { price: 1, growTime: 10000 }, "ä¹Œæ¢…": { price: 1, growTime: 10000 },
            "å±±æ¥‚": { price: 1, growTime: 10000 }, "é™ˆçš®": { price: 1, growTime: 10000 },
            "ç”˜è‰": { price: 1, growTime: 10000 }, "æ¡‚èŠ±": { price: 1, growTime: 10000 },
            "å¤§éº¦": { price: 1, growTime: 10000 }, "èŠèŠ±": { price: 1, growTime: 10000 },
            "é‡‘é“¶èŠ±": { price: 1, growTime: 10000 }, "å†³æ˜å­": { price: 1, growTime: 10000 },
            "æ¸æ": { price: 1, growTime: 10000 }, "ç”Ÿå§œ": { price: 1, growTime: 10000 },
            "æ¡‚åœ†": { price: 1, growTime: 10000 }, "çº¢æ£": { price: 1, growTime: 10000 },
            "è–„è·": { price: 1, growTime: 10000 }, "ç«ç‘°èŠ±": { price: 1, growTime: 10000 },
            "æ´›ç¥èŠ±": { price: 1, growTime: 10000 }, "å†¬ç“œ": { price: 1, growTime: 10000 },
            "è·å¶": { price: 1, growTime: 10000 }, "è–ç±³": { price: 1, growTime: 10000 },
            "é›ªèŠ±æ¢¨": { price: 1, growTime: 10000 }, "è¯æ¢…": { price: 1, growTime: 10000 },
            "ç”˜è”—": { price: 1, growTime: 10000 }, "æŸšå­": { price: 1, growTime: 10000 },
            "æŸ æª¬": { price: 1, growTime: 10000 }, "é“¶è€³": { price: 1, growTime: 10000 },
            "æ¡‘å¶": { price: 2, growTime: 15000 }, "æ­ç™½èŠ": { price: 2, growTime: 15000 },
            "æ°´èœœæ¡ƒ": { price: 3, growTime: 20000 }, "é»„èŠª": { price: 3, growTime: 20000 },
            "ç™½èŒ…æ ¹": { price: 2, growTime: 15000 }, "é©¬è¹„": { price: 2, growTime: 15000 },
            "ç³¯ç±³": { price: 2, growTime: 15000 }, "ç±³": { price: 1, growTime: 15000 }
        };

        // åˆå§‹åŒ–æ•°æ®
        function initializeData() {
            // åˆå§‹åŒ–ç§å­å’Œææ–™åº“å­˜ - æä¾›æ›´å¤šåˆå§‹ææ–™ä»¥ä¾¿å¿«é€Ÿå¼€å§‹æ¸¸æˆ
            Object.keys(seedsInfo).forEach(material => {
                gameData.seeds[material] = material === "äº”å‘³å­" || material === "æŸ æª¬" ? 3 : 0;
                // ç»™äºˆä¸€äº›åˆå§‹ææ–™ï¼Œç‰¹åˆ«æ˜¯åŸºç¡€é…æ–¹ææ–™
                if (material === "äº”å‘³å­" || material === "æŸ æª¬") {
                    gameData.inventory[material] = 5;
                } else {
                    gameData.inventory[material] = gameData.inventory[material] || 0;
                }
            });

            // åˆå§‹åŒ–å°æ–™åº“å­˜ - åŒ…å«åŸºç¡€å°æ–™å’Œå•†åº—å¯è´­ä¹°çš„å°æ–™
            gameData.toppings = {
                "çº¢ç³–": 5, "è–„è·å¶": 5, "å§œä¸": 5, "æŸšå­ä¸": 5,
                "é“¶è€³ä¸": 5, "æŸ æª¬ç‰‡": 5, "èœ‚èœœ": 3,
                "å†°ç³–": 0, "ä¹Œé¾™èŒ¶åŒ…": 0, "å¹²æ¡‚èŠ±": 0,
                "å°åœ†å­": 0, "é…’é…¿": 0, "æ°´èœœæ¡ƒæœè‚‰": 0, "é»„èŠªç‰‡": 0,
                // å•†åº—å¯è´­ä¹°çš„å°æ–™ - åˆå§‹åŒ–ä¸º0
                "å°é±¼å¹²": 0, "çŒ«è–„è·": 0, "è¯æ¢…": 0, "é™ˆçš®ä¸": 0,
                "æ¡‚åœ†è‚‰": 0, "è²å­": 0
            };

            // ç¡®ä¿å¤©æ°”æ•°æ®åŒæ­¥
            gameData.currentWeather = weathers[gameData.weather] || "æ™´å¤©";
            gameData.currentSeason = seasons[gameData.season] || "æ˜¥å¤©";

            // åˆå§‹åŒ–é¡¾å®¢è®¿é—®è®°å½•
            if (!gameData.customerVisits) {
                gameData.customerVisits = {};
                gameData.customerNames.forEach(name => {
                    gameData.customerVisits[name] = 0;
                });
            }

            // åŒæ­¥customerVisitså’Œcustomers.visitsæ•°æ®
            if (gameData.customers && gameData.customerVisits) {
                Object.keys(gameData.customers).forEach(name => {
                    if (gameData.customerVisits[name] !== undefined) {
                        gameData.customers[name].visits = gameData.customerVisits[name];
                    } else {
                        gameData.customerVisits[name] = gameData.customers[name].visits || 0;
                    }
                });
            }

            // åˆå§‹åŒ–é¡¾å®¢ç³»ç»Ÿæ•°æ® - ä¿ç•™å·²æœ‰çš„è®¿é—®æ¬¡æ•°
            if (!gameData.customers) {
                gameData.customers = {};
            }

            // å®šä¹‰é»˜è®¤é¡¾å®¢æ•°æ®
            const defaultCustomers = {
                'æ± æƒŠæš®': { avatar: 'ğŸ§™â€â™‚ï¸', visits: 0, requiredVisits: 2, unlockedRecipe: 'å¤æ³•é…¸æ¢…æ±¤' },
                'å‡Œå°è·¯': { avatar: 'ğŸ‘©â€ğŸ“', visits: 0, requiredVisits: 1, unlockedRecipe: 'æ´›ç¥ç«ç‘°é¥®' },
                'æ±Ÿé£é£': { avatar: 'ğŸ‘¨â€ğŸ’¼', visits: 0, requiredVisits: 2, unlockedRecipe: 'ç„¦é¦™å¤§éº¦èŒ¶' },
                'æ±Ÿä¸‰': { avatar: 'ğŸ‘¨â€ğŸ”§', visits: 0, requiredVisits: 2, unlockedRecipe: 'ä¸‰èŠ±å†³æ˜èŒ¶' },
                'æ±Ÿå››': { avatar: 'ğŸ‘©â€ğŸ³', visits: 0, requiredVisits: 2, unlockedRecipe: 'è–„è·ç”˜è‰å‡‰èŒ¶' },
                'æ± äº‘æ——': { avatar: 'ğŸ‘´', visits: 0, requiredVisits: 3, unlockedRecipe: 'é™ˆçš®å§œç±³èŒ¶' },
                'æ±Ÿæ½®': { avatar: 'ğŸ‘¨â€ğŸ¨', visits: 0, requiredVisits: 4, unlockedRecipe: 'å†¬ç“œè·å¶é¥®' },
                'æ±Ÿæ••å°': { avatar: 'ğŸ§“', visits: 0, requiredVisits: 5, unlockedRecipe: 'å°åŠæ¢¨æ±¤' },
                'èŠ±èŠ±': { avatar: 'ğŸ‘§', visits: 0, requiredVisits: 1, unlockedRecipe: 'æ¡‚åœ†çº¢æ£èŒ¶' },
                'å§¬åˆ«æƒ…': { avatar: 'ğŸ‘©â€ğŸ’»', visits: 0, requiredVisits: 6, unlockedFeature: 'çƒ¤è‚‰æ¶' },
                'æ± ä¹ä¿¡': { avatar: 'ğŸ‘¨â€ğŸ«', visits: 0, requiredVisits: 2, unlockedRecipe: 'ç‰¹åˆ¶èŒ¶é¥®' },
                'ç‹¸æ€’': { avatar: 'ğŸ¦', visits: 0, requiredVisits: 1, unlockedRecipe: 'åŠ¨ç‰©èŒ¶é¥®' }
            };

            // åˆå¹¶é»˜è®¤æ•°æ®å’Œå·²æœ‰æ•°æ®ï¼Œä¿ç•™å·²æœ‰çš„è®¿é—®æ¬¡æ•°
            Object.keys(defaultCustomers).forEach(name => {
                if (!gameData.customers[name]) {
                    gameData.customers[name] = { ...defaultCustomers[name] };
                } else {
                    // ä¿ç•™å·²æœ‰çš„visitsï¼Œæ›´æ–°å…¶ä»–å±æ€§
                    const existingVisits = gameData.customers[name].visits || 0;
                    gameData.customers[name] = {
                        ...defaultCustomers[name],
                        visits: existingVisits
                    };
                }
            });

            // åˆå§‹åŒ–çŒ«å’ªç³»ç»Ÿæ•°æ® - ä¿®å¤ç‰ˆæœ¬
            if (!gameData.cats) {
                gameData.cats = {};
            }
            
            // ç¡®ä¿æ¯åªçŒ«å’ªçš„æ•°æ®ç»“æ„å®Œæ•´
            const catList = ['å¤§æ©˜çŒ«', 'ç‹¸èŠ±çŒ«', 'é»‘çŒ«å°æ‰‹å¥—', 'å°ç™½çŒ«', 'å¤§çŒ«çŒ«'];
            const avatars = ['ğŸ§¡', 'ğŸ±', 'ğŸ–¤', 'ğŸ¤', 'ğŸ˜º'];
            
            catList.forEach((catName, index) => {
                if (!gameData.cats[catName]) {
                    gameData.cats[catName] = {
                        avatar: avatars[index],
                        intimacy: 0,
                        lastGift: null,
                        gifts: ['é‡‘å¸', 'ç§å­', 'é‡‘å¸', 'ç§å­'] // å¯èƒ½çš„ç¤¼ç‰©
                    };
                }
                // ç¡®ä¿æ—§æ•°æ®å…¼å®¹æ€§
                if (typeof gameData.cats[catName].intimacy === 'undefined') {
                    gameData.cats[catName].intimacy = 0;
                }
                if (!gameData.cats[catName].gifts) {
                    gameData.cats[catName].gifts = ['é‡‘å¸', 'ç§å­', 'é‡‘å¸', 'ç§å­'];
                }
            });

            // ä¿æŒæ—§çš„ intimacy ç»“æ„ç”¨äºå…¼å®¹
            if (!gameData.cats.intimacy) {
                gameData.cats.intimacy = {};
                catList.forEach(catName => {
                    gameData.cats.intimacy[catName] = gameData.cats[catName].intimacy || 0;
                });
            }

            // åˆå§‹åŒ–æ¸¸æˆå¤©æ•°å’Œé¡¾å®¢ç³»ç»Ÿ
            if (!gameData.currentDay) {
                gameData.currentDay = 1;
            }

            // é‡ç½®é¡¾å®¢ç”Ÿæˆæ—¶é—´ï¼Œç¡®ä¿ç«‹å³å¯ä»¥ç”Ÿæˆé¡¾å®¢
            gameData.lastCustomerTime = 0;

            // åˆå§‹åŒ–é¡¾å®¢å’ŒçŒ«å’ªçŠ¶æ€æ˜¾ç¤ºï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå…ƒç´ å·²å°±ç»ªï¼‰
            setTimeout(() => {
                if (typeof updateCustomerDisplay === 'function') {
                    updateCustomerDisplay();
                }
            }, 100);
            
            addDebugLog('æ¸¸æˆæ•°æ®åˆå§‹åŒ–å®Œæˆ - å·²æä¾›åˆå§‹ææ–™');
        }

        // æ¸²æŸ“ç§æ¤åŒºåŸŸ
        function renderFarmGrid() {
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';

            gameData.plots.forEach((plot, index) => {
                const plotCard = document.createElement('div');
                plotCard.className = 'plot-card';
                
                const statusClass = plot.state === 'empty' ? 'status-empty' : 
                                  plot.state === 'growing' ? 'status-growing' : 'status-ready';
                
                // è®¡ç®—ç”Ÿé•¿çŠ¶æ€å’Œå€’è®¡æ—¶
                let statusText = plot.state === 'empty' ? 'ç©ºé—²' : 
                               plot.state === 'ready' ? 'å¯æ”¶è·' : 'ç”Ÿé•¿ä¸­';
                
                if (plot.state === 'growing' && plot.plantType && plot.plantTime) {
                    const growTime = seedsInfo[plot.plantType].growTime;
                    const elapsed = Date.now() - plot.plantTime;
                    const remaining = Math.max(0, growTime - elapsed);
                    
                    if (remaining > 0) {
                        const remainingSeconds = Math.ceil(remaining / 1000);
                        const progress = Math.round((elapsed / growTime) * 100);
                        statusText = `ç”Ÿé•¿ä¸­ (${remainingSeconds}ç§’) ${progress}%`;
                    } else {
                        statusText = 'å¯æ”¶è·';
                        // å¦‚æœæ—¶é—´åˆ°äº†ä½†çŠ¶æ€è¿˜æ²¡æ›´æ–°ï¼Œå¼ºåˆ¶æ›´æ–°çŠ¶æ€
                        if (plot.state === 'growing') {
                            plot.state = 'ready';
                        }
                    }
                }

                plotCard.innerHTML = `
                    <div class="plot-header">
                        <div class="plot-title">ç§æ¤åŒºåŸŸ ${index + 1}</div>
                        <div class="plot-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <table class="conditions-table">
                        <tr>
                            <td style="width: 80px; font-weight: 600;">æ¹¿åº¦</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="plot-progress-container">
                            <div class="plot-progress-bar moisture-progress" style="width: ${plot.moisture}%"></div>
                            <div class="plot-progress-text">${plot.moisture}%</div>
                        </div>
                                </div>
                            </td>
                            <td style="width: 50px; text-align: center; font-weight: 600;">${plot.moisture}%</td>
                        </tr>
                        <tr>
                            <td style="font-weight: 600;">è‚¥æ²ƒåº¦</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="plot-progress-container">
                            <div class="plot-progress-bar fertility-progress" style="width: ${plot.fertility}%"></div>
                            <div class="plot-progress-text">${plot.fertility}%</div>
                        </div>
                                </div>
                            </td>
                            <td style="text-align: center; font-weight: 600;">${plot.fertility}%</td>
                        </tr>
                        ${plot.plantType ? `<tr><td style="font-weight: 600;">ç§æ¤ä½œç‰©</td><td colspan="2">${plot.plantType}</td></tr>` : ''}
                        ${plot.state === 'growing' && plot.plantType && plot.plantTime ? 
                            `<tr>
                                <td style="font-weight: 600;">ç”Ÿé•¿è¿›åº¦</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="plot-progress-container">
                            <div class="plot-progress-bar growth-progress" style="width: ${Math.round((Date.now() - plot.plantTime) / seedsInfo[plot.plantType].growTime * 100)}%"></div>
                            <div class="plot-progress-text">${Math.round((Date.now() - plot.plantTime) / seedsInfo[plot.plantType].growTime * 100)}%</div>
                        </div>
                                    </div>
                                </td>
                                <td style="text-align: center; font-weight: 600;">${Math.round((Date.now() - plot.plantTime) / seedsInfo[plot.plantType].growTime * 100)}%</td>
                            </tr>` : ''}
                    </table>
                    
                    <div class="plot-actions">
                        <button class="action-btn" onclick="waterPlot(${index})">æµ‡æ°´</button>
                        <button class="action-btn" onclick="fertilizePlot(${index})">æ–½è‚¥</button>
                        ${plot.state === 'empty' ? `<button class="action-btn primary" onclick="showSeedModal(${index})">ç§æ¤</button>` : ''}
                        ${plot.state === 'ready' ? `<button class="action-btn primary" onclick="harvestPlot(${index})">æ”¶è·</button>` : ''}
                    </div>
                `;
                
                farmGrid.appendChild(plotCard);
            });
        }

        // æ¸²æŸ“å…¶ä»–åŒºåŸŸ
        function renderWorkspaces() {
            renderStoves();
            renderProcessingBoard();
            renderCatsTable();
            updateAllInventoryDisplay();
        }

        function renderStoves() {
            const stovesTable = document.getElementById('stoves-table');
            stovesTable.innerHTML = '';

            gameData.stoves.forEach((stove, index) => {
                const row = document.createElement('tr');
                const recipeText = stove.recipe || 'ç­‰å¾…åˆ¶ä½œ';
                
                // åˆ¶ä½œè¿›åº¦æ¡
                let progressHTML = '';
                if (stove.state === 'cooking') {
                    const progressPercent = Math.round((Date.now() - stove.startTime) / stove.duration * 100);
                    const clampedProgress = Math.min(Math.max(progressPercent, 0), 100);
                    progressHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${clampedProgress}%; background: #e5e7eb;"></div>
                            <div class="progress-text">${clampedProgress}%</div>
                        </div>
                    `;
                } else {
                    progressHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%; background: #e5e7eb;"></div>
                            <div class="progress-text">æœªå¼€å§‹</div>
                        </div>
                    `;
                }

                row.innerHTML = `
                    <td>ç‚‰ç¶ ${index + 1}</td>
                    <td>${recipeText}</td>
                    <td>${progressHTML}</td>
                    <td>
                        ${stove.state === 'idle' ? 
                            `<button class="action-btn primary" onclick="showRecipeModal(${index})">å¼€å§‹åˆ¶èŒ¶</button>` : 
                            `<button class="action-btn" disabled>åˆ¶ä½œä¸­...</button>`
                        }
                    </td>
                `;
                stovesTable.appendChild(row);
            });
        }

        function renderProcessingBoard() {
            const processingTable = document.getElementById('processing-table');
            processingTable.innerHTML = '';

            gameData.processingBoards.forEach((board, index) => {
                const row = document.createElement('tr');
                const recipeText = board.recipe || 'ç­‰å¾…åŠ å·¥';
                
                // åŠ å·¥è¿›åº¦æ¡
                let progressHTML = '';
                if (board.state === 'processing') {
                    const progressPercent = Math.round((Date.now() - board.startTime) / board.duration * 100);
                    const clampedProgress = Math.min(Math.max(progressPercent, 0), 100);
                    progressHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${clampedProgress}%; background: #e5e7eb;"></div>
                            <div class="progress-text">${clampedProgress}%</div>
                        </div>
                    `;
                } else {
                    progressHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%; background: #e5e7eb;"></div>
                            <div class="progress-text">æœªå¼€å§‹</div>
                        </div>
                    `;
                }

                row.innerHTML = `
                    <td>æ¡ˆæ¿ ${index + 1}</td>
                    <td>${recipeText}</td>
                    <td>${progressHTML}</td>
                    <td>
                        ${board.state === 'idle' ? 
                            `<button class="action-btn primary" onclick="showProcessingModal(${index})">å¼€å§‹åŠ å·¥</button>` : 
                            `<button class="action-btn" disabled>åŠ å·¥ä¸­...</button>`
                        }
                    </td>
                `;
                processingTable.appendChild(row);
            });
        }

        function renderInventories() {
            renderTeaInventory();
            renderToppingsInventory();
            renderMaterialsInventory();
            renderCustomersTable();
            renderCatsTable();
        }

        function renderTeaInventory() {
            const teaInventory = document.getElementById('tea-inventory');
            teaInventory.innerHTML = '';

            if (gameData.madeTeas.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">æš‚æ— åˆ¶ä½œå¥½çš„èŒ¶é¥®</td>';
                teaInventory.appendChild(row);
                return;
            }

            gameData.madeTeas.forEach((tea, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tea.name}</td>
                    <td>${tea.temperature || 'å¸¸æ¸©'}</td>
                    <td>${tea.makeTime || '-'}</td>
                    <td>1</td>
                    <td><button class="action-btn" onclick="serveTea(${index})">å”®å‡º</button></td>
                `;
                teaInventory.appendChild(row);
            });
        }

        // é¡¾å®¢ç³»ç»Ÿæ¸²æŸ“å‡½æ•°
        function renderCustomersTable() {
            const customersTable = document.getElementById('customers-table');
            if (!customersTable) return;
            
            customersTable.innerHTML = '';

            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿customerså·²åˆå§‹åŒ–
            if (!gameData.customers) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4">é¡¾å®¢ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</td>';
                customersTable.appendChild(row);
                return;
            }

            Object.entries(gameData.customers).forEach(([name, customerData]) => {
                const row = document.createElement('tr');
                const isUnlocked = customerData.visits >= customerData.requiredVisits;
                const progress = `${customerData.visits}/${customerData.requiredVisits}`;
                
                row.innerHTML = `
                    <td>
                        <span class="customer-avatar">${customerData.avatar}</span>
                        ${name}
                    </td>
                    <td>${progress}</td>
                    <td style="${isUnlocked ? 'color: #6b7280; font-weight: 600;' : 'color: #6b7280;'}">
                        ${isUnlocked ? 'âœ“ ' : 'ğŸ”’ '}${customerData.unlockedRecipe}
                    </td>
                    <td>
                        <button class="action-btn" onclick="showCustomerStory('${name}')"
                                style="margin-right: 5px;">
                            ğŸ“– æ•…äº‹
                        </button>
                        <button class="action-btn" onclick="inviteCustomer('${name}')"
                                ${customerData.visits >= customerData.requiredVisits ? 'disabled' : ''}>
                            ${customerData.visits >= customerData.requiredVisits ? 'å·²å®Œæˆ' : 'é‚€è¯·æ¥è®¿'}
                        </button>
                    </td>
                `;
                customersTable.appendChild(row);
            });
        }

        // çŒ«å’ªç³»ç»Ÿæ¸²æŸ“å‡½æ•°
        function renderCatsTable() {
            const catsTable = document.getElementById('cats-table');
            if (!catsTable) return;
            
            catsTable.innerHTML = '';

            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿catså·²åˆå§‹åŒ–
            if (!gameData.cats) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">çŒ«å’ªç³»ç»Ÿåˆå§‹åŒ–ä¸­...</td>';
                catsTable.appendChild(row);
                return;
            }

            // éå†çŒ«å’ªæ•°æ®ï¼Œè¿‡æ»¤æ‰éçŒ«å’ªå±æ€§
            const catNames = ['å¤§æ©˜çŒ«', 'ç‹¸èŠ±çŒ«', 'é»‘çŒ«å°æ‰‹å¥—', 'å°ç™½çŒ«', 'å¤§çŒ«çŒ«'];
            
            catNames.forEach(name => {
                // ç¡®ä¿æ¯åªçŒ«å’ªéƒ½æœ‰æ•°æ®ï¼Œå³ä½¿æ˜¯åˆå§‹çŠ¶æ€
                if (!gameData.cats[name]) {
                    gameData.cats[name] = {
                        avatar: ['ğŸ§¡', 'ğŸ±', 'ğŸ–¤', 'ğŸ¤', 'ğŸ˜º'][catNames.indexOf(name)],
                        intimacy: 0,
                        lastGift: null,
                        gifts: ['é‡‘å¸', 'ç§å­', 'é‡‘å¸', 'ç§å­']
                    };
                }

                const catData = gameData.cats[name];
                const row = document.createElement('tr');

                // æ ¹æ®README.mdè®¾å®šçš„é‡Œç¨‹ç¢‘ï¼š500/1500/3000/5000
                let intimacyLevel = 1;
                let levelName = 'é™Œç”Ÿ';
                if (catData.intimacy >= 5000) {
                    intimacyLevel = 5;
                    levelName = 'æŒšå‹';
                } else if (catData.intimacy >= 3000) {
                    intimacyLevel = 4;
                    levelName = 'äº²å¯†';
                } else if (catData.intimacy >= 1500) {
                    intimacyLevel = 3;
                    levelName = 'å‹å¥½';
                } else if (catData.intimacy >= 500) {
                    intimacyLevel = 2;
                    levelName = 'ç†Ÿæ‚‰';
                }

                row.innerHTML = `
                    <td>${name}</td>
                    <td>
                        <div class="intimacy-bar">
                            <div class="intimacy-progress" style="width: ${Math.min(100, (catData.intimacy / 5000) * 100)}%"></div>
                        </div>
                        ${catData.intimacy}/5000
                    </td>
                    <td>${levelName} (Lv.${intimacyLevel})</td>
                    <td>${catData.lastGift || 'æš‚æ— '}</td>
                    <td>
                        <button class="action-btn" onclick="selectCatForInteraction('${name}')">é€‰æ‹©äº’åŠ¨</button>
                    </td>
                `;
                catsTable.appendChild(row);
            });
        }

        function renderToppingsInventory() {
            const toppingsInventory = document.getElementById('toppings-inventory');
            toppingsInventory.innerHTML = '';

            // æ˜¾ç¤ºtoppingsä¸­çš„å°æ–™
            Object.entries(gameData.toppings).forEach(([name, count]) => {
                if (count > 0) {
                    const row = document.createElement('tr');

                    // åˆ¤æ–­è·å–æ–¹å¼
                    let getMethod = 'æ¡ˆæ¿åŠ å·¥';
                    let actionButton = '-';

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å•†åº—å¯è´­ä¹°çš„å°æ–™
                    if (toppingsShop[name]) {
                        getMethod = `å•†åº—è´­ä¹° (${toppingsShop[name].price}é‡‘å¸)`;
                        const canAfford = gameData.funds >= toppingsShop[name].price;
                        actionButton = `<button class="action-btn" onclick="buyTopping('${name}')" ${canAfford ? '' : 'disabled'}>
                            ${canAfford ? 'è´­ä¹°' : 'èµ„é‡‘ä¸è¶³'}
                        </button>`;
                    } else if (name.includes('çº¢ç³–') || name.includes('è–„è·å¶') || name.includes('å§œä¸') ||
                        name.includes('æŸšå­ä¸') || name.includes('é“¶è€³ä¸') || name.includes('æŸ æª¬ç‰‡') || name.includes('èœ‚èœœ')) {
                        getMethod = 'åˆå§‹æ‹¥æœ‰';
                        actionButton = `<button class="action-btn">ä½¿ç”¨</button>`;
                    } else {
                        // æ¡ˆæ¿åŠ å·¥çš„å°æ–™
                        actionButton = `<button class="action-btn">ä½¿ç”¨</button>`;
                    }

                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${count}</td>
                        <td>${getMethod}</td>
                        <td>${actionButton}</td>
                    `;
                    toppingsInventory.appendChild(row);
                }
            });

            // æ˜¾ç¤ºåŠ¨ç‰©å‰¯äº§å“ï¼ˆä»materialsä¸­ï¼‰
            if (gameData.materials) {
                const byproductItems = Object.entries(gameData.materials).filter(([name, count]) =>
                    animalByproducts[name] && count > 0
                );

                if (byproductItems.length > 0) {
                    // æ·»åŠ åˆ†éš”è¡Œ
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="4" style="background-color: #fef3c7; text-align: center; font-weight: bold; color: #92400e;">
                            ğŸ¾ åŠ¨ç‰©å‰¯äº§å“ï¼ˆå¯å”®å–ï¼‰
                        </td>
                    `;
                    toppingsInventory.appendChild(separatorRow);

                    // æ˜¾ç¤ºå‰¯äº§å“
                    byproductItems.forEach(([name, count]) => {
                        const byproduct = animalByproducts[name];
                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <td>${name}</td>
                            <td style="background-color: #fef3c7; font-weight: 600;">${count}</td>
                            <td>åŠ¨ç‰©åˆ†è§£è·å¾—</td>
                            <td>
                                <button class="action-btn" onclick="sellByproduct('${name}')" style="background-color: #22c55e; color: white;">
                                    å”®å– (${byproduct.price}é‡‘å¸)
                                </button>
                            </td>
                        `;
                        toppingsInventory.appendChild(row);
                    });
                }
            }
        }

        function renderMaterialsInventory() {
            const materialsInventory = document.getElementById('materials-inventory');
            materialsInventory.innerHTML = '';

            // æ˜¾ç¤ºç§æ¤ç±»ææ–™
            Object.keys(seedsInfo).forEach(material => {
                const row = document.createElement('tr');
                const seedCount = gameData.seeds[material] || 0;
                const materialCount = gameData.inventory[material] || 0;
                const price = seedsInfo[material].price;
                const growTime = Math.round(seedsInfo[material].growTime / 1000);

                // å¦‚æœæœ‰æ”¶è·çš„ææ–™ï¼Œçªå‡ºæ˜¾ç¤º
                const materialStyle = materialCount > 0 ? 'style="background-color: #e8f5e8; font-weight: 600;"' : '';

                row.innerHTML = `
                    <td>${material}</td>
                    <td>${seedCount}</td>
                    <td ${materialStyle}>${materialCount}${materialCount > 0 ? ' âœ“' : ''}</td>
                    <td>${price} é‡‘å¸</td>
                    <td>${growTime} ç§’</td>
                    <td>
                        ${seedCount === 0 ?
                            `<button class="action-btn" onclick="buySeed('${material}')">è´­ä¹°ç§å­</button>` :
                            `<button class="action-btn" onclick="plantSeedFromInventory('${material}')">ç§æ¤</button>`
                        }
                    </td>
                `;
                materialsInventory.appendChild(row);
            });

            // æ˜¾ç¤ºæ‰“çŒè·å¾—çš„ææ–™ï¼ˆåˆ†ç±»æ˜¾ç¤ºï¼‰
            if (gameData.materials && Object.keys(gameData.materials).length > 0) {
                // åˆ†ç±»ææ–™
                const animals = ['å…”å­', 'é¸¡', 'å±±ç¾Š', 'é‡çŒª'];
                const meats = ['å…”è‚‰', 'é¸¡è‚‰', 'å±±ç¾Šè‚‰', 'é‡çŒªè‚‰'];
                const others = Object.keys(gameData.materials).filter(item =>
                    !animals.includes(item) && !meats.includes(item) && gameData.materials[item] > 0
                );

                // æ˜¾ç¤ºå®Œæ•´åŠ¨ç‰©
                const availableAnimals = animals.filter(animal => gameData.materials[animal] > 0);
                if (availableAnimals.length > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="6" style="background-color: #fef3c7; text-align: center; font-weight: bold; color: #92400e;">
                            ğŸ° å®Œæ•´åŠ¨ç‰©ï¼ˆéœ€è¦åˆ†è§£ï¼‰
                        </td>
                    `;
                    materialsInventory.appendChild(separatorRow);

                    availableAnimals.forEach(animal => {
                        const count = gameData.materials[animal];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${animal}</td>
                            <td>-</td>
                            <td style="background-color: #fef3c7; font-weight: 600;">${count} âœ“</td>
                            <td>æ‰“çŒè·å¾—</td>
                            <td>-</td>
                            <td>
                                <span style="color: #92400e; font-size: 12px;">å‰å¾€åŠ å·¥å°åˆ†è§£</span>
                            </td>
                        `;
                        materialsInventory.appendChild(row);
                    });
                }

                // æ˜¾ç¤ºè‚‰ç±»ææ–™
                const availableMeats = meats.filter(meat => gameData.materials[meat] > 0);
                if (availableMeats.length > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="6" style="background-color: #fee2e2; text-align: center; font-weight: bold; color: #991b1b;">
                            ğŸ¥© è‚‰ç±»ææ–™ï¼ˆå¯çƒ¤åˆ¶ï¼‰
                        </td>
                    `;
                    materialsInventory.appendChild(separatorRow);

                    availableMeats.forEach(meat => {
                        const count = gameData.materials[meat];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${meat}</td>
                            <td>-</td>
                            <td style="background-color: #fee2e2; font-weight: 600;">${count} âœ“</td>
                            <td>åˆ†è§£è·å¾—</td>
                            <td>-</td>
                            <td>
                                <span style="color: #991b1b; font-size: 12px;">å‰å¾€çƒ¤è‚‰æ¶çƒ¤åˆ¶</span>
                            </td>
                        `;
                        materialsInventory.appendChild(row);
                    });
                }

                // æ˜¾ç¤ºå…¶ä»–æ‰“çŒææ–™
                if (others.length > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="6" style="background-color: #f0f9ff; text-align: center; font-weight: bold; color: #1e40af;">
                            ğŸŸ å…¶ä»–æ‰“çŒææ–™
                        </td>
                    `;
                    materialsInventory.appendChild(separatorRow);

                    others.forEach(material => {
                        const count = gameData.materials[material];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${material}</td>
                            <td>-</td>
                            <td style="background-color: #f0f9ff; font-weight: 600;">${count} âœ“</td>
                            <td>æ‰“çŒè·å¾—</td>
                            <td>-</td>
                            <td>
                                <span style="color: #1e40af; font-size: 12px;">æ‰“çŒææ–™</span>
                            </td>
                        `;
                        materialsInventory.appendChild(row);
                    });
                }
            }

            // æ˜¾ç¤ºç‰¹æ®Šç‰©å“ï¼ˆtreasuresï¼‰
            if (gameData.treasures && Object.keys(gameData.treasures).length > 0) {
                const treasureItems = Object.entries(gameData.treasures).filter(([name, count]) => count > 0);

                if (treasureItems.length > 0) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `
                        <td colspan="6" style="background-color: #fef3c7; text-align: center; font-weight: bold; color: #92400e;">
                            âœ¨ ç‰¹æ®Šç‰©å“æ”¶è—
                        </td>
                    `;
                    materialsInventory.appendChild(separatorRow);

                    treasureItems.forEach(([treasure, count]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${treasure}</td>
                            <td>-</td>
                            <td style="background-color: #fef3c7; font-weight: 600;">${count} âœ“</td>
                            <td>æ‰“çŒè·å¾—</td>
                            <td>-</td>
                            <td>
                                <span style="color: #92400e; font-size: 12px;">çè´µæ”¶è—å“</span>
                            </td>
                        `;
                        materialsInventory.appendChild(row);
                    });
                }
            }
        }

        // ç§æ¤ç›¸å…³åŠŸèƒ½
        function waterPlot(plotIndex) {
            const plot = gameData.plots[plotIndex];
            plot.moisture = Math.min(100, plot.moisture + 30);
            renderFarmGrid();
        }

        function fertilizePlot(plotIndex) {
            const plot = gameData.plots[plotIndex];
            plot.fertility = Math.min(100, plot.fertility + 25);
            renderFarmGrid();
        }

        function showSeedModal(plotIndex) {
            const modal = document.getElementById('seed-modal');
            const seedGrid = document.getElementById('seed-grid');
            
            seedGrid.innerHTML = '';
            
            // æ˜¾ç¤ºæ‰€æœ‰ç§å­é€‰é¡¹ï¼ŒåŒ…æ‹¬åº“å­˜ä¸º0çš„
            Object.entries(seedsInfo).forEach(([seedName, seedInfo]) => {
                const count = gameData.seeds[seedName] || 0;
                const seedOption = document.createElement('div');
                seedOption.className = 'seed-option';
                
                // å¦‚æœæœ‰åº“å­˜ï¼Œå¯ä»¥ç§æ¤ï¼›å¦‚æœæ²¡æœ‰åº“å­˜ï¼Œå¯ä»¥è´­ä¹°
                if (count > 0) {
                    seedOption.innerHTML = `
                        <div class="seed-name">${seedName}</div>
                        <div class="seed-info">åº“å­˜: ${count}ä¸ª</div>
                        <div class="seed-info">ç”Ÿé•¿æ—¶é—´: ${Math.round(seedInfo.growTime / 1000)}ç§’</div>
                        <div class="seed-info" style="color: #6b7280;">ç‚¹å‡»ç§æ¤</div>
                    `;
                    seedOption.onclick = () => plantSeedInPlot(plotIndex, seedName);
                } else {
                    seedOption.innerHTML = `
                        <div class="seed-name">${seedName}</div>
                        <div class="seed-info">ä»·æ ¼: ${seedInfo.price}é‡‘å¸</div>
                        <div class="seed-info">ç”Ÿé•¿æ—¶é—´: ${Math.round(seedInfo.growTime / 1000)}ç§’</div>
                        <div class="seed-info" style="color: #6b7280;">ç‚¹å‡»è´­ä¹°ç§æ¤</div>
                    `;
                    seedOption.onclick = () => buySeedAndPlant(plotIndex, seedName);
                }
                
                seedGrid.appendChild(seedOption);
            });
            
            modal.style.display = 'block';
        }
        
        function buySeedAndPlant(plotIndex, seedName) {
            const price = seedsInfo[seedName].price;
            if (gameData.funds >= price) {
                // è´­ä¹°ç§å­
                gameData.funds -= price;
                const beforeSeedCount = gameData.seeds[seedName] || 0;
                gameData.seeds[seedName] = beforeSeedCount + 1;
                
                // ç«‹å³ç§æ¤
                plantSeedInPlot(plotIndex, seedName);
                
                document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
                addDebugLog(`è´­ä¹°å¹¶ç§æ¤ï¼š${seedName}ï¼ŒèŠ±è´¹${price}é‡‘å¸ï¼Œç›´æ¥ç§æ¤åˆ°åœ°å—${plotIndex + 1}`);
                updateAllInventoryDisplay();
            } else {
                showAlert('é‡‘å¸ä¸è¶³ï¼éœ€è¦ ' + price + ' é‡‘å¸', 'è´­ä¹°å¤±è´¥', 'ğŸ’°');
                addDebugLog(`è´­ä¹°${seedName}å¤±è´¥ï¼šé‡‘å¸ä¸è¶³ï¼ˆéœ€è¦${price}é‡‘å¸ï¼‰`);
            }
        }

        function plantSeedInPlot(plotIndex, seedName) {
            const plot = gameData.plots[plotIndex];
            if (gameData.seeds[seedName] > 0) {
                const beforeSeedCount = gameData.seeds[seedName];
                gameData.seeds[seedName]--;
                const afterSeedCount = gameData.seeds[seedName];
                
                plot.state = 'growing';
                plot.plantType = seedName;
                plot.growthStage = 0;
                plot.plantTime = Date.now(); // ä¿®å¤ï¼šä½¿ç”¨plantTimeè€ŒéstageStartTime
                plot.stageStartTime = Date.now(); // ä¿ç•™å…¼å®¹æ€§
                
                const growTimeSeconds = Math.round(seedsInfo[seedName].growTime / 1000);
                addDebugLog(`ç§æ¤æ“ä½œï¼šåœ°å—${plotIndex + 1}ç§æ¤${seedName}ï¼Œç§å­åº“å­˜ ${beforeSeedCount} â†’ ${afterSeedCount} (-1)ï¼Œé¢„è®¡${growTimeSeconds}ç§’åæˆç†Ÿ`);
                
                document.getElementById('seed-modal').style.display = 'none';
                renderFarmGrid();
                updateAllInventoryDisplay();
                saveGameDataToDatabase();
            }
        }

        // ç»Ÿä¸€çš„åº“å­˜æ›´æ–°å‡½æ•°
        function updateAllInventoryDisplay() {
            renderMaterialsInventory();
            renderToppingsInventory();
            renderTeaInventory();
            renderCustomersTable();
            renderCatsTable();
            updateDebugDisplay();
        }

        function harvestPlot(plotIndex) {
            const plot = gameData.plots[plotIndex];
            if (plot.state === 'ready' && plot.plantType) {
                const yield = Math.floor(Math.random() * 5) + 3; // 3-7ä¸ª
                const harvestedCrop = plot.plantType; // å…ˆä¿å­˜ä½œç‰©åç§°
                const beforeCount = gameData.inventory[plot.plantType] || 0;
                gameData.inventory[plot.plantType] = beforeCount + yield;
                const afterCount = gameData.inventory[plot.plantType];
                
                // é‡ç½®åœ°å—
                plot.state = 'empty';
                plot.plantType = null;
                plot.growthStage = 0;
                plot.plantTime = 0; // é‡ç½®ç§æ¤æ—¶é—´
                plot.stageStartTime = 0;
                plot.moisture = Math.max(10, plot.moisture - 10);
                plot.fertility = Math.max(20, plot.fertility - 5);
                
                // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                addDebugLog(`æ”¶è·æ“ä½œï¼š${harvestedCrop} ${beforeCount} â†’ ${afterCount} (+${yield})`);
                
                // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                renderFarmGrid();
                updateAllInventoryDisplay();
                
                showAlert(`æ”¶è·äº† ${yield} ä¸ª ${harvestedCrop}ï¼å½“å‰åº“å­˜ï¼š${afterCount}ä¸ª`, 'æ”¶è·æˆåŠŸ', 'ğŸŒ¾');
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                saveGameDataToDatabase();
            }
        }

        function buySeed(material) {
            const price = seedsInfo[material].price;
            if (gameData.funds >= price) {
                gameData.funds -= price;
                const beforeSeedCount = gameData.seeds[material] || 0;
                gameData.seeds[material] = beforeSeedCount + 1;
                const afterSeedCount = gameData.seeds[material];
                
                document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
                
                addDebugLog(`è´­ä¹°ç§å­ï¼š${material} ${beforeSeedCount} â†’ ${afterSeedCount} (+1)ï¼ŒèŠ±è´¹${price}é‡‘å¸`);
                
                // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                updateAllInventoryDisplay();
                showAlert(`è´­ä¹°äº† 1 ä¸ª ${material} ç§å­ï¼ŒèŠ±è´¹ ${price} é‡‘å¸`, 'è´­ä¹°æˆåŠŸ', 'ğŸŒ±');
                saveGameDataToDatabase();
            } else {
                showAlert('é‡‘å¸ä¸è¶³ï¼', 'è´­ä¹°å¤±è´¥', 'ğŸ’°');
                addDebugLog(`è´­ä¹°${material}ç§å­å¤±è´¥ï¼šé‡‘å¸ä¸è¶³ï¼ˆéœ€è¦${price}é‡‘å¸ï¼‰`);
            }
        }

        function plantSeedFromInventory(material) {
            const emptyPlots = gameData.plots.filter(plot => plot.state === 'empty');
            if (emptyPlots.length === 0) {
                showAlert('æ²¡æœ‰ç©ºé—²çš„ç§æ¤åŒºåŸŸï¼è¯·å…ˆæ”¶è·å·²æˆç†Ÿçš„ä½œç‰©ã€‚', 'ç§æ¤å¤±è´¥', 'ğŸš«');
                return;
            }

            if (gameData.seeds[material] <= 0) {
                showAlert(`æ²¡æœ‰${material}çš„ç§å­ï¼`, 'ç§æ¤å¤±è´¥', 'ğŸŒ±');
                return;
            }

            // ä½¿ç”¨ç¬¬ä¸€ä¸ªç©ºé—²åœ°å—
            const plotIndex = gameData.plots.findIndex(plot => plot.state === 'empty');
            plantSeedInPlot(plotIndex, material);
        }

        // ç‚‰ç¶åˆ¶èŒ¶åŠŸèƒ½
        function showRecipeModal(stoveIndex) {
            const availableRecipes = Object.keys(gameData.teaRecipes).filter(recipe => {
                const ingredients = gameData.teaRecipes[recipe];
                return ingredients.every(ingredient => {
                    // æ£€æŸ¥inventoryï¼ˆç§æ¤ææ–™ï¼‰å’Œmaterialsï¼ˆæ‰“çŒææ–™ï¼‰
                    return (gameData.inventory[ingredient] > 0) || (gameData.materials && gameData.materials[ingredient] > 0);
                });
            });

            if (availableRecipes.length === 0) {
                showAlert('æ²¡æœ‰å¯åˆ¶ä½œçš„èŒ¶é¥®é…æ–¹ï¼Œè¯·å…ˆç§æ¤å¹¶æ”¶è·ç›¸åº”ææ–™ï¼', 'åˆ¶èŒ¶å¤±è´¥', 'ğŸµ');
                return;
            }

            const modal = document.getElementById('recipe-modal');
            const recipeGrid = document.getElementById('recipe-grid');
            
            recipeGrid.innerHTML = '';
            availableRecipes.forEach(recipe => {
                const ingredients = gameData.teaRecipes[recipe];
                const ingredientText = ingredients.join(' + ');
                
                const recipeOption = document.createElement('div');
                recipeOption.className = 'seed-option';
                recipeOption.innerHTML = `
                    <div class="seed-name">${recipe}</div>
                    <div class="seed-info">éœ€è¦: ${ingredientText}</div>
                    <div class="seed-info">åˆ¶ä½œæ—¶é—´: 8ç§’</div>
                `;
                recipeOption.onclick = () => {
                    startCooking(stoveIndex, recipe);
                    modal.style.display = 'none';
                };
                recipeGrid.appendChild(recipeOption);
            });
            
            modal.style.display = 'block';
        }

        function startCooking(stoveIndex, recipeName) {
            const stove = gameData.stoves[stoveIndex];
            const ingredients = gameData.teaRecipes[recipeName];
            
            // æ£€æŸ¥ææ–™æ˜¯å¦è¶³å¤Ÿï¼ˆæ£€æŸ¥inventoryå’Œmaterialsï¼‰
            const insufficientMaterials = ingredients.filter(ingredient => {
                const inventoryCount = gameData.inventory[ingredient] || 0;
                const materialsCount = (gameData.materials && gameData.materials[ingredient]) || 0;
                return (inventoryCount + materialsCount) < 1;
            });

            if (insufficientMaterials.length > 0) {
                showAlert(`ææ–™ä¸è¶³ï¼š${insufficientMaterials.join(', ')}`, 'åˆ¶èŒ¶å¤±è´¥', 'ğŸ“¦');
                addDebugLog(`åˆ¶èŒ¶å¤±è´¥ï¼šææ–™ä¸è¶³ ${insufficientMaterials.join(', ')}`);
                return;
            }
            
            // æ¶ˆè€—ææ–™ - è¯¦ç»†è®°å½•æ¯ä¸ªææ–™çš„å˜åŒ–
            addDebugLog(`å¼€å§‹åˆ¶ä½œ${recipeName}ï¼Œæ¶ˆè€—ææ–™ï¼š`);
            ingredients.forEach(ingredient => {
                // ä¼˜å…ˆä»materialsä¸­æ¶ˆè€—ï¼ˆæ‰“çŒææ–™ï¼‰ï¼Œç„¶åä»inventoryä¸­æ¶ˆè€—ï¼ˆç§æ¤ææ–™ï¼‰
                if (gameData.materials && gameData.materials[ingredient] > 0) {
                    const beforeCount = gameData.materials[ingredient];
                    gameData.materials[ingredient] = Math.max(0, beforeCount - 1);
                    const afterCount = gameData.materials[ingredient];
                    addDebugLog(`  - ${ingredient}(æ‰“çŒ): ${beforeCount} â†’ ${afterCount} (-1)`);
                } else if (gameData.inventory[ingredient] > 0) {
                    const beforeCount = gameData.inventory[ingredient];
                    gameData.inventory[ingredient] = Math.max(0, beforeCount - 1);
                    const afterCount = gameData.inventory[ingredient];
                    addDebugLog(`  - ${ingredient}(ç§æ¤): ${beforeCount} â†’ ${afterCount} (-1)`);
                }
            });
            
            // å¼€å§‹åˆ¶èŒ¶
            stove.state = 'cooking';
            stove.recipe = recipeName;
            stove.startTime = Date.now();
            
            addDebugLog(`${recipeName}åˆ¶ä½œä¸­ï¼Œé¢„è®¡8ç§’å®Œæˆ`);
            
            // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            renderStoves();
            updateAllInventoryDisplay();
            saveGameDataToDatabase();
        }

        // æ¡ˆæ¿åŠ å·¥åŠŸèƒ½
        function showProcessingModal(boardIndex = 0) {
            const availableRecipes = Object.keys(gameData.processingRecipes).filter(recipe => {
                const recipeData = gameData.processingRecipes[recipe];
                return recipeData.ingredients.every(ingredient => {
                    // æ£€æŸ¥inventoryï¼ˆç§æ¤ææ–™ï¼‰å’Œmaterialsï¼ˆæ‰“çŒåŠ¨ç‰©ï¼‰
                    return (gameData.inventory[ingredient] > 0) || (gameData.materials && gameData.materials[ingredient] > 0);
                });
            });

            if (availableRecipes.length === 0) {
                showAlert('æ²¡æœ‰å¯åŠ å·¥çš„é…æ–¹ï¼Œè¯·å…ˆç§æ¤å¹¶æ”¶è·ç›¸åº”ææ–™ï¼', 'åŠ å·¥å¤±è´¥', 'âš™ï¸');
                return;
            }

            const modal = document.getElementById('processing-modal');
            const processingGrid = document.getElementById('processing-grid');
            
            processingGrid.innerHTML = '';
            availableRecipes.forEach(recipe => {
                const recipeData = gameData.processingRecipes[recipe];
                const ingredients = recipeData.ingredients.join(' + ');
                const timeInSeconds = Math.round(recipeData.time / 1000);
                
                const processingOption = document.createElement('div');
                processingOption.className = 'seed-option';

                // åŒºåˆ†åŠ¨ç‰©åˆ†è§£å’Œå°æ–™åŠ å·¥çš„æ˜¾ç¤º
                if (recipeData.outputs) {
                    // åŠ¨ç‰©åˆ†è§£é…æ–¹
                    const outputText = recipeData.outputs.map(output => `${output.name}Ã—${output.quantity}`).join(', ');
                    processingOption.innerHTML = `
                        <div class="seed-name">${recipe}</div>
                        <div class="seed-info">éœ€è¦: ${ingredients}</div>
                        <div class="seed-info">äº§å‡º: ${outputText}</div>
                        <div class="seed-info">åˆ†è§£æ—¶é—´: ${timeInSeconds}ç§’</div>
                        <div class="seed-info" style="color: #d2691e; font-size: 11px;">${recipeData.description}</div>
                    `;
                } else {
                    // å°æ–™åŠ å·¥é…æ–¹
                    processingOption.innerHTML = `
                        <div class="seed-name">${recipe}</div>
                        <div class="seed-info">éœ€è¦: ${ingredients}</div>
                        <div class="seed-info">äº§å‡º: ${recipeData.output}ä¸ª</div>
                        <div class="seed-info">åŠ å·¥æ—¶é—´: ${timeInSeconds}ç§’</div>
                    `;
                }
                processingOption.onclick = () => {
                    startProcessing(recipe, boardIndex);
                    modal.style.display = 'none';
                };
                processingGrid.appendChild(processingOption);
            });
            
            modal.style.display = 'block';
        }

        function startProcessing(recipeName, boardIndex = 0) {
            const recipe = gameData.processingRecipes[recipeName];
            const board = gameData.processingBoards[boardIndex];

            // æ¶ˆè€—ææ–™ - è¯¦ç»†è®°å½•æ¯ä¸ªææ–™çš„å˜åŒ–
            addDebugLog(`å¼€å§‹æ¡ˆæ¿åŠ å·¥${recipeName}ï¼Œæ¶ˆè€—ææ–™ï¼š`);
            recipe.ingredients.forEach(ingredient => {
                // ä¼˜å…ˆä»materialsä¸­æ¶ˆè€—ï¼ˆåŠ¨ç‰©ï¼‰ï¼Œç„¶åä»inventoryä¸­æ¶ˆè€—ï¼ˆç§æ¤ææ–™ï¼‰
                if (gameData.materials && gameData.materials[ingredient] > 0) {
                    const beforeCount = gameData.materials[ingredient];
                    gameData.materials[ingredient] = Math.max(0, beforeCount - 1);
                    const afterCount = gameData.materials[ingredient];
                    addDebugLog(`  - ${ingredient}(åŠ¨ç‰©): ${beforeCount} â†’ ${afterCount} (-1)`);
                } else if (gameData.inventory[ingredient] > 0) {
                    const beforeCount = gameData.inventory[ingredient];
                    gameData.inventory[ingredient] = Math.max(0, beforeCount - 1);
                    const afterCount = gameData.inventory[ingredient];
                    addDebugLog(`  - ${ingredient}(ç§æ¤): ${beforeCount} â†’ ${afterCount} (-1)`);
                }
            });

            // å¼€å§‹åŠ å·¥
            board.state = 'processing';
            board.recipe = recipeName;
            board.startTime = Date.now();
            board.duration = recipe.time;
            
            const timeInSeconds = Math.round(recipe.time / 1000);
            addDebugLog(`${recipeName}åŠ å·¥ä¸­ï¼Œé¢„è®¡${timeInSeconds}ç§’å®Œæˆï¼Œäº§å‡º${recipe.output}ä¸ª`);
            
            // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            renderProcessingBoard();
            updateAllInventoryDisplay();
            saveGameDataToDatabase();
        }

        // å”®å‡ºèŒ¶é¥® - æ™ºèƒ½æœåŠ¡é¡¾å®¢
        function serveTea(teaIndex) {
            const tea = gameData.madeTeas[teaIndex];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰çŒ«å’ªåœ¨åœº
            if (gameData.cats && gameData.cats.currentCat) {
                serveCustomer(tea.name);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¡¾å®¢åœ¨ç­‰å¾…
            if (gameData.customer.active) {
                serveCustomer(tea.name);
                return;
            }
            
            // æ²¡æœ‰é¡¾å®¢ï¼Œç›´æ¥å”®å‡º
            const basePrice = 5;
            const tempBonus = tea.temperature === 'çƒ­èŒ¶' ? 3 : 0;
            const totalPrice = basePrice + tempBonus;
            const beforeFunds = gameData.funds;
            const beforeTeaCount = gameData.madeTeas.length;
            
            gameData.funds += totalPrice;
            gameData.madeTeas.splice(teaIndex, 1);
            const afterFunds = gameData.funds;
            const afterTeaCount = gameData.madeTeas.length;
            
            addDebugLog(`ç›´æ¥å”®å‡ºèŒ¶é¥®ï¼š${tea.name}ï¼ŒèŒ¶é¥®åº“å­˜ ${beforeTeaCount} â†’ ${afterTeaCount} (-1)ï¼Œé‡‘å¸ ${beforeFunds} â†’ ${afterFunds} (+${totalPrice})`);
            
            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            updateAllInventoryDisplay();
            showAlert(`å”®å‡º ${tea.name}ï¼Œè·å¾— ${totalPrice} é‡‘å¸ï¼`, 'å”®å‡ºæˆåŠŸ', 'ğŸ’°');
            saveGameDataToDatabase();
        }

        // æŸ¥çœ‹èŒ¶é¥®é…æ–¹
        function checkTeaRecipes(material) {
            const recipesWithMaterial = Object.entries(gameData.teaRecipes).filter(([recipeName, ingredients]) => 
                ingredients.includes(material)
            );

            if (recipesWithMaterial.length === 0) {
                showAlert(`${material} ä¸èƒ½ç”¨äºåˆ¶ä½œä»»ä½•èŒ¶é¥®é…æ–¹`, 'æŸ¥è¯¢ç»“æœ', 'â„¹ï¸');
                return;
            }

            const recipeList = recipesWithMaterial.map(([recipeName, ingredients]) => 
                `${recipeName}ï¼ˆéœ€è¦ï¼š${ingredients.join(' + ')}ï¼‰`
            ).join('\n');

            showWin95Modal('é…æ–¹æŸ¥è¯¢', `<div style="line-height: 1.6;"><strong>${material}</strong> å¯ç”¨äºåˆ¶ä½œä»¥ä¸‹èŒ¶é¥®ï¼š<br><br>${recipeList.replace(/\n/g, '<br>')}</div>`, 'ğŸ“–');
        }

        // æ˜¾ç¤ºé…æ–¹è§£é”çŠ¶æ€
        function showRecipeUnlockStatus() {
            let statusText = "ğŸ“‹ èŒ¶é¥®é…æ–¹è§£é”çŠ¶æ€\n\n";
            
            // å·²è§£é”çš„é…æ–¹
            statusText += "ğŸŸ¢ å·²è§£é”é…æ–¹ï¼š\n";
            const unlockedRecipes = Object.keys(gameData.teaRecipes);
            if (unlockedRecipes.length > 0) {
                unlockedRecipes.forEach(recipe => {
                    const ingredients = gameData.teaRecipes[recipe];
                    statusText += `  âœ“ ${recipe}ï¼š${ingredients.join(' + ')}\n`;
                });
            } else {
                statusText += "  æš‚æ— å·²è§£é”é…æ–¹\n";
            }
            
            statusText += "\nğŸ”’ å¾…è§£é”é…æ–¹ï¼š\n";
            
            // æ˜¾ç¤ºå®¢æˆ·è§£é”è¿›åº¦
            if (gameData.customers) {
                Object.entries(gameData.customers).forEach(([customerName, customerData]) => {
                    const progress = `${customerData.visits}/${customerData.requiredVisits}`;
                    const isUnlocked = customerData.visits >= customerData.requiredVisits;
                    const statusIcon = isUnlocked ? "âœ…" : "â³";
                    
                    statusText += `  ${statusIcon} ${customerData.unlockedRecipe} (${customerName}ï¼š${progress})\n`;
                });
            }
            
            statusText += "\nğŸ’¡ æç¤ºï¼šå¤šæ¬¡æœåŠ¡ç‰¹å®šå®¢æˆ·å¯è§£é”ä»–ä»¬çš„ä¸“å±é…æ–¹ï¼";
            
            showWin95Modal('æ¸¸æˆçŠ¶æ€', `<div style="line-height: 1.6; white-space: pre-line;">${statusText}</div>`, 'ğŸ“Š');
        }

        // é¡¾å®¢å’ŒçŒ«å’ªè‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ
        
        // æ›´æ–°é¡¾å®¢çŠ¶æ€ï¼ˆä¸»å¾ªç¯è°ƒç”¨ï¼‰
        function updateCustomer() {
            // å¦‚æœæœ‰çŒ«å’ªåœ¨åœºï¼Œä¸å¤„ç†æ™®é€šé¡¾å®¢é€»è¾‘
            if (gameData.cats && gameData.cats.currentCat) {
                const cat = gameData.cats.currentCat;
                const elapsed = Date.now() - cat.arrivalTime;

                // å¦‚æœçŒ«å’ªè¿˜åœ¨åœç•™æœŸé—´ï¼Œä¸å¤„ç†æ™®é€šé¡¾å®¢
                if (elapsed < cat.stayDuration) {
                    return;
                }
            }

            // æ™®é€šé¡¾å®¢é€»è¾‘
            if (gameData.customer.active) {
                const elapsed = Date.now() - gameData.customer.arrivalTime;
                const remaining = gameData.customer.patience - elapsed;

                if (remaining <= 0) {
                    // é¡¾å®¢å¤±å»è€å¿ƒç¦»å¼€
                    addDebugLog(`é¡¾å®¢ ${gameData.customer.name} ç­‰å¾—ä¸è€çƒ¦ï¼Œç¦»å¼€äº†`);
                    resetCustomer();
                } else {
                    // æ›´æ–°æ˜¾ç¤º
                    updateCustomerDisplay();
                }
            }
        }

        // å°è¯•ç”Ÿæˆæ–°é¡¾å®¢ï¼ˆä¸»å¾ªç¯è°ƒç”¨ï¼‰
        function trySpawnCustomer() {
            const now = Date.now();

            // ä¿®æ”¹çŒ«å’ªç”Ÿæˆæ¡ä»¶ï¼šæ¯2-4å¤©å¯èƒ½å‡ºç°ä¸€æ¬¡çŒ«å’ª
            if (!gameData.cats.currentCat && 
                gameData.currentDay >= 2 && // ä»ç¬¬2å¤©å¼€å§‹å¯èƒ½å‡ºç°çŒ«å’ª
                !gameData.cats.todayVisited &&
                (gameData.currentDay - (gameData.cats.lastCatDay || 0)) >= 2) { // è‡³å°‘é—´éš”2å¤©
                
                // æ¯å¤©æœ‰30%çš„æ¦‚ç‡ç”ŸæˆçŒ«å’ªï¼ˆä½†æœ€å¤š4å¤©ä¸€å®šä¼šæ¥ä¸€æ¬¡ï¼‰
                const daysSinceLastCat = gameData.currentDay - (gameData.cats.lastCatDay || 0);
                const catChance = daysSinceLastCat >= 4 ? 1.0 : 0.3; // 4å¤©åå¿…å®šå‡ºç°ï¼Œå¦åˆ™30%æ¦‚ç‡
                
                if (Math.random() < catChance) {
                    // çŒ«å’ªè‡ªåŠ¨ç”Ÿæˆé€»è¾‘
                    const catNames = ['å¤§æ©˜çŒ«', 'ç‹¸èŠ±çŒ«', 'é»‘çŒ«å°æ‰‹å¥—', 'å°ç™½çŒ«', 'å¤§çŒ«çŒ«'];
                    const randomIndex = Math.floor(Math.random() * catNames.length);
                    const catName = catNames[randomIndex];
                    
                    gameData.cats.currentCat = {
                        name: catName,
                        arrivalTime: now,
                        stayDuration: 30000, // åœç•™30ç§’
                        fed: false
                    };
                    
                    gameData.cats.lastCatTime = now;
                    gameData.cats.lastCatDay = gameData.currentDay;
                    gameData.cats.todayVisited = true;
                    addDebugLog(`çŒ«å’ª ${catName} æ¥åˆ°äº†èŒ¶åº—ï¼`);
                    updateCustomerDisplay();
                    return;
                }
            }

            // å¦‚æœæœ‰çŒ«å’ªåœ¨åœºï¼Œä¸ç”Ÿæˆæ–°é¡¾å®¢
            if (gameData.cats && gameData.cats.currentCat) {
                const cat = gameData.cats.currentCat;
                const elapsed = Date.now() - cat.arrivalTime;

                // å¦‚æœçŒ«å’ªè¿˜åœ¨åœç•™æœŸé—´ï¼Œä¸ç”Ÿæˆæ–°é¡¾å®¢
                if (elapsed < cat.stayDuration) {
                    return;
                }
            }

            if (gameData.customer.active) return;

            if (now - gameData.lastCustomerTime < gameData.customerSpawnCooldown) return;

            // 80%æ¦‚ç‡ç”Ÿæˆé¡¾å®¢ï¼ˆå¤§å¹…æå‡æ¦‚ç‡ä»¥ä¾¿æµ‹è¯•ï¼‰
            if (Math.random() < 0.8) {
                spawnRandomCustomer();
                gameData.lastCustomerTime = now;
                addDebugLog('è§¦å‘é¡¾å®¢ç”Ÿæˆæ£€æŸ¥ - ç”Ÿæˆæ–°é¡¾å®¢');
            } else {
                addDebugLog('è§¦å‘é¡¾å®¢ç”Ÿæˆæ£€æŸ¥ - è¿™æ¬¡æ²¡æœ‰ç”Ÿæˆé¡¾å®¢');
            }
        }

        // ç”Ÿæˆéšæœºé¡¾å®¢
        function spawnRandomCustomer() {
            // 70%æ¦‚ç‡ç”Ÿæˆç‰¹æ®Šé¡¾å®¢ï¼ˆæœ‰åå­—çš„ï¼‰ï¼Œä¾¿äºæµ‹è¯•è®¿é—®è®°å½•åŠŸèƒ½
            const isVIP = Math.random() < 0.7;
            const customerName = isVIP
                ? gameData.customerNames[Math.floor(Math.random() * gameData.customerNames.length)]
                : "æ™®é€šé¡¾å®¢";

            // é€‰æ‹©è®¢å•ç±»å‹ï¼šèŒ¶é¥®æˆ–çƒ¤è‚‰
            let orderType = 'tea';
            let orderChoice = '';

            // å¦‚æœçƒ¤è‚‰æ¶å·²è§£é”ï¼Œ30%æ¦‚ç‡ç‚¹çƒ¤è‚‰ï¼Œ70%æ¦‚ç‡ç‚¹èŒ¶é¥®
            if (gameData.grillSystem && gameData.grillSystem.unlocked && Math.random() < 0.3) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„çƒ¤è‚‰ç±»é£Ÿå“
                const availableGrilledFoods = gameData.madeTeas.filter(tea => tea.type === 'grilled');
                if (availableGrilledFoods.length > 0) {
                    orderType = 'grilled';
                    orderChoice = availableGrilledFoods[Math.floor(Math.random() * availableGrilledFoods.length)].name;
                } else {
                    // æ²¡æœ‰çƒ¤è‚‰ç±»é£Ÿå“ï¼Œå›é€€åˆ°èŒ¶é¥®
                    orderType = 'tea';
                }
            }

            if (orderType === 'tea') {
                // åªä»åˆå§‹çš„ç®€å•é…æ–¹ä¸­é€‰æ‹©ï¼ˆé¿å…é€‰æ‹©æœªè§£é”çš„å¤æ‚é…æ–¹ï¼‰
                const basicRecipes = ['äº”å‘³å­é¥®', 'æŸ æª¬èŒ¶'];
                orderChoice = basicRecipes[Math.floor(Math.random() * basicRecipes.length)];
            }

            // ä¿®æ”¹è€å¿ƒæ—¶é—´ï¼šæ™®é€šé¡¾å®¢120ç§’ï¼Œç‰¹æ®Šé¡¾å®¢240ç§’
            const patience = isVIP ? 240000 : 120000;

            // æ›´æ–°é¡¾å®¢çŠ¶æ€
            gameData.customer = {
                active: true,
                name: customerName,
                isVIP: isVIP,
                orderType: orderType,
                teaChoice: orderType === 'tea' ? orderChoice : '',
                grilledChoice: orderType === 'grilled' ? orderChoice : '',
                toppingChoices: [],
                arrivalTime: Date.now(),
                patience: patience,
                maxPatience: patience,
                served: false
            };

            // åªæœ‰èŒ¶é¥®è®¢å•æ‰éœ€è¦å°æ–™
            if (orderType === 'tea') {
                // éšæœºé€‰æ‹©0-2ä¸ªå°æ–™
                const possibleToppings = [
                    "çº¢ç³–", "è–„è·å¶", "å§œä¸", "æŸšå­ä¸", "é“¶è€³ä¸", "æŸ æª¬ç‰‡", "èœ‚èœœ",
                    "å†°ç³–", "ä¹Œé¾™èŒ¶åŒ…", "å¹²æ¡‚èŠ±", "å°åœ†å­", "é…’é…¿", "æ°´èœœæ¡ƒæœè‚‰", "é»„èŠªç‰‡"
                ];

                const numToppings = Math.floor(Math.random() * 3); // 0-2ä¸ªå°æ–™
                for (let i = 0; i < numToppings; i++) {
                    const topping = possibleToppings[Math.floor(Math.random() * possibleToppings.length)];
                    if (!gameData.customer.toppingChoices.includes(topping)) {
                        gameData.customer.toppingChoices.push(topping);
                    }
                }
            }

            // æ˜¾ç¤ºé¡¾å®¢æ¶ˆæ¯
            let customerMessage = `${customerName} æ¥åˆ°èŒ¶åº—ï¼Œæƒ³è¦ä¸€æ¯ ${teaChoice}`;
            if (gameData.customer.toppingChoices.length > 0) {
                customerMessage += `ï¼ŒåŠ ${gameData.customer.toppingChoices.join('ã€')}`;
            }
            addDebugLog(customerMessage);

            updateCustomerDisplay();
        }

        // æ›´æ–°é¡¾å®¢å’Œè®¿å®¢çŠ¶æ€æ˜¾ç¤º
        function updateCustomerDisplay() {
            const currentCustomer = document.getElementById('current-customer');
            const customerStatus = document.getElementById('customer-status');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰çŒ«å’ªåœ¨åœº
            if (gameData.cats && gameData.cats.currentCat) {
                const cat = gameData.cats.currentCat;
                const elapsed = Date.now() - cat.arrivalTime;
                const remaining = Math.max(0, cat.stayDuration - elapsed);
                
                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    
                    if (currentCustomer) {
                        currentCustomer.innerHTML = `<tr><td><span class="badge bg-warning">${cat.name}</span></td><td class="text-end">çŒ«å’ªè®¿å®¢</td><td class="text-end">${minutes}:${seconds.toString().padStart(2, '0')}</td><td><div class="progress"><div class="progress-bar bg-warning" style="width: ${(remaining / cat.stayDuration * 100)}%"></div></div></td></tr>`;
                    }
                    
                    if (customerStatus) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰èŒ¶é¥®å’Œå°é±¼å¹²
                        const hasTeas = gameData.madeTeas.length > 0;
                        const toppingsCount = gameData.toppings['å°é±¼å¹²'] || 0;
                        const materialsCount = (gameData.materials && gameData.materials['å°é±¼å¹²']) || 0;
                        const hasFish = (toppingsCount + materialsCount) > 0;

                        customerStatus.innerHTML = `
                            <div class="alert alert-warning">
                                <div><strong>ğŸ± ${cat.name} æ¥è®¿</strong></div>
                                <div style="margin: 10px 0;">å¯ä»¥å–‚é£Ÿå¢åŠ äº²å¯†åº¦</div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="action-btn" onclick="feedCatWithTea('${cat.name}')" ${hasTeas ? '' : 'disabled'}>
                                        ${hasTeas ? 'ğŸµ å–‚èŒ¶é¥®' : 'ğŸµ æ— èŒ¶é¥®'}
                                    </button>
                                    <button class="action-btn" onclick="feedCatWithFish('${cat.name}')" ${hasFish ? '' : 'disabled'}>
                                        ${hasFish ? 'ğŸŸ å–‚å°é±¼å¹²' : 'ğŸŸ æ— å°é±¼å¹²'}
                                    </button>
                                    <button class="action-btn" onclick="petCat('${cat.name}')">
                                        ğŸ¤² æ’¸çŒ«
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    return;
                } else {
                    // çŒ«å’ªç¦»å¼€
                    gameData.cats.currentCat = null;
                    addDebugLog('çŒ«å’ªç¦»å¼€äº†èŒ¶åº—');
                }
            }
            
            // æ™®é€šé¡¾å®¢é€»è¾‘
            if (gameData.customer.active) {
                const elapsed = Date.now() - gameData.customer.arrivalTime;
                const remaining = Math.max(0, gameData.customer.patience - elapsed);
                const percentage = (remaining / gameData.customer.maxPatience) * 100;
                
                if (remaining <= 0) {
                    // é¡¾å®¢å¤±å»è€å¿ƒç¦»å¼€
                    addDebugLog('é¡¾å®¢ ' + gameData.customer.name + ' ç­‰å¾—ä¸è€çƒ¦ï¼Œç¦»å¼€äº†');
                    resetCustomer();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const vipText = gameData.customer.isVIP ? ' (VIP)' : '';
                
                // æ˜¾ç¤ºè®¢å•å†…å®¹
                const orderDisplay = gameData.customer.orderType === 'grilled'
                    ? gameData.customer.grilledChoice
                    : gameData.customer.teaChoice;

                if (currentCustomer) {
                    currentCustomer.innerHTML = `<tr><td><span class="badge bg-success">${gameData.customer.name}${vipText}</span></td><td class="text-end">${orderDisplay}</td><td class="text-end">${minutes}:${seconds.toString().padStart(2, '0')}</td><td><div class="progress"><div class="progress-bar bg-success" style="width: ${percentage}%"></div></div></td></tr>`;
                }

                if (customerStatus) {
                    let statusText = '';
                    if (gameData.customer.orderType === 'grilled') {
                        statusText = `é¡¾å®¢æƒ³è¦ï¼š${gameData.customer.grilledChoice}`;
                    } else {
                        const toppingText = gameData.customer.toppingChoices.length > 0
                            ? 'ï¼Œè¦åŠ ' + gameData.customer.toppingChoices.join('ã€')
                            : '';
                        statusText = `é¡¾å®¢æƒ³è¦ï¼š${gameData.customer.teaChoice}${toppingText}`;
                    }
                    // æ£€æŸ¥è¿›åº¦çŠ¶æ€
                    const progress = gameData.customer.progress || {};
                    const teaSubmitted = progress.teaSubmitted || false;
                    const toppingsSubmitted = progress.toppingsSubmitted || false;
                    
                    let serviceButtons = '';

                    if (gameData.customer.orderType === 'grilled') {
                        // çƒ¤è‚‰ç±»è®¢å•
                        const hasGrilledFood = gameData.madeTeas.some(tea =>
                            tea.type === 'grilled' && tea.name === gameData.customer.grilledChoice);

                        addDebugLog(`ğŸ” æ£€æŸ¥çƒ¤è‚‰åº“å­˜ï¼šéœ€è¦${gameData.customer.grilledChoice}ï¼Œæ‰¾åˆ°ï¼š${hasGrilledFood}`);
                        addDebugLog(`ğŸ” å½“å‰åº“å­˜ï¼š${gameData.madeTeas.filter(tea => tea.type === 'grilled').map(tea => tea.name).join(', ')}`);

                        const grilledBtnText = hasGrilledFood ? 'æä¾›çƒ¤è‚‰' : 'åˆ¶ä½œä¸­...';
                        const grilledBtnDisabled = hasGrilledFood ? '' : 'disabled';

                        serviceButtons = `
                            <button class="action-btn primary" onclick="serveGrilledFood()" ${grilledBtnDisabled}>
                                ${grilledBtnText}
                            </button>
                        `;
                    } else {
                        // èŒ¶é¥®è®¢å•
                        const hasTea = gameData.madeTeas.some(tea => tea.name === gameData.customer.teaChoice);

                        // æ£€æŸ¥å°æ–™æ˜¯å¦å……è¶³
                        const hasAllToppings = gameData.customer.toppingChoices.every(topping =>
                            gameData.toppings[topping] && gameData.toppings[topping] > 0);

                        const teaBtnText = teaSubmitted ? 'âœ“ å·²æäº¤' : (hasTea ? 'æäº¤èŒ¶é¥®' : 'åˆ¶ä½œä¸­...');
                        const teaBtnDisabled = teaSubmitted ? 'disabled' : (hasTea ? '' : 'disabled');

                        const toppingBtnText = toppingsSubmitted ? 'âœ“ å·²æäº¤' : (hasAllToppings ? 'æäº¤å°æ–™' : 'ç¼ºå°‘å°æ–™');
                        const toppingBtnDisabled = toppingsSubmitted ? 'disabled' : (hasAllToppings ? '' : 'disabled');

                        // å®Œæ•´æœåŠ¡æŒ‰é’®
                        const needsToppings = gameData.customer.toppingChoices.length > 0;
                        const canCompleteOrder = teaSubmitted && (!needsToppings || toppingsSubmitted);
                        const completeBtnText = canCompleteOrder ? 'å®Œæˆè®¢å•' : 'å‡†å¤‡ä¸­...';
                        const completeBtnDisabled = canCompleteOrder ? '' : 'disabled';

                        serviceButtons = `
                            <button class="action-btn" onclick="submitTeaOnly()" ${teaBtnDisabled}>
                                ${teaBtnText}
                            </button>
                            ${gameData.customer.toppingChoices.length > 0 ? `
                            <button class="action-btn" onclick="submitToppingsOnly()" ${toppingBtnDisabled}>
                                ${toppingBtnText}
                            </button>` : ''}
                            <button class="action-btn primary" onclick="serveCustomerFromButton()" ${completeBtnDisabled}>
                                ${completeBtnText}
                            </button>
                        `;
                    }

                    if (customerStatus) {
                        customerStatus.innerHTML = `
                            <div class="alert alert-info">
                                <div><strong>é¡¾å®¢éœ€æ±‚ï¼š</strong>${statusText}</div>
                                <div class="mt-2" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${serviceButtons}
                                </div>
                            </div>`;
                    }
                }
            } else {
                if (currentCustomer) {
                    currentCustomer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— é¡¾å®¢</td></tr>';
                }
                if (customerStatus) {
                    customerStatus.innerHTML = '<div class="alert alert-secondary">ç­‰å¾…é¡¾å®¢åˆ°æ¥...</div>';
                }
            }
        }

        // é‡ç½®é¡¾å®¢çŠ¶æ€
        function resetCustomer() {
            gameData.customer = {
                active: false,
                name: "ç­‰å¾…é¡¾å®¢åˆ°æ¥",
                isVIP: false,
                teaChoice: null,
                toppingChoices: [],
                arrivalTime: 0,
                patience: 120000,
                maxPatience: 120000,
                served: false,
                progress: {} // æ¸…é™¤è¿›åº¦çŠ¶æ€
            };
            gameData.lastCustomerTime = Date.now();
            updateCustomerDisplay();
        }

        // ä»æŒ‰é’®æœåŠ¡é¡¾å®¢ - å®Œæˆæ•´ä¸ªè®¢å•
        function serveCustomerFromButton() {
            if (!gameData.customer.active) {
                addDebugLog('å½“å‰æ²¡æœ‰é¡¾å®¢');
                return;
            }
            
            const progress = gameData.customer.progress || {};
            const needsToppings = gameData.customer.toppingChoices.length > 0;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€é¡¹ç›®éƒ½å·²æäº¤
            if (!progress.teaSubmitted) {
                addDebugLog('èŒ¶é¥®å°šæœªæäº¤ï¼');
                showAlert('è¯·å…ˆæäº¤èŒ¶é¥®ï¼', 'æœåŠ¡æé†’', 'ğŸµ');
                return;
            }

            if (needsToppings && !progress.toppingsSubmitted) {
                addDebugLog('å°æ–™å°šæœªæäº¤ï¼');
                showAlert('è¯·å…ˆæäº¤å°æ–™ï¼', 'æœåŠ¡æé†’', 'ğŸ§‚');
                return;
            }
            
            // è®¡ç®—æ”¶å…¥
            const basePrice = 15;
            const toppingBonus = gameData.customer.toppingChoices.length * 2;
            const vipBonus = gameData.customer.isVIP ? 5 : 0;
            const totalPrice = basePrice + toppingBonus + vipBonus;
            
            gameData.funds += totalPrice;

            // å®æ—¶è®°å½•é¡¾å®¢è®¿é—®åˆ°æ•°æ®åº“
            const customerType = gameData.customerNames.includes(gameData.customer.name) ? 'vip' : 'normal';
            const customerName = gameData.customer.name;
            const teaServed = gameData.customer.teaChoice || '';
            const toppingsServed = gameData.customer.toppingChoices.join(', ') || '';

            // ç«‹å³è®°å½•åˆ°æ•°æ®åº“
            recordCustomerVisitToDatabase(customerName, customerType, teaServed, toppingsServed, totalPrice);

            // è®°å½•ç‰¹æ®Šé¡¾å®¢è®¿é—®ï¼ˆä¸ä»…é™äºVIPï¼‰
            if (gameData.customerNames.includes(gameData.customer.name)) {
                if (!gameData.customerVisits) {
                    gameData.customerVisits = {};
                    addDebugLog('åˆå§‹åŒ–customerVisitså¯¹è±¡');
                }

                const oldCount = gameData.customerVisits[gameData.customer.name] || 0;
                gameData.customerVisits[gameData.customer.name] = oldCount + 1;
                const newCount = gameData.customerVisits[gameData.customer.name];

                // åŒæ­¥æ›´æ–°customersè¡¨ä¸­çš„visitsè®¡æ•°
                if (gameData.customers && gameData.customers[gameData.customer.name]) {
                    gameData.customers[gameData.customer.name].visits = newCount;
                }

                addDebugLog(`ğŸ“Š ${gameData.customer.name} è®¿é—®æ¬¡æ•°æ›´æ–°ï¼š${oldCount} â†’ ${newCount}`);

                // æ£€æŸ¥é…æ–¹è§£é”å’Œç‰¹æ®ŠåŠŸèƒ½è§£é”
                checkRecipeUnlock(gameData.customer.name);
                checkSpecialFeatureUnlock(gameData.customer.name);

                // æ£€æŸ¥å½©è›‹ç è§¦å‘
                checkEasterEggTrigger(gameData.customer.name);
            } else {
                // æ™®é€šé¡¾å®¢è®¡æ•°
                gameData.servedCustomers++;
                addDebugLog(`ğŸ“Š æ™®é€šé¡¾å®¢æœåŠ¡å®Œæˆï¼Œæ€»æœåŠ¡é¡¾å®¢æ•°ï¼š${gameData.servedCustomers}`);
            }

            addDebugLog(`æˆåŠŸæœåŠ¡é¡¾å®¢ ${gameData.customer.name}ï¼Œè·å¾—${totalPrice}é‡‘å¸`);
            showAlert(`è®¢å•å®Œæˆï¼è·å¾—${totalPrice}é‡‘å¸`, 'è®¢å•å®Œæˆ', 'ğŸ’°');

            resetCustomer();
            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            updateAllInventoryDisplay();

            // æ£€æŸ¥äººæ•°è§£é”
            checkCustomerCountUnlock();

            saveGameDataToDatabase();
        }

        // åªæäº¤èŒ¶é¥®
        function submitTeaOnly() {
            if (!gameData.customer.active) {
                addDebugLog('å½“å‰æ²¡æœ‰é¡¾å®¢');
                return;
            }
            
            const requiredTea = gameData.customer.teaChoice;
            const tea = gameData.madeTeas.find(tea => tea.name === requiredTea);
            
            if (!tea) {
                addDebugLog(`æ²¡æœ‰åˆ¶ä½œå¥½çš„${requiredTea}ï¼Œè¯·å…ˆåˆ¶ä½œï¼`);
                showAlert(`æ²¡æœ‰åˆ¶ä½œå¥½çš„${requiredTea}ï¼Œè¯·å…ˆåˆ¶ä½œï¼`, 'èŒ¶é¥®ä¸è¶³', 'ğŸµ');
                return;
            }
            
            // æ¶ˆè€—èŒ¶é¥®
            const teaIndex = gameData.madeTeas.findIndex(tea => tea.name === requiredTea);
            if (teaIndex !== -1) {
                gameData.madeTeas.splice(teaIndex, 1);
            }
            
            // æ ‡è®°èŒ¶é¥®å·²æäº¤
            if (!gameData.customer.progress) {
                gameData.customer.progress = {};
            }
            gameData.customer.progress.teaSubmitted = true;
            
            addDebugLog(`å·²æäº¤èŒ¶é¥®ï¼š${requiredTea}`);
            showAlert(`å·²æäº¤èŒ¶é¥®ï¼š${requiredTea}`, 'æäº¤æˆåŠŸ', 'âœ…');
            
            updateAllInventoryDisplay();
            updateCustomerDisplay();

            // æ£€æŸ¥äººæ•°è§£é”
            checkCustomerCountUnlock();

            saveGameDataToDatabase();
        }

        // åªæäº¤å°æ–™
        function submitToppingsOnly() {
            if (!gameData.customer.active) {
                addDebugLog('å½“å‰æ²¡æœ‰é¡¾å®¢');
                return;
            }
            
            const customerToppings = gameData.customer.toppingChoices || [];
            
            // æ£€æŸ¥å°æ–™æ˜¯å¦å……è¶³
            for (let topping of customerToppings) {
                if (!gameData.toppings[topping] || gameData.toppings[topping] <= 0) {
                    addDebugLog(`ç¼ºå°‘é¡¾å®¢è¦æ±‚çš„å°æ–™ï¼š${topping}`);
                    showAlert(`ç¼ºå°‘é¡¾å®¢è¦æ±‚çš„å°æ–™ï¼š${topping}`, 'å°æ–™ä¸è¶³', 'ğŸ§‚');
                    return;
                }
            }
            
            // æ¶ˆè€—å°æ–™
            customerToppings.forEach(topping => {
                if (gameData.toppings[topping] > 0) {
                    gameData.toppings[topping]--;
                }
            });
            
            // æ ‡è®°å°æ–™å·²æäº¤
            if (!gameData.customer.progress) {
                gameData.customer.progress = {};
            }
            gameData.customer.progress.toppingsSubmitted = true;
            
            addDebugLog(`å·²æäº¤å°æ–™ï¼š${customerToppings.join('ã€')}`);
            showAlert(`å·²æäº¤å°æ–™ï¼š${customerToppings.join('ã€')}`, 'æäº¤æˆåŠŸ', 'âœ…');
            
            updateAllInventoryDisplay();
            updateCustomerDisplay();
            saveGameDataToDatabase();
        }

        // æœåŠ¡é¡¾å®¢
        function serveCustomer(teaName) {
            if (gameData.cats && gameData.cats.currentCat) {
                // å–‚é£ŸçŒ«å’ª
                const cat = gameData.cats.currentCat;
                feedCat(cat.name, teaName);
                return;
            }

            if (!gameData.customer.active) {
                addDebugLog('å½“å‰æ²¡æœ‰é¡¾å®¢');
                return;
            }

            if (teaName !== gameData.customer.teaChoice) {
                addDebugLog(`é¡¾å®¢è¦çš„æ˜¯ ${gameData.customer.teaChoice}ï¼Œä¸æ˜¯ ${teaName}`);
                return;
            }

            // æ£€æŸ¥å°æ–™è¦æ±‚
            const customerToppings = gameData.customer.toppingChoices || [];
            for (let topping of customerToppings) {
                if (!gameData.toppings[topping] || gameData.toppings[topping] <= 0) {
                    addDebugLog(`ç¼ºå°‘é¡¾å®¢è¦æ±‚çš„å°æ–™ï¼š${topping}`);
                    return;
                }
            }

            // æ¶ˆè€—å°æ–™
            customerToppings.forEach(topping => {
                if (gameData.toppings[topping] > 0) {
                    gameData.toppings[topping]--;
                }
            });

            // è®¡ç®—æ”¶å…¥
            const basePrice = 15;
            const toppingBonus = customerToppings.length * 2;
            const vipBonus = gameData.customer.isVIP ? 5 : 0;
            const totalPrice = basePrice + toppingBonus + vipBonus;

            gameData.funds += totalPrice;

            // å®æ—¶è®°å½•é¡¾å®¢è®¿é—®åˆ°æ•°æ®åº“
            const customerType = gameData.customerNames.includes(gameData.customer.name) ? 'vip' : 'normal';
            const customerName = gameData.customer.name;

            // ç«‹å³è®°å½•åˆ°æ•°æ®åº“
            recordCustomerVisitToDatabase(customerName, customerType, '', toppingsText, totalPrice);

            // è®°å½•ç‰¹æ®Šé¡¾å®¢è®¿é—®ï¼ˆä¸ä»…é™äºVIPï¼‰
            if (gameData.customerNames.includes(gameData.customer.name)) {
                if (!gameData.customerVisits) {
                    gameData.customerVisits = {};
                    addDebugLog('åˆå§‹åŒ–customerVisitså¯¹è±¡');
                }

                const oldCount = gameData.customerVisits[gameData.customer.name] || 0;
                gameData.customerVisits[gameData.customer.name] = oldCount + 1;
                const newCount = gameData.customerVisits[gameData.customer.name];

                // åŒæ­¥æ›´æ–°customersè¡¨ä¸­çš„visitsè®¡æ•°
                if (gameData.customers && gameData.customers[gameData.customer.name]) {
                    gameData.customers[gameData.customer.name].visits = newCount;
                }

                addDebugLog(`ğŸ“Š ${gameData.customer.name} è®¿é—®æ¬¡æ•°æ›´æ–°ï¼š${oldCount} â†’ ${newCount}`);

                // æ£€æŸ¥é…æ–¹è§£é”å’Œç‰¹æ®ŠåŠŸèƒ½è§£é”
                checkRecipeUnlock(gameData.customer.name);
                checkSpecialFeatureUnlock(gameData.customer.name);
            } else {
                // æ™®é€šé¡¾å®¢è®¡æ•°
                gameData.servedCustomers++;
                addDebugLog(`ğŸ“Š æ™®é€šé¡¾å®¢æœåŠ¡å®Œæˆï¼Œæ€»æœåŠ¡é¡¾å®¢æ•°ï¼š${gameData.servedCustomers}`);
            }

            addDebugLog(`æˆåŠŸæœåŠ¡é¡¾å®¢ ${gameData.customer.name}ï¼Œè·å¾—${totalPrice}é‡‘å¸`);

            // ä»æˆå“èŒ¶ä¸­ç§»é™¤
            const teaIndex = gameData.madeTeas.findIndex(tea => tea.name === teaName);
            if (teaIndex !== -1) {
                gameData.madeTeas.splice(teaIndex, 1);
            }

            resetCustomer();
            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            updateAllInventoryDisplay();
        }

        // å–‚é£ŸçŒ«å’ª
        function feedCat(catName, teaName) {
            if (!gameData.cats.intimacy[catName]) {
                gameData.cats.intimacy[catName] = 0;
            }
            if (!gameData.cats.feedCount[catName]) {
                gameData.cats.feedCount[catName] = 0;
            }

            gameData.cats.intimacy[catName] = Math.min(5000, gameData.cats.intimacy[catName] + 10);
            gameData.cats.feedCount[catName]++;
            gameData.cats.lastSeen[catName] = Date.now();

            // ä»æˆå“èŒ¶ä¸­ç§»é™¤
            const teaIndex = gameData.madeTeas.findIndex(tea => tea.name === teaName);
            if (teaIndex !== -1) {
                gameData.madeTeas.splice(teaIndex, 1);
            }

            const intimacy = gameData.cats.intimacy[catName];
            let gifts = [];
            
            // æ ¹æ®äº²å¯†åº¦ç»™äºˆå¥–åŠ±
            if (intimacy >= 500 && intimacy < 1000) {
                gifts = ['å°é±¼å¹²'];
                gameData.toppings['èœ‚èœœ'] = (gameData.toppings['èœ‚èœœ'] || 0) + 1;
            } else if (intimacy >= 1000 && intimacy < 1500) {
                gifts = ['å°é±¼å¹²', 'èœ‚èœœ'];
                gameData.funds += 5;
            } else if (intimacy >= 1500) {
                gifts = ['é‡‘å¸', 'ç¨€æœ‰ææ–™'];
                gameData.funds += 10;
            }

            addDebugLog(`å–‚é£Ÿäº† ${catName}ï¼Œäº²å¯†åº¦å¢åŠ ï¼å½“å‰äº²å¯†åº¦ï¼š${intimacy}`);
            if (gifts.length > 0) {
                addDebugLog(`è·å¾—äº†çŒ«å’ªçš„ç¤¼ç‰©ï¼š${gifts.join('ã€')}`);
            }

            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            updateAllInventoryDisplay();
        }

        // ç”¨èŒ¶é¥®å–‚é£Ÿè®¿å®¢çŒ«å’ª
        function feedCatWithTea(catName) {
            if (gameData.madeTeas.length === 0) {
                showAlert('æ²¡æœ‰èŒ¶é¥®å¯ä»¥å–‚ç»™çŒ«å’ªï¼è¯·å…ˆåˆ¶ä½œä¸€äº›èŒ¶é¥®ã€‚', 'èŒ¶é¥®ä¸è¶³', 'ğŸµ');
                return;
            }

            // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„èŒ¶é¥®
            const tea = gameData.madeTeas[0];
            feedCat(catName, tea.name);

            // çŒ«å’ªç¦»å¼€
            gameData.cats.currentCat = null;
            addDebugLog(`${catName} åƒé¥±äº†ï¼Œæ»¡è¶³åœ°ç¦»å¼€äº†`);

            showAlert(`ç”¨${tea.name}å–‚é£Ÿäº†${catName}ï¼Œäº²å¯†åº¦å¢åŠ ï¼`, 'å–‚é£ŸæˆåŠŸ', 'ğŸ±');
            updateCustomerDisplay();
            saveGameDataToDatabase();
        }

        // ç”¨å°é±¼å¹²å–‚è®¿å®¢çŒ«å’ª
        function feedCatWithFish(catName) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å°é±¼å¹²ï¼ˆæ£€æŸ¥toppingså’Œmaterialsä¸¤ä¸ªåº“å­˜ï¼‰
            const toppingsCount = gameData.toppings['å°é±¼å¹²'] || 0;
            const materialsCount = (gameData.materials && gameData.materials['å°é±¼å¹²']) || 0;
            const totalFishCount = toppingsCount + materialsCount;

            if (totalFishCount <= 0) {
                showAlert('æ²¡æœ‰å°é±¼å¹²äº†ï¼è¯·æ‰“çŒè·å¾—æˆ–åˆ°å°æ–™å•†åº—è´­ä¹°ã€‚', 'ç‰©å“ä¸è¶³', 'ğŸŸ');
                return;
            }

            // åˆå§‹åŒ–çŒ«å’ªæ•°æ®
            if (!gameData.cats.intimacy[catName]) {
                gameData.cats.intimacy[catName] = 0;
            }
            if (!gameData.cats.feedCount[catName]) {
                gameData.cats.feedCount[catName] = 0;
            }

            // å¢åŠ äº²å¯†åº¦ï¼ˆå°é±¼å¹²æ•ˆæœæ›´å¥½ï¼‰
            gameData.cats.intimacy[catName] = Math.min(5000, gameData.cats.intimacy[catName] + 20);
            gameData.cats.feedCount[catName]++;
            gameData.cats.lastSeen[catName] = Date.now();

            // æ¶ˆè€—å°é±¼å¹²ï¼ˆä¼˜å…ˆä»materialsä¸­æ¶ˆè€—ï¼Œç„¶åä»toppingsä¸­æ¶ˆè€—ï¼‰
            if (gameData.materials && gameData.materials['å°é±¼å¹²'] > 0) {
                const beforeCount = gameData.materials['å°é±¼å¹²'];
                gameData.materials['å°é±¼å¹²']--;
                const afterCount = gameData.materials['å°é±¼å¹²'];
                addDebugLog(`æ¶ˆè€—å°é±¼å¹²(æ‰“çŒ): ${beforeCount} â†’ ${afterCount} (-1)`);
            } else if (gameData.toppings['å°é±¼å¹²'] > 0) {
                const beforeCount = gameData.toppings['å°é±¼å¹²'];
                gameData.toppings['å°é±¼å¹²']--;
                const afterCount = gameData.toppings['å°é±¼å¹²'];
                addDebugLog(`æ¶ˆè€—å°é±¼å¹²(è´­ä¹°): ${beforeCount} â†’ ${afterCount} (-1)`);
            }

            addDebugLog(`ç”¨å°é±¼å¹²å–‚é£Ÿäº† ${catName}ï¼Œäº²å¯†åº¦å¢åŠ 20ï¼`);

            // çŒ«å’ªç¦»å¼€
            gameData.cats.currentCat = null;
            addDebugLog(`${catName} åƒé¥±äº†ï¼Œæ»¡è¶³åœ°ç¦»å¼€äº†`);

            showAlert(`ç”¨å°é±¼å¹²å–‚é£Ÿäº†${catName}ï¼Œäº²å¯†åº¦å¤§å¹…å¢åŠ ï¼`, 'å–‚é£ŸæˆåŠŸ', 'ğŸ±');
            updateCustomerDisplay();
            updateAllInventoryDisplay();
            saveGameDataToDatabase();
        }

        // æ’¸è®¿å®¢çŒ«å’ª
        function petCat(catName) {
            // åˆå§‹åŒ–çŒ«å’ªæ•°æ®
            if (!gameData.cats.intimacy[catName]) {
                gameData.cats.intimacy[catName] = 0;
            }

            // å¢åŠ å°‘é‡äº²å¯†åº¦
            gameData.cats.intimacy[catName] = Math.min(5000, gameData.cats.intimacy[catName] + 5);
            gameData.cats.lastSeen[catName] = Date.now();

            addDebugLog(`æ’¸äº†æ’¸ ${catName}ï¼Œäº²å¯†åº¦å¢åŠ 5`);

            // çŒ«å’ªç¦»å¼€
            gameData.cats.currentCat = null;
            addDebugLog(`${catName} äº«å—äº†ä¸€ç•ªï¼Œæ»¡è¶³åœ°ç¦»å¼€äº†`);

            showAlert(`æ’¸äº†æ’¸${catName}ï¼Œå®ƒå¾ˆå¼€å¿ƒï¼`, 'äº’åŠ¨æˆåŠŸ', 'ğŸ±');
            updateCustomerDisplay();
            saveGameDataToDatabase();
        }

        // ç”¨å°é±¼å¹²å–‚çŒ«ï¼ˆåŸç‰ˆå‡½æ•°ï¼Œç”¨äºçŒ«å’ªç®¡ç†ç•Œé¢ï¼‰
        function feedCatWithFish() {
            const selectedCatDiv = document.getElementById('selected-cat');
            if (!selectedCatDiv || !selectedCatDiv.innerHTML.includes('cat-name')) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€åªçŒ«å’ªï¼', 'çŒ«å’ªç³»ç»Ÿ', 'ğŸ±');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å°é±¼å¹²ï¼ˆæ£€æŸ¥toppingså’Œmaterialsä¸¤ä¸ªåº“å­˜ï¼‰
            const toppingsCount = gameData.toppings['å°é±¼å¹²'] || 0;
            const materialsCount = (gameData.materials && gameData.materials['å°é±¼å¹²']) || 0;
            const totalFishCount = toppingsCount + materialsCount;

            if (totalFishCount <= 0) {
                showAlert('æ²¡æœ‰å°é±¼å¹²äº†ï¼è¯·æ‰“çŒè·å¾—æˆ–åˆ°å°æ–™å•†åº—è´­ä¹°ã€‚', 'ç‰©å“ä¸è¶³', 'ğŸŸ');
                return;
            }

            // è·å–å½“å‰é€‰ä¸­çš„çŒ«å’ªåç§°
            const catNameElement = selectedCatDiv.querySelector('.cat-name');
            if (!catNameElement) {
                showAlert('æ— æ³•è·å–çŒ«å’ªä¿¡æ¯ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼', 'ç³»ç»Ÿé”™è¯¯', 'âŒ');
                return;
            }
            
            const catName = catNameElement.textContent;

            // ç¡®ä¿çŒ«å’ªæ•°æ®å­˜åœ¨
            if (!gameData.cats[catName]) {
                gameData.cats[catName] = {
                    avatar: ['ğŸ§¡', 'ğŸ±', 'ğŸ–¤', 'ğŸ¤', 'ğŸ˜º'][['å¤§æ©˜çŒ«', 'ç‹¸èŠ±çŒ«', 'é»‘çŒ«å°æ‰‹å¥—', 'å°ç™½çŒ«', 'å¤§çŒ«çŒ«'].indexOf(catName)],
                    intimacy: 0,
                    lastGift: null,
                    gifts: ['é‡‘å¸', 'ç§å­', 'é‡‘å¸', 'ç§å­']
                };
            }

            const cat = gameData.cats[catName];
            const beforeIntimacy = cat.intimacy;

            // æ¶ˆè€—å°é±¼å¹²ï¼ˆä¼˜å…ˆä»materialsä¸­æ¶ˆè€—ï¼Œç„¶åä»toppingsä¸­æ¶ˆè€—ï¼‰
            if (gameData.materials && gameData.materials['å°é±¼å¹²'] > 0) {
                const beforeCount = gameData.materials['å°é±¼å¹²'];
                gameData.materials['å°é±¼å¹²']--;
                const afterCount = gameData.materials['å°é±¼å¹²'];
                addDebugLog(`æ¶ˆè€—å°é±¼å¹²(æ‰“çŒ): ${beforeCount} â†’ ${afterCount} (-1)`);
            } else if (gameData.toppings['å°é±¼å¹²'] > 0) {
                const beforeCount = gameData.toppings['å°é±¼å¹²'];
                gameData.toppings['å°é±¼å¹²']--;
                const afterCount = gameData.toppings['å°é±¼å¹²'];
                addDebugLog(`æ¶ˆè€—å°é±¼å¹²(è´­ä¹°): ${beforeCount} â†’ ${afterCount} (-1)`);
            }

            // å°é±¼å¹²æ¯”èŒ¶é¥®æ›´å—çŒ«å’ªå–œçˆ±ï¼Œäº²å¯†åº¦å¢åŠ æ›´å¤š
            const intimacyGain = Math.floor(Math.random() * 50) + 50; // 50-99ç‚¹äº²å¯†åº¦
            cat.intimacy = Math.min(5000, cat.intimacy + intimacyGain);

            // åŒæ­¥åˆ°æ—§ç»“æ„ä¿è¯å…¼å®¹æ€§
            if (!gameData.cats.intimacy) {
                gameData.cats.intimacy = {};
            }
            gameData.cats.intimacy[catName] = cat.intimacy;

            const intimacy = cat.intimacy;
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é‡Œç¨‹ç¢‘å¹¶ç»™äºˆç¤¼ç‰©
            const milestones = [500, 1500, 3000, 5000];
            const reachedMilestone = milestones.find(milestone =>
                beforeIntimacy < milestone && cat.intimacy >= milestone
            );

            addDebugLog(`ç”¨å°é±¼å¹²å–‚é£Ÿäº† ${catName}ï¼Œäº²å¯†åº¦ ${beforeIntimacy} â†’ ${intimacy} (+${intimacyGain})`);

            if (reachedMilestone) {
                // è¾¾åˆ°é‡Œç¨‹ç¢‘ï¼Œç»™äºˆç‰¹æ®Šç¤¼ç‰©
                let gift = '';
                let giftDescription = '';

                if (reachedMilestone === 500) {
                    gift = 'å°é±¼å¹²';
                    gameData.toppings['å°é±¼å¹²'] = (gameData.toppings['å°é±¼å¹²'] || 0) + 5;
                    giftDescription = '5ä¸ªå°é±¼å¹²';
                } else if (reachedMilestone === 1500) {
                    gift = 'é‡‘å¸';
                    const goldReward = 80;
                    gameData.funds += goldReward;
                    giftDescription = `${goldReward}é‡‘å¸`;
                } else if (reachedMilestone === 3000) {
                    gift = 'ç¨€æœ‰ç§å­ + ç¨»é¦™æ‘è§£é”';
                    const rareSeeds = ['äº”å‘³å­', 'æ´›ç¥èŠ±', 'ç«ç‘°èŠ±'];
                    const randomSeed = rareSeeds[Math.floor(Math.random() * rareSeeds.length)];
                    gameData.seeds[randomSeed] = (gameData.seeds[randomSeed] || 0) + 3;
                    giftDescription = `3ä¸ª${randomSeed}ç§å­`;

                    // è§£é”ç¨»é¦™æ‘
                    if (!gameData.riceVillage) {
                        gameData.riceVillage = {
                            unlocked: true,
                            maxIntimacyCats: []
                        };
                    }

                    // æ·»åŠ åˆ°æ»¡çº§çŒ«å’ªåˆ—è¡¨
                    if (!gameData.riceVillage.maxIntimacyCats.includes(catName)) {
                        gameData.riceVillage.maxIntimacyCats.push(catName);
                        addDebugLog(`ğŸ® ${catName}è¾¾åˆ°3000äº²å¯†åº¦ï¼Œè§£é”ç¨»é¦™æ‘ï¼`);

                        // æ˜¾ç¤ºç¨»é¦™æ‘è§£é”æç¤º
                        setTimeout(() => {
                            const unlockContent = `
                                <div style="text-align: center; line-height: 1.6;">
                                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ® é‡å¤§å‘ç°ï¼</h3>
                                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border: 1px inset #c0c0c0;">
                                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">${catName} äº²å¯†åº¦è¾¾åˆ°3000ï¼</div>
                                        <div style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">ğŸ® è§£é”ç¨»é¦™æ‘ï¼</div>
                                        <div style="color: #666; font-size: 12px;">ä¸çŒ«å’ªä¼™ä¼´ä¸€èµ·è¸ä¸Šå†’é™©ä¹‹æ—…</div>
                                    </div>
                                </div>
                            `;
                            showWin95Modal('ç¨»é¦™æ‘è§£é”', unlockContent, 'ğŸ®');
                            updateRiceVillageDisplay();
                        }, 2000);
                    }
                } else if (reachedMilestone === 5000) {
                    gift = 'ç»ˆæç¤¼ç‰©';
                    gameData.funds += 150;
                    gameData.toppings['å°é±¼å¹²'] = (gameData.toppings['å°é±¼å¹²'] || 0) + 15;
                    giftDescription = '150é‡‘å¸ + 15ä¸ªå°é±¼å¹²';
                }

                cat.lastGift = giftDescription;
                addDebugLog(`ğŸ ${catName}è¾¾åˆ°${reachedMilestone}äº²å¯†åº¦é‡Œç¨‹ç¢‘ï¼èµ é€äº†ï¼š${giftDescription}`);

                showWin95Modal('çŒ«å’ªé‡Œç¨‹ç¢‘', `<div style="text-align: center; line-height: 1.6;"><div style="font-size: 12px; margin-bottom: 10px;">ğŸ‰ ${catName} è¾¾åˆ° ${reachedMilestone} äº²å¯†åº¦é‡Œç¨‹ç¢‘ï¼</div><div style="color: #d4af37; font-weight: bold;">è·å¾—å¥–åŠ±ï¼š${giftDescription}</div></div>`, 'ğŸ');
            }

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            updateAllInventoryDisplay();
            renderCatsTable();
            
            // é‡æ–°é€‰æ‹©çŒ«å’ªä»¥æ›´æ–°äº’åŠ¨åŒºåŸŸæ˜¾ç¤º
            selectCatForInteraction(catName);
            renderSelectedCat();
            
            // ä¿å­˜æ•°æ®
            saveGameDataToDatabase();
        }

        // æ›´æ–°ç¨»é¦™æ‘æ˜¾ç¤º
        function updateRiceVillageDisplay() {
            const riceVillageSection = document.getElementById('rice-village-section');

            // æ£€æŸ¥æ˜¯å¦åº”è¯¥è§£é”ç¨»é¦™æ‘
            checkAndUnlockRiceVillage();

            if (gameData.riceVillage && gameData.riceVillage.unlocked) {
                riceVillageSection.style.display = 'block';
                addDebugLog('ğŸ® ç¨»é¦™æ‘å…¥å£å·²æ˜¾ç¤º');
            } else {
                riceVillageSection.style.display = 'none';
            }
        }

        // æ£€æŸ¥å¹¶è§£é”ç¨»é¦™æ‘
        function checkAndUnlockRiceVillage() {
            console.log('æ£€æŸ¥ç¨»é¦™æ‘è§£é”æ¡ä»¶...');

            // å…ˆçœ‹çœ‹localStorageé‡Œéƒ½æœ‰ä»€ä¹ˆ
            console.log('localStorageæ‰€æœ‰é”®:', Object.keys(localStorage));

            // æ£€æŸ¥gameDataé‡Œæ˜¯å¦æœ‰çŒ«å’ª
            if (gameData && gameData.cats) {
                console.log('gameData.cats:', gameData.cats);
            }

            // ä»gameData.catsä¸­æ£€æŸ¥çŒ«å’ªäº²å¯†åº¦
            let maxIntimacyCat = null;

            if (gameData && gameData.cats) {
                console.log('æ£€æŸ¥gameData.catsä¸­çš„çŒ«å’ª...');

                // gameData.catsæ˜¯å¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„ï¼Œéœ€è¦éå†å±æ€§
                for (const catName in gameData.cats) {
                    const cat = gameData.cats[catName];
                    if (cat && typeof cat === 'object' && cat.intimacy) {
                        console.log(`æ£€æŸ¥çŒ«å’ª: ${catName}, äº²å¯†åº¦: ${cat.intimacy}`);

                        if (cat.intimacy >= 3000) {
                            maxIntimacyCat = { name: catName, intimacy: cat.intimacy, ...cat };
                            console.log(`å‘ç°ç¬¦åˆæ¡ä»¶çš„çŒ«å’ª: ${catName} (${cat.intimacy})`);
                            break; // æ‰¾åˆ°ä¸€åªå°±å¤Ÿäº†
                        }
                    }
                }
            }

            console.log('æœ€ç»ˆæ‰¾åˆ°çš„3000+äº²å¯†åº¦çŒ«å’ª:', maxIntimacyCat);

            if (maxIntimacyCat && (!gameData.riceVillage || !gameData.riceVillage.unlocked)) {
                console.log('æ»¡è¶³è§£é”æ¡ä»¶ï¼Œå¼€å§‹è§£é”ç¨»é¦™æ‘...');
                // è§£é”ç¨»é¦™æ‘
                if (!gameData.riceVillage) {
                    gameData.riceVillage = {
                        unlocked: true,
                        maxIntimacyCats: []
                    };
                } else {
                    gameData.riceVillage.unlocked = true;
                }

                // æ·»åŠ åˆ°æ»¡çº§çŒ«å’ªåˆ—è¡¨
                if (!gameData.riceVillage.maxIntimacyCats.includes(maxIntimacyCat.name)) {
                    gameData.riceVillage.maxIntimacyCats.push(maxIntimacyCat.name);
                    addDebugLog(`ğŸ® æ£€æµ‹åˆ°${maxIntimacyCat.name}å·²è¾¾åˆ°3000äº²å¯†åº¦ï¼Œè§£é”ç¨»é¦™æ‘ï¼`);

                    // æ˜¾ç¤ºç¨»é¦™æ‘è§£é”æç¤º
                    setTimeout(() => {
                        const unlockContent = `
                            <div style="text-align: center; line-height: 1.6;">
                                <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ® é‡å¤§å‘ç°ï¼</h3>
                                <div style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border: 1px inset #c0c0c0;">
                                    <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">${maxIntimacyCat.name} äº²å¯†åº¦å·²è¾¾åˆ°3000ï¼</div>
                                    <div style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">ğŸ® è§£é”ç¨»é¦™æ‘ï¼</div>
                                    <div style="color: #666; font-size: 12px;">ä¸çŒ«å’ªä¼™ä¼´ä¸€èµ·è¸ä¸Šå†’é™©ä¹‹æ—…</div>
                                </div>
                            </div>
                        `;
                        showWin95Modal('ç¨»é¦™æ‘è§£é”', unlockContent, 'ğŸ®');
                    }, 1000);
                }

                // ä¿å­˜æ•°æ®
                saveGameDataToDatabase();
            }
        }

        // è¿›å…¥ç¨»é¦™æ‘
        function enterRiceVillage() {
            if (!gameData.riceVillage || !gameData.riceVillage.unlocked) {
                showAlert('ç¨»é¦™æ‘å°šæœªè§£é”ï¼éœ€è¦ä»»æ„çŒ«å’ªè¾¾åˆ°3000äº²å¯†åº¦ã€‚', 'æœªè§£é”', 'ğŸ®');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¨»é¦™æ‘æ•°æ®ï¼ˆè¯´æ˜å·²ç»è¿›å…¥è¿‡ï¼‰
            const riceVillageData = localStorage.getItem('riceVillageData');
            if (riceVillageData) {
                try {
                    const data = JSON.parse(riceVillageData);
                    if (data.cat && data.cat.name && data.cat.name !== "çŒ«å’ªä¼™ä¼´") {
                        // å·²ç»æœ‰çŒ«å’ªåå­—ï¼Œç›´æ¥è¿›å…¥ç¨»é¦™æ‘
                        console.log('æ£€æµ‹åˆ°å·²æœ‰ç¨»é¦™æ‘æ•°æ®ï¼Œç›´æ¥è¿›å…¥');
                        window.location.href = `rice_village.html?catName=${encodeURIComponent(data.cat.name)}`;
                        return;
                    }
                } catch (e) {
                    console.log('ç¨»é¦™æ‘æ•°æ®è§£æå¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹');
                }
            }

            const maxIntimacyCats = gameData.riceVillage.maxIntimacyCats || [];
            if (maxIntimacyCats.length === 0) {
                showAlert('æ²¡æœ‰è¾¾åˆ°æœ€é«˜äº²å¯†åº¦çš„çŒ«å’ªï¼', 'æ— æ³•è¿›å…¥', 'ğŸ®');
                return;
            }

            if (maxIntimacyCats.length === 1) {
                // åªæœ‰ä¸€åªçŒ«å’ªï¼Œç›´æ¥è¿›å…¥å‘½åæµç¨‹
                const catName = maxIntimacyCats[0];
                showCatNamingDialog(catName);
            } else {
                // å¤šåªçŒ«å’ªï¼Œæ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                showCatSelectionDialog(maxIntimacyCats);
            }
        }

        // æ˜¾ç¤ºçŒ«å’ªé€‰æ‹©å¯¹è¯æ¡†
        function showCatSelectionDialog(cats) {
            let catOptions = '';
            cats.forEach(cat => {
                catOptions += `<button class="action-btn" onclick="selectCatForRiceVillage('${cat}')" style="margin: 5px; padding: 10px 15px;">${cat}</button>`;
            });

            const selectionContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ® é€‰æ‹©çŒ«å’ªä¼™ä¼´</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="color: #666; margin-bottom: 15px;">é€‰æ‹©ä¸€åªçŒ«å’ªä½œä¸ºä½ çš„å†’é™©ä¼™ä¼´ï¼š</div>
                        ${catOptions}
                    </div>
                </div>
            `;
            showWin95Modal('é€‰æ‹©çŒ«å’ªä¼™ä¼´', selectionContent, 'ğŸ®');
        }

        // é€‰æ‹©çŒ«å’ªè¿›å…¥ç¨»é¦™æ‘
        function selectCatForRiceVillage(catName) {
            closeWin95Modal();
            showCatNamingDialog(catName);
        }

        // æ˜¾ç¤ºçŒ«å’ªå‘½åå¯¹è¯æ¡†
        function showCatNamingDialog(catName) {
            const namingContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ® ä¸ºçŒ«å’ªèµ·å</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="color: #666; margin-bottom: 15px;">ä¸ºä½ çš„ä¼™ä¼´ ${catName} èµ·ä¸€ä¸ªå†’é™©åå­—ï¼š</div>
                        <input type="text" id="cat-adventure-name" placeholder="è¾“å…¥çŒ«å’ªçš„å†’é™©åå­—"
                               style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; margin-bottom: 15px;">
                        <br>
                        <button class="action-btn primary" onclick="confirmCatName('${catName}')">ç¡®è®¤å¹¶è¿›å…¥ç¨»é¦™æ‘</button>
                        <button class="action-btn" onclick="closeWin95Modal()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            showWin95Modal('çŒ«å’ªå‘½å', namingContent, 'ğŸ®');

            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const nameInput = document.getElementById('cat-adventure-name');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.value = catName; // é»˜è®¤ä½¿ç”¨åŸå
                }
            }, 100);
        }

        // ç¡®è®¤çŒ«å’ªåå­—å¹¶è¿›å…¥ç¨»é¦™æ‘
        function confirmCatName(originalCatName) {
            const nameInput = document.getElementById('cat-adventure-name');
            const adventureName = nameInput ? nameInput.value.trim() : '';

            if (!adventureName) {
                showAlert('è¯·è¾“å…¥çŒ«å’ªçš„å†’é™©åå­—ï¼', 'åå­—ä¸èƒ½ä¸ºç©º', 'ğŸ®');
                return;
            }

            // ä¿å­˜çŒ«å’ªå†’é™©åå­—
            if (!gameData.riceVillage.catNames) {
                gameData.riceVillage.catNames = {};
            }
            gameData.riceVillage.catNames[originalCatName] = adventureName;

            addDebugLog(`ğŸ® ${originalCatName} çš„å†’é™©åå­—è®¾ä¸ºï¼š${adventureName}`);

            // ä¿å­˜æ•°æ®
            saveGameDataToDatabase();

            // å…³é—­å¯¹è¯æ¡†
            closeWin95Modal();

            // è¿›å…¥ç¨»é¦™æ‘
            window.open(`rice_village.html?catName=${encodeURIComponent(adventureName)}`, '_blank');
        }

        // æ£€æŸ¥é…æ–¹è§£é”
        function checkRecipeUnlock(customerName) {
            if (!gameData.customerVisits || !gameData.recipeUnlockRules) return;

            const visitCount = gameData.customerVisits[customerName] || 0;
            
            Object.keys(gameData.recipeUnlockRules).forEach(recipeName => {
                const rule = gameData.recipeUnlockRules[recipeName];
                
                if (rule.customer === customerName && 
                    visitCount >= rule.visitsRequired &&
                    !Object.keys(gameData.teaRecipes).includes(recipeName)) {
                    
                    // æ£€æŸ¥è§£é”å‡ ç‡
                    const shouldUnlock = visitCount >= rule.guaranteedOnVisit || Math.random() < rule.chance;
                    
                    if (shouldUnlock) {
                        // æ·»åŠ åˆ°èŒ¶é¥®é…æ–¹æ•°æ®
                        switch(recipeName) {
                            case 'æ´›ç¥ç«ç‘°é¥®':
                                gameData.teaRecipes[recipeName] = ['æ´›ç¥èŠ±', 'ç«ç‘°èŠ±', 'å±±æ¥‚'];
                                break;
                            case 'æ¡‚åœ†çº¢æ£èŒ¶':
                                gameData.teaRecipes[recipeName] = ['æ¡‚åœ†', 'çº¢æ£', 'æ¸æ'];
                                break;
                            case 'ç„¦é¦™å¤§éº¦èŒ¶':
                                gameData.teaRecipes[recipeName] = ['å¤§éº¦'];
                                break;
                            case 'ä¸‰èŠ±å†³æ˜èŒ¶':
                                gameData.teaRecipes[recipeName] = ['èŠèŠ±', 'é‡‘é“¶èŠ±', 'å†³æ˜å­', 'æ¸æ'];
                                break;
                            case 'è–„è·ç”˜è‰å‡‰èŒ¶':
                                gameData.teaRecipes[recipeName] = ['è–„è·', 'ç”˜è‰'];
                                break;
                            case 'é™ˆçš®å§œç±³èŒ¶':
                                gameData.teaRecipes[recipeName] = ['é™ˆçš®', 'ç”Ÿå§œ'];
                                break;
                            case 'å†¬ç“œè·å¶é¥®':
                                gameData.teaRecipes[recipeName] = ['å†¬ç“œ', 'è·å¶', 'è–ç±³'];
                                break;
                            case 'å¤æ³•é…¸æ¢…æ±¤':
                                gameData.teaRecipes[recipeName] = ['ä¹Œæ¢…', 'å±±æ¥‚', 'é™ˆçš®', 'ç”˜è‰', 'æ¡‚èŠ±'];
                                break;
                            case 'å°åŠæ¢¨æ±¤':
                                gameData.teaRecipes[recipeName] = ['é›ªèŠ±æ¢¨', 'é“¶è€³', 'è¯æ¢…', 'æ¸æ'];
                                break;
                            // ç¥ç§˜é¡¾å®¢é…æ–¹
                            case 'é«˜çº§èŒ¶é¥®':
                                gameData.teaRecipes[recipeName] = ['é¾™äº•èŒ¶', 'äººå‚', 'çµèŠ', 'èœ‚èœœ'];
                                break;
                            case 'ç‰¹åˆ¶èŒ¶é¥®':
                                gameData.teaRecipes[recipeName] = ['æ™®æ´±èŒ¶', 'ä½•é¦–ä¹Œ', 'å½“å½’', 'çº¢æ£'];
                                break;
                            case 'åŠ¨ç‰©èŒ¶é¥®':
                                gameData.teaRecipes[recipeName] = ['é‡ç”ŸèŒ¶å¶', 'æ¾å­', 'æ ¸æ¡ƒ', 'èœ‚èœœ'];
                                break;
                        }
                        
                        addDebugLog(`ğŸ‰ è§£é”æ–°é…æ–¹ï¼š${recipeName}ï¼`);

                        // ç¥ç§˜é¡¾å®¢åˆ—è¡¨
                        const mysteriousCustomers = ['å§¬åˆ«æƒ…', 'æ± ä¹ä¿¡', 'ç‹¸æ€’'];

                        if (mysteriousCustomers.includes(customerName)) {
                            // ç¥ç§˜é¡¾å®¢åªæ˜¾ç¤ºé…æ–¹è§£é”ï¼Œä¸æ˜¾ç¤ºæ•…äº‹
                            const mysteriousContent = `
                                <div style="text-align: center; line-height: 1.6;">
                                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ‰ è§£é”æ–°é…æ–¹ï¼š${recipeName}</h3>
                                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                                        <div style="color: #666; margin-bottom: 8px;">ç¥ç§˜é¡¾å®¢ ${customerName}</div>
                                        <div style="font-style: italic; color: #444;">
                                            ${customerName === 'å§¬åˆ«æƒ…' ? 'ç¥ç§˜çš„æŠ€æœ¯ä¸“å®¶ï¼Œæ“…é•¿ä¿¡æ¯æ”¶é›†' :
                                              customerName === 'æ± ä¹ä¿¡' ? 'å­¦è€…å‹äººç‰©ï¼ŒçŸ¥è¯†æ¸Šåš' :
                                              'ä¸åŠ¨ç‰©æœ‰ç‰¹æ®Šè”ç³»çš„ç¥ç§˜è§’è‰²'}
                                        </div>
                                    </div>
                                    <div style="color: #888; font-size: 12px;">
                                        ç¥ç§˜é¡¾å®¢çš„æ•…äº‹éšè—åœ¨è¿·é›¾ä¸­...
                                    </div>
                                </div>
                            `;
                            showWin95Modal('ç¥ç§˜é…æ–¹è§£é”', mysteriousContent, 'ğŸ”®');
                        } else {
                            // æ™®é€šé¡¾å®¢æ˜¾ç¤ºå®Œæ•´æ•…äº‹
                            const story = gameData.customerStories[customerName];
                            if (story) {
                                const unlockContent = `
                                    <div style="text-align: center; margin-bottom: 15px;">
                                        <h3 style="color: #0040c0; margin: 0;">ğŸ‰ è§£é”æ–°é…æ–¹ï¼š${recipeName}</h3>
                                    </div>
                                    <div style="text-align: left; line-height: 1.6;">
                                        <h4 style="margin: 10px 0 5px 0; color: #0040c0;">${story.title}</h4>
                                        <div style="margin-bottom: 12px; padding: 8px; background: #f0f0f0; border: 1px inset #c0c0c0; font-style: italic;">
                                            ${story.content}
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <strong>èŒ¶é¥®åŠŸæ•ˆï¼š</strong><br>
                                            <span style="color: #006600;">${story.effect}</span>
                                        </div>
                                    </div>
                                `;
                                showWin95Modal(`${customerName} çš„æ•…äº‹`, unlockContent, 'ğŸ“–');
                            } else {
                                showAlert(`ğŸ‰ æ­å–œï¼è§£é”æ–°é…æ–¹ï¼š${recipeName}`, 'é…æ–¹è§£é”', 'ğŸ‰');
                            }
                        }
                    }
                }
            });
        }



        // é€‰æ‹©çŒ«å’ªè¿›è¡Œäº’åŠ¨
        function selectCatForInteraction(catName) {
            const selectedCatDiv = document.getElementById('selected-cat');
            const catData = gameData.cats[catName];
            const intimacy = catData ? catData.intimacy : 0;

            // è®¡ç®—ç­‰çº§å’Œåç§°
            let level = 1;
            let levelName = 'é™Œç”Ÿ';
            if (intimacy >= 5000) {
                level = 5;
                levelName = 'æŒšå‹';
            } else if (intimacy >= 3000) {
                level = 4;
                levelName = 'äº²å¯†';
            } else if (intimacy >= 1500) {
                level = 3;
                levelName = 'å‹å¥½';
            } else if (intimacy >= 500) {
                level = 2;
                levelName = 'ç†Ÿæ‚‰';
            }

            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„è¿›åº¦
            let nextMilestone = 500;
            let progressInLevel = intimacy;
            if (intimacy >= 5000) {
                nextMilestone = 5000;
                progressInLevel = 5000;
            } else if (intimacy >= 3000) {
                nextMilestone = 5000;
                progressInLevel = intimacy - 3000;
            } else if (intimacy >= 1500) {
                nextMilestone = 3000;
                progressInLevel = intimacy - 1500;
            } else if (intimacy >= 500) {
                nextMilestone = 1500;
                progressInLevel = intimacy - 500;
            }

            const progressPercent = intimacy >= 5000 ? 100 : (progressInLevel / (nextMilestone - (intimacy >= 3000 ? 3000 : intimacy >= 1500 ? 1500 : intimacy >= 500 ? 500 : 0))) * 100;

            selectedCatDiv.innerHTML = `
                <div class="cat-name" style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">${catName}</div>
                <div class="cat-intimacy" style="margin-bottom: 10px;">
                    äº²å¯†åº¦ï¼š${intimacy}/5000 (${levelName} Lv.${level})
                    <div class="intimacy-bar">
                        <div class="intimacy-progress" style="width: ${Math.min(100, progressPercent)}%;"></div>
                    </div>
                    ${intimacy < 5000 ? `è·ç¦»ä¸‹ä¸€é‡Œç¨‹ç¢‘ï¼š${nextMilestone - intimacy}` : 'å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼'}
                </div>
                <div class="cat-status" style="color: #6c757d; font-size: 12px;">
                    ${catData && catData.lastGift ? `ä¸Šæ¬¡ç¤¼ç‰©ï¼š${catData.lastGift}` : 'è¿˜æ²¡æœ‰æ”¶åˆ°è¿‡ç¤¼ç‰©'}
                </div>
            `;

            gameData.selectedCat = catName;
            addDebugLog(`é€‰æ‹©äº†çŒ«å’ªï¼š${catName} è¿›è¡Œäº’åŠ¨`);
        }

        // æ¸²æŸ“é€‰ä¸­çš„çŒ«å’ªæ˜¾ç¤ºåŒºåŸŸ
        function renderSelectedCat() {
            if (!gameData.selectedCat) return;

            const selectedCatDiv = document.getElementById('selected-cat');
            const catData = gameData.cats[gameData.selectedCat];
            const intimacy = catData ? catData.intimacy : 0;

            // è®¡ç®—ç­‰çº§å’Œåç§°
            let level = 1;
            let levelName = 'é™Œç”Ÿ';
            if (intimacy >= 5000) {
                level = 5;
                levelName = 'æŒšå‹';
            } else if (intimacy >= 3000) {
                level = 4;
                levelName = 'äº²å¯†';
            } else if (intimacy >= 1500) {
                level = 3;
                levelName = 'å‹å¥½';
            } else if (intimacy >= 500) {
                level = 2;
                levelName = 'ç†Ÿæ‚‰';
            }

            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘çš„è¿›åº¦
            let nextMilestone = 500;
            let progressInLevel = intimacy;
            if (intimacy >= 5000) {
                nextMilestone = 5000;
                progressInLevel = 5000;
            } else if (intimacy >= 3000) {
                nextMilestone = 5000;
                progressInLevel = intimacy - 3000;
            } else if (intimacy >= 1500) {
                nextMilestone = 3000;
                progressInLevel = intimacy - 1500;
            } else if (intimacy >= 500) {
                nextMilestone = 1500;
                progressInLevel = intimacy - 500;
            }

            const progressPercent = intimacy >= 5000 ? 100 : (progressInLevel / (nextMilestone - (intimacy >= 3000 ? 3000 : intimacy >= 1500 ? 1500 : intimacy >= 500 ? 500 : 0))) * 100;

            selectedCatDiv.innerHTML = `
                <div class="cat-name" style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">${gameData.selectedCat}</div>
                <div class="cat-intimacy" style="margin-bottom: 10px;">
                    äº²å¯†åº¦ï¼š${intimacy}/5000 (${levelName} Lv.${level})
                    <div class="intimacy-bar">
                        <div class="intimacy-progress" style="width: ${Math.min(100, progressPercent)}%;"></div>
                    </div>
                    ${intimacy < 5000 ? `è·ç¦»ä¸‹ä¸€é‡Œç¨‹ç¢‘ï¼š${nextMilestone - intimacy}` : 'å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼'}
                </div>
                <div class="cat-status" style="color: #6c757d; font-size: 12px;">
                    ${catData && catData.lastGift ? `ä¸Šæ¬¡ç¤¼ç‰©ï¼š${catData.lastGift}` : 'è¿˜æ²¡æœ‰æ”¶åˆ°è¿‡ç¤¼ç‰©'}
                </div>
            `;
        }

        function feedCat() {
            if (!gameData.selectedCat) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€åªçŒ«å’ªï¼', 'çŒ«å’ªç³»ç»Ÿ', 'ğŸ±');
                return;
            }

            if (gameData.madeTeas.length === 0) {
                showAlert('æ²¡æœ‰èŒ¶é¥®å¯ä»¥å–‚ç»™çŒ«å’ªï¼è¯·å…ˆåˆ¶ä½œä¸€äº›èŒ¶é¥®ã€‚', 'èŒ¶é¥®ä¸è¶³', 'ğŸµ');
                return;
            }

            const cat = gameData.cats[gameData.selectedCat];
            const beforeIntimacy = cat.intimacy;
            
            // æ¶ˆè€—ä¸€ä¸ªèŒ¶é¥®
            const tea = gameData.madeTeas.shift();
            
            // å¢åŠ äº²å¯†åº¦ï¼ˆæŒ‰ç…§5000æ»¡çº§è®¾è®¡ï¼‰
            const intimacyGain = Math.floor(Math.random() * 50) + 25; // 25-74ç‚¹äº²å¯†åº¦
            cat.intimacy = Math.min(5000, cat.intimacy + intimacyGain);
            
            // åŒæ­¥åˆ°æ—§ç»“æ„ä¿è¯å…¼å®¹æ€§
            if (gameData.cats.intimacy) {
                gameData.cats.intimacy[gameData.selectedCat] = cat.intimacy;
            }
            
            addDebugLog(`å–‚é£Ÿ${gameData.selectedCat}ï¼šæ¶ˆè€—äº†${tea.name}ï¼Œäº²å¯†åº¦ ${beforeIntimacy} â†’ ${cat.intimacy} (+${intimacyGain})`);
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é‡Œç¨‹ç¢‘å¹¶ç»™äºˆç¤¼ç‰©
            const milestones = [500, 1500, 3000, 5000];
            const reachedMilestone = milestones.find(milestone =>
                beforeIntimacy < milestone && cat.intimacy >= milestone
            );

            if (reachedMilestone) {
                // è¾¾åˆ°é‡Œç¨‹ç¢‘ï¼Œç»™äºˆç‰¹æ®Šç¤¼ç‰©
                let gift = '';
                let giftDescription = '';

                if (reachedMilestone === 500) {
                    gift = 'å°é±¼å¹²';
                    gameData.toppings['å°é±¼å¹²'] = (gameData.toppings['å°é±¼å¹²'] || 0) + 3;
                    giftDescription = '3ä¸ªå°é±¼å¹²';
                } else if (reachedMilestone === 1500) {
                    gift = 'é‡‘å¸';
                    const goldReward = 50;
                    gameData.funds += goldReward;
                    giftDescription = `${goldReward}é‡‘å¸`;
                } else if (reachedMilestone === 3000) {
                    gift = 'ç¨€æœ‰ç§å­ + ç¨»é¦™æ‘è§£é”';
                    const rareSeeds = ['äº”å‘³å­', 'æ´›ç¥èŠ±', 'ç«ç‘°èŠ±'];
                    const randomSeed = rareSeeds[Math.floor(Math.random() * rareSeeds.length)];
                    gameData.seeds[randomSeed] = (gameData.seeds[randomSeed] || 0) + 2;
                    giftDescription = `2ä¸ª${randomSeed}ç§å­`;

                    // è§£é”ç¨»é¦™æ‘
                    if (!gameData.riceVillage) {
                        gameData.riceVillage = {
                            unlocked: true,
                            maxIntimacyCats: []
                        };
                    }

                    // æ·»åŠ åˆ°æ»¡çº§çŒ«å’ªåˆ—è¡¨
                    if (!gameData.riceVillage.maxIntimacyCats.includes(catName)) {
                        gameData.riceVillage.maxIntimacyCats.push(catName);
                        addDebugLog(`ğŸ® ${catName}è¾¾åˆ°3000äº²å¯†åº¦ï¼Œè§£é”ç¨»é¦™æ‘ï¼`);

                        // æ˜¾ç¤ºç¨»é¦™æ‘è§£é”æç¤º
                        setTimeout(() => {
                            const unlockContent = `
                                <div style="text-align: center; line-height: 1.6;">
                                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ® é‡å¤§å‘ç°ï¼</h3>
                                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border: 1px inset #c0c0c0;">
                                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">${catName} äº²å¯†åº¦è¾¾åˆ°3000ï¼</div>
                                        <div style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">ğŸ® è§£é”ç¨»é¦™æ‘ï¼</div>
                                        <div style="color: #666; font-size: 12px;">ä¸çŒ«å’ªä¼™ä¼´ä¸€èµ·è¸ä¸Šå†’é™©ä¹‹æ—…</div>
                                    </div>
                                </div>
                            `;
                            showWin95Modal('ç¨»é¦™æ‘è§£é”', unlockContent, 'ğŸ®');
                            updateRiceVillageDisplay();
                        }, 2000);
                    }
                } else if (reachedMilestone === 5000) {
                    gift = 'ç»ˆæç¤¼ç‰©';
                    gameData.funds += 100;
                    gameData.toppings['å°é±¼å¹²'] = (gameData.toppings['å°é±¼å¹²'] || 0) + 10;
                    giftDescription = '100é‡‘å¸ + 10ä¸ªå°é±¼å¹²';
                }

                cat.lastGift = giftDescription;
                document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
                addDebugLog(`ğŸ ${gameData.selectedCat}è¾¾åˆ°${reachedMilestone}äº²å¯†åº¦é‡Œç¨‹ç¢‘ï¼èµ é€äº†ï¼š${giftDescription}`);

                showWin95Modal('çŒ«å’ªé‡Œç¨‹ç¢‘', `<div style="text-align: center; line-height: 1.6;"><div style="font-size: 12px; margin-bottom: 10px;">ğŸ‰ ${gameData.selectedCat} è¾¾åˆ° ${reachedMilestone} äº²å¯†åº¦é‡Œç¨‹ç¢‘ï¼</div><div style="color: #d4af37; font-weight: bold;">è·å¾—å¥–åŠ±ï¼š${giftDescription}</div></div>`, 'ğŸ');
            }
            
            renderSelectedCat();
            renderCatsTable(); // é‡æ–°æ¸²æŸ“çŒ«å’ªè¡¨æ ¼
            updateAllInventoryDisplay();
            saveGameDataToDatabase(); // ç«‹å³ä¿å­˜æ•°æ®
        }

        function petCat() {
            if (!gameData.selectedCat) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€åªçŒ«å’ªï¼', 'çŒ«å’ªç³»ç»Ÿ', 'ğŸ±');
                return;
            }

            const cat = gameData.cats[gameData.selectedCat];
            const beforeIntimacy = cat.intimacy;
            
            // æ’¸çŒ«å¢åŠ å°‘é‡äº²å¯†åº¦ï¼ˆæŒ‰ç…§5000æ»¡çº§è®¾è®¡ï¼‰
            const intimacyGain = Math.floor(Math.random() * 15) + 5; // 5-19ç‚¹äº²å¯†åº¦
            cat.intimacy = Math.min(5000, cat.intimacy + intimacyGain);
            
            // åŒæ­¥åˆ°æ—§ç»“æ„ä¿è¯å…¼å®¹æ€§
            if (gameData.cats.intimacy) {
                gameData.cats.intimacy[gameData.selectedCat] = cat.intimacy;
            }
            
            addDebugLog(`æ’¸çŒ«${gameData.selectedCat}ï¼šäº²å¯†åº¦ ${beforeIntimacy} â†’ ${cat.intimacy} (+${intimacyGain})`);
            
            const reactions = ['å–µ~', 'å‘¼å™œå‘¼å™œ~', 'èˆ’æœ~', 'å†æ¥ä¸€æ¬¡ï¼', 'å¼€å¿ƒ~'];
            const reaction = reactions[Math.floor(Math.random() * reactions.length)];
            showAlert(`${gameData.selectedCat}ï¼š${reaction}`, 'çŒ«å’ªååº”', 'ğŸ±');
            
            renderSelectedCat();
            renderCatsTable(); // é‡æ–°æ¸²æŸ“çŒ«å’ªè¡¨æ ¼
            updateAllInventoryDisplay();
            saveGameDataToDatabase(); // ç«‹å³ä¿å­˜æ•°æ®
        }

        // ä¸‹æ‹‰èœå•æ§åˆ¶å‡½æ•°
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isVisible = dropdown.classList.contains('show');

            // å…ˆå…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
            closeAllDropdowns();

            // å¦‚æœå½“å‰èœå•ä¸æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œåˆ™æ˜¾ç¤ºå®ƒ
            if (!isVisible) {
                dropdown.classList.add('show');
            }
        }

        function closeDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.remove('show');
        }

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.dropdown-content');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            const isDropdownButton = event.target.closest('.menu-btn');
            const isDropdownContent = event.target.closest('.dropdown-content');

            if (!isDropdownButton && !isDropdownContent) {
                closeAllDropdowns();
            }
        });

        // å­˜æ¡£ç®¡ç†ç³»ç»Ÿ

        // GitHub Pagesç‰ˆæœ¬ï¼šç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨+äº‘ç«¯
        function saveToDatabaseNow() {
            addDebugLog('ğŸ¯ ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ç«‹å³ä¿å­˜...');
            saveGameDataToDatabase();

            // æ£€æŸ¥äº‘ç«¯å­˜æ¡£çŠ¶æ€
            const cloudStatus = cloudSaveConfig.githubToken && cloudSaveConfig.gistId ? 'å·²åŒæ­¥åˆ°äº‘ç«¯' : 'ä»…ä¿å­˜åˆ°æœ¬åœ°';
            showAlert(`æ¸¸æˆæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œ${cloudStatus}`, 'ä¿å­˜å®Œæˆ', 'ğŸ’¾');
        }

        // å®æ—¶è®°å½•é¡¾å®¢è®¿é—®åˆ°æ•°æ®åº“
        function recordCustomerVisitToDatabase(customerName, customerType, teaServed, toppingsServed, totalPrice) {
            const visitData = {
                customerName: customerName,
                customerType: customerType,
                teaServed: teaServed,
                toppingsServed: toppingsServed,
                totalPrice: totalPrice
            };

            addDebugLog(`ğŸ¯ å®æ—¶è®°å½•é¡¾å®¢è®¿é—®ï¼š${customerName} (${customerType})`);

            fetch('http://localhost:5002/api/customer/visit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(visitData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addDebugLog(`âœ… é¡¾å®¢è®¿é—®è®°å½•æˆåŠŸï¼š${customerName} æ€»è®¿é—®${data.totalVisits}æ¬¡`);

                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    if (customerType === 'vip') {
                        if (!gameData.customerVisits) gameData.customerVisits = {};
                        gameData.customerVisits[customerName] = data.totalVisits;

                        // åŒæ­¥æ›´æ–°customersè¡¨
                        if (gameData.customers && gameData.customers[customerName]) {
                            gameData.customers[customerName].visits = data.totalVisits;
                        }

                        // æ›´æ–°é¡¾å®¢ç®¡ç†è¡¨æ˜¾ç¤º
                        renderCustomersTable();
                    }
                } else {
                    addDebugLog(`âŒ é¡¾å®¢è®¿é—®è®°å½•å¤±è´¥ï¼š${data.error}`);
                }
            })
            .catch(error => {
                addDebugLog(`âŒ é¡¾å®¢è®¿é—®è®°å½•ç½‘ç»œé”™è¯¯ï¼š${error.message}`);
            });
        }

        // å¼€å§‹åå±±æ‰“çŒ
        function startHunting() {
            if (!gameData.huntingSystem.backMountain.unlocked || gameData.huntingSystem.backMountain.isHunting) return;

            gameData.huntingSystem.backMountain.isHunting = true;
            gameData.huntingSystem.backMountain.huntStartTime = Date.now();

            addDebugLog(`ğŸ¹ å¼€å§‹åå±±æ‰“çŒ... æŒç»­æ—¶é—´ï¼š${gameData.huntingSystem.backMountain.huntDuration}æ¯«ç§’`);
            updateHuntingDisplay();

            // è®¾ç½®å®šæ—¶å™¨
            setTimeout(() => {
                addDebugLog('â° åå±±æ‰“çŒå®šæ—¶å™¨è§¦å‘');
                if (gameData.huntingSystem.backMountain.isHunting) {
                    addDebugLog('â° å®šæ—¶å™¨æ£€æŸ¥ï¼šåå±±æ‰“çŒçŠ¶æ€ä¸ºtrueï¼Œè°ƒç”¨completeHunting');
                    completeHunting('backMountain');
                } else {
                    addDebugLog('â° å®šæ—¶å™¨æ£€æŸ¥ï¼šåå±±æ‰“çŒçŠ¶æ€ä¸ºfalseï¼Œè·³è¿‡');
                }
            }, gameData.huntingSystem.backMountain.huntDuration);
        }

        // å¼€å§‹å±±æ´æ‰“çŒ
        function startCaveHunting() {
            if (!gameData.huntingSystem.cave.unlocked || gameData.huntingSystem.cave.isHunting) return;

            gameData.huntingSystem.cave.isHunting = true;
            gameData.huntingSystem.cave.huntStartTime = Date.now();

            addDebugLog(`ğŸ”ï¸ å¼€å§‹å±±æ´æ‰“çŒ... æŒç»­æ—¶é—´ï¼š${gameData.huntingSystem.cave.huntDuration}æ¯«ç§’`);
            updateCaveHuntingDisplay();

            // è®¾ç½®å®šæ—¶å™¨
            setTimeout(() => {
                addDebugLog('â° å±±æ´æ‰“çŒå®šæ—¶å™¨è§¦å‘');
                if (gameData.huntingSystem.cave.isHunting) {
                    addDebugLog('â° å®šæ—¶å™¨æ£€æŸ¥ï¼šå±±æ´æ‰“çŒçŠ¶æ€ä¸ºtrueï¼Œè°ƒç”¨completeHunting');
                    completeHunting('cave');
                } else {
                    addDebugLog('â° å®šæ—¶å™¨æ£€æŸ¥ï¼šå±±æ´æ‰“çŒçŠ¶æ€ä¸ºfalseï¼Œè·³è¿‡');
                }
            }, gameData.huntingSystem.cave.huntDuration);
        }

        // å®Œæˆæ‰“çŒ
        function completeHunting(location = 'backMountain') {
            const huntingData = gameData.huntingSystem[location];

            if (!huntingData.isHunting) {
                addDebugLog(`âš ï¸ completeHuntingè¢«è°ƒç”¨ä½†${location}æ‰“çŒçŠ¶æ€ä¸ºfalse`);
                return;
            }

            addDebugLog(`ğŸ¯ å¼€å§‹å®Œæˆ${location}æ‰“çŒæµç¨‹...`);
            huntingData.isHunting = false;
            huntingData.huntCount++;

            // ç¡®å®šçŒç‰©æ± 
            const huntPool = huntingData.huntCount >= 50 ?
                [...huntingData.huntResults.basic, ...huntingData.huntResults.advanced] :
                huntingData.huntResults.basic;

            addDebugLog(`ğŸ¯ ${location}ä½¿ç”¨çŒç‰©æ± ï¼š${huntPool.map(item => item.name).join(', ')}`);

            // éšæœºé€‰æ‹©çŒç‰©
            const random = Math.random();
            addDebugLog(`ğŸ¯ éšæœºæ•°ï¼š${random}`);
            let cumulativeChance = 0;
            let huntResult = null;

            for (const item of huntPool) {
                cumulativeChance += item.chance;
                addDebugLog(`ğŸ¯ æ£€æŸ¥ ${item.name}ï¼šç´¯ç§¯æ¦‚ç‡ ${cumulativeChance}ï¼Œéšæœºæ•° ${random}`);
                if (random <= cumulativeChance) {
                    huntResult = item;
                    addDebugLog(`ğŸ¯ é€‰ä¸­çŒç‰©ï¼š${item.name}`);
                    break;
                }
            }

            if (!huntResult) {
                huntResult = huntPool[huntPool.length - 1]; // å¤‡é€‰
                addDebugLog(`ğŸ¯ ä½¿ç”¨å¤‡é€‰çŒç‰©ï¼š${huntResult.name}`);
            }

            // æ·»åŠ åˆ°åº“å­˜
            addDebugLog(`ğŸ¯ å‡†å¤‡æ·»åŠ åˆ°åº“å­˜ï¼š${huntResult.name}`);
            if (!gameData.materials) {
                gameData.materials = {};
                addDebugLog(`ğŸ¯ åˆå§‹åŒ–materialså¯¹è±¡`);
            }
            if (!gameData.treasures) {
                gameData.treasures = {};
                addDebugLog(`ğŸ¯ åˆå§‹åŒ–treasureså¯¹è±¡`);
            }
            // å¤„ç†ä¸åŒç±»å‹çš„æ‰“çŒç»“æœ
            let resultMessage = '';
            let specialAction = '';

            if (huntResult.name === 'é‡‘å¸') {
                // ç›´æ¥è·å¾—é‡‘å¸
                const goldAmount = huntResult.value || 15;
                gameData.funds += goldAmount;
                resultMessage = `è·å¾—ï¼š${goldAmount}é‡‘å¸`;
                addDebugLog(`ğŸ¯ æ‰“çŒè·å¾—é‡‘å¸ï¼š+${goldAmount}ï¼Œå½“å‰èµ„é‡‘ï¼š${gameData.funds}`);
            } else if (huntResult.name === 'åœ°å›¾') {
                // è§£é”å±±æ´æ‰“çŒ
                if (!gameData.treasures[huntResult.name]) {
                    gameData.treasures[huntResult.name] = 0;
                }
                gameData.treasures[huntResult.name]++;

                if (!gameData.huntingSystem.cave.unlocked) {
                    gameData.huntingSystem.cave.unlocked = true;
                    specialAction = 'unlock_cave';
                    resultMessage = `è·å¾—ï¼šç¥ç§˜åœ°å›¾ - è§£é”å±±æ´æ‰“çŒï¼`;
                    addDebugLog(`ğŸ—ºï¸ è·å¾—åœ°å›¾ï¼Œè§£é”å±±æ´æ‰“çŒåŠŸèƒ½ï¼`);
                } else {
                    resultMessage = `è·å¾—ï¼šåœ°å›¾ç¢ç‰‡`;
                    addDebugLog(`ğŸ—ºï¸ è·å¾—é¢å¤–åœ°å›¾ç¢ç‰‡`);
                }
            } else if (['ç°ªå­', 'æ¢³å­', 'çŸ³å¤´', 'èŠ±æœµ'].includes(huntResult.name)) {
                // ç‰¹æ®Šç‰©å“å­˜å‚¨åˆ°treasures
                if (!gameData.treasures[huntResult.name]) {
                    gameData.treasures[huntResult.name] = 0;
                }
                const oldCount = gameData.treasures[huntResult.name];
                gameData.treasures[huntResult.name]++;
                const newCount = gameData.treasures[huntResult.name];
                resultMessage = `è·å¾—ï¼š${huntResult.name}`;
                addDebugLog(`ğŸ¯ æ‰“çŒè·å¾—ç‰¹æ®Šç‰©å“ï¼š${huntResult.name} (${oldCount} â†’ ${newCount})`);
            } else {
                // æ™®é€šææ–™å­˜å‚¨åˆ°materials
                if (!gameData.materials[huntResult.name]) {
                    gameData.materials[huntResult.name] = 0;
                }
                const oldCount = gameData.materials[huntResult.name];
                gameData.materials[huntResult.name]++;
                const newCount = gameData.materials[huntResult.name];
                resultMessage = `è·å¾—ï¼š${huntResult.name}`;
                addDebugLog(`ğŸ¯ æ‰“çŒè·å¾—ææ–™ï¼š${huntResult.name} (${oldCount} â†’ ${newCount})`);
            }

            // æ£€æŸ¥é¦–æ¬¡è·å¾—é…æ–¹è§£é”
            if (huntResult.firstTimeRecipe && !gameData.teaRecipes[huntResult.firstTimeRecipe]) {
                gameData.teaRecipes[huntResult.firstTimeRecipe] = ['æµ†æœ'];
                addDebugLog(`ğŸ‰ é¦–æ¬¡è·å¾—${huntResult.name}ï¼Œè§£é”é…æ–¹ï¼š${huntResult.firstTimeRecipe}ï¼`);

                const unlockContent = `
                    <div style="text-align: center; line-height: 1.6;">
                        <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ‰ æ–°é…æ–¹è§£é”ï¼</h3>
                        <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                            <div style="color: #666; margin-bottom: 8px;">é¦–æ¬¡çŒåˆ° ${huntResult.name}</div>
                            <div style="font-weight: bold; color: #d2691e;">è§£é”é…æ–¹ï¼š${huntResult.firstTimeRecipe}</div>
                        </div>
                    </div>
                `;
                showWin95Modal('æ‰“çŒé…æ–¹è§£é”', unlockContent, 'ğŸ¯');
            }

            // æ˜¾ç¤ºæ‰“çŒç»“æœå¼¹çª—
            addDebugLog(`ğŸ¯ å‡†å¤‡æ˜¾ç¤ºæ‰“çŒç»“æœå¼¹çª—`);
            const locationName = location === 'backMountain' ? 'åå±±' : 'å±±æ´';
            const locationIcon = location === 'backMountain' ? 'ğŸ¯' : 'ğŸ”ï¸';

            let huntResultContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">${locationIcon} ${locationName}æ‰“çŒæˆåŠŸï¼</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="font-size: 18px; font-weight: bold; color: #d2691e; margin-bottom: 8px;">${resultMessage}</div>
                        <div style="color: #666; font-size: 14px;">${locationName}æ‰“çŒæ¬¡æ•°ï¼š${huntingData.huntCount}</div>
                        ${huntingData.huntCount >= 50 ? '<div style="color: #22c55e; font-size: 12px;">å·²è§£é”é«˜çº§çŒç‰©</div>' : ''}
                    </div>
                </div>
            `;

            // å¦‚æœè§£é”äº†å±±æ´ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            if (specialAction === 'unlock_cave') {
                huntResultContent = `
                    <div style="text-align: center; line-height: 1.6;">
                        <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ—ºï¸ é‡å¤§å‘ç°ï¼</h3>
                        <div style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border: 1px inset #c0c0c0;">
                            <div style="font-size: 18px; font-weight: bold; color: #d2691e; margin-bottom: 8px;">è·å¾—ï¼šç¥ç§˜åœ°å›¾</div>
                            <div style="color: #1e40af; font-weight: bold; margin-bottom: 8px;">ğŸ”ï¸ è§£é”å±±æ´æ‰“çŒåŠŸèƒ½ï¼</div>
                            <div style="color: #666; font-size: 12px;">å±±æ´æ‰“çŒæ—¶é—´ï¼š20ç§’ï¼Œå¯è·å¾—çè´µçš„é“¶è€³</div>
                        </div>
                    </div>
                `;
            }

            showWin95Modal('æ‰“çŒç»“æœ', huntResultContent, 'ğŸ¯');
            addDebugLog(`ğŸ¯ æ‰“çŒç»“æœå¼¹çª—å·²æ˜¾ç¤º`);

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const huntingStatus = document.getElementById('hunting-status');
            if (huntingStatus) {
                huntingStatus.innerHTML = `<div class="alert alert-success">ğŸ¯ æ‰“çŒæˆåŠŸï¼è·å¾—ï¼š${huntResult.name}</div>`;
                setTimeout(() => {
                    updateHuntingDisplay();
                }, 3000);
            }

            addDebugLog(`ğŸ¯ å¼€å§‹æ›´æ–°ç•Œé¢å’Œä¿å­˜æ•°æ®`);
            updateHuntingDisplay();
            updateAllInventoryDisplay();
            saveGameDataToDatabase();
            addDebugLog(`ğŸ¯ æ‰“çŒå®Œæˆæµç¨‹ç»“æŸ`);
        }

        // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥é¡¾å®¢æ•°æ®å’Œé…æ–¹è§£é”
        function debugCustomerUnlock() {
            addDebugLog('=== é¡¾å®¢æ•°æ®è°ƒè¯• ===');
            addDebugLog(`customerVisits: ${JSON.stringify(gameData.customerVisits)}`);
            addDebugLog(`customers: ${JSON.stringify(gameData.customers)}`);
            addDebugLog(`å·²è§£é”é…æ–¹: ${Object.keys(gameData.teaRecipes).join(', ')}`);

            // æ‰‹åŠ¨æ£€æŸ¥æ± ä¹ä¿¡å’Œç‹¸æ€’çš„è§£é”
            if (gameData.customerVisits['æ± ä¹ä¿¡'] >= 2) {
                addDebugLog('ğŸ” æ‰‹åŠ¨æ£€æŸ¥æ± ä¹ä¿¡é…æ–¹è§£é”...');
                checkRecipeUnlock('æ± ä¹ä¿¡');
            }
            if (gameData.customerVisits['ç‹¸æ€’'] >= 1) {
                addDebugLog('ğŸ” æ‰‹åŠ¨æ£€æŸ¥ç‹¸æ€’é…æ–¹è§£é”...');
                checkRecipeUnlock('ç‹¸æ€’');
            }

            addDebugLog('=== è°ƒè¯•å®Œæˆ ===');
        }

        // æµ‹è¯•çƒ¤è‚‰æ¶è§£é”
        function testGrillUnlock() {
            addDebugLog('ğŸ§ª æµ‹è¯•å§¬åˆ«æƒ…çƒ¤è‚‰æ¶è§£é”...');

            // è®¾ç½®å§¬åˆ«æƒ…è®¿é—®æ¬¡æ•°ä¸º6
            if (!gameData.customerVisits) gameData.customerVisits = {};
            gameData.customerVisits['å§¬åˆ«æƒ…'] = 6;

            if (gameData.customers && gameData.customers['å§¬åˆ«æƒ…']) {
                gameData.customers['å§¬åˆ«æƒ…'].visits = 6;
            }

            // ç›´æ¥è§£é”åŠŸèƒ½ï¼ˆç»•è¿‡æ£€æŸ¥ï¼‰
            gameData.grillSystem.unlocked = true;
            gameData.huntingSystem.backMountain.unlocked = true;

            addDebugLog(`ğŸ”¥ å¼ºåˆ¶è§£é”çƒ¤è‚‰æ¶å’Œæ‰“çŒåŠŸèƒ½ï¼`);

            // æ˜¾ç¤ºè§£é”æç¤º
            const unlockContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ”¥ èŒ¶é“ºå‡çº§ï¼</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="color: #666; margin-bottom: 8px;">å§¬åˆ«æƒ… 6æ¬¡è®¿é—®è¾¾æˆ</div>
                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">ğŸ”¥ è§£é”çƒ¤è‚‰æ¶åŠŸèƒ½</div>
                        <div style="font-weight: bold; color: #228b22;">ğŸ¹ è§£é”åå±±æ‰“çŒåŠŸèƒ½</div>
                    </div>
                    <div style="color: #888; font-size: 12px; line-height: 1.4;">
                        ç°åœ¨å¯ä»¥ä¸ºé¡¾å®¢æä¾›çƒ¤è‚‰æœåŠ¡<br>
                        ç‚¹å‡»æ‰“çŒæŒ‰é’®è·å–è‚‰ç±»å’Œå…¶ä»–é£Ÿæ<br>
                        é¦–æ¬¡çŒåˆ°æµ†æœå¯è§£é”æµ†æœæ±é…æ–¹
                    </div>
                </div>
            `;
            showWin95Modal('èŒ¶é“ºåŠŸèƒ½å‡çº§', unlockContent, 'ğŸ”¥');

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateGrillAndHuntingDisplay();

            // æ›´æ–°æ˜¾ç¤º
            renderCustomersTable();
            saveGameDataToDatabase();

            addDebugLog('âœ… æµ‹è¯•å®Œæˆï¼Œå§¬åˆ«æƒ…è®¿é—®æ¬¡æ•°è®¾ä¸º6æ¬¡');
        }

        function initSaveSlots() {
            // åˆå§‹åŒ–å­˜æ¡£æ§½ä½æ˜¾ç¤º
            updateSaveSlotDisplay();
        }

        function updateSaveSlotDisplay() {
            for (let i = 1; i <= 4; i++) {
                const timeElement = document.getElementById(`save-time-${i}`);
                if (timeElement) {
                    const saveData = localStorage.getItem(`teaGameSave_${i}`);
                    if (saveData) {
                        try {
                            const data = JSON.parse(saveData);
                            timeElement.textContent = new Date(data.timestamp).toLocaleString();
                        } catch (error) {
                            timeElement.textContent = 'æ•°æ®æŸå';
                        }
                    } else {
                        if (i === 1) {
                            timeElement.textContent = 'è‡ªåŠ¨å­˜æ¡£';
                        } else {
                            timeElement.textContent = 'ç©ºæ§½ä½';
                        }
                    }
                }
            }
        }

        function handleSaveSlot(slotNumber) {
            if (slotNumber === 1) {
                // æ§½ä½1æ˜¯è‡ªåŠ¨å­˜æ¡£ï¼Œåªèƒ½åŠ è½½
                showSaveSlotMenu(1, true); // ä¼ å…¥trueè¡¨ç¤ºåªè¯»æ¨¡å¼
                return;
            }

            const saveData = localStorage.getItem(`teaGameSave_${slotNumber}`);

            if (saveData) {
                // å·²æœ‰å­˜æ¡£ï¼Œæ˜¾ç¤ºé€‰æ‹©èœå•
                showSaveSlotMenu(slotNumber, false);
            } else {
                // ç©ºæ§½ä½ï¼Œæ˜¾ç¤ºä¿å­˜/æ–°å»ºé€‰é¡¹
                showEmptySlotMenu(slotNumber);
            }
        }

        function showSaveSlotMenu(slotNumber, isReadOnly = false) {
            const saveData = localStorage.getItem(`teaGameSave_${slotNumber}`);
            const data = JSON.parse(saveData);
            const saveTime = new Date(data.timestamp).toLocaleString();

            let buttonsHtml = '';
            if (isReadOnly) {
                // è‡ªåŠ¨å­˜æ¡£æ§½ä½ï¼Œåªèƒ½åŠ è½½
                buttonsHtml = `
                    <button class="action-btn" onclick="loadSaveSlot(${slotNumber}); closeWin95Modal();">åŠ è½½å­˜æ¡£</button>
                `;
            } else {
                // æ‰‹åŠ¨å­˜æ¡£æ§½ä½ï¼Œå¯ä»¥åŠ è½½ã€ä¿å­˜ã€åˆ é™¤
                buttonsHtml = `
                    <button class="action-btn" onclick="loadSaveSlot(${slotNumber}); closeWin95Modal();">åŠ è½½å­˜æ¡£</button>
                    <button class="action-btn" onclick="saveToSlot(${slotNumber}); closeWin95Modal();" style="background: #22c55e;">ä¿å­˜è¿›åº¦</button>
                    <button class="action-btn" onclick="deleteSaveSlot(${slotNumber}); closeWin95Modal();" style="background: #ef4444;">åˆ é™¤å­˜æ¡£</button>
                `;
            }

            const menuContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">æ§½ä½${slotNumber}${isReadOnly ? ' - è‡ªåŠ¨å­˜æ¡£' : ''}</div>
                    <div style="color: #666; margin-bottom: 15px;">ä¿å­˜æ—¶é—´ï¼š${saveTime}</div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        ${buttonsHtml}
                    </div>
                </div>
            `;

            showWin95Modal('å­˜æ¡£ç®¡ç†', menuContent, 'ğŸ’¾');
        }

        function showEmptySlotMenu(slotNumber) {
            const menuContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">æ§½ä½${slotNumber} - ç©ºæ§½ä½</div>
                    <div style="color: #666; margin-bottom: 15px;">é€‰æ‹©æ“ä½œï¼š</div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="action-btn" onclick="saveToSlot(${slotNumber}); closeWin95Modal();" style="background: #22c55e;">ä¿å­˜å½“å‰è¿›åº¦</button>
                        <button class="action-btn" onclick="createNewSave(${slotNumber}); closeWin95Modal();" style="background: #f59e0b;">æ–°å»ºå­˜æ¡£</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px; color: #999;">
                        ä¿å­˜å½“å‰è¿›åº¦ï¼šä¿å­˜ç°åœ¨çš„æ¸¸æˆçŠ¶æ€<br>
                        æ–°å»ºå­˜æ¡£ï¼šæ¸…ç©ºè¿›åº¦é‡æ–°å¼€å§‹
                    </div>
                </div>
            `;

            showWin95Modal('å­˜æ¡£ç®¡ç†', menuContent, 'ğŸ’¾');
        }

        function createNewSave(slotNumber) {
            // æ¸…ç©ºå½“å‰æ¸¸æˆæ•°æ®
            resetGameDataSilent();

            // ä¿å­˜åˆ°æŒ‡å®šæ§½ä½
            saveToSlot(slotNumber);

            addDebugLog(`å·²åœ¨æ§½ä½${slotNumber}åˆ›å»ºæ–°å­˜æ¡£`);
            showAlert(`å·²åœ¨æ§½ä½${slotNumber}åˆ›å»ºæ–°å­˜æ¡£`, 'æ–°å»ºæˆåŠŸ', 'ğŸ’¾');
        }

        function saveToSlot(slotNumber) {
            const gameState = {
                timestamp: new Date().toISOString(),
                funds: gameData.funds,
                plots: gameData.plots,
                inventory: gameData.inventory,
                seeds: gameData.seeds,
                madeTeas: gameData.madeTeas,
                toppings: gameData.toppings,
                stoves: gameData.stoves,
                processingBoards: gameData.processingBoards,
                customer: gameData.customer,
                cats: gameData.cats,
                customers: gameData.customers,
                servedCustomers: gameData.servedCustomers,
                lastCustomerTime: gameData.lastCustomerTime,
                currentDay: gameData.currentDay,
                seasonDay: gameData.seasonDay,
                season: gameData.season,
                weather: gameData.weather,
                currentSeason: gameData.currentSeason,
                currentWeather: gameData.currentWeather,
                lastDayChange: gameData.lastDayChange,
                selectedCat: gameData.selectedCat,
                customerVisits: gameData.customerVisits,
                teaRecipes: gameData.teaRecipes
            };

            localStorage.setItem(`teaGameSave_${slotNumber}`, JSON.stringify(gameState));
            updateSaveSlotDisplay();

            addDebugLog(`æ¸¸æˆå·²ä¿å­˜åˆ°æ§½ä½${slotNumber}`);
            showAlert(`æ¸¸æˆå·²ä¿å­˜åˆ°æ§½ä½${slotNumber}`, 'ä¿å­˜æˆåŠŸ', 'ğŸ’¾');
        }

        function loadSaveSlot(slotNumber) {
            const saveData = localStorage.getItem(`teaGameSave_${slotNumber}`);

            if (!saveData) {
                showAlert(`æ§½ä½${slotNumber}ä¸ºç©ºï¼`, 'åŠ è½½å¤±è´¥', 'âŒ');
                return;
            }

            try {
                const gameState = JSON.parse(saveData);
                Object.assign(gameData, gameState);

                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                renderFarmGrid();
                renderWorkspaces();
                updateAllInventoryDisplay();
                updateAllFundsDisplay();
                updateDebugDisplay();
                updateWeatherAndSeasonDisplay();

                addDebugLog(`å·²ä»æ§½ä½${slotNumber}åŠ è½½å­˜æ¡£`);
                showAlert(`å·²ä»æ§½ä½${slotNumber}åŠ è½½å­˜æ¡£`, 'åŠ è½½æˆåŠŸ', 'ğŸ’¾');
            } catch (error) {
                showAlert(`æ§½ä½${slotNumber}æ•°æ®æŸåï¼`, 'åŠ è½½å¤±è´¥', 'âŒ');
                addDebugLog(`æ§½ä½${slotNumber}æ•°æ®è§£æå¤±è´¥: ${error.message}`);
            }
        }

        function deleteSaveSlot(slotNumber) {
            if (slotNumber === 1) {
                showAlert('ä¸èƒ½åˆ é™¤è‡ªåŠ¨å­˜æ¡£æ§½ä½ï¼', 'åˆ é™¤å¤±è´¥', 'âŒ');
                return;
            }

            showConfirm(
                `ç¡®å®šè¦åˆ é™¤æ§½ä½${slotNumber}çš„å­˜æ¡£å—ï¼Ÿ<br><br><strong style="color: red;">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong>`,
                'åˆ é™¤å­˜æ¡£',
                () => {
                    localStorage.removeItem(`teaGameSave_${slotNumber}`);
                    updateSaveSlotDisplay();
                    addDebugLog(`å·²åˆ é™¤æ§½ä½${slotNumber}çš„å­˜æ¡£`);
                    showAlert(`å·²åˆ é™¤æ§½ä½${slotNumber}çš„å­˜æ¡£`, 'åˆ é™¤æˆåŠŸ', 'ğŸ—‘ï¸');
                }
            );
        }

        function resetGameDataSilent() {
            // é™é»˜é‡ç½®æ¸¸æˆæ•°æ®ï¼ˆä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
            gameData.funds = 1000;
            gameData.currentDay = 1;
            gameData.seasonDay = 1;
            gameData.season = 0;
            gameData.weather = 0;
            gameData.currentSeason = "æ˜¥å¤©";
            gameData.currentWeather = "æ™´å¤©";
            gameData.lastDayChange = Date.now();
            gameData.servedCustomers = 0;
            gameData.lastCustomerTime = 0;

            // é‡ç½®æ‰€æœ‰æ•°ç»„å’Œå¯¹è±¡
            gameData.plots.forEach(plot => {
                plot.state = 'empty';
                plot.plantType = null;
                plot.plantTime = null;
                plot.moisture = 50;
                plot.fertility = 50;
            });

            gameData.inventory = {};
            gameData.seeds = {};
            gameData.madeTeas = [];
            gameData.toppings = {};
            gameData.customer = { active: false };
            gameData.cats = {};
            gameData.customers = {};
            gameData.customerVisits = {};
            gameData.selectedCat = null;

            // é‡ç½®å·¥ä½œå°çŠ¶æ€
            gameData.stoves.forEach(stove => {
                stove.state = 'idle';
                stove.recipe = null;
                stove.startTime = null;
                stove.duration = null;
            });

            gameData.processingBoards.forEach(board => {
                board.state = 'idle';
                board.recipe = null;
                board.startTime = null;
                board.duration = null;
            });

            // é‡æ–°åˆå§‹åŒ–åŸºç¡€é…æ–¹
            gameData.teaRecipes = {
                'äº”å‘³å­é¥®': ['äº”å‘³å­'],
                'æŸ æª¬èŒ¶': ['æŸ æª¬']
            };

            // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            renderFarmGrid();
            renderWorkspaces();
            updateAllInventoryDisplay();
            updateAllFundsDisplay();
            updateDebugDisplay();
        }

        // æ£€æŸ¥ç‰¹æ®ŠåŠŸèƒ½è§£é”
        function checkSpecialFeatureUnlock(customerName) {
            if (!gameData.customerVisits || !gameData.customers) return;

            const visitCount = gameData.customerVisits[customerName] || 0;

            // å§¬åˆ«æƒ…6æ¬¡è®¿é—®è§£é”çƒ¤è‚‰æ¶
            if (customerName === 'å§¬åˆ«æƒ…' && visitCount >= 6 && !gameData.grillSystem.unlocked) {
                gameData.grillSystem.unlocked = true;
                gameData.huntingSystem.backMountain.unlocked = true;

                addDebugLog(`ğŸ”¥ å§¬åˆ«æƒ…6æ¬¡è®¿é—®ï¼Œè§£é”çƒ¤è‚‰æ¶å’Œæ‰“çŒåŠŸèƒ½ï¼`);

                const unlockContent = `
                    <div style="text-align: center; line-height: 1.6;">
                        <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ”¥ èŒ¶é“ºå‡çº§ï¼</h3>
                        <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                            <div style="color: #666; margin-bottom: 8px;">å§¬åˆ«æƒ… 6æ¬¡è®¿é—®è¾¾æˆ</div>
                            <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">ğŸ”¥ è§£é”çƒ¤è‚‰æ¶åŠŸèƒ½</div>
                            <div style="font-weight: bold; color: #228b22;">ğŸ¹ è§£é”åå±±æ‰“çŒåŠŸèƒ½</div>
                        </div>
                        <div style="color: #888; font-size: 12px; line-height: 1.4;">
                            ç°åœ¨å¯ä»¥ä¸ºé¡¾å®¢æä¾›çƒ¤è‚‰æœåŠ¡<br>
                            ç‚¹å‡»æ‰“çŒæŒ‰é’®è·å–è‚‰ç±»å’Œå…¶ä»–é£Ÿæ<br>
                            é¦–æ¬¡çŒåˆ°æµ†æœå¯è§£é”æµ†æœæ±é…æ–¹
                        </div>
                    </div>
                `;
                showWin95Modal('èŒ¶é“ºåŠŸèƒ½å‡çº§', unlockContent, 'ğŸ”¥');

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateGrillAndHuntingDisplay();
            }
        }

        // æ›´æ–°çƒ¤è‚‰æ¶å’Œæ‰“çŒæ˜¾ç¤º
        function updateGrillAndHuntingDisplay() {
            const grillSection = document.getElementById('grill-section');
            const huntingSection = document.getElementById('hunting-section');
            const caveHuntingSection = document.getElementById('cave-hunting-section');

            if (gameData.grillSystem.unlocked) {
                grillSection.style.display = 'block';
                renderGrillTable();
            }

            if (gameData.huntingSystem.backMountain.unlocked) {
                huntingSection.style.display = 'block';
                updateHuntingDisplay();
            }

            if (gameData.huntingSystem.cave.unlocked && caveHuntingSection) {
                caveHuntingSection.style.display = 'block';
                updateCaveHuntingDisplay();
            }
        }

        // æ¸²æŸ“çƒ¤è‚‰æ¶è¡¨æ ¼
        function renderGrillTable() {
            const grillTable = document.getElementById('grill-table');
            if (!grillTable) return;

            grillTable.innerHTML = `
                <tr>
                    <td>çƒ¤è‚‰æ¶ #1</td>
                    <td id="grill-recipe">${gameData.grillSystem.currentRecipe || 'ç©ºé—²'}</td>
                    <td id="grill-progress">
                        ${gameData.grillSystem.isGrilling ?
                            `<div class="progress-bar">
                                <div class="progress-fill" id="grill-progress-fill" style="width: 0%"></div>
                            </div>` :
                            'ç­‰å¾…ä¸­'
                        }
                    </td>
                    <td>
                        <button class="action-btn" onclick="showGrillMenu()"
                                ${gameData.grillSystem.isGrilling ? 'disabled' : ''}>
                            ğŸ”¥ å¼€å§‹çƒ¤åˆ¶
                        </button>
                    </td>
                </tr>
            `;
        }

        // æ˜¾ç¤ºçƒ¤è‚‰æ¶èœå•
        function showGrillMenu() {
            if (!gameData.grillSystem.unlocked || gameData.grillSystem.isGrilling) return;

            // è·å–å¯ç”¨çš„çƒ¤åˆ¶é…æ–¹
            const availableRecipes = Object.keys(gameData.grillSystem.recipes).filter(recipe => {
                const recipeData = gameData.grillSystem.recipes[recipe];
                return recipeData.ingredients.every(ingredient =>
                    gameData.materials && gameData.materials[ingredient] > 0
                );
            });

            if (availableRecipes.length === 0) {
                showAlert('æ²¡æœ‰å¯çƒ¤åˆ¶çš„è‚‰ç±»ææ–™ï¼è¯·å…ˆæ‰“çŒå¹¶åˆ†è§£åŠ¨ç‰©è·å¾—è‚‰ç±»ã€‚', 'çƒ¤åˆ¶å¤±è´¥', 'ğŸ”¥');
                return;
            }

            // åˆ›å»ºçƒ¤åˆ¶é€‰æ‹©å¼¹çª—
            const grillContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ”¥ é€‰æ‹©çƒ¤åˆ¶é…æ–¹</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${availableRecipes.map(recipe => {
                            const recipeData = gameData.grillSystem.recipes[recipe];
                            const ingredients = recipeData.ingredients.join(' + ');
                            const cookTimeSeconds = Math.round(recipeData.cookTime / 1000);
                            const availableCount = Math.min(...recipeData.ingredients.map(ing => gameData.materials[ing] || 0));

                            return `
                                <div style="margin-bottom: 10px; padding: 10px; background: #f0f0f0; border: 1px inset #c0c0c0; cursor: pointer;"
                                     onclick="startGrilling('${recipe}'); closeModal();">
                                    <div style="font-weight: bold; color: #d2691e;">${recipe}</div>
                                    <div style="font-size: 12px; color: #666; margin: 4px 0;">éœ€è¦: ${ingredients}</div>
                                    <div style="font-size: 12px; color: #666; margin: 4px 0;">çƒ¤åˆ¶æ—¶é—´: ${cookTimeSeconds}ç§’</div>
                                    <div style="font-size: 12px; color: #666; margin: 4px 0;">å”®ä»·: ${recipeData.price}é‡‘å¸</div>
                                    <div style="font-size: 12px; color: #22c55e;">å¯çƒ¤åˆ¶: ${availableCount}æ¬¡</div>
                                    <div style="font-size: 11px; color: #999; margin-top: 4px;">${recipeData.description}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            showWin95Modal('çƒ¤è‚‰æ¶', grillContent, 'ğŸ”¥');
        }

        // å¼€å§‹çƒ¤åˆ¶
        function startGrilling(recipeName) {
            if (!gameData.grillSystem.unlocked || gameData.grillSystem.isGrilling) return;

            const recipe = gameData.grillSystem.recipes[recipeName];
            if (!recipe) return;

            // æ£€æŸ¥ææ–™æ˜¯å¦è¶³å¤Ÿ
            const hasEnoughMaterials = recipe.ingredients.every(ingredient =>
                gameData.materials && gameData.materials[ingredient] > 0
            );

            if (!hasEnoughMaterials) {
                showAlert('ææ–™ä¸è¶³ï¼', 'çƒ¤åˆ¶å¤±è´¥', 'ğŸ”¥');
                return;
            }

            // æ¶ˆè€—ææ–™
            addDebugLog(`ğŸ”¥ å¼€å§‹çƒ¤åˆ¶${recipeName}ï¼Œæ¶ˆè€—ææ–™ï¼š`);
            recipe.ingredients.forEach(ingredient => {
                const beforeCount = gameData.materials[ingredient];
                gameData.materials[ingredient] = Math.max(0, beforeCount - 1);
                const afterCount = gameData.materials[ingredient];
                addDebugLog(`  - ${ingredient}: ${beforeCount} â†’ ${afterCount} (-1)`);
            });

            // è®¾ç½®çƒ¤åˆ¶çŠ¶æ€
            gameData.grillSystem.isGrilling = true;
            gameData.grillSystem.grillStartTime = Date.now();
            gameData.grillSystem.grillDuration = recipe.cookTime;
            gameData.grillSystem.currentRecipe = recipeName;

            addDebugLog(`ğŸ”¥ å¼€å§‹çƒ¤åˆ¶${recipeName}ï¼Œé¢„è®¡${Math.round(recipe.cookTime / 1000)}ç§’å®Œæˆ`);

            // æ›´æ–°æ˜¾ç¤º
            renderGrillTable();
            updateAllInventoryDisplay();

            // è®¾ç½®å®šæ—¶å™¨
            setTimeout(() => {
                if (gameData.grillSystem.isGrilling && gameData.grillSystem.currentRecipe === recipeName) {
                    completeGrilling();
                }
            }, recipe.cookTime);
        }

        // å®Œæˆçƒ¤åˆ¶
        function completeGrilling() {
            if (!gameData.grillSystem.isGrilling) return;

            const recipeName = gameData.grillSystem.currentRecipe;
            const recipe = gameData.grillSystem.recipes[recipeName];

            addDebugLog(`ğŸ”¥ çƒ¤åˆ¶å®Œæˆï¼š${recipeName}`);

            // é‡ç½®çƒ¤åˆ¶çŠ¶æ€
            gameData.grillSystem.isGrilling = false;
            gameData.grillSystem.grillStartTime = 0;
            gameData.grillSystem.grillDuration = 0;
            gameData.grillSystem.currentRecipe = null;
            gameData.grillSystem.currentProduct = recipeName;

            // æ˜¾ç¤ºçƒ¤åˆ¶å®Œæˆå’Œå”®å–é€‰æ‹©
            showGrillSellOptions(recipeName, recipe);

            // æ›´æ–°æ˜¾ç¤º
            renderGrillTable();
            updateAllInventoryDisplay();
            saveGameDataToDatabase();
        }

        // æ˜¾ç¤ºå”®å–é€‰æ‹©
        function showGrillSellOptions(productName, recipe) {
            const sellContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ”¥ çƒ¤åˆ¶å®Œæˆï¼</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="font-size: 18px; font-weight: bold; color: #d2691e; margin-bottom: 8px;">${productName}</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">${recipe.description}</div>
                        <div style="color: #22c55e; font-weight: bold;">åŸºç¡€ä»·æ ¼: ${recipe.price}é‡‘å¸</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">é€‰æ‹©å”®å–æ–¹å¼ï¼š</div>
                        <div style="margin-bottom: 8px;">
                            <button style="width: 100%; padding: 8px; margin-bottom: 5px; background: #e5e7eb; border: 1px solid #d1d5db; cursor: pointer;"
                                    onclick="sellGrilledFood('${productName}', ${recipe.price}, 'direct'); closeModal();">
                                ğŸ’° ç›´æ¥å”®å– (${recipe.price}é‡‘å¸)
                            </button>
                        </div>
                        <div>
                            <button style="width: 100%; padding: 8px; background: #dbeafe; border: 1px solid #93c5fd; cursor: pointer;"
                                    onclick="sellGrilledFood('${productName}', ${Math.round(recipe.price * 1.2)}, 'customer'); closeModal();">
                                ğŸ½ï¸ ç­‰å¾…é¡¾å®¢ç‚¹é¤ (${Math.round(recipe.price * 1.2)}é‡‘å¸+å°è´¹)
                            </button>
                        </div>
                    </div>
                </div>
            `;

            showWin95Modal('çƒ¤åˆ¶å®Œæˆ', sellContent, 'ğŸ”¥');
        }

        // å”®å–çƒ¤åˆ¶é£Ÿå“
        function sellGrilledFood(productName, price, sellType) {
            if (sellType === 'direct') {
                // ç›´æ¥å”®å–è·å¾—é‡‘å¸
                gameData.funds += price;
                addDebugLog(`ğŸ’° ç›´æ¥å”®å–${productName}ï¼Œè·å¾—${price}é‡‘å¸`);
                showAlert(`å”®å‡º${productName}ï¼Œè·å¾—${price}é‡‘å¸ï¼`, 'å”®å–æˆåŠŸ', 'ğŸ’°');

                // é‡ç½®äº§å“çŠ¶æ€
                gameData.grillSystem.currentProduct = null;

                updateAllInventoryDisplay();
                saveGameDataToDatabase();

            } else if (sellType === 'customer') {
                // æ·»åŠ åˆ°èŒ¶é¥®åº“å­˜ç­‰å¾…é¡¾å®¢ç‚¹é¤
                gameData.madeTeas.push({
                    name: productName,
                    temperature: 'çƒ­é£Ÿ',
                    makeTime: new Date().toLocaleTimeString(),
                    type: 'grilled',
                    basePrice: price
                });

                addDebugLog(`ğŸ½ï¸ ${productName}å·²æ·»åŠ åˆ°åº“å­˜ï¼Œç­‰å¾…é¡¾å®¢ç‚¹é¤`);
                showAlert(`${productName}å·²å‡†å¤‡å¥½ï¼Œç­‰å¾…é¡¾å®¢ç‚¹é¤ï¼`, 'å‡†å¤‡å®Œæˆ', 'ğŸ½ï¸');

                // é‡ç½®äº§å“çŠ¶æ€
                gameData.grillSystem.currentProduct = null;

                updateAllInventoryDisplay();
                saveGameDataToDatabase();
            }
        }

        // æ›´æ–°çƒ¤åˆ¶è¿›åº¦
        function updateGrillProgress() {
            if (!gameData.grillSystem.isGrilling) return;

            const elapsed = Date.now() - gameData.grillSystem.grillStartTime;
            const remaining = Math.max(0, gameData.grillSystem.grillDuration - elapsed);
            const progress = Math.min(100, (elapsed / gameData.grillSystem.grillDuration) * 100);

            // æ›´æ–°è¿›åº¦æ¡
            const progressFill = document.getElementById('grill-progress-fill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }

            // æ›´æ–°é…æ–¹æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºå‰©ä½™æ—¶é—´ï¼‰
            const grillRecipe = document.getElementById('grill-recipe');
            if (grillRecipe) {
                const remainingSeconds = Math.ceil(remaining / 1000);
                grillRecipe.textContent = `${gameData.grillSystem.currentRecipe} (${remainingSeconds}ç§’)`;
            }

            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (remaining <= 0) {
                completeGrilling();
            }
        }

        // å…³é—­å½“å‰å¼¹çª—
        function closeModal() {
            // å…³é—­æ‰€æœ‰å¯èƒ½çš„å¼¹çª—
            const modals = document.querySelectorAll('.modal, .win95-modal');
            modals.forEach(modal => {
                if (modal.style.display === 'block' || modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            });
        }

        // æ›´æ–°åå±±æ‰“çŒæ˜¾ç¤º
        function updateHuntingDisplay() {
            const huntCount = document.getElementById('hunt-count');
            const advancedStatus = document.getElementById('advanced-hunt-status');
            const huntBtn = document.getElementById('hunt-btn');
            const huntingStatus = document.getElementById('hunting-status');

            const backMountain = gameData.huntingSystem.backMountain;

            if (huntCount) huntCount.textContent = backMountain.huntCount;

            if (advancedStatus) {
                if (backMountain.huntCount >= 50) {
                    advancedStatus.textContent = 'å·²è§£é”';
                    advancedStatus.style.color = '#22c55e';
                } else {
                    advancedStatus.textContent = `éœ€è¦${50 - backMountain.huntCount}æ¬¡`;
                }
            }

            if (backMountain.isHunting) {
                const elapsed = Date.now() - backMountain.huntStartTime;
                const remaining = Math.max(0, backMountain.huntDuration - elapsed);

                if (remaining <= 0) {
                    addDebugLog('â° åå±±æ‰“çŒæ—¶é—´åˆ°ï¼Œè§¦å‘å®Œæˆæ‰“çŒ');
                    completeHunting('backMountain');
                    return;
                }

                const seconds = Math.max(1, Math.ceil(remaining / 1000));

                if (huntBtn) {
                    huntBtn.disabled = true;
                    huntBtn.textContent = `ğŸ¹ æ‰“çŒä¸­... (${seconds}ç§’)`;
                }

                if (huntingStatus) {
                    huntingStatus.innerHTML = `<div class="alert alert-info">æ­£åœ¨åå±±æ‰“çŒ... å‰©ä½™${seconds}ç§’</div>`;
                }
            } else {
                if (huntBtn) {
                    huntBtn.disabled = false;
                    huntBtn.textContent = 'ğŸ¹ å¼€å§‹æ‰“çŒ (15ç§’)';
                }

                if (huntingStatus) {
                    huntingStatus.innerHTML = '<div class="alert alert-secondary">å‡†å¤‡æ‰“çŒ...</div>';
                }
            }
        }

        // æ›´æ–°å±±æ´æ‰“çŒæ˜¾ç¤º
        function updateCaveHuntingDisplay() {
            const caveHuntCount = document.getElementById('cave-hunt-count');
            const caveHuntBtn = document.getElementById('cave-hunt-btn');
            const caveHuntingStatus = document.getElementById('cave-hunting-status');

            const cave = gameData.huntingSystem.cave;

            if (caveHuntCount) caveHuntCount.textContent = cave.huntCount;

            if (cave.isHunting) {
                const elapsed = Date.now() - cave.huntStartTime;
                const remaining = Math.max(0, cave.huntDuration - elapsed);

                if (remaining <= 0) {
                    addDebugLog('â° å±±æ´æ‰“çŒæ—¶é—´åˆ°ï¼Œè§¦å‘å®Œæˆæ‰“çŒ');
                    completeHunting('cave');
                    return;
                }

                const seconds = Math.max(1, Math.ceil(remaining / 1000));

                if (caveHuntBtn) {
                    caveHuntBtn.disabled = true;
                    caveHuntBtn.textContent = `ğŸ”ï¸ æ¢ç´¢ä¸­... (${seconds}ç§’)`;
                }

                if (caveHuntingStatus) {
                    caveHuntingStatus.innerHTML = `<div class="alert alert-info">æ­£åœ¨æ¢ç´¢å±±æ´... å‰©ä½™${seconds}ç§’</div>`;
                }
            } else {
                if (caveHuntBtn) {
                    caveHuntBtn.disabled = false;
                    caveHuntBtn.textContent = 'ğŸ”ï¸ æ¢ç´¢å±±æ´ (20ç§’)';
                }

                if (caveHuntingStatus) {
                    caveHuntingStatus.innerHTML = '<div class="alert alert-secondary">å‡†å¤‡æ¢ç´¢å±±æ´...</div>';
                }
            }
        }

        // æ£€æŸ¥äººæ•°è§£é”é…æ–¹
        function checkCustomerCountUnlock() {
            if (!gameData.customerCountUnlockRules) return;

            const servedCount = gameData.servedCustomers;

            Object.keys(gameData.customerCountUnlockRules).forEach(recipeName => {
                const rule = gameData.customerCountUnlockRules[recipeName];

                if (servedCount >= rule.customersRequired &&
                    !Object.keys(gameData.teaRecipes).includes(recipeName)) {

                    // è§£é”é…æ–¹
                    gameData.teaRecipes[recipeName] = rule.ingredients;

                    addDebugLog(`ğŸ‰ äººæ•°è§£é”æ–°é…æ–¹ï¼š${recipeName}ï¼(æœåŠ¡${servedCount}ä½é¡¾å®¢)`);

                    const unlockContent = `
                        <div style="text-align: center; margin-bottom: 15px;">
                            <h3 style="color: #0040c0; margin: 0;">ğŸ‰ äººæ•°è§£é”æ–°é…æ–¹ï¼š${recipeName}</h3>
                            <p style="color: #666; margin: 5px 0;">å·²æœåŠ¡ ${servedCount} ä½é¡¾å®¢</p>
                        </div>
                        <div style="text-align: left; line-height: 1.6;">
                            <div style="margin-bottom: 12px; padding: 8px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                                <strong>é…æ–¹æˆåˆ†ï¼š</strong><br>
                                ${rule.ingredients.join(' + ')}
                            </div>
                            <div style="color: #006600;">
                                æ­å–œæ‚¨è¾¾æˆæœåŠ¡é‡Œç¨‹ç¢‘ï¼è¿™æ˜¯å¯¹æ‚¨è¾›å‹¤ç»è¥çš„å¥–åŠ±ã€‚
                            </div>
                        </div>
                    `;
                    showWin95Modal('é‡Œç¨‹ç¢‘å¥–åŠ±', unlockContent, 'ğŸ†');

                    // æ›´æ–°æ˜¾ç¤º
                    updateAllInventoryDisplay();
                }
            });
        }

        // å½©è›‹ç ç³»ç»Ÿ
        function generateEasterEggCode(customerName, visitCount) {
            // åŸºäºè®¾å¤‡æŒ‡çº¹+æ—¶é—´æˆ³+é¡¾å®¢ä¿¡æ¯ç”Ÿæˆ
            const deviceFingerprint = navigator.userAgent + screen.width + screen.height;
            const timestamp = Date.now();
            const customerInfo = customerName + visitCount;

            // ç®€å•çš„å“ˆå¸Œå‡½æ•°
            function simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
                }
                return Math.abs(hash);
            }

            const hash = simpleHash(deviceFingerprint + timestamp + customerInfo);

            // ç”Ÿæˆæ ¼å¼ï¼šXXXX-XXXX-XXXX
            const part1 = (hash % 10000).toString().padStart(4, '0');
            const part2 = ((hash >> 4) % 10000).toString().padStart(4, '0');
            const part3 = ((hash >> 8) % 10000).toString().padStart(4, '0');

            return `${part1}-${part2}-${part3}`;
        }

        function checkEasterEggTrigger(customerName) {
            const visitCount = gameData.customerVisits[customerName] || 0;

            // è®¿é—®10æ¬¡ä»¥ä¸Šè§¦å‘å½©è›‹ç 
            if (visitCount >= 10) {
                const easterEggCode = generateEasterEggCode(customerName, visitCount);

                const easterEggContent = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="color: #ff6b35; margin: 0;">ğŸ ç‰¹æ®Šå½©è›‹ç ç”Ÿæˆï¼</h3>
                        <p style="color: #666; margin: 5px 0;">${customerName} ç¬¬ ${visitCount} æ¬¡è®¿é—®</p>
                    </div>
                    <div style="text-align: center; line-height: 1.8;">
                        <div style="margin: 15px 0; padding: 12px; background: #fff3cd; border: 2px dashed #ffc107; font-family: monospace; font-size: 12px; font-weight: bold; color: #856404;">
                            ${easterEggCode}
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 10px;">
                            è¿™æ˜¯æ‚¨ä¸ ${customerName} æ·±åšå‹è°Šçš„è§è¯ï¼<br>
                            è¯·å¦¥å–„ä¿å­˜è¿™ä¸ªç‹¬ç‰¹çš„çºªå¿µç ã€‚
                        </div>
                    </div>
                `;

                showWin95Modal('å‹è°Šçºªå¿µ', easterEggContent, 'ğŸ');

                // ç»™äºˆç‰¹æ®Šå¥–åŠ±
                gameData.funds += 500;
                addDebugLog(`ğŸ å½©è›‹ç å¥–åŠ±ï¼šè·å¾—500é‡‘å¸ï¼`);
                document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            }
        }

        // ç›´æ¥åŠ å·¥ææ–™
        function directProcessing(material) {
            const recipe = gameData.processingRecipes[material];
            if (!recipe) {
                alert(`${material} ä¸èƒ½ç›´æ¥åŠ å·¥`);
                return;
            }

            if (gameData.inventory[material] < 1) {
                alert(`${material} åº“å­˜ä¸è¶³ï¼`);
                return;
            }

            // æ‰¾åˆ°ç©ºé—²çš„åŠ å·¥å°
            const availableBoardIndex = gameData.processingBoards.findIndex(board => board.state === 'idle');
            if (availableBoardIndex === -1) {
                alert('æ‰€æœ‰åŠ å·¥å°éƒ½åœ¨å¿™ï¼Œè¯·ç­‰å¾…å½“å‰åŠ å·¥å®Œæˆï¼');
                return;
            }

            if (confirm(`ç¡®è®¤åŠ å·¥ ${material}ï¼Ÿ\nå°†è·å¾— ${recipe.output} ä¸ª ${material}ï¼Œè€—æ—¶ ${Math.round(recipe.time / 1000)} ç§’`)) {
                startProcessing(material, availableBoardIndex);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        document.querySelector('.close').onclick = function() {
            document.getElementById('seed-modal').style.display = 'none';
        }

        document.querySelector('.close-recipe').onclick = function() {
            document.getElementById('recipe-modal').style.display = 'none';
        }

        document.querySelector('.close-processing').onclick = function() {
            document.getElementById('processing-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const seedModal = document.getElementById('seed-modal');
            const recipeModal = document.getElementById('recipe-modal');
            const processingModal = document.getElementById('processing-modal');
            
            if (event.target === seedModal) {
                seedModal.style.display = 'none';
            }
            if (event.target === recipeModal) {
                recipeModal.style.display = 'none';
            }
            if (event.target === processingModal) {
                processingModal.style.display = 'none';
            }
        }

        // æ¸¸æˆå¾ªç¯æ›´æ–°
        function gameLoop() {
            // æ›´æ–°ç§æ¤è¿›åº¦
            let plotsUpdated = false;
            let hasGrowingPlots = false;
            
            gameData.plots.forEach((plot, index) => {
                if (plot.state === 'growing' && plot.plantType) {
                    hasGrowingPlots = true;
                    const baseGrowTime = seedsInfo[plot.plantType].growTime;

                    // åº”ç”¨å¤©æ°”å½±å“åˆ°ç”Ÿé•¿æ—¶é—´
                    const currentWeather = weathers[gameData.weather];
                    const weatherEffect = weatherGrowthEffects[currentWeather];
                    const growthMultiplier = weatherEffect ? weatherEffect.growthMultiplier : 1.0;
                    const adjustedGrowTime = baseGrowTime / growthMultiplier;

                    const totalElapsed = Date.now() - plot.plantTime;

                    if (totalElapsed >= adjustedGrowTime) {
                        // ç”Ÿé•¿å®Œæˆ
                        plot.state = 'ready';
                        plot.growthStage = 4;
                        plotsUpdated = true;
                        addDebugLog(`ç§æ¤åŒºåŸŸ ${index + 1} çš„ ${plot.plantType} ç”Ÿé•¿å®Œæˆï¼Œå¯ä»¥æ”¶è·äº†ï¼ï¼ˆå¤©æ°”åŠ æˆï¼š${growthMultiplier.toFixed(1)}xï¼‰`);
                    } else {
                        // æ›´æ–°ç”Ÿé•¿é˜¶æ®µï¼ˆç”¨äºæ˜¾ç¤ºè¿›åº¦ï¼‰
                        const progress = totalElapsed / adjustedGrowTime;
                        const newStage = Math.floor(progress * 4);
                        if (newStage !== plot.growthStage) {
                            plot.growthStage = newStage;
                            plotsUpdated = true;
                        }
                    }
                }
            });
            
            // å¦‚æœæœ‰ç”Ÿé•¿ä¸­çš„æ¤ç‰©ï¼Œå¼ºåˆ¶æ›´æ–°æ˜¾ç¤ºï¼ˆç”¨äºå€’è®¡æ—¶ï¼‰
            if (hasGrowingPlots) {
                plotsUpdated = true;
            }
            
            if (plotsUpdated) {
                renderFarmGrid();
            }

            // æ›´æ–°ç‚‰ç¶è¿›åº¦
            let stoveUpdated = false;
            gameData.stoves.forEach((stove, index) => {
                if (stove.state === 'cooking') {
                    const elapsed = Date.now() - stove.startTime;
                    if (elapsed >= stove.duration) {
                        // åˆ¶èŒ¶å®Œæˆ
                        const completedRecipe = stove.recipe;
                        const beforeTeaCount = gameData.madeTeas.length;
                        gameData.madeTeas.push({
                            name: stove.recipe,
                            temperature: 'çƒ­èŒ¶',
                            makeTime: new Date().toLocaleTimeString()
                        });
                        const afterTeaCount = gameData.madeTeas.length;
                        
                        stove.state = 'idle';
                        stove.recipe = null;
                        stoveUpdated = true;
                        
                        addDebugLog(`åˆ¶èŒ¶å®Œæˆï¼š${completedRecipe}ï¼ŒèŒ¶é¥®åº“å­˜ ${beforeTeaCount} â†’ ${afterTeaCount} (+1)`);
                        
                        // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                        updateAllInventoryDisplay();
                        showWin95Modal('åˆ¶èŒ¶å®Œæˆ', `<div style="text-align: center; line-height: 1.6;"><div style="font-size: 12px; margin-bottom: 8px;">ğŸµ ${completedRecipe} åˆ¶ä½œå®Œæˆï¼</div><div style="color: #006600;">å·²æ·»åŠ åˆ°èŒ¶é¥®åº“å­˜</div></div>`, 'ğŸµ');
                    } else {
                        stoveUpdated = true; // è¿›åº¦æ›´æ–°
                    }
                }
            });
            if (stoveUpdated) renderStoves();

            // æ›´æ–°æ‰“çŒå€’è®¡æ—¶
            if (gameData.huntingSystem) {
                if (gameData.huntingSystem.backMountain && gameData.huntingSystem.backMountain.isHunting) {
                    updateHuntingDisplay();
                }
                if (gameData.huntingSystem.cave && gameData.huntingSystem.cave.isHunting) {
                    updateCaveHuntingDisplay();
                }
            }

            // æ›´æ–°çƒ¤åˆ¶è¿›åº¦
            if (gameData.grillSystem && gameData.grillSystem.isGrilling) {
                updateGrillProgress();
            }

            // æ›´æ–°åŠ å·¥å°è¿›åº¦
            let processingUpdated = false;
            gameData.processingBoards.forEach((board, index) => {
                if (board.state === 'processing') {
                    const elapsed = Date.now() - board.startTime;
                    if (elapsed >= board.duration) {
                        // åŠ å·¥å®Œæˆ
                        const recipe = gameData.processingRecipes[board.recipe];
                        const recipeName = board.recipe;

                        // æ”¯æŒå¤šäº§å‡ºï¼ˆåŠ¨ç‰©åˆ†è§£ï¼‰å’Œå•äº§å‡ºï¼ˆå°æ–™åŠ å·¥ï¼‰
                        if (recipe.outputs) {
                            // å¤šäº§å‡ºæ¨¡å¼ï¼ˆåŠ¨ç‰©åˆ†è§£ï¼‰
                            let resultText = [];
                            recipe.outputs.forEach(output => {
                                if (!gameData.materials[output.name]) {
                                    gameData.materials[output.name] = 0;
                                }
                                const beforeCount = gameData.materials[output.name];
                                gameData.materials[output.name] += output.quantity;
                                const afterCount = gameData.materials[output.name];
                                resultText.push(`${output.name}Ã—${output.quantity}`);
                                addDebugLog(`åˆ†è§£è·å¾—ï¼š${output.name} ${beforeCount} â†’ ${afterCount} (+${output.quantity})`);
                            });

                            addDebugLog(`æ¡ˆæ¿${index + 1}åˆ†è§£å®Œæˆï¼š${recipeName} â†’ ${resultText.join(', ')}`);
                            showWin95Modal('åˆ†è§£å®Œæˆ',
                                `<div style="text-align: center; line-height: 1.6;">
                                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ”§ ${recipeName}å®Œæˆï¼</h3>
                                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">è·å¾—ææ–™ï¼š</div>
                                        ${resultText.map(item => `<div style="color: #666;">${item}</div>`).join('')}
                                    </div>
                                </div>`, 'ğŸ”§');
                        } else {
                            // å•äº§å‡ºæ¨¡å¼ï¼ˆå°æ–™åŠ å·¥ï¼‰
                            const beforeCount = gameData.toppings[recipeName] || 0;
                            gameData.toppings[recipeName] = beforeCount + recipe.output;
                            const afterCount = gameData.toppings[recipeName];

                            addDebugLog(`æ¡ˆæ¿${index + 1}åŠ å·¥å®Œæˆï¼š${recipeName} ${beforeCount} â†’ ${afterCount} (+${recipe.output})`);
                            showAlert(`${recipeName}åŠ å·¥å®Œæˆï¼è·å¾— ${recipe.output} ä¸ª`, 'åŠ å·¥å®Œæˆ', 'âœ…');
                        }

                        board.state = 'idle';
                        board.recipe = null;
                        board.startTime = 0;
                        board.duration = 0;

                        processingUpdated = true;
                        updateAllInventoryDisplay();
                        saveGameDataToDatabase();
                    } else {
                        processingUpdated = true; // è¿›åº¦æ›´æ–°
                    }
                }
            });
            if (processingUpdated) renderProcessingBoard();

            // æ›´æ–°é¡¾å®¢å’ŒçŒ«å’ªç³»ç»Ÿ
            updateCustomer();
            trySpawnCustomer();
            
            // æ¯10ç§’è¾“å‡ºä¸€æ¬¡ç³»ç»ŸçŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            if (Date.now() % 10000 < 1000) {
                const teaCount = gameData.madeTeas.length;
                const customerActive = gameData.customer.active;
                const plots = gameData.plots.map(p => p.state).join(',');
                addDebugLog(`ç³»ç»ŸçŠ¶æ€ - èŒ¶é¥®:${teaCount} é¡¾å®¢:${customerActive} åœ°å—:${plots}`);
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            initializeData();
            renderFarmGrid();
            renderWorkspaces();
            updateAllInventoryDisplay(); // ç¡®ä¿åº“å­˜æ˜¾ç¤ºæ­£ç¡®
            
            // æ›´æ–°æ‰€æœ‰èµ„é‡‘æ˜¾ç¤ºå…ƒç´ 
            updateAllFundsDisplay();
            
            // ä»æ•°æ®åº“åŠ è½½æ•°æ®
            loadGameDataFromDatabase();
            
            // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
            startAutoSave();
            
            // å¯åŠ¨æ¸¸æˆå¾ªç¯
            setInterval(gameLoop, 1000);

            // æ£€æŸ¥ç¨»é¦™æ‘è§£é”çŠ¶æ€
            updateRiceVillageDisplay();

            // å»¶è¿Ÿå†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
            setTimeout(() => {
                console.log('å»¶è¿Ÿæ£€æŸ¥ç¨»é¦™æ‘è§£é”çŠ¶æ€...');
                updateRiceVillageDisplay();
            }, 2000);

            addDebugLog('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
        }

        // æ›´æ–°æ‰€æœ‰èµ„é‡‘æ˜¾ç¤ºçš„å‡½æ•°
        function updateAllFundsDisplay() {
            // æ›´æ–°ä¸»è¦èµ„é‡‘æ˜¾ç¤º
            const currentFunds = document.getElementById('current-funds');
            if (currentFunds) currentFunds.textContent = gameData.funds + ' é‡‘å¸';
            
            // æ›´æ–°å•†åº—èµ„é‡‘æ˜¾ç¤º
            const shopFunds = document.getElementById('shop-funds');
            if (shopFunds) shopFunds.textContent = gameData.funds + ' é‡‘å¸';
            
            // æ›´æ–°è°ƒè¯•é¢æ¿èµ„é‡‘æ˜¾ç¤º
            const debugFunds = document.getElementById('debug-funds');
            if (debugFunds) debugFunds.textContent = gameData.funds + ' é‡‘å¸';
        }

        // æ•°æ®åº“ä¿å­˜åŠŸèƒ½
        function saveGameDataToDatabase() {
            const gameState = {
                timestamp: new Date().toISOString(),
                funds: gameData.funds,
                plots: gameData.plots,
                inventory: gameData.inventory,
                seeds: gameData.seeds,
                madeTeas: gameData.madeTeas,
                toppings: gameData.toppings,
                stoves: gameData.stoves,
                processingBoards: gameData.processingBoards,
                customer: gameData.customer,
                cats: gameData.cats,
                customers: gameData.customers,
                servedCustomers: gameData.servedCustomers,
                lastCustomerTime: gameData.lastCustomerTime,
                currentDay: gameData.currentDay,
                seasonDay: gameData.seasonDay,
                season: gameData.season,
                weather: gameData.weather,
                currentSeason: gameData.currentSeason,
                currentWeather: gameData.currentWeather,
                lastDayChange: gameData.lastDayChange,
                selectedCat: gameData.selectedCat,
                customerVisits: gameData.customerVisits,
                // æ–°å¢ï¼šèŒ¶é¥®é…æ–¹è§£é”çŠ¶æ€
                teaRecipes: gameData.teaRecipes,
                // æ–°å¢ï¼šæ‰“çŒå’Œçƒ¤è‚‰æ¶ç³»ç»ŸçŠ¶æ€
                materials: gameData.materials,
                huntingSystem: gameData.huntingSystem,
                grillSystem: gameData.grillSystem
            };
            
            // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
            localStorage.setItem('teaGameData', JSON.stringify(gameState));

            // åŒæ—¶æ›´æ–°æ§½ä½1ï¼ˆè‡ªåŠ¨å­˜æ¡£ï¼‰
            localStorage.setItem('teaGameSave_1', JSON.stringify(gameState));
            updateSaveSlotDisplay();

            // äº‘ç«¯åŒæ­¥ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡æ¸¸æˆï¼‰
            if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥ï¼ˆé¿å…é¢‘ç¹åŒæ­¥ï¼‰
                const now = Date.now();
                const timeSinceLastSync = now - cloudSaveConfig.lastSyncTime;

                if (timeSinceLastSync > 30000) { // 30ç§’å†…æœ€å¤šåŒæ­¥ä¸€æ¬¡
                    syncToCloud(1).catch(error => {
                        addDebugLog(`â˜ï¸ è‡ªåŠ¨äº‘ç«¯åŒæ­¥å¤±è´¥: ${error.message}`);
                    });
                }
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            addDebugLog(`ğŸ’¾ å‡†å¤‡ä¿å­˜åˆ°æ•°æ®åº“ï¼ŒcustomerVisits: ${JSON.stringify(gameState.customerVisits)}`);

            // GitHub Pagesç‰ˆæœ¬ï¼šåªä½¿ç”¨æœ¬åœ°å­˜å‚¨å’Œäº‘ç«¯åŒæ­¥
            console.log('GitHub Pagesç‰ˆæœ¬ï¼šæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');

            // æ›´æ–°è°ƒè¯•é¢æ¿çŠ¶æ€
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = 'localStorage';
                dbStatus.className = 'debug-status status-connected';
            }
            const lastSave = document.getElementById('last-save');
            if (lastSave) lastSave.textContent = new Date().toLocaleTimeString();

            addDebugLog('âœ… æ¸¸æˆæ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨æˆåŠŸï¼ˆåŒ…å«customerVisitsï¼‰');

            // æ›´æ–°äº‘ç«¯å­˜æ¡£çŠ¶æ€æ˜¾ç¤º
            const cloudStatus = document.getElementById('cloud-status');
            if (cloudStatus && cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                cloudStatus.textContent = 'å·²é…ç½®';
                cloudStatus.className = 'debug-status status-connected';
            } else if (cloudStatus) {
                cloudStatus.textContent = 'æœªè®¾ç½®';
                cloudStatus.className = 'debug-status status-loading';
            }
        }
        
        // GitHub Pagesç‰ˆæœ¬ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadGameDataFromDatabase() {
            console.log('GitHub Pagesç‰ˆæœ¬ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®');

            // ç›´æ¥ä»localStorageåŠ è½½
            loadFromLocalStorage();

            // è°ƒè¯•customerVisitsåŠ è½½æƒ…å†µ
            addDebugLog(`ğŸ“¥ ä»æœ¬åœ°å­˜å‚¨åŠ è½½customerVisits: ${JSON.stringify(gameData.customerVisits || {})}`);

            // æ›´æ–°è°ƒè¯•é¢æ¿çŠ¶æ€
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = 'localStorage';
                dbStatus.className = 'debug-status status-connected';
            }

            addDebugLog('âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®æˆåŠŸï¼ˆåŒ…å«customerVisitsï¼‰');

            // ç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            renderFarmGrid();
            renderWorkspaces();
            updateAllInventoryDisplay();
            const currentFunds = document.getElementById('current-funds');
            if (currentFunds) currentFunds.textContent = gameData.funds + ' é‡‘å¸';
            updateDebugDisplay();
        }

        // GitHub Pagesç‰ˆæœ¬ï¼šæœ¬åœ°é¡¾å®¢ç»Ÿè®¡åŒæ­¥
        function syncCustomerStatsFromDatabase() {
            addDebugLog('ğŸ“Š GitHub Pagesç‰ˆæœ¬ï¼šä½¿ç”¨æœ¬åœ°é¡¾å®¢ç»Ÿè®¡æ•°æ®');

            // ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´
            if (!gameData.customerVisits) gameData.customerVisits = {};
            if (!gameData.customers) gameData.customers = {};

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            renderCustomersTable();
            updateAllFundsDisplay();
            updateGrillAndHuntingDisplay();

            addDebugLog('âœ… æœ¬åœ°é¡¾å®¢ç»Ÿè®¡æ•°æ®åŒæ­¥å®Œæˆ');
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('teaGameData');
            if (savedData) {
                try {
                    const gameState = JSON.parse(savedData);
                    Object.assign(gameData, gameState);
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®');
                } catch (error) {
                    console.error('æœ¬åœ°å­˜å‚¨æ•°æ®è§£æå¤±è´¥:', error);
                }
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        function startAutoSave() {
            setInterval(() => {
                saveGameDataToDatabase();
            }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
        }

        // å¤©æ°”å’Œå­£èŠ‚ç³»ç»Ÿ
        const seasons = ['æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©'];
        const seasonsEmoji = ['ğŸŒ¸', 'â˜€ï¸', 'ğŸ‚', 'â„ï¸'];
        const weathers = ['æ™´å¤©', 'å¤šäº‘', 'é›¨å¤©', 'æš´é£é›¨'];
        const weathersEmoji = ['â˜€ï¸', 'â›…', 'ğŸŒ§ï¸', 'â›ˆï¸'];
        const weatherEffects = {
            'æ™´å¤©': 'ä½œç‰©ç”Ÿé•¿ +20%',
            'å¤šäº‘': 'ä½œç‰©ç”Ÿé•¿ æ­£å¸¸',
            'é›¨å¤©': 'ä½œç‰©ç”Ÿé•¿ +10%, è‡ªåŠ¨æµ‡æ°´',
            'æš´é£é›¨': 'ä½œç‰©ç”Ÿé•¿ -10%'
        };

        // å¤©æ°”å¯¹å†œä½œç‰©çš„å½±å“ç³»ç»Ÿ
        const weatherGrowthEffects = {
            'æ™´å¤©': { growthMultiplier: 1.2, moistureChange: -5, fertilityChange: 0 },
            'å¤šäº‘': { growthMultiplier: 1.0, moistureChange: -3, fertilityChange: 0 },
            'é›¨å¤©': { growthMultiplier: 1.1, moistureChange: +15, fertilityChange: +3 },
            'æš´é£é›¨': { growthMultiplier: 0.9, moistureChange: +10, fertilityChange: -5 }
        };

        // æ¨è¿›ä¸€å¤©
        function advanceDay() {
            gameData.currentDay++;
            gameData.seasonDay++;
            gameData.lastDayChange = Date.now();

            // æ¯10å¤©æ¢ä¸€ä¸ªå­£èŠ‚ï¼ˆæŒ‰ç…§è®¾å®šï¼‰
            if (gameData.seasonDay > 10) {
                gameData.seasonDay = 1;
                gameData.season = (gameData.season + 1) % 4;
                addDebugLog(`å­£èŠ‚å˜åŒ–ï¼šè¿›å…¥${seasons[gameData.season]}`);
            }
            
            // æ›´æ–°å­£èŠ‚å’Œå¤©æ°”æ–‡æœ¬
            gameData.currentSeason = seasons[gameData.season];
            gameData.currentWeather = weathers[gameData.weather];
            
            // éšæœºå˜åŒ–å¤©æ°”ï¼ˆ30%å‡ ç‡ï¼‰
            if (Math.random() < 0.3) {
                changeWeather();
            }
            
            addDebugLog(`æ—¶é—´æ¨è¿›ï¼šç¬¬${gameData.currentDay}å¤©ï¼Œ${gameData.currentSeason}ç¬¬${gameData.seasonDay}å¤©ï¼Œ${gameData.currentWeather}`);
            updateWeatherAndSeasonDisplay();

            // åº”ç”¨å¤©æ°”å½±å“åˆ°æ‰€æœ‰ç§æ¤ä¸­çš„ä½œç‰©
            applyWeatherEffects();

            saveGameDataToDatabase();
        }

        // åº”ç”¨å¤©æ°”å½±å“åˆ°å†œä½œç‰©
        function applyWeatherEffects() {
            const currentWeather = weathers[gameData.weather];
            const effects = weatherGrowthEffects[currentWeather];

            if (!effects) return;

            gameData.plots.forEach((plot, index) => {
                if (plot.state === 'growing') {
                    // åº”ç”¨æ¹¿åº¦å˜åŒ–
                    plot.moisture = Math.max(0, Math.min(100, plot.moisture + effects.moistureChange));

                    // åº”ç”¨è‚¥æ²ƒåº¦å˜åŒ–
                    plot.fertility = Math.max(0, Math.min(100, plot.fertility + effects.fertilityChange));

                    addDebugLog(`å¤©æ°”å½±å“ - ç”°åœ°${index + 1}: æ¹¿åº¦${effects.moistureChange > 0 ? '+' : ''}${effects.moistureChange}%, è‚¥æ²ƒåº¦${effects.fertilityChange > 0 ? '+' : ''}${effects.fertilityChange}%`);
                }
            });

            // æ›´æ–°æ˜¾ç¤º
            renderFarmGrid();
        }

        // æ”¹å˜å¤©æ°”
        function changeWeather() {
            const oldWeather = gameData.weather;
            gameData.weather = Math.floor(Math.random() * 4);
            gameData.currentWeather = weathers[gameData.weather];

            // è®°å½•å¤©æ°”å˜åŒ–æ—¶é—´
            gameData.lastWeatherChange = Date.now();

            if (oldWeather !== gameData.weather) {
                addDebugLog(`å¤©æ°”å˜åŒ–ï¼š${weathers[oldWeather]} â†’ ${weathers[gameData.weather]} (${weatherEffects[gameData.weather]})`);
                updateWeatherAndSeasonDisplay();

                // é›¨å¤©è‡ªåŠ¨æµ‡æ°´æ•ˆæœ
                if (gameData.weather === 2) { // é›¨å¤©
                    gameData.plots.forEach((plot, index) => {
                        if (plot.state !== 'empty') {
                            plot.moisture = Math.min(100, plot.moisture + 20);
                        }
                    });
                    addDebugLog('ğŸŒ§ï¸ é›¨å¤©è‡ªåŠ¨ä¸ºæ‰€æœ‰ç”°åœ°æµ‡æ°´ï¼');
                    renderFarmGrid();
                }
            }
        }

        // æ›´æ–°å¤©æ°”å’Œå­£èŠ‚æ˜¾ç¤º
        function updateWeatherAndSeasonDisplay() {
            // æ›´æ–°åŸºç¡€ä¿¡æ¯è¡¨æ ¼ä¸­çš„æ˜¾ç¤º
            const currentDayElement = document.getElementById('current-day');
            const currentSeasonElement = document.getElementById('current-season');
            const currentWeatherElement = document.getElementById('current-weather');
            
            if (currentDayElement) {
                currentDayElement.textContent = `ç¬¬${gameData.currentDay}å¤©`;
            }
            
            if (currentSeasonElement) {
                currentSeasonElement.innerHTML = `${gameData.currentSeason} (ç¬¬${gameData.seasonDay}å¤©)`;
            }
            
            if (currentWeatherElement) {
                const currentWeatherName = weathers[gameData.weather];
                const weatherEffect = weatherEffects[currentWeatherName];
                currentWeatherElement.innerHTML = `<span class="weather-icon">${weathersEmoji[gameData.weather]}</span> ${gameData.currentWeather}<br><small>${weatherEffect}</small>`;
            }
            
            // æ›´æ–°è°ƒè¯•é¢æ¿ä¸­çš„æ˜¾ç¤º
            updateDebugDisplay();
        }

        // æ¸¸æˆæ—¶é—´å¾ªç¯ï¼ˆæŒ‰ç…§è®¾å®šè¿è¡Œï¼‰
        function startGameTimeLoop() {
            // å¤©æ°”å˜åŒ–å¾ªç¯ - æ¯1åˆ†é’Ÿå˜åŒ–ä¸€æ¬¡å¤©æ°”
            setInterval(() => {
                changeWeather();
                addDebugLog('å¤©æ°”è‡ªåŠ¨å˜åŒ–');
            }, 60000); // 1åˆ†é’Ÿå˜åŒ–ä¸€æ¬¡å¤©æ°”

            // æ—¶é—´æ¨è¿›å¾ªç¯ - æ¯30ç§’æœ‰æœºä¼šæ¨è¿›ä¸€å¤©
            setInterval(() => {
                // æ¯30ç§’æœ‰20%çš„å‡ ç‡æ¨è¿›ä¸€å¤©ï¼Œè®©æ¸¸æˆæ›´æ´»è·ƒ
                if (Math.random() < 0.2) {
                    advanceDay();
                }
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

            // å¿«é€Ÿæ—¶é—´æ¨è¿›ï¼ˆç”¨äºæµ‹è¯•å’Œæ´»è·ƒæ¸¸æˆï¼‰
            setInterval(() => {
                // æ¯10ç§’æœ‰5%çš„å‡ ç‡æ¨è¿›ä¸€å¤©
                if (Math.random() < 0.05) {
                    advanceDay();
                }
            }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // æ‰‹åŠ¨æ¨è¿›æ—¶é—´ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function forceAdvanceDay() {
            advanceDay();
            addDebugLog('æ‰‹åŠ¨æ¨è¿›äº†ä¸€å¤©');
            alert(`æ—¶é—´æ¨è¿›ï¼ç°åœ¨æ˜¯ç¬¬${gameData.currentDay}å¤©ï¼Œ${gameData.currentSeason}ç¬¬${gameData.seasonDay}å¤©`);
        }

        // è°ƒè¯•é¢æ¿ç›¸å…³å‡½æ•°
        function toggleDebugContent() {
            const panel = document.getElementById('debug-panel');
            const content = document.getElementById('debug-content');
            const toggle = document.querySelector('.debug-toggle');
            
            if (panel.classList.contains('collapsed')) {
                // å±•å¼€åˆ°é•¿æ¡çŠ¶æ€
                panel.classList.remove('collapsed');
                toggle.textContent = 'âˆ’';
                addDebugLog('è°ƒè¯•é¢æ¿å·²å±•å¼€');
            } else {
                // ç¼©èµ·æ¥å˜æˆåœ†çƒ
                panel.classList.add('collapsed');
                addDebugLog('è°ƒè¯•é¢æ¿å·²æ”¶èµ·');
            }
        }
        
        function addDebugLog(message) {
            const log = document.getElementById('debug-log');
            if (log) {
                const timestamp = new Date().toLocaleTimeString();
                log.innerHTML += `[${timestamp}] ${message}<br>`;
                log.scrollTop = log.scrollHeight;
            }
        }
        
        function clearDebugLog() {
            const log = document.getElementById('debug-log');
            if (log) log.innerHTML = 'æ—¥å¿—å·²æ¸…ç©º<br>';
        }

        // æµ‹è¯•å‡½æ•°ï¼šç«‹å³ç”Ÿæˆé¡¾å®¢
        function forceSpawnCustomer() {
            if (gameData.customer.active) {
                addDebugLog('å½“å‰å·²æœ‰é¡¾å®¢ï¼Œæ— æ³•ç”Ÿæˆæ–°é¡¾å®¢');
                alert('å½“å‰å·²æœ‰é¡¾å®¢åœ¨ç­‰å¾…ï¼');
                return;
            }
            
            spawnRandomCustomer();
            addDebugLog('æ‰‹åŠ¨è§¦å‘ï¼šç«‹å³ç”Ÿæˆäº†ä¸€ä¸ªé¡¾å®¢');
            alert('æˆåŠŸç”Ÿæˆé¡¾å®¢ï¼');
        }

        // æµ‹è¯•å‡½æ•°ï¼šæ·»åŠ æµ‹è¯•ææ–™
        function addTestMaterials() {
            // æ·»åŠ å„ç§åŸºç¡€ææ–™ç”¨äºæµ‹è¯•
            const testMaterials = ['äº”å‘³å­', 'æŸ æª¬', 'å±±æ¥‚', 'æ¡‚åœ†', 'çº¢æ£', 'æ¸æ', 'å¤§éº¦', 'è–„è·', 'ç”˜è‰'];
            testMaterials.forEach(material => {
                gameData.inventory[material] = (gameData.inventory[material] || 0) + 10;
            });
            
            // æ·»åŠ ä¸€äº›ç§å­
            testMaterials.forEach(material => {
                gameData.seeds[material] = (gameData.seeds[material] || 0) + 5;
            });
            
            // æ›´æ–°æ˜¾ç¤º
            updateAllInventoryDisplay();
            addDebugLog('æ·»åŠ äº†æµ‹è¯•ææ–™ï¼š' + testMaterials.join(', ') + 'ï¼ˆå„10ä¸ªï¼‰');
            alert('å·²æ·»åŠ æµ‹è¯•ææ–™ï¼ç°åœ¨å¯ä»¥å°è¯•åˆ¶ä½œèŒ¶é¥®äº†ã€‚');
            saveGameDataToDatabase();
        }
        
        function updateDebugDisplay() {
            try {
                // æ›´æ–°å¤©æ°”å’Œå­£èŠ‚æ˜¾ç¤º
                const debugDay = document.getElementById('debug-day');
                if (debugDay) debugDay.textContent = `ç¬¬${gameData.currentDay}å¤©`;
                
                const debugSeason = document.getElementById('debug-season');
                if (debugSeason) debugSeason.textContent = `${gameData.currentSeason} (ç¬¬${gameData.seasonDay}å¤©)`;
                
                const debugWeather = document.getElementById('debug-weather');
                if (debugWeather) debugWeather.innerHTML = `<span class="weather-icon">${weathersEmoji[gameData.weather]}</span> ${gameData.currentWeather}`;
                
                // æ›´æ–°èµ„é‡‘æ˜¾ç¤º
                const debugFunds = document.getElementById('debug-funds');
                if (debugFunds) debugFunds.textContent = gameData.funds + ' é‡‘å¸';
                
                // è®¡ç®—ç§å­æ€»æ•°
                const totalSeeds = Object.values(gameData.seeds).reduce((sum, count) => sum + count, 0);
                const debugSeeds = document.getElementById('debug-seeds');
                if (debugSeeds) debugSeeds.textContent = totalSeeds + ' ä¸ª';
                
                // è®¡ç®—ææ–™æ€»æ•°
                const totalMaterials = Object.values(gameData.inventory).reduce((sum, count) => sum + count, 0);
                const debugMaterials = document.getElementById('debug-materials');
                if (debugMaterials) debugMaterials.textContent = totalMaterials + ' ä¸ª';

                // æ›´æ–°æœåŠ¡é¡¾å®¢æ•°
                const debugServedCustomers = document.getElementById('debug-served-customers');
                if (debugServedCustomers) debugServedCustomers.textContent = gameData.servedCustomers + ' ä½';
                
                // è®¡ç®—å°æ–™æ€»æ•°
                const totalToppings = Object.values(gameData.toppings).reduce((sum, count) => sum + count, 0);
                const debugToppings = document.getElementById('debug-toppings');
                if (debugToppings) debugToppings.textContent = totalToppings + ' ä¸ª';
                
                // æ›´æ–°ç§æ¤çŠ¶æ€
                const debugPlots = document.getElementById('debug-plots');
                if (debugPlots) {
                    debugPlots.innerHTML = '';
                    gameData.plots.forEach((plot, index) => {
                        const plotInfo = document.createElement('div');
                        plotInfo.className = 'debug-item';
                        plotInfo.innerHTML = `
                            <span>åœ°å—${index + 1}:</span>
                            <span>${plot.state === 'empty' ? 'ç©ºé—²' : 
                                   plot.state === 'growing' ? `ç§æ¤${plot.plantType}` : 
                                   `${plot.plantType}å¯æ”¶è·`}</span>
                        `;
                        debugPlots.appendChild(plotInfo);
                    });
                }
            } catch (error) {
                console.error('æ›´æ–°è°ƒè¯•æ˜¾ç¤ºæ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }
        
        // GitHub Pagesç‰ˆæœ¬ï¼šæµ‹è¯•æœ¬åœ°å­˜å‚¨
        function testLocalStorage() {
            addDebugLog('æ­£åœ¨æµ‹è¯•æœ¬åœ°å­˜å‚¨...');
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = 'æµ‹è¯•ä¸­...';
                dbStatus.className = 'debug-status status-loading';
            }

            try {
                // æµ‹è¯•localStorageè¯»å†™
                const testData = { test: 'GitHub Pagesç‰ˆæœ¬', timestamp: Date.now() };
                localStorage.setItem('teaGameTest', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('teaGameTest'));

                if (retrieved && retrieved.test === 'GitHub Pagesç‰ˆæœ¬') {
                    if (dbStatus) {
                        dbStatus.textContent = 'localStorage';
                        dbStatus.className = 'debug-status status-connected';
                    }
                    addDebugLog('âœ… æœ¬åœ°å­˜å‚¨æµ‹è¯•æˆåŠŸ');

                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    localStorage.removeItem('teaGameTest');
                } else {
                    throw new Error('æ•°æ®è¯»å–éªŒè¯å¤±è´¥');
                }
            } catch (error) {
                if (dbStatus) {
                    dbStatus.textContent = 'å­˜å‚¨å¤±è´¥';
                    dbStatus.className = 'debug-status status-error';
                }
                addDebugLog('âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        function forceSaveGame() {
            addDebugLog('å¼ºåˆ¶ä¿å­˜æ¸¸æˆæ•°æ®...');
            saveGameDataToDatabase();
            const lastSave = document.getElementById('last-save');
            if (lastSave) lastSave.textContent = new Date().toLocaleTimeString();
        }
        
        function forceLoadGame() {
            addDebugLog('å¼ºåˆ¶åŠ è½½æ¸¸æˆæ•°æ®...');
            loadGameDataFromDatabase();
            updateDebugDisplay();
        }

        // é‡ç½®æ¸¸æˆæ•°æ®å‡½æ•°
        function resetGameData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼ˆåŒ…æ‹¬1000é‡‘å¸ï¼‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('teaGameData');
                
                // é‡ç½®gameDataä¸ºåˆå§‹çŠ¶æ€
                gameData.funds = 1000;
                gameData.currentDay = 1;
                gameData.seasonDay = 1;
                gameData.season = 0;
                gameData.weather = 0;
                gameData.currentSeason = "æ˜¥å¤©";
                gameData.currentWeather = "æ™´å¤©";
                gameData.lastDayChange = Date.now();
                gameData.servedCustomers = 0;
                gameData.lastCustomerTime = 0;
                
                // é‡ç½®æ‰€æœ‰æ•°ç»„å’Œå¯¹è±¡
                gameData.plots.forEach(plot => {
                    plot.state = 'empty';
                    plot.moisture = 50;
                    plot.fertility = 50;
                    plot.plantType = null;
                    plot.growthStage = 0;
                    plot.stageStartTime = 0;
                });
                
                gameData.stoves.forEach(stove => {
                    stove.state = 'idle';
                    stove.recipe = null;
                    stove.startTime = 0;
                });
                
                gameData.processingBoards.forEach(board => {
                    board.state = 'idle';
                    board.recipe = null;
                    board.startTime = 0;
                    board.duration = 0;
                });
                
                gameData.madeTeas = [];
                
                // é‡æ–°åˆå§‹åŒ–æ•°æ®
                initializeData();
                
                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                updateAllFundsDisplay();
                renderFarmGrid();
                renderWorkspaces();
                updateAllInventoryDisplay();
                updateDebugDisplay();
                
                // ä¿å­˜é‡ç½®åçš„æ•°æ®
                saveGameDataToDatabase();
                
                addDebugLog('æ¸¸æˆæ•°æ®å·²é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ï¼Œå½“å‰èµ„é‡‘: 1000é‡‘å¸');
                alert('æ¸¸æˆæ•°æ®å·²é‡ç½®ï¼å½“å‰èµ„é‡‘: 1000é‡‘å¸');
            }
        }

        // å°æ–™å•†åº—ç›¸å…³å‡½æ•°
        function openToppingsShop() {
            const modal = document.getElementById('toppings-shop-modal');
            const shopFunds = document.getElementById('shop-funds');
            const shopGrid = document.getElementById('toppings-shop-grid');
            
            // æ›´æ–°èµ„é‡‘æ˜¾ç¤º
            if (shopFunds) {
                shopFunds.textContent = gameData.funds + ' é‡‘å¸';
            }
            
            // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆå•†å“åˆ—è¡¨
            if (shopGrid) {
                shopGrid.innerHTML = '';
                
                Object.entries(toppingsShop).forEach(([itemName, itemData]) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'topping-item';
                    
                    const currentStock = gameData.toppings[itemName] || 0;
                    const canAfford = gameData.funds >= itemData.price;
                    
                    itemDiv.innerHTML = `
                        <div class="topping-name">${itemName}</div>
                        <div class="topping-price">${itemData.price} é‡‘å¸</div>
                        <div class="topping-stock">åº“å­˜: ${currentStock}</div>
                        <div class="topping-description">${itemData.description}</div>
                        <button class="buy-btn" onclick="buyTopping('${itemName}')" ${canAfford ? '' : 'disabled'}>
                            ${canAfford ? 'è´­ä¹°' : 'èµ„é‡‘ä¸è¶³'}
                        </button>
                    `;
                    
                    shopGrid.appendChild(itemDiv);
                });
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function buyTopping(itemName) {
            const itemData = toppingsShop[itemName];
            if (!itemData) {
                addDebugLog(`æœªæ‰¾åˆ°å•†å“ï¼š${itemName}`);
                return;
            }
            
            if (gameData.funds < itemData.price) {
                addDebugLog(`èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹°${itemName}ï¼ˆéœ€è¦${itemData.price}é‡‘å¸ï¼‰`);
                alert('èµ„é‡‘ä¸è¶³ï¼');
                return;
            }
            
            // æ‰£é™¤é‡‘å¸
            gameData.funds -= itemData.price;
            
            // å¢åŠ å°æ–™åº“å­˜
            if (!gameData.toppings[itemName]) {
                gameData.toppings[itemName] = 0;
            }
            gameData.toppings[itemName] += 1;
            
            // æ›´æ–°æ˜¾ç¤º
            updateAllInventoryDisplay();
            document.getElementById('current-funds').textContent = gameData.funds + ' é‡‘å¸';
            
            // é‡æ–°æ‰“å¼€å•†åº—ä»¥åˆ·æ–°æ˜¾ç¤º
            openToppingsShop();
            
            addDebugLog(`è´­ä¹°äº† ${itemName}ï¼ŒèŠ±è´¹ ${itemData.price} é‡‘å¸`);
            
            // ä¿å­˜æ•°æ®
            saveGameDataToDatabase();
        }

        function closeToppingsShop() {
            const modal = document.getElementById('toppings-shop-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // å”®å–åŠ¨ç‰©å‰¯äº§å“
        function sellByproduct(itemName) {
            if (!gameData.materials || !gameData.materials[itemName] || gameData.materials[itemName] <= 0) {
                showAlert('æ²¡æœ‰å¯å”®å–çš„ç‰©å“ï¼', 'å”®å–å¤±è´¥', 'âŒ');
                return;
            }

            const byproduct = animalByproducts[itemName];
            if (!byproduct) {
                showAlert('è¯¥ç‰©å“ä¸å¯å”®å–ï¼', 'å”®å–å¤±è´¥', 'âŒ');
                return;
            }

            // ç¡®è®¤å”®å–
            const sellContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ’° ç¡®è®¤å”®å–</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">${itemName}</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">å½“å‰åº“å­˜: ${gameData.materials[itemName]}ä¸ª</div>
                        <div style="color: #22c55e; font-weight: bold;">å”®ä»·: ${byproduct.price}é‡‘å¸/ä¸ª</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button style="width: 48%; padding: 8px; margin-right: 4%; background: #22c55e; color: white; border: 1px solid #16a34a; cursor: pointer;"
                                onclick="confirmSellByproduct('${itemName}', 1); closeModal();">
                            å”®å–1ä¸ª
                        </button>
                        <button style="width: 48%; padding: 8px; background: #3b82f6; color: white; border: 1px solid #2563eb; cursor: pointer;"
                                onclick="confirmSellByproduct('${itemName}', ${gameData.materials[itemName]}); closeModal();">
                            å…¨éƒ¨å”®å–
                        </button>
                    </div>
                </div>
            `;

            showWin95Modal('å”®å–å‰¯äº§å“', sellContent, 'ğŸ’°');
        }

        // ç¡®è®¤å”®å–å‰¯äº§å“
        function confirmSellByproduct(itemName, quantity) {
            if (!gameData.materials || !gameData.materials[itemName] || gameData.materials[itemName] < quantity) {
                showAlert('åº“å­˜ä¸è¶³ï¼', 'å”®å–å¤±è´¥', 'âŒ');
                return;
            }

            const byproduct = animalByproducts[itemName];
            const totalPrice = byproduct.price * quantity;

            // æ‰£é™¤ç‰©å“ï¼Œå¢åŠ é‡‘å¸
            const beforeCount = gameData.materials[itemName];
            gameData.materials[itemName] = Math.max(0, beforeCount - quantity);
            const afterCount = gameData.materials[itemName];

            gameData.funds += totalPrice;

            addDebugLog(`ğŸ’° å”®å–${itemName}Ã—${quantity}ï¼Œè·å¾—${totalPrice}é‡‘å¸`);
            addDebugLog(`  - ${itemName}: ${beforeCount} â†’ ${afterCount} (-${quantity})`);
            addDebugLog(`  - é‡‘å¸: ${gameData.funds - totalPrice} â†’ ${gameData.funds} (+${totalPrice})`);

            showAlert(`æˆåŠŸå”®å–${itemName}Ã—${quantity}ï¼Œè·å¾—${totalPrice}é‡‘å¸ï¼`, 'å”®å–æˆåŠŸ', 'ğŸ’°');

            // æ›´æ–°æ˜¾ç¤º
            updateAllInventoryDisplay();
            updateAllFundsDisplay();
            saveGameDataToDatabase();
        }

        // ===== äº‘ç«¯å­˜å‚¨åŠŸèƒ½ =====

        // æ˜¾ç¤ºäº‘ç«¯å­˜å‚¨è®¾ç½®ç•Œé¢
        function showCloudSaveSettings() {
            const currentToken = cloudSaveConfig.githubToken;
            const currentGistId = cloudSaveConfig.gistId;
            const isConnected = currentToken && currentGistId;

            const settingsContent = `
                <div style="text-align: left; line-height: 1.6; max-width: 500px;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">â˜ï¸ äº‘ç«¯å­˜æ¡£è®¾ç½®</h3>

                    <div style="margin-bottom: 15px; padding: 12px; background: ${isConnected ? '#f0f8ff' : '#fff8dc'}; border: 1px inset #c0c0c0;">
                        <div style="font-weight: bold; margin-bottom: 8px;">
                            çŠ¶æ€: ${isConnected ? 'âœ… å·²è¿æ¥åˆ°äº‘ç«¯' : 'âš ï¸ æœªè¿æ¥äº‘ç«¯'}
                        </div>
                        ${isConnected ? `<div style="font-size: 12px; color: #666;">Gist ID: ${currentGistId}</div>` : ''}
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">GitHub Personal Access Token:</label>
                        <input type="password" id="github-token-input" value="${currentToken}"
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; font-family: monospace; font-size: 12px;">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            éœ€è¦ 'gist' æƒé™ï¼Œ<a href="#" onclick="showTokenHelp()">å¦‚ä½•åˆ›å»ºTokenï¼Ÿ</a>
                        </small>
                    </div>

                    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="testGitHubConnection()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; cursor: pointer;">
                            æµ‹è¯•è¿æ¥
                        </button>
                        <button onclick="saveCloudSettings()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; cursor: pointer;">
                            ä¿å­˜è®¾ç½®
                        </button>
                        ${isConnected ? `
                        <button onclick="syncToCloud()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; cursor: pointer;">
                            ç«‹å³åŒæ­¥
                        </button>` : ''}
                    </div>

                    <div id="cloud-connection-status" style="margin-top: 15px; padding: 8px; background: #f9f9f9; border: 1px inset #c0c0c0; min-height: 20px;">
                        ${isConnected ? 'äº‘ç«¯å­˜æ¡£å·²å°±ç»ªï¼Œæ¸¸æˆæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°GitHub Gist' : 'è¯·è®¾ç½®GitHub Tokenä»¥å¯ç”¨äº‘ç«¯å­˜æ¡£åŠŸèƒ½'}
                    </div>

                    <div style="margin-top: 15px; font-size: 12px; color: #666; line-height: 1.4;">
                        <strong>è¯´æ˜ï¼š</strong><br>
                        â€¢ äº‘ç«¯å­˜æ¡£å®Œå…¨å…è´¹ï¼Œæ•°æ®å­˜å‚¨åœ¨ä½ çš„GitHubè´¦å·ä¸­<br>
                        â€¢ æ”¯æŒå¤šè®¾å¤‡åŒæ­¥ï¼Œä»»ä½•åœ°æ–¹éƒ½èƒ½ç»§ç»­æ¸¸æˆ<br>
                        â€¢ Tokenåªéœ€è¦'gist'æƒé™ï¼Œå®‰å…¨å¯æ§<br>
                        â€¢ å³ä½¿ä¸è®¾ç½®äº‘ç«¯å­˜æ¡£ï¼Œæ¸¸æˆä¹Ÿä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­
                    </div>
                </div>
            `;

            showWin95Modal('äº‘ç«¯å­˜æ¡£è®¾ç½®', settingsContent, 'â˜ï¸');
        }

        // æ˜¾ç¤ºTokenåˆ›å»ºå¸®åŠ©
        function showTokenHelp() {
            const helpContent = `
                <div style="text-align: left; line-height: 1.6; max-width: 600px;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ“ å¦‚ä½•åˆ›å»ºGitHub Token</h3>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #d2691e; margin: 10px 0 5px 0;">æ­¥éª¤1ï¼šè¿›å…¥GitHubè®¾ç½®</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li>è®¿é—® <a href="https://github.com" target="_blank">github.com</a> å¹¶ç™»å½•</li>
                            <li>ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ Settings</li>
                            <li>å·¦ä¾§èœå• â†’ Developer settings</li>
                            <li>Personal access tokens â†’ Tokens (classic)</li>
                        </ol>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #d2691e; margin: 10px 0 5px 0;">æ­¥éª¤2ï¼šåˆ›å»ºæ–°Token</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li>ç‚¹å‡» "Generate new token" â†’ "Generate new token (classic)"</li>
                            <li>Note: å¡«å†™ "Farm Game Data Storage"</li>
                            <li>Expiration: é€‰æ‹© "No expiration"</li>
                            <li>æƒé™åªå‹¾é€‰: <strong>âœ… gist</strong></li>
                            <li>ç‚¹å‡» "Generate token"</li>
                        </ol>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #d2691e; margin: 10px 0 5px 0;">æ­¥éª¤3ï¼šå¤åˆ¶Token</h4>
                        <div style="padding: 10px; background: #fff8dc; border: 1px solid #ddd;">
                            <strong>é‡è¦ï¼š</strong>ç”Ÿæˆåç«‹å³å¤åˆ¶Tokenï¼ˆç±»ä¼¼ ghp_xxxxxxxxxxxxxxxxxxxxï¼‰ï¼Œ
                            é¡µé¢åˆ·æ–°åå°±çœ‹ä¸åˆ°äº†ï¼
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #d2691e; margin: 10px 0 5px 0;">æ­¥éª¤4ï¼šåœ¨æ¸¸æˆä¸­ä½¿ç”¨</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li>å°†Tokenç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†ä¸­</li>
                            <li>ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯</li>
                            <li>ç‚¹å‡»"ä¿å­˜è®¾ç½®"å®Œæˆé…ç½®</li>
                        </ol>
                    </div>

                    <div style="padding: 10px; background: #f0f8ff; border: 1px solid #ddd; font-size: 12px;">
                        <strong>å®‰å…¨æç¤ºï¼š</strong><br>
                        â€¢ Tokenåªæœ‰'gist'æƒé™ï¼Œæ— æ³•è®¿é—®ä½ çš„ä»£ç ä»“åº“<br>
                        â€¢ å¯ä»¥éšæ—¶åœ¨GitHubè®¾ç½®ä¸­åˆ é™¤Token<br>
                        â€¢ Tokenä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="window.open('https://github.com/settings/tokens', '_blank')"
                                style="padding: 10px 20px; background: #22c55e; color: white; border: none; cursor: pointer;">
                            ğŸš€ æ‰“å¼€GitHub Tokené¡µé¢
                        </button>
                    </div>
                </div>
            `;

            showWin95Modal('GitHub Tokenåˆ›å»ºæ•™ç¨‹', helpContent, 'ğŸ“');
        }

        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            const tokenInput = document.getElementById('github-token-input');
            const statusDiv = document.getElementById('cloud-connection-status');

            if (!tokenInput || !tokenInput.value.trim()) {
                statusDiv.innerHTML = 'âŒ è¯·å…ˆè¾“å…¥GitHub Token';
                statusDiv.style.background = '#ffe6e6';
                return;
            }

            const token = tokenInput.value.trim();
            statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...';
            statusDiv.style.background = '#fff8dc';

            try {
                // æµ‹è¯•Tokenæ˜¯å¦æœ‰æ•ˆ
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const userData = await response.json();

                statusDiv.innerHTML = `âœ… è¿æ¥æˆåŠŸï¼GitHubç”¨æˆ·: ${userData.login}`;
                statusDiv.style.background = '#f0f8ff';

                addDebugLog(`âœ… GitHubè¿æ¥æµ‹è¯•æˆåŠŸï¼Œç”¨æˆ·: ${userData.login}`);

            } catch (error) {
                statusDiv.innerHTML = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
                statusDiv.style.background = '#ffe6e6';
                addDebugLog(`âŒ GitHubè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // ä¿å­˜äº‘ç«¯è®¾ç½®
        async function saveCloudSettings() {
            const tokenInput = document.getElementById('github-token-input');
            const statusDiv = document.getElementById('cloud-connection-status');

            if (!tokenInput || !tokenInput.value.trim()) {
                statusDiv.innerHTML = 'âŒ è¯·å…ˆè¾“å…¥GitHub Token';
                statusDiv.style.background = '#ffe6e6';
                return;
            }

            const token = tokenInput.value.trim();
            statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ä¿å­˜è®¾ç½®...';
            statusDiv.style.background = '#fff8dc';

            try {
                // ä¿å­˜Tokenåˆ°æœ¬åœ°
                cloudSaveConfig.githubToken = token;
                localStorage.setItem('githubToken', token);

                // å¦‚æœæ²¡æœ‰Gist IDï¼Œåˆ›å»ºæ–°çš„Gist
                if (!cloudSaveConfig.gistId) {
                    const gistId = await createGameDataGist(token);
                    cloudSaveConfig.gistId = gistId;
                    localStorage.setItem('gistId', gistId);
                }

                // ç«‹å³åŒæ­¥å½“å‰æ¸¸æˆæ•°æ®
                await syncToCloud();

                statusDiv.innerHTML = 'âœ… è®¾ç½®ä¿å­˜æˆåŠŸï¼äº‘ç«¯å­˜æ¡£å·²å¯ç”¨';
                statusDiv.style.background = '#f0f8ff';

                addDebugLog('âœ… äº‘ç«¯å­˜æ¡£è®¾ç½®ä¿å­˜æˆåŠŸ');

                // å…³é—­è®¾ç½®çª—å£
                setTimeout(() => {
                    closeModal();
                    showAlert('äº‘ç«¯å­˜æ¡£å·²å¯ç”¨ï¼æ¸¸æˆæ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°GitHub', 'è®¾ç½®æˆåŠŸ', 'â˜ï¸');
                }, 1500);

            } catch (error) {
                statusDiv.innerHTML = `âŒ ä¿å­˜å¤±è´¥: ${error.message}`;
                statusDiv.style.background = '#ffe6e6';
                addDebugLog(`âŒ äº‘ç«¯å­˜æ¡£è®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ›å»ºæ¸¸æˆæ•°æ®Gist
        async function createGameDataGist(token) {
            const gistData = {
                description: "Farm Game Save Data - å¯çˆ±èŒ¶é“ºå†œåœºç®¡ç†ç³»ç»Ÿå­˜æ¡£",
                public: false, // ç§æœ‰Gist
                files: {
                    "save1.json": {
                        content: JSON.stringify({
                            ...gameData,
                            timestamp: new Date().toISOString(),
                            saveSlot: 1,
                            description: "å­˜æ¡£æ§½1 - è‡ªåŠ¨ä¿å­˜"
                        }, null, 2)
                    },
                    "save2.json": {
                        content: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            saveSlot: 2,
                            description: "å­˜æ¡£æ§½2 - ç©ºå­˜æ¡£",
                            empty: true
                        }, null, 2)
                    },
                    "save3.json": {
                        content: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            saveSlot: 3,
                            description: "å­˜æ¡£æ§½3 - ç©ºå­˜æ¡£",
                            empty: true
                        }, null, 2)
                    },
                    "save4.json": {
                        content: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            saveSlot: 4,
                            description: "å­˜æ¡£æ§½4 - ç©ºå­˜æ¡£",
                            empty: true
                        }, null, 2)
                    },
                    "README.md": {
                        content: `# å¯çˆ±èŒ¶é“ºå†œåœºç®¡ç†ç³»ç»Ÿ - æ¸¸æˆå­˜æ¡£

è¿™ä¸ªGistå­˜å‚¨äº†ä½ çš„æ¸¸æˆå­˜æ¡£æ•°æ®ã€‚

## å­˜æ¡£è¯´æ˜
- save1.json: å­˜æ¡£æ§½1 (è‡ªåŠ¨ä¿å­˜)
- save2.json: å­˜æ¡£æ§½2 (æ‰‹åŠ¨å­˜æ¡£)
- save3.json: å­˜æ¡£æ§½3 (æ‰‹åŠ¨å­˜æ¡£)
- save4.json: å­˜æ¡£æ§½4 (æ‰‹åŠ¨å­˜æ¡£)

## æ³¨æ„äº‹é¡¹
- è¯·ä¸è¦æ‰‹åŠ¨ä¿®æ”¹è¿™äº›æ–‡ä»¶
- æ¸¸æˆä¼šè‡ªåŠ¨åŒæ­¥æ•°æ®åˆ°è¿™é‡Œ
- å¦‚éœ€å¤‡ä»½ï¼Œå¯ä»¥ä¸‹è½½æ•´ä¸ªGist

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
`
                    }
                }
            };

            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                throw new Error(`åˆ›å»ºGistå¤±è´¥: HTTP ${response.status}`);
            }

            const gist = await response.json();
            addDebugLog(`âœ… åˆ›å»ºæ¸¸æˆå­˜æ¡£GistæˆåŠŸï¼ŒID: ${gist.id}`);

            return gist.id;
        }

        // åŒæ­¥åˆ°äº‘ç«¯
        async function syncToCloud(saveSlot = 1) {
            if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                addDebugLog('âŒ äº‘ç«¯å­˜æ¡£æœªé…ç½®ï¼Œè·³è¿‡åŒæ­¥');
                return false;
            }

            if (cloudSaveConfig.syncInProgress) {
                addDebugLog('â³ åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åŒæ­¥');
                return false;
            }

            cloudSaveConfig.syncInProgress = true;

            try {
                const saveData = {
                    ...gameData,
                    timestamp: new Date().toISOString(),
                    saveSlot: saveSlot,
                    description: `å­˜æ¡£æ§½${saveSlot} - ${saveSlot === 1 ? 'è‡ªåŠ¨ä¿å­˜' : 'æ‰‹åŠ¨å­˜æ¡£'}`,
                    syncTime: Date.now()
                };

                const response = await fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        files: {
                            [`save${saveSlot}.json`]: {
                                content: JSON.stringify(saveData, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`åŒæ­¥å¤±è´¥: HTTP ${response.status}`);
                }

                cloudSaveConfig.lastSyncTime = Date.now();
                addDebugLog(`â˜ï¸ å­˜æ¡£${saveSlot}åŒæ­¥åˆ°äº‘ç«¯æˆåŠŸ`);
                return true;

            } catch (error) {
                addDebugLog(`âŒ äº‘ç«¯åŒæ­¥å¤±è´¥: ${error.message}`);
                return false;
            } finally {
                cloudSaveConfig.syncInProgress = false;
            }
        }

        // ä»äº‘ç«¯åŠ è½½
        async function loadFromCloud(saveSlot = 1) {
            if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                addDebugLog('âŒ äº‘ç«¯å­˜æ¡£æœªé…ç½®ï¼Œæ— æ³•åŠ è½½');
                return false;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`åŠ è½½å¤±è´¥: HTTP ${response.status}`);
                }

                const gist = await response.json();
                const saveFile = gist.files[`save${saveSlot}.json`];

                if (!saveFile) {
                    throw new Error(`å­˜æ¡£æ§½${saveSlot}ä¸å­˜åœ¨`);
                }

                const saveData = JSON.parse(saveFile.content);

                if (saveData.empty) {
                    addDebugLog(`å­˜æ¡£æ§½${saveSlot}ä¸ºç©ºå­˜æ¡£`);
                    return false;
                }

                // å¤‡ä»½å½“å‰æ•°æ®åˆ°localStorage
                localStorage.setItem('gameDataBackup', JSON.stringify(gameData));

                // åŠ è½½äº‘ç«¯æ•°æ®
                Object.assign(gameData, saveData);

                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                updateAllDisplays();

                addDebugLog(`â˜ï¸ ä»äº‘ç«¯åŠ è½½å­˜æ¡£${saveSlot}æˆåŠŸ`);
                return true;

            } catch (error) {
                addDebugLog(`âŒ ä»äº‘ç«¯åŠ è½½å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
        function updateAllDisplays() {
            renderFarmGrid();
            renderWorkspaces();
            updateAllInventoryDisplay();
            updateAllFundsDisplay();
            updateDebugDisplay();
            updateCustomerDisplay();
            updateGrillAndHuntingDisplay();
        }

        // æœåŠ¡çƒ¤è‚‰ç±»é£Ÿå“ç»™é¡¾å®¢
        function serveGrilledFood() {
            addDebugLog('ğŸ½ï¸ serveGrilledFoodå‡½æ•°è¢«è°ƒç”¨');

            if (!gameData.customer.active) {
                addDebugLog('âŒ å½“å‰æ²¡æœ‰æ´»è·ƒé¡¾å®¢');
                return;
            }

            if (gameData.customer.orderType !== 'grilled') {
                addDebugLog(`âŒ é¡¾å®¢è®¢å•ç±»å‹ä¸æ˜¯çƒ¤è‚‰ï¼š${gameData.customer.orderType}`);
                return;
            }

            const requiredFood = gameData.customer.grilledChoice;
            addDebugLog(`ğŸ” é¡¾å®¢éœ€è¦ï¼š${requiredFood}`);
            addDebugLog(`ğŸ” å½“å‰åº“å­˜ï¼š${JSON.stringify(gameData.madeTeas.filter(tea => tea.type === 'grilled'))}`);

            // æŸ¥æ‰¾å¯¹åº”çš„çƒ¤è‚‰ç±»é£Ÿå“
            const foodIndex = gameData.madeTeas.findIndex(tea =>
                tea.type === 'grilled' && tea.name === requiredFood);

            addDebugLog(`ğŸ” æ‰¾åˆ°é£Ÿå“ç´¢å¼•ï¼š${foodIndex}`);

            if (foodIndex === -1) {
                addDebugLog(`âŒ æ²¡æœ‰æ‰¾åˆ°${requiredFood}ï¼`);
                showAlert(`æ²¡æœ‰${requiredFood}ï¼Œè¯·å…ˆåˆ¶ä½œï¼`, 'æœåŠ¡å¤±è´¥', 'âŒ');
                return;
            }

            const food = gameData.madeTeas[foodIndex];

            // å…ˆä¿å­˜é¡¾å®¢ä¿¡æ¯ï¼ˆå› ä¸ºresetCustomerä¼šæ¸…é™¤ï¼‰
            const customerName = gameData.customer.name;
            const isVIP = gameData.customer.isVIP;

            // ç§»é™¤é£Ÿå“
            gameData.madeTeas.splice(foodIndex, 1);

            // è®¡ç®—æ”¶å…¥ï¼ˆçƒ¤è‚‰ç±»é£Ÿå“æœ‰1.2å€ä»·æ ¼+å°è´¹ï¼‰
            const basePrice = food.basePrice || 25;
            const tip = Math.floor(Math.random() * 5) + 1; // 1-5é‡‘å¸å°è´¹
            const totalEarning = basePrice + tip;

            gameData.funds += totalEarning;

            // è®°å½•é¡¾å®¢è®¿é—®
            recordCustomerVisit(customerName, isVIP);

            addDebugLog(`ğŸ½ï¸ æœåŠ¡${customerName}ï¼š${requiredFood}ï¼Œè·å¾—${totalEarning}é‡‘å¸ï¼ˆå«${tip}é‡‘å¸å°è´¹ï¼‰`);

            // ç«‹å³é‡ç½®é¡¾å®¢çŠ¶æ€ï¼Œé¿å…ç•Œé¢æ˜¾ç¤ºé—®é¢˜
            resetCustomer();

            // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿ç•Œé¢çŠ¶æ€æ­£ç¡®
            updateAllInventoryDisplay();
            updateAllFundsDisplay();
            updateCustomerDisplay(); // ç¡®ä¿é¡¾å®¢çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®

            // æ˜¾ç¤ºæœåŠ¡æˆåŠŸä¿¡æ¯
            const serviceContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ½ï¸ æœåŠ¡æˆåŠŸï¼</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        <div style="font-weight: bold; color: #d2691e; margin-bottom: 8px;">é¡¾å®¢ï¼š${customerName}</div>
                        <div style="color: #666; margin-bottom: 8px;">è®¢å•ï¼š${requiredFood}</div>
                        <div style="color: #22c55e; font-weight: bold;">æ”¶å…¥ï¼š${basePrice}é‡‘å¸ + ${tip}é‡‘å¸å°è´¹ = ${totalEarning}é‡‘å¸</div>
                    </div>
                </div>
            `;

            showWin95Modal('æœåŠ¡å®Œæˆ', serviceContent, 'ğŸ½ï¸');

            saveGameDataToDatabase();
        }

        // é¡¶éƒ¨èœå•æ§åˆ¶å‡½æ•°
        function toggleInventoryTable(type) {
            let sectionId;
            if (type === 'materials') {
                sectionId = 'materials-section';
            } else if (type === 'toppings') {
                sectionId = 'toppings-section';
            }
            
            const section = document.getElementById(sectionId);
            if (section) {
                if (section.classList.contains('active')) {
                    section.classList.remove('active');
                } else {
                    // å…ˆéšè—å…¶ä»–æ‰€æœ‰å¯æŠ˜å åŒºåŸŸ
                    document.querySelectorAll('.collapsible-section').forEach(s => s.classList.remove('active'));
                    // ç„¶åæ˜¾ç¤ºå½“å‰åŒºåŸŸ
                    section.classList.add('active');
                    // æ»šåŠ¨åˆ°åŒºåŸŸé¡¶éƒ¨
                    setTimeout(() => {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }
        }

        function toggleCustomerTable() {
            const section = document.getElementById('customer-section');
            if (section) {
                if (section.classList.contains('active')) {
                    section.classList.remove('active');
                } else {
                    // å…ˆéšè—å…¶ä»–æ‰€æœ‰å¯æŠ˜å åŒºåŸŸ
                    document.querySelectorAll('.collapsible-section').forEach(s => s.classList.remove('active'));
                    // ç„¶åæ˜¾ç¤ºå½“å‰åŒºåŸŸ
                    section.classList.add('active');
                    // æ»šåŠ¨åˆ°åŒºåŸŸé¡¶éƒ¨
                    setTimeout(() => {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }
        }

        // è°ƒè¯•é¢æ¿æ§åˆ¶å‡½æ•°

        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³åˆå§‹åŒ–è°ƒè¯•é¢æ¿
            addDebugLog('ğŸš€ å¯çˆ±èŒ¶é“º GitHub Pagesç‰ˆæœ¬å¯åŠ¨ä¸­...');
            addDebugLog(`ç‰ˆæœ¬: ${VERSION_INFO.version} (${VERSION_INFO.build})`);
            addDebugLog('âœ… å·²ç§»é™¤åç«¯ä¾èµ–ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨+äº‘ç«¯åŒæ­¥');
            
            initGame();
            
            // åŠ è½½ä¿å­˜çš„æ•°æ®ï¼ˆä¼šè‡ªåŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼‰
            loadGameDataFromDatabase();

            // å°è¯•ä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®
            if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                addDebugLog('â˜ï¸ æ£€æµ‹åˆ°äº‘ç«¯å­˜æ¡£é…ç½®ï¼Œå°è¯•åŠ è½½æœ€æ–°æ•°æ®...');
                loadFromCloud(1).then(success => {
                    if (success) {
                        addDebugLog('â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ');
                        showAlert('å·²ä»äº‘ç«¯åŠ è½½æœ€æ–°å­˜æ¡£ï¼', 'äº‘ç«¯åŒæ­¥', 'â˜ï¸');
                    } else {
                        addDebugLog('â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    }
                }).catch(error => {
                    addDebugLog(`â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½é”™è¯¯: ${error.message}`);
                });
            }
            
            // å¼€å§‹è‡ªåŠ¨ä¿å­˜
            startAutoSave();
            
            // å¼€å§‹æ¸¸æˆæ—¶é—´å¾ªç¯
            startGameTimeLoop();
            
            // åˆå§‹åŒ–å¤©æ°”å’Œå­£èŠ‚æ˜¾ç¤º
            updateWeatherAndSeasonDisplay();

            // åˆå§‹åŒ–å­˜æ¡£æ§½ä½æ˜¾ç¤º
            initSaveSlots();
            
            // è®¾ç½®å°æ–™å•†åº—å…³é—­äº‹ä»¶
            const closeToppingsShopBtn = document.querySelector('.close-toppings-shop');
            if (closeToppingsShopBtn) {
                closeToppingsShopBtn.addEventListener('click', closeToppingsShop);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­å°æ–™å•†åº—
            const toppingsShopModal = document.getElementById('toppings-shop-modal');
            if (toppingsShopModal) {
                toppingsShopModal.addEventListener('click', function(e) {
                    if (e.target === toppingsShopModal) {
                        closeToppingsShop();
                    }
                });
            }
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', function() {
                cloudSaveConfig.isOnline = true;
                addDebugLog('ğŸŒ ç½‘ç»œè¿æ¥å·²æ¢å¤ï¼Œäº‘ç«¯åŒæ­¥åŠŸèƒ½å¯ç”¨');

                // ç½‘ç»œæ¢å¤åå°è¯•åŒæ­¥
                if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                    setTimeout(() => {
                        syncToCloud(1).catch(error => {
                            addDebugLog(`â˜ï¸ ç½‘ç»œæ¢å¤ååŒæ­¥å¤±è´¥: ${error.message}`);
                        });
                    }, 2000);
                }
            });

            window.addEventListener('offline', function() {
                cloudSaveConfig.isOnline = false;
                addDebugLog('ğŸŒ ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œäº‘ç«¯åŒæ­¥æš‚åœ');
            });

            // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿ç•Œé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                addDebugLog('ğŸ® å¯çˆ±èŒ¶é“º GitHub Pagesç‰ˆæœ¬å¯åŠ¨å®Œæˆ');
                addDebugLog('ğŸ’¾ è‡ªåŠ¨ä¿å­˜å·²å¯åŠ¨ï¼Œæ¯30ç§’ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                addDebugLog('ğŸ›’ å°æ–™å•†åº—ç³»ç»Ÿå·²å°±ç»ª');
                addDebugLog('ğŸ”§ æ‰€æœ‰æ¸¸æˆåŠŸèƒ½æ­£å¸¸ï¼Œæ— åç«¯ä¾èµ–');

                // æ˜¾ç¤ºäº‘ç«¯å­˜æ¡£çŠ¶æ€
                if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                    addDebugLog('â˜ï¸ äº‘ç«¯å­˜æ¡£å·²é…ç½®ï¼Œæ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°GitHub');
                } else {
                    addDebugLog('ğŸ’¡ æç¤ºï¼šå¯åœ¨è°ƒè¯•é¢æ¿ä¸­è®¾ç½®äº‘ç«¯å­˜æ¡£ï¼Œå®ç°å¤šè®¾å¤‡åŒæ­¥');
                }
            }, 500);
        });

        // Win95é£æ ¼å¼¹çª—ç³»ç»Ÿ
        function showWin95Modal(title, content, icon = 'â„¹ï¸', buttons = null) {
            const overlay = document.getElementById('win95-modal-overlay');
            const modal = document.getElementById('win95-modal');
            const titleElement = document.getElementById('win95-modal-title-text');
            const iconElement = document.getElementById('win95-modal-icon');
            const contentElement = document.getElementById('win95-modal-content');
            const buttonsElement = document.getElementById('win95-modal-buttons');

            titleElement.textContent = title;
            iconElement.textContent = icon;
            contentElement.innerHTML = content;

            // è®¾ç½®æŒ‰é’®
            if (buttons) {
                buttonsElement.innerHTML = '';
                buttons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.className = `win95-button ${button.primary ? 'primary' : ''}`;
                    btn.textContent = button.text;
                    btn.onclick = button.onclick;
                    buttonsElement.appendChild(btn);
                });
            } else {
                buttonsElement.innerHTML = '<button class="win95-button primary" onclick="closeWin95Modal()">ç¡®å®š</button>';
            }

            overlay.style.display = 'flex';

            // æ·»åŠ é”®ç›˜æ”¯æŒ
            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    closeWin95Modal();
                    document.removeEventListener('keydown', handleKeyPress);
                }
            };
            document.addEventListener('keydown', handleKeyPress);
        }

        function closeWin95Modal() {
            const overlay = document.getElementById('win95-modal-overlay');
            overlay.style.display = 'none';
        }

        // æ›¿æ¢åŸæœ‰çš„alertå‡½æ•°
        function showAlert(message, title = 'ç³»ç»Ÿæ¶ˆæ¯', icon = 'â„¹ï¸') {
            showWin95Modal(title, message, icon);
        }

        function showConfirm(message, title = 'ç¡®è®¤æ“ä½œ', onConfirm = null, onCancel = null) {
            const buttons = [
                {
                    text: 'ç¡®å®š',
                    primary: true,
                    onclick: () => {
                        closeWin95Modal();
                        if (onConfirm) onConfirm();
                    }
                },
                {
                    text: 'å–æ¶ˆ',
                    onclick: () => {
                        closeWin95Modal();
                        if (onCancel) onCancel();
                    }
                }
            ];
            showWin95Modal(title, message, 'â“', buttons);
        }

        // æ˜¾ç¤ºé¡¾å®¢æ•…äº‹
        function showCustomerStory(customerName) {
            const story = gameData.customerStories[customerName];
            if (!story) {
                showAlert(`${customerName} çš„æ•…äº‹å°šæœªè§£é”`, 'æ•…äº‹ç³»ç»Ÿ', 'ğŸ“–');
                return;
            }

            const storyContent = `
                <div style="text-align: left; line-height: 1.6;">
                    <h3 style="margin: 0 0 10px 0; color: #0040c0;">${story.title}</h3>
                    <div style="margin-bottom: 12px; padding: 8px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                        ${story.content}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>èŒ¶é¥®åŠŸæ•ˆï¼š</strong><br>
                        <span style="color: #006600;">${story.effect}</span>
                    </div>
                    <div>
                        <strong>äººç‰©ç‰¹å¾ï¼š</strong><br>
                        <span style="color: #800080;">${story.character}</span>
                    </div>
                </div>
            `;

            showWin95Modal(`${customerName} çš„æ•…äº‹`, storyContent, 'ğŸ“–');
        }
    </script>
</body>
</html>
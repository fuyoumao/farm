<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® ç¨»é¦™æ‘ - å¯çˆ±èŒ¶é“º</title>
    <style>
        /* å®Œå…¨å¤åˆ¶èŒ¶é“ºé¦–é¡µæ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #374151;
            line-height: 1.4;
            font-size: 12px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 16px; color: #374151; margin-bottom: 8px; font-weight: 500; }
        .header .subtitle { color: #6b7280; margin-top: 5px; font-size: 12px; }
        .section { margin-bottom: 25px; }
        .section-title { font-size: 12px; font-weight: 500; margin-bottom: 10px; color: #374151; }

        /* å¯¼èˆªæ  */
        .nav-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        .nav-btn {
            padding: 6px 10px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            margin-bottom: 15px;
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
        }

        .status-table th,
        .status-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #374151;
        }

        .status-table th {
            background-color: #f9fafb;
            font-weight: 500;
        }

        /* ä¸»è¦è¡¨æ ¼æ ·å¼ */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            background-color: #ffffff;
        }

        .main-table th,
        .main-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #374151;
        }

        .main-table th {
            background-color: #f9fafb;
            font-weight: 500;
        }

        /* æŒ‰é’®æ ·å¼ - å®Œå…¨å¤åˆ¶èŒ¶é“ºé¦–é¡µ */
        .action-btn {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        .action-btn:disabled {
            background: #f3f4f6;
            border-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background-color: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        .action-btn.primary:hover {
            background-color: #e5e7eb;
        }

        /* è¿›åº¦æ¡æ ·å¼ - åœ†è§’ç°è‰²è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: #9ca3af;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .progress-text {
            position: relative;
            z-index: 1;
            font-size: 12px;
            color: #374151;
            font-weight: 500;
        }

        /* æ–‡å­—è¿›åº¦æ¡ï¼ˆç”¨äºæˆ˜æ–—/é‡‡é›†çŠ¶æ€ï¼‰ */
        .text-progress {
            font-family: monospace;
            font-size: 12px;
            color: #374151;
        }

        /* ç»éªŒå€¼è¿›åº¦æ¡ */
        .exp-bar {
            width: 100%;
            height: 16px;
            background-color: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
        }
        .exp-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: #6b7280;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        .exp-text {
            position: relative;
            z-index: 1;
            font-size: 10px;
            color: #374151;
            font-weight: 500;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ - å®Œå…¨å¤åˆ¶èŒ¶é“ºé¦–é¡µ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 12px;
        }

        .modal-header {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .close {
            color: #9ca3af;
            float: right;
            font-size: 18px;
            font-weight: normal;
            cursor: pointer;
        }

        .close:hover {
            color: #374151;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ - å»æ‰é¢œè‰²ï¼Œä½¿ç”¨ç°è‰²ç³» */
        .status-indicator {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 400;
        }

        .status-available {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .status-busy {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .status-cooldown {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        /* æ‚¬æµ®ä»»åŠ¡æ—¥å¿—çƒ */
        .floating-quest-ball {
            position: fixed;
            right: 20px;
            top: 40%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .floating-quest-ball:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-50%) scale(1.1);
        }

        .floating-quest-panel {
            position: fixed;
            right: 80px;
            top: 40%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 400px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            z-index: 998;
            display: none;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        /* æ‚¬æµ®èƒŒåŒ…çƒ */
        .floating-bag-ball {
            position: fixed;
            right: 20px;
            top: 60%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .floating-bag-ball:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-50%) scale(1.1);
        }

        .floating-bag-panel {
            position: fixed;
            right: 80px;
            top: 60%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 400px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            z-index: 998;
            display: none;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .floating-quest-panel.show {
            display: block !important;
        }

        .floating-quest-panel.show {
            display: block;
        }

        .quest-panel-header {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .quest-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
        }

        .quest-title {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .quest-progress {
            color: #6b7280;
            font-size: 11px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-bar {
                flex-wrap: wrap;
                gap: 5px;
            }

            .nav-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .main-table th,
            .main-table td {
                padding: 6px 8px;
                font-size: 12px;
            }

            .action-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .floating-quest-ball {
                width: 40px;
                height: 40px;
                right: 15px;
                font-size: 11px;
            }

            .floating-quest-panel {
                right: 65px;
                width: 250px;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ç¨»é¦™æ‘</h1>
            <div class="subtitle">ä¸çŒ«å’ªä¼™ä¼´çš„å†’é™©ä¹‹æ—…</div>
        </div>

        <!-- åŸºç¡€è¿è¥æ•°æ® -->
        <div class="section">
            <h2 class="section-title">åŸºç¡€è¿è¥æ•°æ®</h2>
            <table class="main-table">
                <tr>
                    <td>è¿è¥å¤©æ•°</td>
                    <td id="operation-days">ç¬¬1å¤©</td>
                    <td>å½“å‰å­£èŠ‚</td>
                    <td id="current-season">æ˜¥å¤© (ç¬¬1å¤©)</td>
                    <td>å¤©æ°”çŠ¶å†µ</td>
                    <td id="weather-status">æ™´å¤©</td>
                </tr>
                <tr>
                    <td colspan="2" id="weather-effect">ä½œç‰©ç”Ÿé•¿ æ­£å¸¸</td>
                    <td>è¿è¥èµ„é‡‘</td>
                    <td colspan="3" id="operation-funds">0 é‡‘å¸</td>
                </tr>
            </table>
        </div>

        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <button class="nav-btn" onclick="returnToTeaShop()">è¿”å›èŒ¶é“º</button>
            <button class="nav-btn" onclick="openBag()">èƒŒåŒ…</button>
            <button class="nav-btn" onclick="openQuestLog()">ä»»åŠ¡æ—¥å¿—</button>
            <button class="nav-btn" onclick="meditate()">æ‰“åæ¢å¤</button>
            <button class="nav-btn" onclick="manualCloudSync()" style="background: #e0f2fe;">äº‘ç«¯åŒæ­¥</button>
            <button class="nav-btn" onclick="forceRefreshData()" style="background: #fef3c7;">åˆ·æ–°æ•°æ®</button>
            <button class="nav-btn" onclick="testBag()" style="background: #dcfce7;">æµ‹è¯•èƒŒåŒ…</button>
            <button class="nav-btn" onclick="forceUpdateFunds()" style="background: #fef08a;">å¼ºåˆ¶åˆ·æ–°é‡‘å¸</button>
            <button class="nav-btn" onclick="clearRiceVillageProgress()" style="background: #fca5a5;">æ¸…é™¤ç¨»é¦™æ‘è¿›åº¦</button>
        </div>

        <!-- è§’è‰²çŠ¶æ€ -->
        <div class="status-bar">
            <table class="status-table">
                <thead>
                    <tr>
                        <th>è§’è‰²</th>
                        <th>ç­‰çº§</th>
                        <th>è¡€é‡</th>
                        <th>åŠ›é‡</th>
                        <th>ä½“åŠ›</th>
                        <th>è£…å¤‡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ç©å®¶</td>
                        <td id="player-level">1çº§</td>
                        <td id="player-hp">100/100</td>
                        <td id="player-power">5</td>
                        <td id="player-stamina">100/100</td>
                        <td id="player-equipment">æ— è£…å¤‡</td>
                    </tr>
                    <tr>
                        <td colspan="6" id="player-exp-bar">
                            <div class="exp-bar">
                                <div class="exp-fill" id="exp-fill" style="width: 0%"></div>
                                <div class="exp-text" id="exp-text">0/100 ç»éªŒ</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td id="cat-name">çŒ«å’ªä¼™ä¼´</td>
                        <td id="cat-level">1çº§</td>
                        <td id="cat-hp">100/100</td>
                        <td id="cat-power">10</td>
                        <td id="cat-type">-</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- NPCåˆ—è¡¨ -->
        <div class="section">
            <h3 class="section-title">æ‘æ°‘</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>èŒä¸š</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="npc-list">
                    <tr>
                        <td>æ‘é•¿åˆ˜æ´‹</td>
                        <td>æ‘é•¿</td>
                        <td><span class="status-indicator status-available">å¯å¯¹è¯</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('æ‘é•¿åˆ˜æ´‹')">èŠå¤©</button></td>
                    </tr>
                    <tr>
                        <td>ç‹å©†å©†</td>
                        <td>æ‘æ°‘</td>
                        <td><span class="status-indicator status-available">å¯å¯¹è¯</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ç‹å©†å©†')">èŠå¤©</button></td>
                    </tr>
                    <tr>
                        <td>æå¤</td>
                        <td>ç¥ç§˜äºº</td>
                        <td><span class="status-indicator status-available">å¯å¯¹è¯</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('æå¤')">èŠå¤©</button></td>
                    </tr>
                    <tr>
                        <td>æ°‘å…µé˜Ÿé•¿ç‹å¤§çŸ³</td>
                        <td>æ°‘å…µé˜Ÿé•¿</td>
                        <td><span class="status-indicator status-available">å¯å¯¹è¯</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ç‹å¤§çŸ³')">èŠå¤©</button></td>
                    </tr>
                    <tr>
                        <td>ä½™åŠä»™</td>
                        <td>ç®—å‘½å…ˆç”Ÿ</td>
                        <td><span class="status-indicator status-available">å¯ç®—å‘½</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ä½™åŠä»™')">èŠå¤©</button></td>
                    </tr>
                    <tr>
                        <td>æ­¦å™¨é“ºè€æ¿</td>
                        <td>å•†äºº</td>
                        <td><span class="status-indicator status-available">è¥ä¸šä¸­</span></td>
                        <td>
                            <button class="action-btn" onclick="talkToNPC('æ­¦å™¨é“ºè€æ¿')">èŠå¤©</button>
                            <button class="action-btn success" onclick="openWeaponShop()">è´­ä¹°</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ¤ç‰©èµ„æº -->
        <div class="section">
            <h3 class="section-title">æ¤ç‰©èµ„æº</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>åç§°</th>
                        <th>æè¿°</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="plant-list">
                    <tr>
                        <td>æ­¢è¡€è‰</td>
                        <td>å¸¸è§çš„è¯è‰</td>
                        <td><span class="status-indicator status-available">å¯é‡‡é›†</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('æ­¢è¡€è‰')">é‡‡é›†</button></td>
                    </tr>
                    <tr>
                        <td>é‡èœ</td>
                        <td>æ™®é€šçš„é‡èœ</td>
                        <td><span class="status-indicator status-available">å¯é‡‡é›†</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('é‡èœ')">é‡‡é›†</button></td>
                    </tr>
                    <tr>
                        <td>çµèŠ</td>
                        <td>çè´µçš„è¯æ</td>
                        <td><span class="status-indicator status-available">å¯é‡‡é›†</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('çµèŠ')">é‡‡é›†</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ€ªç‰© -->
        <div class="section">
            <h3 class="section-title">é‡ç”ŸåŠ¨ç‰©</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>åç§°</th>
                        <th>è¡€é‡</th>
                        <th>å½“å‰è¡€é‡</th>
                        <th>æ”»å‡»åŠ›</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="monster-list">
                    <tr>
                        <td>æœå­ç‹¸</td>
                        <td>10</td>
                        <td id="monster-hp-æœå­ç‹¸">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">10/10</div>
                            </div>
                        </td>
                        <td>1</td>
                        <td id="monster-status-æœå­ç‹¸"><span class="status-indicator status-available">å¯æ”»å‡»</span></td>
                        <td id="monster-action-æœå­ç‹¸"><button class="action-btn" onclick="attackMonster('æœå­ç‹¸')">æ”»å‡»</button></td>
                    </tr>
                    <tr>
                        <td>çŒ´å­</td>
                        <td>15</td>
                        <td id="monster-hp-çŒ´å­">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">15/15</div>
                            </div>
                        </td>
                        <td>2</td>
                        <td id="monster-status-çŒ´å­"><span class="status-indicator status-available">å¯æ”»å‡»</span></td>
                        <td id="monster-action-çŒ´å­"><button class="action-btn" onclick="attackMonster('çŒ´å­')">æ”»å‡»</button></td>
                    </tr>
                    <tr>
                        <td>å±±è´¼</td>
                        <td>25</td>
                        <td id="monster-hp-å±±è´¼">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">25/25</div>
                            </div>
                        </td>
                        <td>5</td>
                        <td id="monster-status-å±±è´¼"><span class="status-indicator status-available">å¯æ”»å‡»</span></td>
                        <td id="monster-action-å±±è´¼"><button class="action-btn" onclick="attackMonster('å±±è´¼')">æ”»å‡»</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- èƒŒåŒ…æ¨¡æ€æ¡† -->
    <div id="bag-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                èƒŒåŒ…
                <span class="close" onclick="closeBag()">&times;</span>
            </div>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>ç‰©å“åç§°</th>
                        <th>æ•°é‡</th>
                        <th>æè¿°</th>
                    </tr>
                </thead>
                <tbody id="bag-items">
                    <tr>
                        <td colspan="3" style="text-align: center; color: #666;">èƒŒåŒ…ä¸ºç©º</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ä»»åŠ¡æ—¥å¿—æ¨¡æ€æ¡† -->
    <div id="quest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ä»»åŠ¡æ—¥å¿—
                <span class="close" onclick="closeQuestLog()">&times;</span>
            </div>
            <div id="quest-content">
                <p style="text-align: center; color: #666;">æš‚æ— ä»»åŠ¡</p>
            </div>
        </div>
    </div>

    <!-- æ­¦å™¨é“ºæ¨¡æ€æ¡† -->
    <div id="weapon-shop-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                æ­¦å™¨é“º
                <span class="close" onclick="closeWeaponShop()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0;">æ­¦å™¨</h4>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>æ”»å‡»åŠ›</th>
                            <th>è€ä¹…åº¦</th>
                            <th>ä»·æ ¼</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>çŸ­å‰‘</td>
                            <td>+1</td>
                            <td>20å›åˆ</td>
                            <td>10é‡‘å¸</td>
                            <td><button class="action-btn" onclick="buyWeapon('çŸ­å‰‘', 1, 10)">è´­ä¹°</button></td>
                        </tr>
                        <tr>
                            <td>é•¿å‰‘</td>
                            <td>+2</td>
                            <td>20å›åˆ</td>
                            <td>20é‡‘å¸</td>
                            <td><button class="action-btn" onclick="buyWeapon('é•¿å‰‘', 2, 20)">è´­ä¹°</button></td>
                        </tr>
                        <tr>
                            <td>é“¾</td>
                            <td>+3</td>
                            <td>20å›åˆ</td>
                            <td>30é‡‘å¸</td>
                            <td><button class="action-btn" onclick="buyWeapon('é“¾', 3, 30)">è´­ä¹°</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0;">é˜²å…·</h4>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th>åç§°</th>
                            <th>è¡€é‡</th>
                            <th>ä»·æ ¼</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>å¸ƒç”²</td>
                            <td>+1</td>
                            <td>1é‡‘å¸</td>
                            <td><button class="action-btn" onclick="buyArmor('å¸ƒç”²', 1, 1)">è´­ä¹°</button></td>
                        </tr>
                        <tr>
                            <td>çš®ç”²</td>
                            <td>+20</td>
                            <td>20é‡‘å¸</td>
                            <td><button class="action-btn" onclick="buyArmor('çš®ç”²', 20, 20)">è´­ä¹°</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="repair-section" style="margin-bottom: 20px; display: none;">
                <h4 style="margin: 0 0 10px 0;">ä¿®ç†æœåŠ¡</h4>
                <table class="main-table">
                    <tbody id="repair-list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®ä»»åŠ¡æ—¥å¿—çƒ -->
    <div class="floating-quest-ball" onclick="toggleFloatingQuest()" id="floating-quest-ball">
        ä»»åŠ¡
    </div>

    <!-- æ‚¬æµ®ä»»åŠ¡é¢æ¿ -->
    <div class="floating-quest-panel" id="floating-quest-panel">
        <div class="quest-panel-header">
            å½“å‰ä»»åŠ¡
            <span style="float: right; cursor: pointer; color: #9ca3af;" onclick="toggleFloatingQuest()">&times;</span>
        </div>
        <div id="floating-quest-content">
            <div style="text-align: center; color: #6b7280; font-size: 11px;">æš‚æ— ä»»åŠ¡</div>
        </div>
    </div>

    <!-- æ‚¬æµ®èƒŒåŒ…çƒ -->
    <div class="floating-bag-ball" onclick="console.log('èƒŒåŒ…çƒè¢«ç‚¹å‡»'); toggleFloatingBag();" id="floating-bag-ball">
        èƒŒåŒ…
    </div>

    <!-- æ‚¬æµ®èƒŒåŒ…é¢æ¿ -->
    <div class="floating-bag-panel" id="floating-bag-panel" style="display: none;">
        <div class="quest-panel-header">
            èƒŒåŒ…ç‰©å“
            <span style="float: right; cursor: pointer; color: #9ca3af;" onclick="console.log('å…³é—­æŒ‰é’®è¢«ç‚¹å‡»'); toggleFloatingBag();">&times;</span>
        </div>
        <div id="floating-bag-content">
            <div style="text-align: center; color: #6b7280; font-size: 11px;">èƒŒåŒ…ä¸ºç©º</div>
        </div>
    </div>

    <script>
        // ç¨»é¦™æ‘æ¸¸æˆæ•°æ®
        let riceVillageData = {
            player: {
                name: "ç©å®¶",
                hp: 100,
                maxHp: 100,
                stamina: 100,
                maxStamina: 100,
                power: 5,
                level: 1,
                exp: 0,
                weapon: null,
                armor: null
            },
            cat: {
                name: "çŒ«å’ªä¼™ä¼´",
                hp: 100,
                maxHp: 100,
                power: 10,
                level: 1,
                type: null // 'tank' æˆ– 'damage'
            },
            inventory: {},
            npcs: {
                "æ‘é•¿åˆ˜æ´‹": { questStage: 0, lastTalkTime: 0 },
                "ç‹å©†å©†": { questStage: 0, lastTalkTime: 0 },
                "æå¤": { questStage: 0, lastTalkTime: 0 },
                "ç‹å¤§çŸ³": { questStage: 0, lastTalkTime: 0 },
                "ä½™åŠä»™": { questStage: 0, lastTalkTime: 0 },
                "æ­¦å™¨é“ºè€æ¿": { questStage: 0, lastTalkTime: 0 }
            },
            currentQuest: null,
            questProgress: 0,
            questTarget: 0,
            plants: {
                "æ­¢è¡€è‰": { available: true, lastGathered: 0 },
                "é‡èœ": { available: true, lastGathered: 0 },
                "çµèŠ": { available: true, lastGathered: 0 }
            },
            monsters: {
                "æœå­ç‹¸": { hp: 10, maxHp: 10, attack: 1, available: true, lastKilled: 0 },
                "çŒ´å­": { hp: 15, maxHp: 15, attack: 2, available: true, lastKilled: 0 },
                "å±±è´¼": { hp: 25, maxHp: 25, attack: 5, available: true, lastKilled: 0 }
            }
        };

        // Win95æ ·å¼å¼¹çª—
        function showWin95Modal(title, content, icon = '') {
            // å…ˆå…³é—­æ‰€æœ‰ç°æœ‰çš„æ¨¡æ€æ¡†
            closeWin95Modal();

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999'; // ç¡®ä¿åœ¨æœ€é¡¶å±‚
            modal.innerHTML = `
                <div class="modal-content" style="background: #c0c0c0; border: 2px outset #c0c0c0; border-radius: 0; max-width: 400px;">
                    <div style="background: linear-gradient(90deg, #0040c0, #4080ff); color: white; padding: 4px 8px; margin: -20px -20px 15px -20px; font-size: 12px; font-weight: bold;">
                        ${icon} ${title}
                        <span class="close" onclick="closeWin95Modal()" style="float: right; color: white; font-size: 16px;">&times;</span>
                    </div>
                    <div style="padding: 10px; background: #c0c0c0; color: #000; font-size: 12px;">
                        ${content}
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="closeWin95Modal()" style="padding: 4px 20px; background: #c0c0c0; border: 1px outset #c0c0c0; font-size: 12px;">ç¡®å®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeWin95Modal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ˜¾ç¤ºçš„çª—å£
            processModalQueue();
        }

        // çª—å£é˜Ÿåˆ—ç®¡ç†
        let modalQueue = [];

        function queueModal(title, content, icon = '') {
            modalQueue.push({ title, content, icon });
            if (modalQueue.length === 1) {
                processModalQueue();
            }
        }

        function processModalQueue() {
            if (modalQueue.length > 0) {
                const { title, content, icon } = modalQueue.shift();
                setTimeout(() => {
                    showWin95Modal(title, content, icon);
                }, 500); // å»¶è¿Ÿ500msæ˜¾ç¤ºä¸‹ä¸€ä¸ªçª—å£
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // ä»URLå‚æ•°è·å–çŒ«å’ªåå­—
            const urlParams = new URLSearchParams(window.location.search);
            const catName = urlParams.get('catName');
            if (catName) {
                riceVillageData.cat.name = catName;
                document.getElementById('cat-name').textContent = catName;
            }

            // åŠ è½½ç¨»é¦™æ‘å­˜æ¡£æ•°æ®
            loadRiceVillageData();

            // å°è¯•ä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®
            setTimeout(() => {
                loadFromGitHubGist();
            }, 1000);

            // ä»èŒ¶é“ºè·å–åŸºç¡€æ•°æ®
            loadTeaShopData();
            updateDisplay();
            updateFloatingQuestDisplay(); // åˆå§‹åŒ–æ‚¬æµ®ä»»åŠ¡æ˜¾ç¤º
            updateFloatingBagDisplay(); // åˆå§‹åŒ–æ‚¬æµ®èƒŒåŒ…æ˜¾ç¤º

            // å¼ºåˆ¶æ›´æ–°é‡‘å¸æ˜¾ç¤ºï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…å¼¹çª—ï¼‰
            setTimeout(() => {
                console.log('é¡µé¢åŠ è½½åè‡ªåŠ¨æ›´æ–°é‡‘å¸...');

                // é™é»˜æ›´æ–°ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                const funds = parsed.funds || 0;
                                console.log(`è‡ªåŠ¨ä»${key}è·å–é‡‘å¸:`, funds);

                                // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤º
                                const operationFunds = document.getElementById('operation-funds');
                                if (operationFunds) {
                                    operationFunds.textContent = `${funds} é‡‘å¸`;
                                }

                                // æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
                                updateFloatingBagDisplay();
                                break;
                            }
                        } catch (e) {
                            console.log(`è‡ªåŠ¨æ›´æ–°: ${key}æ•°æ®è§£æå¤±è´¥`);
                        }
                    }
                }
            }, 1000);

            // åˆå§‹åŒ–æ‰€æœ‰æ€ªç‰©è¡€é‡æ˜¾ç¤º
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                updateMonsterHP(monsterName);
            });

            startStaminaRegeneration();

            // å»¶è¿Ÿå†æ¬¡åŠ è½½æ•°æ®ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
            setTimeout(() => {
                loadTeaShopData();
                updateFloatingBagDisplay();
                console.log('å»¶è¿ŸåŠ è½½å®Œæˆ');
            }, 500);

            // å†æ¬¡å»¶è¿ŸåŠ è½½ç¡®ä¿æ•°æ®æ­£ç¡®
            setTimeout(() => {
                loadTeaShopData();
                updateFloatingBagDisplay();
                console.log('äºŒæ¬¡å»¶è¿ŸåŠ è½½å®Œæˆ');
            }, 2000);

            // å®šæœŸä¿å­˜æ•°æ®å’Œåˆ·æ–°é‡‘å¸
            setInterval(() => {
                saveRiceVillageData();
                // å®šæœŸåˆ·æ–°é‡‘å¸æ•°æ®
                loadTeaShopData();
            }, 30000); // æ¯30ç§’ä¿å­˜å’Œåˆ·æ–°ä¸€æ¬¡
        };

        // ä¿å­˜ç¨»é¦™æ‘æ•°æ®
        function saveRiceVillageData() {
            try {
                localStorage.setItem('riceVillageData', JSON.stringify(riceVillageData));
                console.log('ç¨»é¦™æ‘æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');

                // å¦‚æœæœ‰GitHub Tokenï¼Œä¹Ÿä¿å­˜åˆ°äº‘ç«¯
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                    saveToGitHubGist();
                }
            } catch (error) {
                console.error('ä¿å­˜ç¨»é¦™æ‘æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç¨»é¦™æ‘æ•°æ®
        function loadRiceVillageData() {
            try {
                const savedData = localStorage.getItem('riceVillageData');
                console.log('æœ¬åœ°ç¨»é¦™æ‘æ•°æ®:', savedData); // è°ƒè¯•æ—¥å¿—

                if (savedData) {
                    const data = JSON.parse(savedData);
                    console.log('è§£æåçš„ç¨»é¦™æ‘æ•°æ®:', data); // è°ƒè¯•æ—¥å¿—

                    // æ·±åº¦åˆå¹¶ä¿å­˜çš„æ•°æ®ï¼Œä¿ç•™å½“å‰çš„é»˜è®¤å€¼ç»“æ„
                    riceVillageData.player = { ...riceVillageData.player, ...data.player };
                    riceVillageData.cat = { ...riceVillageData.cat, ...data.cat };
                    riceVillageData.npcs = { ...riceVillageData.npcs, ...data.npcs };
                    riceVillageData.plants = { ...riceVillageData.plants, ...data.plants };
                    riceVillageData.monsters = { ...riceVillageData.monsters, ...data.monsters };
                    riceVillageData.inventory = { ...riceVillageData.inventory, ...data.inventory };

                    if (data.currentQuest) riceVillageData.currentQuest = data.currentQuest;
                    if (data.questProgress !== undefined) riceVillageData.questProgress = data.questProgress;
                    if (data.questTarget !== undefined) riceVillageData.questTarget = data.questTarget;
                    if (data.questCompleted) riceVillageData.questCompleted = data.questCompleted;

                    console.log('ç¨»é¦™æ‘æ•°æ®å·²ä»æœ¬åœ°åŠ è½½ï¼Œå½“å‰ç­‰çº§:', riceVillageData.player.level);
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°æœ¬åœ°ç¨»é¦™æ‘æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                }
            } catch (error) {
                console.error('åŠ è½½ç¨»é¦™æ‘æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜åˆ°GitHub Gist
        function saveToGitHubGist() {
            try {
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                console.log('äº‘ç«¯ä¿å­˜é…ç½®:', cloudSaveConfig); // è°ƒè¯•æ—¥å¿—

                if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                    console.log('æ²¡æœ‰GitHub Tokenæˆ–Gist IDï¼Œè·³è¿‡äº‘ç«¯ä¿å­˜');
                    return;
                }

                const saveData = {
                    riceVillageData: riceVillageData,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };

                const gistData = {
                    description: "ç¨»é¦™æ‘RPGå­˜æ¡£æ•°æ®",
                    files: {
                        "rice_village_save.json": {
                            content: JSON.stringify(saveData, null, 2)
                        }
                    }
                };

                console.log('æ­£åœ¨ä¿å­˜åˆ°GitHub Gist...'); // è°ƒè¯•æ—¥å¿—

                fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(gistData)
                }).then(response => {
                    if (response.ok) {
                        console.log('ç¨»é¦™æ‘æ•°æ®å·²ä¿å­˜åˆ°GitHub Gist');
                        return response.json();
                    } else {
                        console.error('ä¿å­˜åˆ°GitHub Gistå¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                        return response.text().then(text => {
                            console.error('é”™è¯¯è¯¦æƒ…:', text);
                        });
                    }
                }).catch(error => {
                    console.error('GitHub Gistä¿å­˜é”™è¯¯:', error);
                });
            } catch (error) {
                console.error('GitHub Gistä¿å­˜å¼‚å¸¸:', error);
            }
        }

        // ä»GitHub GiståŠ è½½æ•°æ®
        function loadFromGitHubGist() {
            try {
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                    console.log('æ²¡æœ‰GitHub Tokenæˆ–Gist IDï¼Œè·³è¿‡äº‘ç«¯åŠ è½½');
                    return;
                }

                console.log('æ­£åœ¨ä»GitHub GiståŠ è½½æ•°æ®...');

                fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                    }
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('ä»GitHub GiståŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                        return null;
                    }
                }).then(gist => {
                    if (gist && gist.files && gist.files['rice_village_save.json']) {
                        const content = gist.files['rice_village_save.json'].content;
                        const saveData = JSON.parse(content);

                        if (saveData.riceVillageData) {
                            // åˆå¹¶äº‘ç«¯æ•°æ®
                            const cloudData = saveData.riceVillageData;
                            riceVillageData.player = { ...riceVillageData.player, ...cloudData.player };
                            riceVillageData.cat = { ...riceVillageData.cat, ...cloudData.cat };
                            riceVillageData.npcs = { ...riceVillageData.npcs, ...cloudData.npcs };
                            riceVillageData.plants = { ...riceVillageData.plants, ...cloudData.plants };
                            riceVillageData.monsters = { ...riceVillageData.monsters, ...cloudData.monsters };
                            riceVillageData.inventory = { ...riceVillageData.inventory, ...cloudData.inventory };

                            if (cloudData.currentQuest) riceVillageData.currentQuest = cloudData.currentQuest;
                            if (cloudData.questProgress !== undefined) riceVillageData.questProgress = cloudData.questProgress;
                            if (cloudData.questTarget !== undefined) riceVillageData.questTarget = cloudData.questTarget;
                            if (cloudData.questCompleted) riceVillageData.questCompleted = cloudData.questCompleted;

                            console.log('ä»GitHub GiståŠ è½½æ•°æ®æˆåŠŸï¼Œç­‰çº§:', riceVillageData.player.level);
                            updateDisplay();
                            updateFloatingQuestDisplay();
                        }
                    }
                }).catch(error => {
                    console.error('GitHub GiståŠ è½½é”™è¯¯:', error);
                });
            } catch (error) {
                console.error('GitHub GiståŠ è½½å¼‚å¸¸:', error);
            }
        }

        // ä»èŒ¶é“ºè·å–åŸºç¡€æ•°æ®
        function loadTeaShopData() {
            try {
                console.log('å¼€å§‹åŠ è½½èŒ¶é“ºæ•°æ®...');
                console.log('localStorageæ‰€æœ‰é”®:', Object.keys(localStorage));

                // å°è¯•å¤šç§å¯èƒ½çš„localStorageé”®å
                const possibleKeys = ['teaGameData', 'gameData', 'cuteTeaShop_save', 'teaGameSave_1', 'teaShopData'];
                let teaShopData = null;
                let usedKey = null;

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`æ£€æŸ¥${key}:`, parsed); // è°ƒè¯•ï¼šçœ‹çœ‹æ¯ä¸ªé”®çš„æ•°æ®ç»“æ„

                            if (parsed && (parsed.funds !== undefined || parsed.day !== undefined)) {
                                teaShopData = data;
                                usedKey = key;
                                console.log(`ä»${key}æ‰¾åˆ°èŒ¶é“ºæ•°æ®ï¼Œé‡‘å¸:${parsed.funds}, å¤©æ•°:${parsed.day}`);
                                break;
                            }
                        } catch (e) {
                            console.log(`${key}æ•°æ®è§£æå¤±è´¥:`, e);
                        }
                    } else {
                        console.log(`${key}: æ— æ•°æ®`);
                    }
                }

                console.log('èŒ¶é“ºæ•°æ®æŸ¥æ‰¾ç»“æœ:', teaShopData ? `å·²æ‰¾åˆ°(${usedKey})` : 'æœªæ‰¾åˆ°');

                if (teaShopData) {
                    const data = JSON.parse(teaShopData);
                    console.log('è§£æåçš„èŒ¶é“ºæ•°æ® - å¤©æ•°:', data.day, 'é‡‘å¸:', data.funds, 'å¤©æ°”:', data.weather); // è°ƒè¯•æ—¥å¿—

                    // æ›´æ–°è¿è¥æ•°æ®æ˜¾ç¤º
                    const operationDays = document.getElementById('operation-days');
                    const currentSeason = document.getElementById('current-season');
                    const weatherStatus = document.getElementById('weather-status');
                    const weatherEffect = document.getElementById('weather-effect');
                    const operationFunds = document.getElementById('operation-funds');

                    if (operationDays) {
                        const dayNum = data.day || data.currentDay || 1;
                        operationDays.textContent = `ç¬¬${dayNum}å¤©`;
                        console.log('æ›´æ–°è¿è¥å¤©æ•°:', operationDays.textContent);
                    }

                    // å­£èŠ‚æ˜¾ç¤º
                    const seasons = ['æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©'];
                    const seasonName = seasons[data.season] || 'æ˜¥å¤©';
                    if (currentSeason) {
                        currentSeason.textContent = `${seasonName} (ç¬¬${data.seasonDay || 1}å¤©)`;
                        console.log('æ›´æ–°å­£èŠ‚:', currentSeason.textContent);
                    }

                    // å¤©æ°”æ˜¾ç¤º
                    const weatherIcons = {
                        'æ™´å¤©': 'â˜€ï¸',
                        'å¤šäº‘': 'â˜ï¸',
                        'é›¨å¤©': 'ğŸŒ§ï¸',
                        'æš´é£é›¨': 'â›ˆï¸',
                        'é›ªå¤©': 'â„ï¸'
                    };

                    // å¤„ç†å¤©æ°”æ•°æ®ï¼ˆå¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
                    let weatherName = 'æ™´å¤©';
                    if (data.currentWeather) {
                        weatherName = data.currentWeather;
                    } else if (typeof data.weather === 'number') {
                        const weatherNames = ['æ™´å¤©', 'å¤šäº‘', 'é›¨å¤©', 'æš´é£é›¨', 'é›ªå¤©'];
                        weatherName = weatherNames[data.weather] || 'æ™´å¤©';
                    } else if (data.weather) {
                        weatherName = data.weather;
                    }

                    const weatherIcon = weatherIcons[weatherName] || 'â˜€ï¸';
                    if (weatherStatus) {
                        weatherStatus.textContent = `${weatherIcon} ${weatherName}`;
                        console.log('æ›´æ–°å¤©æ°”:', weatherStatus.textContent);
                    }

                    // å¤©æ°”æ•ˆæœ
                    let weatherEffectText = 'ä½œç‰©ç”Ÿé•¿ æ­£å¸¸';
                    if (data.weather === 'é›¨å¤©') {
                        weatherEffectText = 'ä½œç‰©ç”Ÿé•¿ +10%';
                    } else if (data.weather === 'æš´é£é›¨') {
                        weatherEffectText = 'ä½œç‰©ç”Ÿé•¿ -10%';
                    } else if (data.weather === 'é›ªå¤©') {
                        weatherEffectText = 'ä½œç‰©ç”Ÿé•¿ -20%';
                    }
                    if (weatherEffect) {
                        weatherEffect.textContent = weatherEffectText;
                        console.log('æ›´æ–°å¤©æ°”æ•ˆæœ:', weatherEffect.textContent);
                    }

                    if (operationFunds) {
                        const funds = data.funds || 0;
                        operationFunds.textContent = `${funds} é‡‘å¸`;
                        console.log('æ›´æ–°é‡‘å¸æ˜¾ç¤º:', operationFunds.textContent);

                        // åŒæ—¶æ›´æ–°èƒŒåŒ…ä¸­çš„é‡‘å¸æ˜¾ç¤º
                        updateFloatingBagDisplay();
                    }

                    console.log('èŒ¶é“ºæ•°æ®åŠ è½½å®Œæˆ'); // è°ƒè¯•æ—¥å¿—
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°èŒ¶é“ºæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼'); // è°ƒè¯•æ—¥å¿—
                    // è®¾ç½®é»˜è®¤å€¼
                    const operationDays = document.getElementById('operation-days');
                    const currentSeason = document.getElementById('current-season');
                    const weatherStatus = document.getElementById('weather-status');
                    const weatherEffect = document.getElementById('weather-effect');
                    const operationFunds = document.getElementById('operation-funds');

                    if (operationDays) operationDays.textContent = 'ç¬¬1å¤©';
                    if (currentSeason) currentSeason.textContent = 'æ˜¥å¤© (ç¬¬1å¤©)';
                    if (weatherStatus) weatherStatus.textContent = 'â˜€ï¸ æ™´å¤©';
                    if (weatherEffect) weatherEffect.textContent = 'ä½œç‰©ç”Ÿé•¿ æ­£å¸¸';
                    if (operationFunds) operationFunds.textContent = '0 é‡‘å¸';
                }
            } catch (error) {
                console.error('åŠ è½½èŒ¶é“ºæ•°æ®å¤±è´¥:', error);
            }
        }

        // è¿”å›èŒ¶é“º
        function returnToTeaShop() {
            if (confirm('ç¡®å®šè¦è¿”å›èŒ¶é“ºå—ï¼Ÿå½“å‰è¿›åº¦ä¼šä¿å­˜ã€‚')) {
                // ä¿å­˜ç¨»é¦™æ‘æ•°æ®
                saveRiceVillageData();
                window.location.href = 'index.html';
            }
        }

        // è®¡ç®—å‡çº§æ‰€éœ€ç»éªŒ
        function getExpRequiredForLevel(level) {
            return 50 + (level - 1) * 50; // 1çº§â†’2çº§éœ€è¦100ç»éªŒï¼Œæ¯çº§å¢åŠ 50
        }

        // è·å¾—ç»éªŒå€¼
        function gainExp(amount) {
            riceVillageData.player.exp += amount;

            // æ£€æŸ¥å‡çº§
            let leveledUp = false;
            while (true) {
                const requiredExp = getExpRequiredForLevel(riceVillageData.player.level);
                if (riceVillageData.player.exp >= requiredExp) {
                    riceVillageData.player.exp -= requiredExp;
                    riceVillageData.player.level++;
                    leveledUp = true;

                    // å‡çº§å¥–åŠ±ï¼šæ¯çº§å¢åŠ 5è¡€é‡ä¸Šé™ï¼Œ1ç‚¹åŠ›é‡ï¼ˆæ¯5çº§ï¼‰
                    riceVillageData.player.maxHp += 5;
                    riceVillageData.player.hp = riceVillageData.player.maxHp; // å‡çº§å›æ»¡è¡€

                    if (riceVillageData.player.level % 5 === 0) {
                        riceVillageData.player.power++;
                    }

                    // æ£€æŸ¥ç­‰çº§ä¸Šé™
                    if (riceVillageData.player.level >= 130) {
                        riceVillageData.player.level = 130;
                        riceVillageData.player.exp = 0;
                        break;
                    }
                } else {
                    break;
                }
            }

            if (leveledUp) {
                console.log(`ğŸ‰ æ­å–œå‡çº§ï¼å½“å‰ç­‰çº§ï¼š${riceVillageData.player.level}çº§ï¼Œè¡€é‡ä¸Šé™å¢åŠ ï¼${riceVillageData.player.level % 5 === 0 ? 'åŠ›é‡å¢åŠ ï¼' : ''}`);

                // å»¶è¿Ÿå‡çº§çŒ«å’ªï¼Œé¿å…ä¸å…¶ä»–çª—å£å†²çª
                setTimeout(() => {
                    upgradeCat();
                }, 1000);
            }

            updateDisplay();
        }

        // çŒ«å’ªå‡çº§ç³»ç»Ÿ
        function upgradeCat() {
            // å¦‚æœçŒ«å’ªè¿˜æ²¡æœ‰é€‰æ‹©å‡çº§æ–¹å‘ï¼ŒåŠ å…¥çª—å£é˜Ÿåˆ—
            if (!riceVillageData.cat.type) {
                const choiceContent = `
                    <div style="text-align: center; line-height: 1.6;">
                        <h3 style="color: #0040c0; margin: 0 0 15px 0;">ğŸ± çŒ«å’ªå‡çº§</h3>
                        <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                            <div style="color: #666; margin-bottom: 15px;">é€‰æ‹©${riceVillageData.cat.name}çš„å‡çº§æ–¹å‘ï¼š</div>
                            <button class="action-btn" onclick="chooseCatType('tank')" style="margin: 5px; padding: 10px 15px;">
                                ğŸ›¡ï¸ å¦å…‹å‹<br><small>æ¯çº§ è¡€é‡+20, æ”»å‡»+1</small>
                            </button>
                            <button class="action-btn" onclick="chooseCatType('damage')" style="margin: 5px; padding: 10px 15px;">
                                âš”ï¸ è¾“å‡ºå‹<br><small>æ¯çº§ è¡€é‡+5, æ”»å‡»+10</small>
                            </button>
                        </div>
                    </div>
                `;
                queueModal('çŒ«å’ªå‡çº§é€‰æ‹©', choiceContent, 'ğŸ±');
                return;
            }

            // æ ¹æ®ç±»å‹å‡çº§
            riceVillageData.cat.level = riceVillageData.player.level;

            if (riceVillageData.cat.type === 'tank') {
                // å¦å…‹å‹ï¼šè¡€é‡+20ï¼Œæ”»å‡»+1
                riceVillageData.cat.maxHp += 20;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp; // å‡çº§å›æ»¡è¡€
                riceVillageData.cat.power += 1;
                console.log(`ğŸ± ${riceVillageData.cat.name}å‡çº§ï¼å¦å…‹å‹ è¡€é‡+20, æ”»å‡»+1`);
            } else if (riceVillageData.cat.type === 'damage') {
                // è¾“å‡ºå‹ï¼šè¡€é‡+5ï¼Œæ”»å‡»+10
                riceVillageData.cat.maxHp += 5;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp; // å‡çº§å›æ»¡è¡€
                riceVillageData.cat.power += 10;
                console.log(`ğŸ± ${riceVillageData.cat.name}å‡çº§ï¼è¾“å‡ºå‹ è¡€é‡+5, æ”»å‡»+10`);
            }
        }

        // é€‰æ‹©çŒ«å’ªå‡çº§ç±»å‹
        function chooseCatType(type) {
            riceVillageData.cat.type = type;
            closeWin95Modal();

            // ç«‹å³å‡çº§åˆ°å½“å‰ç©å®¶ç­‰çº§
            const levelDiff = riceVillageData.player.level - riceVillageData.cat.level;
            for (let i = 0; i < levelDiff; i++) {
                if (type === 'tank') {
                    riceVillageData.cat.maxHp += 20;
                    riceVillageData.cat.power += 1;
                } else if (type === 'damage') {
                    riceVillageData.cat.maxHp += 5;
                    riceVillageData.cat.power += 10;
                }
            }

            riceVillageData.cat.level = riceVillageData.player.level;
            riceVillageData.cat.hp = riceVillageData.cat.maxHp; // å›æ»¡è¡€

            const typeName = type === 'tank' ? 'å¦å…‹å‹' : 'è¾“å‡ºå‹';
            showWin95Modal('å‡çº§å®Œæˆ', `${riceVillageData.cat.name}é€‰æ‹©äº†${typeName}å‡çº§è·¯çº¿ï¼<br>ç­‰çº§å·²åŒæ­¥åˆ°${riceVillageData.cat.level}çº§`, 'ğŸ‰');

            updateDisplay();
            saveRiceVillageData();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // æ›´æ–°ç©å®¶çŠ¶æ€
            document.getElementById('player-level').textContent = `${riceVillageData.player.level}çº§`;
            document.getElementById('player-hp').textContent = `${riceVillageData.player.hp}/${riceVillageData.player.maxHp}`;
            document.getElementById('player-power').textContent = riceVillageData.player.power;
            document.getElementById('player-stamina').textContent = `${riceVillageData.player.stamina}/${riceVillageData.player.maxStamina}`;

            // æ›´æ–°ç»éªŒæ¡
            const requiredExp = getExpRequiredForLevel(riceVillageData.player.level);
            const expPercent = Math.min(100, (riceVillageData.player.exp / requiredExp) * 100);
            document.getElementById('exp-fill').style.width = `${expPercent}%`;
            document.getElementById('exp-text').textContent = `${riceVillageData.player.exp}/${requiredExp} ç»éªŒ`;

            // æ›´æ–°çŒ«å’ªçŠ¶æ€
            document.getElementById('cat-level').textContent = `${riceVillageData.cat.level}çº§`;
            document.getElementById('cat-hp').textContent = `${riceVillageData.cat.hp}/${riceVillageData.cat.maxHp}`;
            document.getElementById('cat-power').textContent = riceVillageData.cat.power;

            // æ›´æ–°çŒ«å’ªç±»å‹æ˜¾ç¤º
            const catTypeElement = document.getElementById('cat-type');
            if (catTypeElement) {
                if (riceVillageData.cat.type === 'tank') {
                    catTypeElement.textContent = 'ğŸ›¡ï¸å¦å…‹';
                } else if (riceVillageData.cat.type === 'damage') {
                    catTypeElement.textContent = 'âš”ï¸è¾“å‡º';
                } else {
                    catTypeElement.textContent = 'æœªé€‰æ‹©';
                }
            }

            // æ›´æ–°è£…å¤‡æ˜¾ç¤º
            let equipmentText = "æ— è£…å¤‡";
            if (riceVillageData.player.weapon || riceVillageData.player.armor) {
                let parts = [];
                if (riceVillageData.player.weapon) parts.push(riceVillageData.player.weapon.name);
                if (riceVillageData.player.armor) parts.push(riceVillageData.player.armor.name);
                equipmentText = parts.join(", ");
            }
            document.getElementById('player-equipment').textContent = equipmentText;
        }

        // ä½“åŠ›è‡ªåŠ¨æ¢å¤
        function startStaminaRegeneration() {
            setInterval(() => {
                if (riceVillageData.player.stamina < riceVillageData.player.maxStamina) {
                    riceVillageData.player.stamina = Math.min(
                        riceVillageData.player.maxStamina, 
                        riceVillageData.player.stamina + 1
                    );
                    updateDisplay();
                }
            }, 30000); // æ¯30ç§’æ¢å¤1ç‚¹ä½“åŠ›
        }

        // æ‰“åæ¢å¤åŠŸèƒ½
        let meditationTimer = null;
        let meditationStartTime = 0;

        function meditate() {
            if (meditationTimer) {
                alert('å·²åœ¨æ‰“åä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆï¼');
                return;
            }

            if (riceVillageData.player.hp >= riceVillageData.player.maxHp) {
                alert('è¡€é‡å·²æ»¡ï¼Œæ— éœ€æ‰“åï¼');
                return;
            }

            // å¼€å§‹æ‰“å
            meditationStartTime = Date.now();
            meditationTimer = setTimeout(() => {
                // 20ç§’åæ¢å¤æ»¡è¡€
                riceVillageData.player.hp = riceVillageData.player.maxHp;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp;
                meditationTimer = null;
                updateDisplay();
                alert('æ‰“åå®Œæˆï¼è¡€é‡å·²æ¢å¤ï¼');
            }, 20000);

            updateMeditationDisplay();
        }

        function updateMeditationDisplay() {
            const meditateBtn = document.querySelector('button[onclick="meditate()"]');
            if (meditationTimer) {
                const elapsed = Date.now() - meditationStartTime;
                const remaining = Math.max(0, 20000 - elapsed);
                const seconds = Math.ceil(remaining / 1000);

                if (seconds > 0) {
                    meditateBtn.textContent = `æ‰“åä¸­... ${seconds}ç§’`;
                    meditateBtn.disabled = true;
                    setTimeout(updateMeditationDisplay, 1000);
                } else {
                    meditateBtn.textContent = 'æ‰“åæ¢å¤';
                    meditateBtn.disabled = false;
                }
            } else {
                meditateBtn.textContent = 'æ‰“åæ¢å¤';
                meditateBtn.disabled = false;
            }
        }

        // æ‚¬æµ®èƒŒåŒ…åŠŸèƒ½ - ç®€åŒ–ç‰ˆæœ¬
        function toggleFloatingBag() {
            console.log('èƒŒåŒ…æŒ‰é’®è¢«ç‚¹å‡»');

            const panel = document.getElementById('floating-bag-panel');
            if (!panel) {
                console.error('æ‰¾ä¸åˆ°èƒŒåŒ…é¢æ¿');
                return;
            }

            // ç›´æ¥åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                console.log('éšè—èƒŒåŒ…');
            } else {
                panel.style.display = 'block';
                console.log('æ˜¾ç¤ºèƒŒåŒ…');
                updateFloatingBagDisplay();
            }
        }

        // æ›´æ–°æ‚¬æµ®èƒŒåŒ…æ˜¾ç¤º
        function updateFloatingBagDisplay() {
            const floatingBagContent = document.getElementById('floating-bag-content');

            // ç›´æ¥ä»localStorageè·å–æœ€æ–°é‡‘å¸æ•°
            let currentFunds = 0;
            try {
                const gameData = localStorage.getItem('gameData');
                if (gameData) {
                    const data = JSON.parse(gameData);
                    currentFunds = data.funds || 0;
                    console.log('èƒŒåŒ…æ˜¾ç¤º: è·å–åˆ°é‡‘å¸æ•°:', currentFunds);
                }
            } catch (error) {
                console.error('èƒŒåŒ…æ˜¾ç¤º: è·å–é‡‘å¸å¤±è´¥:', error);
            }

            let bagContent = `
                <div style="margin-bottom: 15px; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px;">
                    <div style="font-weight: 500; color: #374151; margin-bottom: 4px;">ğŸ’° é‡‘å¸</div>
                    <div style="color: #6b7280; font-size: 11px;">${currentFunds} é‡‘å¸</div>
                </div>
            `;

            // æ˜¾ç¤ºèƒŒåŒ…ç‰©å“
            const hasItems = Object.keys(riceVillageData.inventory).some(item => riceVillageData.inventory[item] > 0);

            if (hasItems) {
                bagContent += '<div style="margin-bottom: 10px; font-weight: 500; color: #374151;">ç‰©å“ï¼š</div>';

                for (const [itemName, quantity] of Object.entries(riceVillageData.inventory)) {
                    if (quantity > 0) {
                        bagContent += `
                            <div style="margin-bottom: 8px; padding: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <div style="font-weight: 500; color: #374151; font-size: 11px;">${itemName}</div>
                                <div style="color: #6b7280; font-size: 10px;">æ•°é‡: ${quantity}</div>
                            </div>
                        `;
                    }
                }
            } else {
                bagContent += '<div style="text-align: center; color: #6b7280; font-size: 11px; margin-top: 10px;">æš‚æ— å…¶ä»–ç‰©å“</div>';
            }

            floatingBagContent.innerHTML = bagContent;
        }

        // èƒŒåŒ…å’Œä»»åŠ¡æ—¥å¿—åŠŸèƒ½ï¼ˆä¿ç•™åŸæœ‰æ¨¡æ€æ¡†åŠŸèƒ½ï¼‰
        function openBag() {
            console.log('å¯¼èˆªæ èƒŒåŒ…æŒ‰é’®è¢«ç‚¹å‡»');
            toggleFloatingBag();
        }

        function closeBag() {
            const panel = document.getElementById('floating-bag-panel');
            if (panel) {
                panel.style.display = 'none';
                console.log('èƒŒåŒ…å·²å…³é—­');
            }
        }

        function openQuestLog() {
            const modal = document.getElementById('quest-modal');
            if (modal) {
                modal.style.display = 'block';
                updateQuestDisplay();
            } else {
                console.error('ä»»åŠ¡æ—¥å¿—æ¨¡æ€æ¡†æœªæ‰¾åˆ°');
            }
        }

        function closeQuestLog() {
            const modal = document.getElementById('quest-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateBagDisplay() {
            const bagItems = document.getElementById('bag-items');
            bagItems.innerHTML = '';
            
            if (Object.keys(riceVillageData.inventory).length === 0) {
                bagItems.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">èƒŒåŒ…ä¸ºç©º</td></tr>';
                return;
            }
            
            for (const [item, count] of Object.entries(riceVillageData.inventory)) {
                if (count > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item}</td>
                        <td>${count}</td>
                        <td>-</td>
                    `;
                    bagItems.appendChild(row);
                }
            }
        }

        function updateQuestDisplay() {
            const questContent = document.getElementById('quest-content');
            if (riceVillageData.currentQuest) {
                questContent.innerHTML = `
                    <h4>å½“å‰ä»»åŠ¡: ${riceVillageData.currentQuest}</h4>
                    <p>è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}</p>
                `;
            } else {
                questContent.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— ä»»åŠ¡</p>';
            }

            // åŒæ—¶æ›´æ–°æ‚¬æµ®ä»»åŠ¡é¢æ¿
            updateFloatingQuestDisplay();
        }

        // æ‚¬æµ®ä»»åŠ¡çƒåŠŸèƒ½
        function toggleFloatingQuest() {
            const panel = document.getElementById('floating-quest-panel');
            const isVisible = panel.classList.contains('show');

            if (isVisible) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                updateFloatingQuestDisplay();
            }
        }

        // æ›´æ–°æ‚¬æµ®ä»»åŠ¡æ˜¾ç¤º
        function updateFloatingQuestDisplay() {
            const floatingContent = document.getElementById('floating-quest-content');
            const questBall = document.getElementById('floating-quest-ball');

            console.log(`æ›´æ–°ä»»åŠ¡æ˜¾ç¤º: currentQuest=${riceVillageData.currentQuest}, progress=${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // è°ƒè¯•æ—¥å¿—

            if (riceVillageData.currentQuest) {
                const isCompleted = riceVillageData.questProgress >= riceVillageData.questTarget;

                // æ›´æ–°ä»»åŠ¡çƒæ˜¾ç¤º
                if (isCompleted) {
                    questBall.textContent = 'âœ“';
                    questBall.style.background = '#dcfce7';
                    questBall.style.borderColor = '#16a34a';
                    questBall.style.color = '#15803d';
                } else {
                    questBall.textContent = '!';
                    questBall.style.background = '#fef3c7';
                    questBall.style.borderColor = '#f59e0b';
                    questBall.style.color = '#92400e';
                }

                // æ›´æ–°æ‚¬æµ®é¢æ¿å†…å®¹
                floatingContent.innerHTML = `
                    <div class="quest-item">
                        <div class="quest-title">${riceVillageData.currentQuest} ${isCompleted ? 'âœ…' : ''}</div>
                        <div class="quest-progress">è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}</div>
                        <div style="margin-top: 4px;">
                            <div class="progress-bar" style="height: 12px;">
                                <div class="progress-fill" style="width: ${(riceVillageData.questProgress / riceVillageData.questTarget) * 100}%"></div>
                                <div class="progress-text" style="font-size: 10px;">${Math.round((riceVillageData.questProgress / riceVillageData.questTarget) * 100)}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ ä»»åŠ¡æç¤º
                if (isCompleted) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #16a34a; margin-top: 8px; font-weight: 500;">
                            ğŸ‰ ä»»åŠ¡å®Œæˆï¼è¯·ä¸ç‹å©†å©†å¯¹è¯äº¤ä»˜ä»»åŠ¡
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('é‡‡é›†')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ¤ç‰©èµ„æºä¸­çš„"é‡‡é›†"æŒ‰é’®
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('å‡»è´¥')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            ğŸ’¡ æç¤ºï¼šç‚¹å‡»é‡ç”ŸåŠ¨ç‰©ä¸­çš„"æ”»å‡»"æŒ‰é’®
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('é¦’å¤´')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            ğŸ’¡ æç¤ºï¼šä¸ç‹å¤§çŸ³å¯¹è¯äº¤ä»˜é¦’å¤´
                        </div>
                    `;
                }
            } else {
                // æ— ä»»åŠ¡çŠ¶æ€
                questBall.textContent = 'ä»»åŠ¡';
                questBall.style.background = '#f3f4f6';
                questBall.style.borderColor = '#d1d5db';
                questBall.style.color = '#374151';

                floatingContent.innerHTML = `
                    <div style="text-align: center; color: #6b7280; font-size: 11px;">æš‚æ— ä»»åŠ¡</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                        ğŸ’¡ æç¤ºï¼šä¸ç‹å©†å©†å¯¹è¯å¼€å§‹ä»»åŠ¡é“¾
                    </div>
                `;
            }
        }

        // æ‰‹åŠ¨äº‘ç«¯åŒæ­¥
        function manualCloudSync() {
            const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');

            if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                showWin95Modal('äº‘ç«¯åŒæ­¥', 'è¯·å…ˆåœ¨èŒ¶é“ºä¸»é¡µè®¾ç½®GitHub Tokenå’ŒGist ID', 'â˜ï¸');
                return;
            }

            showWin95Modal('äº‘ç«¯åŒæ­¥', 'æ­£åœ¨åŒæ­¥æ•°æ®åˆ°äº‘ç«¯...', 'â˜ï¸');

            // ä¿å­˜åˆ°äº‘ç«¯
            saveToGitHubGist();

            // 1ç§’åä»äº‘ç«¯åŠ è½½
            setTimeout(() => {
                loadFromGitHubGist();
                showWin95Modal('äº‘ç«¯åŒæ­¥', 'æ•°æ®åŒæ­¥å®Œæˆï¼', 'âœ…');
            }, 2000);
        }

        // å¼ºåˆ¶åˆ·æ–°æ•°æ®
        function forceRefreshData() {
            console.log('å¼ºåˆ¶åˆ·æ–°æ•°æ®å¼€å§‹...');

            // é‡ç½®æ‰€æœ‰æ€ªç‰©çŠ¶æ€
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                const monster = riceVillageData.monsters[monsterName];
                monster.available = true;
                monster.hp = monster.maxHp;
                console.log(`é‡ç½®${monsterName}: available=${monster.available}, hp=${monster.hp}/${monster.maxHp}`);
                updateMonsterStatus(monsterName, 'å¯æ”»å‡»', '');
                updateMonsterHP(monsterName);
            });

            // é‡æ–°åŠ è½½èŒ¶é“ºæ•°æ®
            loadTeaShopData();

            // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            updateDisplay();
            updateFloatingQuestDisplay();
            updateFloatingBagDisplay();

            // æ£€æŸ¥localStorageä¸­çš„æ•°æ®
            const teaShopData = localStorage.getItem('gameData');
            console.log('å½“å‰localStorageä¸­çš„èŒ¶é“ºæ•°æ®:', teaShopData ? JSON.parse(teaShopData) : 'æ— æ•°æ®');

            showWin95Modal('æ•°æ®åˆ·æ–°', 'æ•°æ®å·²å¼ºåˆ¶åˆ·æ–°ï¼æ‰€æœ‰æ€ªç‰©å·²é‡ç½®ä¸ºå¯æ”»å‡»çŠ¶æ€ã€‚', 'ğŸ”„');
        }

        // æµ‹è¯•èƒŒåŒ…åŠŸèƒ½
        function testBag() {
            console.log('æµ‹è¯•èƒŒåŒ…åŠŸèƒ½å¼€å§‹...');

            const panel = document.getElementById('floating-bag-panel');
            const ball = document.getElementById('floating-bag-ball');

            console.log('èƒŒåŒ…é¢æ¿å…ƒç´ :', panel);
            console.log('èƒŒåŒ…çƒå…ƒç´ :', ball);

            if (panel) {
                console.log('å¼ºåˆ¶æ˜¾ç¤ºèƒŒåŒ…é¢æ¿...');
                panel.style.display = 'block';
                panel.classList.add('show');
                updateFloatingBagDisplay();
                console.log('èƒŒåŒ…é¢æ¿å·²å¼ºåˆ¶æ˜¾ç¤º');
            } else {
                console.error('æ‰¾ä¸åˆ°èƒŒåŒ…é¢æ¿ï¼');
            }
        }

        // å¼ºåˆ¶æ›´æ–°é‡‘å¸æ˜¾ç¤º
        function forceUpdateFunds() {
            console.log('å¼ºåˆ¶æ›´æ–°é‡‘å¸æ˜¾ç¤º...');

            // å°è¯•å¤šä¸ªå¯èƒ½çš„localStorageé”®å
            const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];
            let foundData = false;

            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                console.log(`æ£€æŸ¥${key}:`, data ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');

                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (parsed && parsed.funds !== undefined) {
                            const funds = parsed.funds || 0;
                            console.log(`ä»${key}è§£æå‡ºé‡‘å¸æ•°:`, funds);

                            // å¼ºåˆ¶æ›´æ–°é¡¶éƒ¨æ˜¾ç¤º
                            const operationFunds = document.getElementById('operation-funds');
                            if (operationFunds) {
                                operationFunds.textContent = `${funds} é‡‘å¸`;
                                console.log('å·²æ›´æ–°é¡¶éƒ¨é‡‘å¸æ˜¾ç¤º');
                            }

                            // å¼ºåˆ¶æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
                            updateFloatingBagDisplay();

                            showWin95Modal('é‡‘å¸æ›´æ–°', `å·²ä»${key}æ›´æ–°é‡‘å¸æ˜¾ç¤ºï¼š${funds} é‡‘å¸`, 'ğŸ’°');
                            foundData = true;
                            break;
                        }
                    } catch (e) {
                        console.log(`${key}æ•°æ®è§£æå¤±è´¥:`, e);
                    }
                }
            }

            if (!foundData) {
                console.error('æ‰€æœ‰æ•°æ®æºéƒ½æ‰¾ä¸åˆ°é‡‘å¸æ•°æ®');
                console.log('localStorageæ‰€æœ‰é”®:', Object.keys(localStorage));
                showWin95Modal('æ›´æ–°å¤±è´¥', 'æ‰¾ä¸åˆ°ä»»ä½•èŒ¶é“ºæ•°æ®ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä»èŒ¶é“ºæ­£ç¡®è¿›å…¥ç¨»é¦™æ‘', 'âŒ');
            }
        }

        // æ¸…é™¤ç¨»é¦™æ‘è¿›åº¦
        function clearRiceVillageProgress() {
            const confirmContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #dc2626; margin: 0 0 15px 0;">âš ï¸ ç¡®è®¤æ¸…é™¤</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #fef2f2; border: 1px inset #c0c0c0;">
                        <div style="color: #dc2626; margin-bottom: 8px; font-weight: bold;">å³å°†æ¸…é™¤æ‰€æœ‰ç¨»é¦™æ‘è¿›åº¦ï¼š</div>
                        <div style="color: #666; font-size: 11px; text-align: left;">
                            â€¢ ç©å®¶ç­‰çº§é‡ç½®ä¸º1çº§<br>
                            â€¢ çŒ«å’ªç­‰çº§é‡ç½®ä¸º1çº§<br>
                            â€¢ æ‰€æœ‰ä»»åŠ¡è¿›åº¦æ¸…é™¤<br>
                            â€¢ èƒŒåŒ…ç‰©å“æ¸…ç©º<br>
                            â€¢ NPCå¯¹è¯é‡ç½®<br>
                            â€¢ è£…å¤‡æ¸…é™¤
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="confirmClearProgress()" style="margin: 5px; padding: 8px 15px; background: #dc2626; color: white; border: 1px outset #dc2626;">ç¡®è®¤æ¸…é™¤</button>
                        <button onclick="closeWin95Modal()" style="margin: 5px; padding: 8px 15px; background: #6b7280; color: white; border: 1px outset #6b7280;">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            showWin95Modal('æ¸…é™¤ç¨»é¦™æ‘è¿›åº¦', confirmContent, 'âš ï¸');
        }

        // ç¡®è®¤æ¸…é™¤è¿›åº¦
        function confirmClearProgress() {
            console.log('å¼€å§‹æ¸…é™¤ç¨»é¦™æ‘è¿›åº¦...');

            // é‡ç½®ç¨»é¦™æ‘æ•°æ®ä¸ºåˆå§‹çŠ¶æ€
            riceVillageData = {
                player: {
                    name: "ç©å®¶",
                    hp: 100,
                    maxHp: 100,
                    stamina: 100,
                    maxStamina: 100,
                    power: 5,
                    level: 1,
                    exp: 0,
                    weapon: null,
                    armor: null
                },
                cat: {
                    name: "çŒ«å’ªä¼™ä¼´",
                    hp: 100,
                    maxHp: 100,
                    power: 10,
                    level: 1,
                    type: null
                },
                inventory: {},
                npcs: {
                    "æ‘é•¿åˆ˜æ´‹": { questStage: 0, lastTalkTime: 0 },
                    "ç‹å©†å©†": { questStage: 0, lastTalkTime: 0 },
                    "æå¤": { questStage: 0, lastTalkTime: 0 },
                    "ç‹å¤§çŸ³": { questStage: 0, lastTalkTime: 0 },
                    "ä½™åŠä»™": { questStage: 0, lastTalkTime: 0 },
                    "æ­¦å™¨é“ºè€æ¿": { questStage: 0, lastTalkTime: 0 }
                },
                currentQuest: null,
                questProgress: 0,
                questTarget: 0,
                plants: {
                    "æ­¢è¡€è‰": { available: true, lastGathered: 0 },
                    "é‡èœ": { available: true, lastGathered: 0 },
                    "çµèŠ": { available: true, lastGathered: 0 }
                },
                monsters: {
                    "æœå­ç‹¸": { hp: 10, maxHp: 10, attack: 1, available: true, lastKilled: 0 },
                    "çŒ´å­": { hp: 15, maxHp: 15, attack: 2, available: true, lastKilled: 0 },
                    "å±±è´¼": { hp: 25, maxHp: 25, attack: 5, available: true, lastKilled: 0 }
                },
                questCompleted: {}
            };

            // ä¿å­˜é‡ç½®åçš„æ•°æ®
            saveRiceVillageData();

            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            updateFloatingQuestDisplay();
            updateFloatingBagDisplay();

            // é‡ç½®æ‰€æœ‰æ€ªç‰©è¡€é‡æ˜¾ç¤º
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                updateMonsterHP(monsterName);
                updateMonsterStatus(monsterName, 'å¯æ”»å‡»', '');
            });

            closeWin95Modal();
            showWin95Modal('æ¸…é™¤å®Œæˆ', 'ç¨»é¦™æ‘è¿›åº¦å·²å…¨éƒ¨æ¸…é™¤ï¼å¯ä»¥é‡æ–°å¼€å§‹å†’é™©äº†ã€‚', 'âœ…');

            console.log('ç¨»é¦™æ‘è¿›åº¦æ¸…é™¤å®Œæˆ');
        }

        // ä¸è‡ªåŠ¨å…³é—­æ‚¬æµ®é¢æ¿ï¼Œåªèƒ½æ‰‹åŠ¨ç‚¹å‡»å…³é—­
        // ç§»é™¤è‡ªåŠ¨å…³é—­åŠŸèƒ½ï¼Œè®©ç©å®¶å¯ä»¥å¸¸å¼€ä»»åŠ¡é¢æ¿

        // æ£€æŸ¥ä»»åŠ¡è¿›åº¦
        function checkQuestProgress(action, target) {
            console.log(`æ£€æŸ¥ä»»åŠ¡è¿›åº¦: action=${action}, target=${target}, currentQuest=${riceVillageData.currentQuest}`); // è°ƒè¯•æ—¥å¿—

            if (!riceVillageData.currentQuest) {
                console.log('æ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œè·³è¿‡è¿›åº¦æ£€æŸ¥');
                return;
            }

            let progressMade = false;

            // æ£€æŸ¥ä¸åŒç±»å‹çš„ä»»åŠ¡
            if (riceVillageData.currentQuest === 'é‡‡é›†æ­¢è¡€è‰' && action === 'é‡‡é›†' && target === 'æ­¢è¡€è‰') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`é‡‡é›†æ­¢è¡€è‰ä»»åŠ¡è¿›åº¦+1ï¼Œå½“å‰è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'å‡»è´¥æœå­ç‹¸' && action === 'å‡»è´¥' && target === 'æœå­ç‹¸') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`å‡»è´¥æœå­ç‹¸ä»»åŠ¡è¿›åº¦+1ï¼Œå½“å‰è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'å‡»è´¥çŒ´å­' && action === 'å‡»è´¥' && target === 'çŒ´å­') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`å‡»è´¥çŒ´å­ä»»åŠ¡è¿›åº¦+1ï¼Œå½“å‰è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'å‡»è´¥å±±è´¼' && action === 'å‡»è´¥' && target === 'å±±è´¼') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`å‡»è´¥å±±è´¼ä»»åŠ¡è¿›åº¦+1ï¼Œå½“å‰è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else {
                console.log(`ä»»åŠ¡æ¡ä»¶ä¸åŒ¹é…: å½“å‰ä»»åŠ¡="${riceVillageData.currentQuest}", åŠ¨ä½œ="${action}", ç›®æ ‡="${target}"`);
            }

            if (progressMade) {
                // ç«‹å³ä¿å­˜æ•°æ®
                saveRiceVillageData();

                // æ›´æ–°æ‚¬æµ®ä»»åŠ¡æ˜¾ç¤º
                updateFloatingQuestDisplay();

                // ä¸è‡ªåŠ¨å®Œæˆä»»åŠ¡ï¼Œåªæ›´æ–°è¿›åº¦
                // ä»»åŠ¡å®Œæˆéœ€è¦ç©å®¶ä¸»åŠ¨ä¸NPCäº¤äº’
                if (riceVillageData.questProgress >= riceVillageData.questTarget) {
                    // æ ‡è®°ä»»åŠ¡å¯ä»¥äº¤ä»˜ï¼Œä½†ä¸è‡ªåŠ¨å®Œæˆ
                    console.log(`ğŸ“‹ ä»»åŠ¡è¿›åº¦å·²å®Œæˆï¼è¯·å›å»æ‰¾NPCäº¤ä»˜ä»»åŠ¡ã€‚`);
                }
            }
        }

        // NPCäº¤ä»˜ä»»åŠ¡å®Œæˆ
        function completeQuestWithNPC(questName) {
            console.log(`å®Œæˆä»»åŠ¡: ${questName}`); // è°ƒè¯•æ—¥å¿—

            // æ¸…é™¤å½“å‰ä»»åŠ¡
            riceVillageData.currentQuest = null;
            riceVillageData.questProgress = 0;
            riceVillageData.questTarget = 0;

            let message = '';
            // æ ¹æ®ä»»åŠ¡ç±»å‹ç»™äºˆå¥–åŠ±å’Œæ¨è¿›NPCä»»åŠ¡é˜¶æ®µ
            if (questName === 'é‡‡é›†æ­¢è¡€è‰') {
                riceVillageData.npcs['ç‹å©†å©†'].questStage = 5;
                gainExp(150);
                message = 'é‡‡é›†ä»»åŠ¡å®Œæˆï¼è·å¾—150ç»éªŒï¼';
            } else if (questName === 'å‡»è´¥æœå­ç‹¸') {
                riceVillageData.npcs['ç‹å©†å©†'].questStage = 7;
                gainExp(200);
                message = 'æœå­ç‹¸è®¨ä¼å®Œæˆï¼è·å¾—200ç»éªŒï¼';
            } else if (questName === 'å‡»è´¥çŒ´å­') {
                riceVillageData.npcs['ç‹å©†å©†'].questStage = 9;
                gainExp(250);
                message = 'çŒ´å­è®¨ä¼å®Œæˆï¼è·å¾—250ç»éªŒï¼';
            } else if (questName === 'å‡»è´¥å±±è´¼') {
                riceVillageData.npcs['ç‹å©†å©†'].questStage = 11;
                gainExp(300);
                message = 'å±±è´¼è®¨ä¼å®Œæˆï¼è·å¾—300ç»éªŒï¼è¿™æ˜¯æœ€åçš„ä»»åŠ¡ï¼';
            } else {
                message = 'ä»»åŠ¡å®Œæˆï¼';
            }

            // ç«‹å³æ›´æ–°æ‚¬æµ®ä»»åŠ¡æ˜¾ç¤º
            updateFloatingQuestDisplay();
            console.log(`ä»»åŠ¡å®ŒæˆåçŠ¶æ€: currentQuest=${riceVillageData.currentQuest}, questStage=${riceVillageData.npcs['ç‹å©†å©†'].questStage}`); // è°ƒè¯•æ—¥å¿—

            return message;
        }

        // é‡‡é›†æ¤ç‰©åŠŸèƒ½
        function gatherPlant(plantName) {
            const plant = riceVillageData.plants[plantName];
            if (!plant || !plant.available) {
                alert(`${plantName}æš‚æ—¶æ— æ³•é‡‡é›†ï¼`);
                return;
            }

            if (riceVillageData.player.stamina < 1) {
                alert('ä½“åŠ›ä¸è¶³ï¼è¯·ç­‰å¾…ä½“åŠ›æ¢å¤æˆ–æ‰“åæ¢å¤ã€‚');
                return;
            }

            // æ¶ˆè€—ä½“åŠ›
            riceVillageData.player.stamina--;

            // è®¾ç½®é‡‡é›†çŠ¶æ€
            plant.available = false;
            plant.lastGathered = Date.now();

            // æ˜¾ç¤ºé‡‡é›†è¿›åº¦
            updatePlantStatus(plantName, 'é‡‡é›†ä¸­...', 'progress');

            setTimeout(() => {
                // é‡‡é›†å®Œæˆ
                if (!riceVillageData.inventory[plantName]) {
                    riceVillageData.inventory[plantName] = 0;
                }
                riceVillageData.inventory[plantName]++;

                // è·å¾—å°‘é‡ç»éªŒ
                gainExp(2);

                // ç«‹å³åˆ·æ–°èƒŒåŒ…æ˜¾ç¤º
                updateFloatingBagDisplay();

                // æ£€æŸ¥ä»»åŠ¡è¿›åº¦
                checkQuestProgress('é‡‡é›†', plantName);

                // 3ç§’ååˆ·æ–°
                setTimeout(() => {
                    plant.available = true;
                    updatePlantStatus(plantName, 'å¯é‡‡é›†', '');
                }, 3000);

                // ç«‹å³æ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
                updatePlantStatus(plantName, 'åˆ·æ–°ä¸­...', '');

                updateDisplay();
                saveRiceVillageData(); // ä¿å­˜æ•°æ®
                // ä¸æ˜¾ç¤ºå¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
                console.log(`é‡‡é›†åˆ° ${plantName} x1ï¼è·å¾— 2 ç»éªŒï¼`);
            }, 3000);

            updateDisplay();
        }

        // æ”»å‡»æ€ªç‰©åŠŸèƒ½
        function attackMonster(monsterName) {
            const monster = riceVillageData.monsters[monsterName];
            console.log(`æ”»å‡»${monsterName}: æ€ªç‰©æ•°æ®=`, monster); // è°ƒè¯•æ—¥å¿—

            if (!monster) {
                alert(`æ‰¾ä¸åˆ°æ€ªç‰©ï¼š${monsterName}ï¼`);
                return;
            }

            // ç§»é™¤availableæ£€æŸ¥ï¼Œè®©æ‰€æœ‰æ€ªç‰©éƒ½å¯ä»¥æ”»å‡»
            console.log(`å¼€å§‹æ”»å‡»${monsterName}ï¼Œå½“å‰è¡€é‡: ${monster.hp}/${monster.maxHp}`); // è°ƒè¯•æ—¥å¿—

            if (riceVillageData.player.stamina < 2) {
                alert('ä½“åŠ›ä¸è¶³ï¼æ”»å‡»éœ€è¦2ç‚¹ä½“åŠ›ã€‚');
                return;
            }

            // æ¶ˆè€—ä½“åŠ›
            riceVillageData.player.stamina -= 2;

            // è®¾ç½®æˆ˜æ–—çŠ¶æ€
            monster.available = false;

            // æ˜¾ç¤ºæˆ˜æ–—è¿›åº¦
            updateMonsterStatus(monsterName, 'æˆ˜æ–—ä¸­...', 'progress');

            setTimeout(() => {
                // æˆ˜æ–—ç»“ç®—
                const playerAttack = riceVillageData.player.power + (riceVillageData.player.weapon ? riceVillageData.player.weapon.attack : 0);
                const catAttack = riceVillageData.cat.power;
                const totalDamage = playerAttack + catAttack;

                // æ€ªç‰©å—ä¼¤
                console.log(`${monsterName} å—åˆ° ${totalDamage} ç‚¹ä¼¤å®³ï¼Œè¡€é‡ä» ${monster.hp} å˜ä¸º ${monster.hp - totalDamage}`);
                monster.hp -= totalDamage;

                // ç«‹å³æ›´æ–°è¡€é‡æ˜¾ç¤º
                updateMonsterHP(monsterName);

                if (monster.hp <= 0) {
                    console.log(`${monsterName} æ­»äº¡ï¼å‡†å¤‡å¢åŠ ä»»åŠ¡è¿›åº¦`);  // è°ƒè¯•æ—¥å¿—
                    // æ€ªç‰©æ­»äº¡ï¼Œè·å¾—ç»éªŒ
                    let expGain = 0;
                    switch(monsterName) {
                        case 'æœå­ç‹¸':
                            expGain = 8;
                            break;
                        case 'çŒ´å­':
                            expGain = 12;
                            break;
                        case 'å±±è´¼':
                            expGain = 20;
                            break;
                    }

                    monster.hp = monster.maxHp; // é‡ç½®è¡€é‡
                    updateMonsterHP(monsterName); // æ›´æ–°è¡€é‡æ˜¾ç¤º

                    // 3ç§’ååˆ·æ–°ï¼ˆç¼©çŸ­åˆ·æ–°æ—¶é—´ï¼‰
                    setTimeout(() => {
                        monster.available = true;
                        updateMonsterStatus(monsterName, 'å¯æ”»å‡»', '');
                        updateMonsterHP(monsterName); // ç¡®ä¿è¡€é‡æ˜¾ç¤ºæ­£ç¡®
                        console.log(`${monsterName}åˆ·æ–°å®Œæˆï¼Œå¯ä»¥å†æ¬¡æ”»å‡»`);
                    }, 3000);

                    // ç«‹å³æ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
                    updateMonsterStatus(monsterName, 'åˆ·æ–°ä¸­...', '');

                    gainExp(expGain);

                    // æ£€æŸ¥ä»»åŠ¡è¿›åº¦ - åªæœ‰åœ¨æ€ªç‰©çœŸæ­£æ­»äº¡æ—¶æ‰è°ƒç”¨
                    console.log(`${monsterName} å·²æ­»äº¡ï¼Œå‡†å¤‡æ£€æŸ¥ä»»åŠ¡è¿›åº¦: å‡»è´¥ ${monsterName}`); // è°ƒè¯•æ—¥å¿—
                    console.log(`å½“å‰ä»»åŠ¡: ${riceVillageData.currentQuest}, ä»»åŠ¡è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // è°ƒè¯•æ—¥å¿—
                    checkQuestProgress('å‡»è´¥', monsterName);
                    console.log(`ä»»åŠ¡è¿›åº¦æ£€æŸ¥å®Œæˆï¼Œæ–°è¿›åº¦: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // è°ƒè¯•æ—¥å¿—

                    // ä¸æ˜¾ç¤ºå¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
                    console.log(`å‡»è´¥äº† ${monsterName}ï¼è·å¾— ${expGain} ç»éªŒï¼`);
                } else {
                    // æ€ªç‰©åå‡»
                    const monsterDamage = monster.attack;
                    let damageMessage = '';

                    // éšæœºæ”»å‡»ç©å®¶æˆ–çŒ«å’ª
                    if (Math.random() < 0.5) {
                        riceVillageData.player.hp = Math.max(0, riceVillageData.player.hp - monsterDamage);
                        damageMessage = `${monsterName}æ”»å‡»äº†ä½ ï¼Œé€ æˆ${monsterDamage}ç‚¹ä¼¤å®³ï¼`;

                        if (riceVillageData.player.hp === 0) {
                            damageMessage += '\nä½ è¢«å‡»è´¥äº†ï¼è¯·æ‰“åæ¢å¤ã€‚';
                            // è£…å¤‡æŸå10%
                            if (riceVillageData.player.weapon && Math.random() < 0.1) {
                                damageMessage += '\næ­¦å™¨å—æŸï¼';
                                riceVillageData.player.weapon.durability--;
                                if (riceVillageData.player.weapon.durability <= 0) {
                                    damageMessage += '\næ­¦å™¨æŸåäº†ï¼';
                                    riceVillageData.player.weapon = null;
                                }
                            }
                        }
                    } else {
                        riceVillageData.cat.hp = Math.max(0, riceVillageData.cat.hp - monsterDamage);
                        damageMessage = `${monsterName}æ”»å‡»äº†${riceVillageData.cat.name}ï¼Œé€ æˆ${monsterDamage}ç‚¹ä¼¤å®³ï¼`;

                        if (riceVillageData.cat.hp === 0) {
                            damageMessage += `\n${riceVillageData.cat.name}è¢«å‡»è´¥äº†ï¼è¯·æ‰“åæ¢å¤ã€‚`;
                        }
                    }

                    // åªåœ¨æ­»äº¡æ—¶å¼¹çª—ï¼Œå¦åˆ™åªè®°å½•æ—¥å¿—
                    if (riceVillageData.player.hp === 0 || riceVillageData.cat.hp === 0) {
                        showWin95Modal('æˆ˜æ–—ç»“æœ', `å¯¹${monsterName}é€ æˆ${totalDamage}ç‚¹ä¼¤å®³ï¼\n${damageMessage}`, 'ğŸ’€');
                    } else {
                        console.log(`å¯¹${monsterName}é€ æˆ${totalDamage}ç‚¹ä¼¤å®³ï¼${damageMessage}`);
                    }

                    // ç»§ç»­æˆ˜æ–—ï¼ˆæ€ªç‰©æ²¡æ­»ï¼Œç«‹å³å¯ä»¥å†æ¬¡æ”»å‡»ï¼‰
                    monster.available = true;
                    console.log(`${monsterName}æ²¡æ­»ï¼Œè¡€é‡å‰©ä½™${monster.hp}ï¼Œç«‹å³å¯ä»¥å†æ¬¡æ”»å‡»`); // è°ƒè¯•æ—¥å¿—
                    updateMonsterStatus(monsterName, 'å¯æ”»å‡»', '');

                    // ç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡»
                    const actionElement = document.getElementById(`monster-action-${monsterName}`);
                    if (actionElement) {
                        actionElement.innerHTML = `<button class="action-btn" onclick="attackMonster('${monsterName}')">æ”»å‡»</button>`;
                    }
                }

                updateDisplay();
            }, 5000);

            updateDisplay();
        }

        // æ›´æ–°æ¤ç‰©çŠ¶æ€æ˜¾ç¤º
        function updatePlantStatus(plantName, status, progress) {
            const plantRows = document.querySelectorAll('#plant-list tr');
            plantRows.forEach(row => {
                const nameCell = row.cells[0];
                if (nameCell && nameCell.textContent === plantName) {
                    const statusCell = row.cells[2];
                    const actionCell = row.cells[3];

                    if (status === 'å¯é‡‡é›†') {
                        statusCell.innerHTML = '<span class="status-indicator status-available">å¯é‡‡é›†</span>';
                        actionCell.innerHTML = `<button class="action-btn" onclick="gatherPlant('${plantName}')">é‡‡é›†</button>`;
                    } else if (progress === 'progress') {
                        statusCell.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                        actionCell.innerHTML = `
                            <div class="progress-bar" style="width: 80px; height: 16px;">
                                <div class="progress-fill" id="progress-${plantName}" style="width: 0%"></div>
                                <div class="progress-text">0%</div>
                            </div>
                        `;
                        // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
                        startProgressAnimation(plantName, 3000);
                    } else {
                        statusCell.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                        actionCell.innerHTML = `<span class="text-progress">${progress}</span>`;
                    }
                }
            });
        }

        // æ›´æ–°æ€ªç‰©çŠ¶æ€æ˜¾ç¤º
        function updateMonsterStatus(monsterName, status, progress) {
            const statusElement = document.getElementById(`monster-status-${monsterName}`);
            const actionElement = document.getElementById(`monster-action-${monsterName}`);

            if (!statusElement || !actionElement) {
                console.error(`æ‰¾ä¸åˆ°æ€ªç‰©å…ƒç´ : ${monsterName}`);
                return;
            }

            if (status === 'å¯æ”»å‡»') {
                statusElement.innerHTML = '<span class="status-indicator status-available">å¯æ”»å‡»</span>';
                actionElement.innerHTML = `<button class="action-btn" onclick="attackMonster('${monsterName}')">æ”»å‡»</button>`;
            } else if (progress === 'progress') {
                statusElement.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                actionElement.innerHTML = `
                    <div class="progress-bar" style="width: 80px; height: 16px;">
                        <div class="progress-fill" id="progress-${monsterName}" style="width: 0%"></div>
                        <div class="progress-text">0%</div>
                    </div>
                `;
                // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
                startProgressAnimation(monsterName, 5000);
            } else {
                statusElement.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                actionElement.innerHTML = `<span class="text-progress">${progress}</span>`;
            }
        }

        // æ›´æ–°æ€ªç‰©è¡€é‡æ˜¾ç¤º
        function updateMonsterHP(monsterName) {
            const monster = riceVillageData.monsters[monsterName];
            const hpElement = document.getElementById(`monster-hp-${monsterName}`);

            if (!monster || !hpElement) {
                console.error(`æ‰¾ä¸åˆ°æ€ªç‰©æˆ–è¡€é‡å…ƒç´ : ${monsterName}`);
                return;
            }

            const hpPercent = Math.max(0, (monster.hp / monster.maxHp) * 100);
            const progressFill = hpElement.querySelector('.progress-fill');
            const progressText = hpElement.querySelector('.progress-text');

            if (progressFill && progressText) {
                progressFill.style.width = `${hpPercent}%`;
                progressText.textContent = `${Math.max(0, monster.hp)}/${monster.maxHp}`;

                // æ ¹æ®è¡€é‡ç™¾åˆ†æ¯”æ”¹å˜é¢œè‰²
                if (hpPercent > 60) {
                    progressFill.style.backgroundColor = '#9ca3af'; // ç°è‰² - å¥åº·
                } else if (hpPercent > 30) {
                    progressFill.style.backgroundColor = '#f59e0b'; // é»„è‰² - å—ä¼¤
                } else {
                    progressFill.style.backgroundColor = '#ef4444'; // çº¢è‰² - æ¿’æ­»
                }
            }
        }

        // è¿›åº¦æ¡åŠ¨ç”»
        function startProgressAnimation(id, duration) {
            const progressFill = document.getElementById(`progress-${id}`);
            const progressText = progressFill ? progressFill.nextElementSibling : null;

            if (!progressFill || !progressText) return;

            let startTime = Date.now();

            function updateProgress() {
                const elapsed = Date.now() - startTime;
                const percent = Math.min(100, (elapsed / duration) * 100);

                progressFill.style.width = `${percent}%`;
                progressText.textContent = `${Math.round(percent)}%`;

                if (percent < 100) {
                    requestAnimationFrame(updateProgress);
                }
            }

            updateProgress();
        }

        // NPCå¯¹è¯åŠŸèƒ½ - åŸºç¡€ç‰ˆæœ¬
        function talkToNPC(npcName) {
            const npc = riceVillageData.npcs[npcName];
            if (!npc) return;

            let dialogue = '';
            switch(npcName) {
                case 'æ‘é•¿åˆ˜æ´‹':
                    dialogue = 'æ¬¢è¿æ¥åˆ°ç¨»é¦™æ‘ï¼è¿™é‡Œæ˜¯ä¸ªå’Œå¹³çš„åœ°æ–¹ã€‚';
                    break;
                case 'ç‹å©†å©†':
                    if (npc.questStage === 0) {
                        dialogue = 'ä½ å¥½ï¼Œå¹´è½»äººï¼æˆ‘æ˜¯ç‹å©†å©†ã€‚';
                        npc.questStage = 1;
                        // ä¸ç»™ç»éªŒï¼Œåªæ˜¯åˆæ¬¡å¯¹è¯
                    } else if (npc.questStage === 1) {
                        dialogue = 'è¿™ä¸ªé¦’å¤´ç»™ä½ ï¼Œè¯·å¸®æˆ‘äº¤ç»™ç‹å¤§çŸ³ã€‚';
                        if (!riceVillageData.inventory['é¦’å¤´']) {
                            riceVillageData.inventory['é¦’å¤´'] = 0;
                        }
                        riceVillageData.inventory['é¦’å¤´']++;
                        npc.questStage = 2;
                        riceVillageData.currentQuest = 'å°†é¦’å¤´äº¤ç»™ç‹å¤§çŸ³';
                        riceVillageData.questProgress = 0;

                        // ç«‹å³åˆ·æ–°èƒŒåŒ…æ˜¾ç¤º
                        updateFloatingBagDisplay();
                        riceVillageData.questTarget = 1;
                        // ä¸åœ¨è¿™é‡Œç»™ç»éªŒï¼Œç­‰äº¤ä»»åŠ¡æ—¶ç»™
                    } else if (npc.questStage === 3) {
                        dialogue = 'è¯·å¸®æˆ‘é‡‡é›†5ä¸ªæ­¢è¡€è‰ã€‚';
                        riceVillageData.currentQuest = 'é‡‡é›†æ­¢è¡€è‰';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 4;
                        // ä¸åœ¨è¿™é‡Œç»™ç»éªŒ
                    } else if (npc.questStage === 4) {
                        // æ£€æŸ¥é‡‡é›†ä»»åŠ¡æ˜¯å¦å®Œæˆ
                        if (riceVillageData.currentQuest === 'é‡‡é›†æ­¢è¡€è‰' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('é‡‡é›†æ­¢è¡€è‰');
                            // ä»»åŠ¡å®Œæˆåç«‹å³æ›´æ–°æ˜¾ç¤º
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'è¯·ç»§ç»­é‡‡é›†æ­¢è¡€è‰ï¼Œè¿˜éœ€è¦' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'ä¸ªã€‚';
                        }
                    } else if (npc.questStage === 5) {
                        dialogue = 'è¯·å¸®æˆ‘å‡»è´¥3åªæœå­ç‹¸ã€‚';
                        riceVillageData.currentQuest = 'å‡»è´¥æœå­ç‹¸';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 3;
                        npc.questStage = 6;
                        // æ–°ä»»åŠ¡å¼€å§‹åç«‹å³æ›´æ–°æ˜¾ç¤º
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 6) {
                        // æ£€æŸ¥æœå­ç‹¸ä»»åŠ¡æ˜¯å¦å®Œæˆ
                        if (riceVillageData.currentQuest === 'å‡»è´¥æœå­ç‹¸' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('å‡»è´¥æœå­ç‹¸');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'è¯·ç»§ç»­å‡»è´¥æœå­ç‹¸ï¼Œè¿˜éœ€è¦å‡»è´¥' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'åªã€‚';
                        }
                    } else if (npc.questStage === 7) {
                        dialogue = 'è¯·å¸®æˆ‘å‡»è´¥5åªçŒ´å­ã€‚';
                        riceVillageData.currentQuest = 'å‡»è´¥çŒ´å­';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 8;
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 8) {
                        // æ£€æŸ¥çŒ´å­ä»»åŠ¡æ˜¯å¦å®Œæˆ
                        if (riceVillageData.currentQuest === 'å‡»è´¥çŒ´å­' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('å‡»è´¥çŒ´å­');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'è¯·ç»§ç»­å‡»è´¥çŒ´å­ï¼Œè¿˜éœ€è¦å‡»è´¥' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'åªã€‚';
                        }
                    } else if (npc.questStage === 9) {
                        dialogue = 'æœ€åçš„ä»»åŠ¡ï¼šè¯·å»æ‘å£å‡»è´¥5åªå±±è´¼ã€‚';
                        riceVillageData.currentQuest = 'å‡»è´¥å±±è´¼';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 10;
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 10) {
                        // æ£€æŸ¥å±±è´¼ä»»åŠ¡æ˜¯å¦å®Œæˆ
                        if (riceVillageData.currentQuest === 'å‡»è´¥å±±è´¼' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('å‡»è´¥å±±è´¼');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'è¯·ç»§ç»­å‡»è´¥å±±è´¼ï¼Œè¿˜éœ€è¦å‡»è´¥' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'åªã€‚';
                        }
                    } else if (npc.questStage === 11) {
                        dialogue = 'è°¢è°¢ä½ å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡ï¼è¿™æ˜¯ç²¾è‡´çš„ä»¤ç‰Œï¼Œè¯·æ”¶ä¸‹ã€‚';
                        if (!riceVillageData.inventory['ç²¾è‡´ä»¤ç‰Œ']) {
                            riceVillageData.inventory['ç²¾è‡´ä»¤ç‰Œ'] = 0;
                        }
                        riceVillageData.inventory['ç²¾è‡´ä»¤ç‰Œ']++;
                        npc.questStage = 12; // ä»»åŠ¡å®Œæˆ
                        riceVillageData.currentQuest = null;
                        gainExp(300); // æœ€ç»ˆå¥–åŠ±

                        // æ ‡è®°ç‹å©†å©†ä»»åŠ¡é“¾å®Œæˆ
                        riceVillageData.questCompleted = riceVillageData.questCompleted || {};
                        riceVillageData.questCompleted['ç‹å©†å©†'] = true;

                        // ç«‹å³åˆ·æ–°èƒŒåŒ…æ˜¾ç¤º
                        console.log('è·å¾—ç²¾è‡´ä»¤ç‰Œï¼Œåˆ·æ–°èƒŒåŒ…æ˜¾ç¤º');
                        updateFloatingBagDisplay();

                        // ä¿å­˜æ•°æ®
                        saveRiceVillageData();
                    } else if (npc.questStage === 12) {
                        dialogue = 'æ„Ÿè°¢ä½ çš„å¸®åŠ©ï¼Œå¹´è½»çš„å†’é™©è€…ï¼';
                    } else {
                        dialogue = 'è¯·å®Œæˆå½“å‰ä»»åŠ¡ã€‚';
                    }
                    break;
                case 'ç‹å¤§çŸ³':
                    if (riceVillageData.inventory['é¦’å¤´'] && riceVillageData.inventory['é¦’å¤´'] > 0) {
                        dialogue = 'è°¢è°¢ä½ çš„é¦’å¤´ï¼ç‹å©†å©†çœŸæ˜¯å¤ªå¥½äº†ã€‚è·å¾—150ç»éªŒï¼';
                        riceVillageData.inventory['é¦’å¤´']--;
                        riceVillageData.currentQuest = null;
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 0;
                        // è§¦å‘ç‹å©†å©†ä¸‹ä¸€ä¸ªä»»åŠ¡
                        riceVillageData.npcs['ç‹å©†å©†'].questStage = 3;
                        gainExp(150); // å®Œæˆä»»åŠ¡å¥–åŠ±
                        // ç«‹å³æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else {
                        dialogue = 'ä½ å¥½ï¼æˆ‘æ˜¯æ°‘å…µé˜Ÿé•¿ç‹å¤§çŸ³ã€‚';
                        // æ™®é€šå¯¹è¯ä¸ç»™ç»éªŒ
                    }
                    break;
                case 'æå¤':
                    dialogue = 'æå¤å†²ä½ ä¸€ç¬‘ï¼Œç¥ç§˜ä¸è¯­ã€‚';
                    break;
                case 'ä½™åŠä»™':
                    const fortunes = [
                        'ä»Šæ—¥å®œé‡‡é›†ï¼Œå¿Œæˆ˜æ–—ã€‚',
                        'è´¢è¿äº¨é€šï¼Œé‡‘å¸å°†è‡³ã€‚',
                        'å°å¿ƒé‡å…½ï¼Œæ³¨æ„å®‰å…¨ã€‚',
                        'è´µäººç›¸åŠ©ï¼Œä»»åŠ¡é¡ºåˆ©ã€‚',
                        'å¤©æ—¶åœ°åˆ©ï¼Œä¸‡äº‹å¦‚æ„ã€‚'
                    ];
                    dialogue = fortunes[Math.floor(Math.random() * fortunes.length)];
                    break;
                case 'æ­¦å™¨é“ºè€æ¿':
                    dialogue = 'æ¬¢è¿å…‰ä¸´æ­¦å™¨é“ºï¼éœ€è¦ä»€ä¹ˆè£…å¤‡å—ï¼Ÿ';
                    break;
                default:
                    dialogue = 'ä½ å¥½ï¼';
            }

            showWin95Modal(`ä¸${npcName}å¯¹è¯`, dialogue, 'ğŸ’¬');
            updateDisplay();
            updateFloatingQuestDisplay(); // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
            saveRiceVillageData(); // ä¿å­˜æ•°æ®
        }

        // æ­¦å™¨é“ºåŠŸèƒ½
        function openWeaponShop() {
            // ä»èŒ¶é“ºè·å–å½“å‰é‡‘å¸æ•°
            loadTeaShopData();
            updateRepairSection();
            document.getElementById('weapon-shop-modal').style.display = 'block';
        }

        function closeWeaponShop() {
            document.getElementById('weapon-shop-modal').style.display = 'none';
        }

        // è´­ä¹°æ­¦å™¨
        function buyWeapon(name, attack, price) {
            // æ£€æŸ¥é‡‘å¸
            const currentFunds = getCurrentFunds();
            if (currentFunds < price) {
                showWin95Modal('é‡‘å¸ä¸è¶³', `è´­ä¹°${name}éœ€è¦${price}é‡‘å¸ï¼Œå½“å‰åªæœ‰${currentFunds}é‡‘å¸ã€‚`, 'ğŸ’°');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ­¦å™¨
            if (riceVillageData.player.weapon) {
                if (!confirm(`å·²è£…å¤‡${riceVillageData.player.weapon.name}ï¼Œæ˜¯å¦æ›¿æ¢ä¸º${name}ï¼Ÿ\næ—§æ­¦å™¨å°†ä¸¢å¤±ï¼`)) {
                    return;
                }
            }

            // æ‰£é™¤é‡‘å¸
            deductFunds(price);

            // è£…å¤‡æ­¦å™¨
            riceVillageData.player.weapon = {
                name: name,
                attack: attack,
                durability: 20,
                maxDurability: 20
            };

            updateDisplay();
            showWin95Modal('è´­ä¹°æˆåŠŸ', `æˆåŠŸè´­ä¹°å¹¶è£…å¤‡${name}ï¼<br>æ”»å‡»åŠ›+${attack}`, 'âš”ï¸');
        }

        // è´­ä¹°é˜²å…·
        function buyArmor(name, hpBonus, price) {
            // æ£€æŸ¥é‡‘å¸
            const currentFunds = getCurrentFunds();
            if (currentFunds < price) {
                showWin95Modal('é‡‘å¸ä¸è¶³', `è´­ä¹°${name}éœ€è¦${price}é‡‘å¸ï¼Œå½“å‰åªæœ‰${currentFunds}é‡‘å¸ã€‚`, 'ğŸ’°');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é˜²å…·
            if (riceVillageData.player.armor) {
                if (!confirm(`å·²è£…å¤‡${riceVillageData.player.armor.name}ï¼Œæ˜¯å¦æ›¿æ¢ä¸º${name}ï¼Ÿ\næ—§é˜²å…·å°†ä¸¢å¤±ï¼`)) {
                    return;
                }
                // ç§»é™¤æ—§é˜²å…·çš„è¡€é‡åŠ æˆ
                riceVillageData.player.maxHp -= riceVillageData.player.armor.hpBonus;
                riceVillageData.player.hp = Math.min(riceVillageData.player.hp, riceVillageData.player.maxHp);
            }

            // æ‰£é™¤é‡‘å¸
            deductFunds(price);

            // è£…å¤‡é˜²å…·
            riceVillageData.player.armor = {
                name: name,
                hpBonus: hpBonus
            };

            // å¢åŠ è¡€é‡ä¸Šé™
            riceVillageData.player.maxHp += hpBonus;
            riceVillageData.player.hp += hpBonus; // è£…å¤‡æ—¶å›å¤å¯¹åº”è¡€é‡

            updateDisplay();
            showWin95Modal('è´­ä¹°æˆåŠŸ', `æˆåŠŸè´­ä¹°å¹¶è£…å¤‡${name}ï¼<br>è¡€é‡ä¸Šé™+${hpBonus}`, 'ğŸ›¡ï¸');
        }

        // è·å–å½“å‰é‡‘å¸æ•°ï¼ˆä»å¤šä¸ªæ•°æ®æºè¯»å–ï¼‰
        function getCurrentFunds() {
            try {
                // å°è¯•å¤šä¸ªå¯èƒ½çš„localStorageé”®å
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                console.log(`getCurrentFunds: ä»${key}è·å–é‡‘å¸:`, parsed.funds);
                                return parsed.funds;
                            }
                        } catch (e) {
                            console.log(`getCurrentFunds: ${key}æ•°æ®è§£æå¤±è´¥`);
                        }
                    }
                }
            } catch (error) {
                console.error('getCurrentFunds: è·å–é‡‘å¸å¤±è´¥:', error);
            }
            console.log('getCurrentFunds: æ²¡æœ‰æ‰¾åˆ°é‡‘å¸æ•°æ®ï¼Œè¿”å›0');
            return 0;
        }

        // ä»æ•°æ®åº“è¯»å–é‡‘å¸
        function readFundsFromDatabase() {
            try {
                // å°è¯•ä»æ•°æ®åº“è¯»å–
                const request = indexedDB.open('TeaShopDB', 1);
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    if (db.objectStoreNames.contains('gameData')) {
                        const transaction = db.transaction(['gameData'], 'readonly');
                        const store = transaction.objectStore('gameData');
                        const getRequest = store.get('currentGame');

                        getRequest.onsuccess = function() {
                            if (getRequest.result && getRequest.result.data) {
                                const funds = getRequest.result.data.funds || 0;
                                console.log('ä»IndexedDBè·å–é‡‘å¸:', funds);
                                // æ›´æ–°æ˜¾ç¤º
                                updateFundsDisplay(funds);
                                return funds;
                            }
                        };
                    }
                };
            } catch (error) {
                console.error('ä»æ•°æ®åº“è¯»å–é‡‘å¸å¤±è´¥:', error);
            }
            return 0;
        }

        // æ›´æ–°é‡‘å¸æ˜¾ç¤º
        function updateFundsDisplay(funds) {
            const operationFunds = document.getElementById('operation-funds');
            if (operationFunds) {
                operationFunds.textContent = `${funds} é‡‘å¸`;
                console.log('æ›´æ–°é‡‘å¸æ˜¾ç¤º:', funds);
            }

            // åŒæ—¶æ›´æ–°èƒŒåŒ…æ˜¾ç¤º
            updateFloatingBagDisplay();
        }

        // æ‰£é™¤é‡‘å¸ï¼ˆåŒæ­¥åˆ°èŒ¶é“ºï¼‰
        function deductFunds(amount) {
            console.log(`æ‰£é™¤é‡‘å¸: ${amount}`);

            try {
                // å°è¯•å¤šä¸ªå¯èƒ½çš„localStorageé”®å
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                const oldFunds = parsed.funds || 0;
                                parsed.funds = Math.max(0, oldFunds - amount);
                                localStorage.setItem(key, JSON.stringify(parsed));
                                console.log(`ä»${key}æ‰£é™¤é‡‘å¸: ${oldFunds} -> ${parsed.funds}`);

                                // æ›´æ–°ç¨»é¦™æ‘æ˜¾ç¤º
                                updateFundsDisplay(parsed.funds);
                                return;
                            }
                        } catch (e) {
                            console.log(`æ‰£é™¤é‡‘å¸: ${key}æ•°æ®è§£æå¤±è´¥`);
                        }
                    }
                }

                console.error('æ‰¾ä¸åˆ°èŒ¶é“ºæ•°æ®ï¼Œæ— æ³•æ‰£é™¤é‡‘å¸');
                showWin95Modal('æ‰£é™¤å¤±è´¥', 'æ‰¾ä¸åˆ°èŒ¶é“ºæ•°æ®ï¼Œæ— æ³•æ‰£é™¤é‡‘å¸', 'âŒ');

            } catch (error) {
                console.error('æ‰£é™¤é‡‘å¸å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ä¿®ç†åŒºåŸŸ
        function updateRepairSection() {
            const repairSection = document.getElementById('repair-section');
            const repairList = document.getElementById('repair-list');

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!repairSection || !repairList) {
                console.log('ä¿®ç†åŒºåŸŸå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }

            if (riceVillageData.player.weapon && riceVillageData.player.weapon.durability < riceVillageData.player.weapon.maxDurability) {
                repairSection.style.display = 'block';
                const weapon = riceVillageData.player.weapon;
                const repairCost = Math.ceil((weapon.maxDurability - weapon.durability) * 2); // æ¯ç‚¹è€ä¹…2é‡‘å¸

                repairList.innerHTML = `
                    <tr>
                        <td>å½“å‰æ­¦å™¨: ${weapon.name}</td>
                        <td>è€ä¹…: ${weapon.durability}/${weapon.maxDurability}</td>
                        <td>ä¿®ç†è´¹ç”¨: ${repairCost}é‡‘å¸</td>
                        <td><button class="action-btn" onclick="repairWeapon(${repairCost})">ä¿®ç†</button></td>
                    </tr>
                `;
            } else {
                repairSection.style.display = 'none';
            }
        }

        // ä¿®ç†æ­¦å™¨
        function repairWeapon(cost) {
            const currentFunds = getCurrentFunds();
            if (currentFunds < cost) {
                showWin95Modal('é‡‘å¸ä¸è¶³', `ä¿®ç†éœ€è¦${cost}é‡‘å¸ï¼Œå½“å‰åªæœ‰${currentFunds}é‡‘å¸ã€‚`, 'ğŸ’°');
                return;
            }

            deductFunds(cost);
            riceVillageData.player.weapon.durability = riceVillageData.player.weapon.maxDurability;

            updateDisplay();
            updateRepairSection();
            showWin95Modal('ä¿®ç†å®Œæˆ', `${riceVillageData.player.weapon.name}å·²ä¿®ç†å®Œæˆï¼`, 'ğŸ”§');
        }
    </script>
</body>
</html>

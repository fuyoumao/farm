<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÆ Á®ªÈ¶ôÊùë - ÂèØÁà±Ëå∂Èì∫</title>
    <style>
        /* ÂÆåÂÖ®Â§çÂà∂Ëå∂Èì∫È¶ñÈ°µÊ†∑Âºè */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #374151;
            line-height: 1.4;
            font-size: 12px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 16px; color: #374151; margin-bottom: 8px; font-weight: 500; }
        .header .subtitle { color: #6b7280; margin-top: 5px; font-size: 12px; }
        .section { margin-bottom: 25px; }
        .section-title { font-size: 12px; font-weight: 500; margin-bottom: 10px; color: #374151; }

        /* ÂØºËà™Ê†è */
        .nav-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        .nav-btn {
            padding: 6px 10px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        /* Áä∂ÊÄÅÊ†è */
        .status-bar {
            margin-bottom: 15px;
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
        }

        .status-table th,
        .status-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #374151;
        }

        .status-table th {
            background-color: #f9fafb;
            font-weight: 500;
        }

        /* ‰∏ªË¶ÅË°®Ê†ºÊ†∑Âºè */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            margin-bottom: 15px;
            background-color: #ffffff;
        }

        .main-table th,
        .main-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #374151;
        }

        .main-table th {
            background-color: #f9fafb;
            font-weight: 500;
        }

        /* ÊåâÈíÆÊ†∑Âºè - ÂÆåÂÖ®Â§çÂà∂Ëå∂Èì∫È¶ñÈ°µ */
        .action-btn {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #374151;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        .action-btn:disabled {
            background: #f3f4f6;
            border-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .action-btn.primary {
            background-color: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        .action-btn.primary:hover {
            background-color: #e5e7eb;
        }

        /* ËøõÂ∫¶Êù°Ê†∑Âºè - ÂúÜËßíÁÅ∞Ëâ≤ËøõÂ∫¶Êù° */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: #9ca3af;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .progress-text {
            position: relative;
            z-index: 1;
            font-size: 12px;
            color: #374151;
            font-weight: 500;
        }

        /* ÊñáÂ≠óËøõÂ∫¶Êù°ÔºàÁî®‰∫éÊàòÊñó/ÈááÈõÜÁä∂ÊÄÅÔºâ */
        .text-progress {
            font-family: monospace;
            font-size: 12px;
            color: #374151;
        }

        /* ÁªèÈ™åÂÄºËøõÂ∫¶Êù° */
        .exp-bar {
            width: 100%;
            height: 16px;
            background-color: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
        }
        .exp-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: #6b7280;
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        .exp-text {
            position: relative;
            z-index: 1;
            font-size: 10px;
            color: #374151;
            font-weight: 500;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè - ÂÆåÂÖ®Â§çÂà∂Ëå∂Èì∫È¶ñÈ°µ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 12px;
        }

        .modal-header {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .close {
            color: #9ca3af;
            float: right;
            font-size: 18px;
            font-weight: normal;
            cursor: pointer;
        }

        .close:hover {
            color: #374151;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® - ÂéªÊéâÈ¢úËâ≤Ôºå‰ΩøÁî®ÁÅ∞Ëâ≤Á≥ª */
        .status-indicator {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 400;
        }

        .status-available {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .status-busy {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .status-cooldown {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        /* ÊÇ¨ÊµÆ‰ªªÂä°Êó•ÂøóÁêÉ */
        .floating-quest-ball {
            position: fixed;
            right: 20px;
            top: 40%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .floating-quest-ball:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-50%) scale(1.1);
        }

        .floating-quest-panel {
            position: fixed;
            right: 80px;
            top: 40%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 400px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            z-index: 998;
            display: none;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        /* ÊÇ¨ÊµÆËÉåÂåÖÁêÉ */
        .floating-bag-ball {
            position: fixed;
            right: 20px;
            top: 60%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .floating-bag-ball:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-50%) scale(1.1);
        }

        .floating-bag-panel {
            position: fixed;
            right: 80px;
            top: 60%;
            transform: translateY(-50%);
            width: 300px;
            max-height: 400px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            z-index: 998;
            display: none;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .floating-quest-panel.show {
            display: block !important;
        }

        .floating-quest-panel.show {
            display: block;
        }

        .quest-panel-header {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .quest-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
        }

        .quest-title {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .quest-progress {
            color: #6b7280;
            font-size: 11px;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-bar {
                flex-wrap: wrap;
                gap: 5px;
            }

            .nav-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .main-table th,
            .main-table td {
                padding: 6px 8px;
                font-size: 12px;
            }

            .action-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .floating-quest-ball {
                width: 40px;
                height: 40px;
                right: 15px;
                font-size: 11px;
            }

            .floating-quest-panel {
                right: 65px;
                width: 250px;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <div class="header">
            <h1>Á®ªÈ¶ôÊùë</h1>
            <div class="subtitle">‰∏éÁå´Âí™‰ºô‰º¥ÁöÑÂÜíÈô©‰πãÊóÖ</div>
        </div>

        <!-- Âü∫Á°ÄËøêËê•Êï∞ÊçÆ -->
        <div class="section">
            <h2 class="section-title">Âü∫Á°ÄËøêËê•Êï∞ÊçÆ</h2>
            <table class="main-table">
                <tr>
                    <td>ËøêËê•Â§©Êï∞</td>
                    <td id="operation-days">Á¨¨1Â§©</td>
                    <td>ÂΩìÂâçÂ≠£ËäÇ</td>
                    <td id="current-season">Êò•Â§© (Á¨¨1Â§©)</td>
                    <td>Â§©Ê∞îÁä∂ÂÜµ</td>
                    <td id="weather-status">Êô¥Â§©</td>
                </tr>
                <tr>
                    <td colspan="2" id="weather-effect">‰ΩúÁâ©ÁîüÈïø Ê≠£Â∏∏</td>
                    <td>ËøêËê•ËµÑÈáë</td>
                    <td colspan="3" id="operation-funds">0 ÈáëÂ∏Å</td>
                </tr>
            </table>
        </div>

        <!-- ÂØºËà™Ê†è -->
        <div class="nav-bar">
            <button class="nav-btn" onclick="returnToTeaShop()">ËøîÂõûËå∂Èì∫</button>
            <button class="nav-btn" onclick="openBag()">ËÉåÂåÖ</button>
            <button class="nav-btn" onclick="openQuestLog()">‰ªªÂä°Êó•Âøó</button>
            <button class="nav-btn" onclick="meditate()">ÊâìÂùêÊÅ¢Â§ç</button>
            <button class="nav-btn" onclick="manualCloudSync()" style="background: #e0f2fe;">‰∫ëÁ´ØÂêåÊ≠•</button>
            <button class="nav-btn" onclick="forceRefreshData()" style="background: #fef3c7;">Âà∑Êñ∞Êï∞ÊçÆ</button>
            <button class="nav-btn" onclick="testBag()" style="background: #dcfce7;">ÊµãËØïËÉåÂåÖ</button>
            <button class="nav-btn" onclick="forceUpdateFunds()" style="background: #fef08a;">Âº∫Âà∂Âà∑Êñ∞ÈáëÂ∏Å</button>
            <button class="nav-btn" onclick="clearRiceVillageProgress()" style="background: #fca5a5;">Ê∏ÖÈô§Á®ªÈ¶ôÊùëËøõÂ∫¶</button>
        </div>

        <!-- ËßíËâ≤Áä∂ÊÄÅ -->
        <div class="status-bar">
            <table class="status-table">
                <thead>
                    <tr>
                        <th>ËßíËâ≤</th>
                        <th>Á≠âÁ∫ß</th>
                        <th>Ë°ÄÈáè</th>
                        <th>ÂäõÈáè</th>
                        <th>‰ΩìÂäõ</th>
                        <th>Ë£ÖÂ§á</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Áé©ÂÆ∂</td>
                        <td id="player-level">1Á∫ß</td>
                        <td id="player-hp">100/100</td>
                        <td id="player-power">5</td>
                        <td id="player-stamina">100/100</td>
                        <td id="player-equipment">Êó†Ë£ÖÂ§á</td>
                    </tr>
                    <tr>
                        <td colspan="6" id="player-exp-bar">
                            <div class="exp-bar">
                                <div class="exp-fill" id="exp-fill" style="width: 0%"></div>
                                <div class="exp-text" id="exp-text">0/100 ÁªèÈ™å</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td id="cat-name">Áå´Âí™‰ºô‰º¥</td>
                        <td id="cat-level">1Á∫ß</td>
                        <td id="cat-hp">100/100</td>
                        <td id="cat-power">10</td>
                        <td id="cat-type">-</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- NPCÂàóË°® -->
        <div class="section">
            <h3 class="section-title">ÊùëÊ∞ë</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>ÂßìÂêç</th>
                        <th>ËÅå‰∏ö</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="npc-list">
                    <tr>
                        <td>ÊùëÈïøÂàòÊ¥ã</td>
                        <td>ÊùëÈïø</td>
                        <td><span class="status-indicator status-available">ÂèØÂØπËØù</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ÊùëÈïøÂàòÊ¥ã')">ËÅäÂ§©</button></td>
                    </tr>
                    <tr>
                        <td>ÁéãÂ©ÜÂ©Ü</td>
                        <td>ÊùëÊ∞ë</td>
                        <td><span class="status-indicator status-available">ÂèØÂØπËØù</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ÁéãÂ©ÜÂ©Ü')">ËÅäÂ§©</button></td>
                    </tr>
                    <tr>
                        <td>ÊùéÂ§ç</td>
                        <td>Á•ûÁßò‰∫∫</td>
                        <td><span class="status-indicator status-available">ÂèØÂØπËØù</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ÊùéÂ§ç')">ËÅäÂ§©</button></td>
                    </tr>
                    <tr>
                        <td>Ê∞ëÂÖµÈòüÈïøÁéãÂ§ßÁü≥</td>
                        <td>Ê∞ëÂÖµÈòüÈïø</td>
                        <td><span class="status-indicator status-available">ÂèØÂØπËØù</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('ÁéãÂ§ßÁü≥')">ËÅäÂ§©</button></td>
                    </tr>
                    <tr>
                        <td>‰ΩôÂçä‰ªô</td>
                        <td>ÁÆóÂëΩÂÖàÁîü</td>
                        <td><span class="status-indicator status-available">ÂèØÁÆóÂëΩ</span></td>
                        <td><button class="action-btn" onclick="talkToNPC('‰ΩôÂçä‰ªô')">ËÅäÂ§©</button></td>
                    </tr>
                    <tr>
                        <td>Ê≠¶Âô®Èì∫ËÄÅÊùø</td>
                        <td>ÂïÜ‰∫∫</td>
                        <td><span class="status-indicator status-available">Ëê•‰∏ö‰∏≠</span></td>
                        <td>
                            <button class="action-btn" onclick="talkToNPC('Ê≠¶Âô®Èì∫ËÄÅÊùø')">ËÅäÂ§©</button>
                            <button class="action-btn success" onclick="openWeaponShop()">Ë¥≠‰π∞</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Ê§çÁâ©ËµÑÊ∫ê -->
        <div class="section">
            <h3 class="section-title">Ê§çÁâ©ËµÑÊ∫ê</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>ÂêçÁß∞</th>
                        <th>ÊèèËø∞</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="plant-list">
                    <tr>
                        <td>Ê≠¢Ë°ÄËçâ</td>
                        <td>Â∏∏ËßÅÁöÑËçØËçâ</td>
                        <td><span class="status-indicator status-available">ÂèØÈááÈõÜ</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('Ê≠¢Ë°ÄËçâ')">ÈááÈõÜ</button></td>
                    </tr>
                    <tr>
                        <td>ÈáéËèú</td>
                        <td>ÊôÆÈÄöÁöÑÈáéËèú</td>
                        <td><span class="status-indicator status-available">ÂèØÈááÈõÜ</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('ÈáéËèú')">ÈááÈõÜ</button></td>
                    </tr>
                    <tr>
                        <td>ÁÅµËäù</td>
                        <td>ÁèçË¥µÁöÑËçØÊùê</td>
                        <td><span class="status-indicator status-available">ÂèØÈááÈõÜ</span></td>
                        <td><button class="action-btn" onclick="gatherPlant('ÁÅµËäù')">ÈááÈõÜ</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ÊÄ™Áâ© -->
        <div class="section">
            <h3 class="section-title">ÈáéÁîüÂä®Áâ©</h3>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>ÂêçÁß∞</th>
                        <th>Ë°ÄÈáè</th>
                        <th>ÂΩìÂâçË°ÄÈáè</th>
                        <th>ÊîªÂáªÂäõ</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="monster-list">
                    <tr>
                        <td>ÊûúÂ≠êÁã∏</td>
                        <td>10</td>
                        <td id="monster-hp-ÊûúÂ≠êÁã∏">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">10/10</div>
                            </div>
                        </td>
                        <td>1</td>
                        <td id="monster-status-ÊûúÂ≠êÁã∏"><span class="status-indicator status-available">ÂèØÊîªÂáª</span></td>
                        <td id="monster-action-ÊûúÂ≠êÁã∏"><button class="action-btn" onclick="attackMonster('ÊûúÂ≠êÁã∏')">ÊîªÂáª</button></td>
                    </tr>
                    <tr>
                        <td>Áå¥Â≠ê</td>
                        <td>15</td>
                        <td id="monster-hp-Áå¥Â≠ê">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">15/15</div>
                            </div>
                        </td>
                        <td>2</td>
                        <td id="monster-status-Áå¥Â≠ê"><span class="status-indicator status-available">ÂèØÊîªÂáª</span></td>
                        <td id="monster-action-Áå¥Â≠ê"><button class="action-btn" onclick="attackMonster('Áå¥Â≠ê')">ÊîªÂáª</button></td>
                    </tr>
                    <tr>
                        <td>Â±±Ë¥º</td>
                        <td>25</td>
                        <td id="monster-hp-Â±±Ë¥º">
                            <div class="progress-bar" style="height: 16px;">
                                <div class="progress-fill" style="width: 100%"></div>
                                <div class="progress-text">25/25</div>
                            </div>
                        </td>
                        <td>5</td>
                        <td id="monster-status-Â±±Ë¥º"><span class="status-indicator status-available">ÂèØÊîªÂáª</span></td>
                        <td id="monster-action-Â±±Ë¥º"><button class="action-btn" onclick="attackMonster('Â±±Ë¥º')">ÊîªÂáª</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ËÉåÂåÖÊ®°ÊÄÅÊ°Ü -->
    <div id="bag-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ËÉåÂåÖ
                <span class="close" onclick="closeBag()">&times;</span>
            </div>
            <table class="main-table">
                <thead>
                    <tr>
                        <th>Áâ©ÂìÅÂêçÁß∞</th>
                        <th>Êï∞Èáè</th>
                        <th>ÊèèËø∞</th>
                    </tr>
                </thead>
                <tbody id="bag-items">
                    <tr>
                        <td colspan="3" style="text-align: center; color: #666;">ËÉåÂåÖ‰∏∫Á©∫</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ‰ªªÂä°Êó•ÂøóÊ®°ÊÄÅÊ°Ü -->
    <div id="quest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ‰ªªÂä°Êó•Âøó
                <span class="close" onclick="closeQuestLog()">&times;</span>
            </div>
            <div id="quest-content">
                <p style="text-align: center; color: #666;">ÊöÇÊó†‰ªªÂä°</p>
            </div>
        </div>
    </div>

    <!-- Ê≠¶Âô®Èì∫Ê®°ÊÄÅÊ°Ü -->
    <div id="weapon-shop-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                Ê≠¶Âô®Èì∫
                <span class="close" onclick="closeWeaponShop()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0;">Ê≠¶Âô®</h4>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th>ÂêçÁß∞</th>
                            <th>ÊîªÂáªÂäõ</th>
                            <th>ËÄê‰πÖÂ∫¶</th>
                            <th>‰ª∑Ê†º</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Áü≠Ââë</td>
                            <td>+1</td>
                            <td>20ÂõûÂêà</td>
                            <td>10ÈáëÂ∏Å</td>
                            <td><button class="action-btn" onclick="buyWeapon('Áü≠Ââë', 1, 10)">Ë¥≠‰π∞</button></td>
                        </tr>
                        <tr>
                            <td>ÈïøÂâë</td>
                            <td>+2</td>
                            <td>20ÂõûÂêà</td>
                            <td>20ÈáëÂ∏Å</td>
                            <td><button class="action-btn" onclick="buyWeapon('ÈïøÂâë', 2, 20)">Ë¥≠‰π∞</button></td>
                        </tr>
                        <tr>
                            <td>Èìæ</td>
                            <td>+3</td>
                            <td>20ÂõûÂêà</td>
                            <td>30ÈáëÂ∏Å</td>
                            <td><button class="action-btn" onclick="buyWeapon('Èìæ', 3, 30)">Ë¥≠‰π∞</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0;">Èò≤ÂÖ∑</h4>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th>ÂêçÁß∞</th>
                            <th>Ë°ÄÈáè</th>
                            <th>‰ª∑Ê†º</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Â∏ÉÁî≤</td>
                            <td>+1</td>
                            <td>1ÈáëÂ∏Å</td>
                            <td><button class="action-btn" onclick="buyArmor('Â∏ÉÁî≤', 1, 1)">Ë¥≠‰π∞</button></td>
                        </tr>
                        <tr>
                            <td>ÁöÆÁî≤</td>
                            <td>+20</td>
                            <td>20ÈáëÂ∏Å</td>
                            <td><button class="action-btn" onclick="buyArmor('ÁöÆÁî≤', 20, 20)">Ë¥≠‰π∞</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="repair-section" style="margin-bottom: 20px; display: none;">
                <h4 style="margin: 0 0 10px 0;">‰øÆÁêÜÊúçÂä°</h4>
                <table class="main-table">
                    <tbody id="repair-list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÊÇ¨ÊµÆ‰ªªÂä°Êó•ÂøóÁêÉ -->
    <div class="floating-quest-ball" onclick="toggleFloatingQuest()" id="floating-quest-ball">
        ‰ªªÂä°
    </div>

    <!-- ÊÇ¨ÊµÆ‰ªªÂä°Èù¢Êùø -->
    <div class="floating-quest-panel" id="floating-quest-panel">
        <div class="quest-panel-header">
            ÂΩìÂâç‰ªªÂä°
            <span style="float: right; cursor: pointer; color: #9ca3af;" onclick="toggleFloatingQuest()">&times;</span>
        </div>
        <div id="floating-quest-content">
            <div style="text-align: center; color: #6b7280; font-size: 11px;">ÊöÇÊó†‰ªªÂä°</div>
        </div>
    </div>

    <!-- ÊÇ¨ÊµÆËÉåÂåÖÁêÉ -->
    <div class="floating-bag-ball" onclick="console.log('ËÉåÂåÖÁêÉË¢´ÁÇπÂáª'); toggleFloatingBag();" id="floating-bag-ball">
        ËÉåÂåÖ
    </div>

    <!-- ÊÇ¨ÊµÆËÉåÂåÖÈù¢Êùø -->
    <div class="floating-bag-panel" id="floating-bag-panel" style="display: none;">
        <div class="quest-panel-header">
            ËÉåÂåÖÁâ©ÂìÅ
            <span style="float: right; cursor: pointer; color: #9ca3af;" onclick="console.log('ÂÖ≥Èó≠ÊåâÈíÆË¢´ÁÇπÂáª'); toggleFloatingBag();">&times;</span>
        </div>
        <div id="floating-bag-content">
            <div style="text-align: center; color: #6b7280; font-size: 11px;">ËÉåÂåÖ‰∏∫Á©∫</div>
        </div>
    </div>

    <script>
        // Á®ªÈ¶ôÊùëÊ∏∏ÊàèÊï∞ÊçÆ
        let riceVillageData = {
            player: {
                name: "Áé©ÂÆ∂",
                hp: 100,
                maxHp: 100,
                stamina: 100,
                maxStamina: 100,
                power: 5,
                level: 1,
                exp: 0,
                weapon: null,
                armor: null
            },
            cat: {
                name: "Áå´Âí™‰ºô‰º¥",
                hp: 100,
                maxHp: 100,
                power: 10,
                level: 1,
                type: null // 'tank' Êàñ 'damage'
            },
            inventory: {},
            npcs: {
                "ÊùëÈïøÂàòÊ¥ã": { questStage: 0, lastTalkTime: 0 },
                "ÁéãÂ©ÜÂ©Ü": { questStage: 0, lastTalkTime: 0 },
                "ÊùéÂ§ç": { questStage: 0, lastTalkTime: 0 },
                "ÁéãÂ§ßÁü≥": { questStage: 0, lastTalkTime: 0 },
                "‰ΩôÂçä‰ªô": { questStage: 0, lastTalkTime: 0 },
                "Ê≠¶Âô®Èì∫ËÄÅÊùø": { questStage: 0, lastTalkTime: 0 }
            },
            currentQuest: null,
            questProgress: 0,
            questTarget: 0,
            plants: {
                "Ê≠¢Ë°ÄËçâ": { available: true, lastGathered: 0 },
                "ÈáéËèú": { available: true, lastGathered: 0 },
                "ÁÅµËäù": { available: true, lastGathered: 0 }
            },
            monsters: {
                "ÊûúÂ≠êÁã∏": { hp: 10, maxHp: 10, attack: 1, available: true, lastKilled: 0 },
                "Áå¥Â≠ê": { hp: 15, maxHp: 15, attack: 2, available: true, lastKilled: 0 },
                "Â±±Ë¥º": { hp: 25, maxHp: 25, attack: 5, available: true, lastKilled: 0 }
            }
        };

        // Win95Ê†∑ÂºèÂºπÁ™ó
        function showWin95Modal(title, content, icon = '') {
            // ÂÖàÂÖ≥Èó≠ÊâÄÊúâÁé∞ÊúâÁöÑÊ®°ÊÄÅÊ°Ü
            closeWin95Modal();

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999'; // Á°Æ‰øùÂú®ÊúÄÈ°∂Â±Ç
            modal.innerHTML = `
                <div class="modal-content" style="background: #c0c0c0; border: 2px outset #c0c0c0; border-radius: 0; max-width: 400px;">
                    <div style="background: linear-gradient(90deg, #0040c0, #4080ff); color: white; padding: 4px 8px; margin: -20px -20px 15px -20px; font-size: 12px; font-weight: bold;">
                        ${icon} ${title}
                        <span class="close" onclick="closeWin95Modal()" style="float: right; color: white; font-size: 16px;">&times;</span>
                    </div>
                    <div style="padding: 10px; background: #c0c0c0; color: #000; font-size: 12px;">
                        ${content}
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="closeWin95Modal()" style="padding: 4px 20px; background: #c0c0c0; border: 1px outset #c0c0c0; font-size: 12px;">Á°ÆÂÆö</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeWin95Modal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂæÖÊòæÁ§∫ÁöÑÁ™óÂè£
            processModalQueue();
        }

        // Á™óÂè£ÈòüÂàóÁÆ°ÁêÜ
        let modalQueue = [];

        function queueModal(title, content, icon = '') {
            modalQueue.push({ title, content, icon });
            if (modalQueue.length === 1) {
                processModalQueue();
            }
        }

        function processModalQueue() {
            if (modalQueue.length > 0) {
                const { title, content, icon } = modalQueue.shift();
                setTimeout(() => {
                    showWin95Modal(title, content, icon);
                }, 500); // Âª∂Ëøü500msÊòæÁ§∫‰∏ã‰∏Ä‰∏™Á™óÂè£
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.onload = function() {
            // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñÁå´Âí™ÂêçÂ≠ó
            const urlParams = new URLSearchParams(window.location.search);
            const catName = urlParams.get('catName');
            if (catName) {
                riceVillageData.cat.name = catName;
                document.getElementById('cat-name').textContent = catName;
            }

            // Âä†ËΩΩÁ®ªÈ¶ôÊùëÂ≠òÊ°£Êï∞ÊçÆ
            loadRiceVillageData();

            // Â∞ùËØï‰ªé‰∫ëÁ´ØÂä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆ
            setTimeout(() => {
                loadFromGitHubGist();
            }, 1000);

            // ‰ªéËå∂Èì∫Ëé∑ÂèñÂü∫Á°ÄÊï∞ÊçÆ
            loadTeaShopData();
            updateDisplay();
            updateFloatingQuestDisplay(); // ÂàùÂßãÂåñÊÇ¨ÊµÆ‰ªªÂä°ÊòæÁ§∫
            updateFloatingBagDisplay(); // ÂàùÂßãÂåñÊÇ¨ÊµÆËÉåÂåÖÊòæÁ§∫

            // Âº∫Âà∂Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫ÔºàÂª∂ËøüÊâßË°åÔºåÈÅøÂÖçÂºπÁ™óÔºâ
            setTimeout(() => {
                console.log('È°µÈù¢Âä†ËΩΩÂêéËá™Âä®Êõ¥Êñ∞ÈáëÂ∏Å...');

                // ÈùôÈªòÊõ¥Êñ∞Ôºå‰∏çÊòæÁ§∫ÂºπÁ™ó
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                const funds = parsed.funds || 0;
                                console.log(`Ëá™Âä®‰ªé${key}Ëé∑ÂèñÈáëÂ∏Å:`, funds);

                                // Êõ¥Êñ∞È°∂ÈÉ®ÊòæÁ§∫
                                const operationFunds = document.getElementById('operation-funds');
                                if (operationFunds) {
                                    operationFunds.textContent = `${funds} ÈáëÂ∏Å`;
                                }

                                // Êõ¥Êñ∞ËÉåÂåÖÊòæÁ§∫
                                updateFloatingBagDisplay();
                                break;
                            }
                        } catch (e) {
                            console.log(`Ëá™Âä®Êõ¥Êñ∞: ${key}Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•`);
                        }
                    }
                }
            }, 1000);

            // ÂàùÂßãÂåñÊâÄÊúâÊÄ™Áâ©Ë°ÄÈáèÊòæÁ§∫
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                updateMonsterHP(monsterName);
            });

            startStaminaRegeneration();

            // Âª∂ËøüÂÜçÊ¨°Âä†ËΩΩÊï∞ÊçÆÁ°Æ‰øùÊòæÁ§∫Ê≠£Á°Æ
            setTimeout(() => {
                loadTeaShopData();
                updateFloatingBagDisplay();
                console.log('Âª∂ËøüÂä†ËΩΩÂÆåÊàê');
            }, 500);

            // ÂÜçÊ¨°Âª∂ËøüÂä†ËΩΩÁ°Æ‰øùÊï∞ÊçÆÊ≠£Á°Æ
            setTimeout(() => {
                loadTeaShopData();
                updateFloatingBagDisplay();
                console.log('‰∫åÊ¨°Âª∂ËøüÂä†ËΩΩÂÆåÊàê');
            }, 2000);

            // ÂÆöÊúü‰øùÂ≠òÊï∞ÊçÆÂíåÂà∑Êñ∞ÈáëÂ∏Å
            setInterval(() => {
                saveRiceVillageData();
                // ÂÆöÊúüÂà∑Êñ∞ÈáëÂ∏ÅÊï∞ÊçÆ
                loadTeaShopData();
            }, 30000); // ÊØè30Áßí‰øùÂ≠òÂíåÂà∑Êñ∞‰∏ÄÊ¨°
        };

        // ‰øùÂ≠òÁ®ªÈ¶ôÊùëÊï∞ÊçÆ
        function saveRiceVillageData() {
            try {
                localStorage.setItem('riceVillageData', JSON.stringify(riceVillageData));
                console.log('Á®ªÈ¶ôÊùëÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞');

                // Â¶ÇÊûúÊúâGitHub TokenÔºå‰πü‰øùÂ≠òÂà∞‰∫ëÁ´Ø
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                if (cloudSaveConfig.githubToken && cloudSaveConfig.gistId) {
                    saveToGitHubGist();
                }
            } catch (error) {
                console.error('‰øùÂ≠òÁ®ªÈ¶ôÊùëÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÁ®ªÈ¶ôÊùëÊï∞ÊçÆ
        function loadRiceVillageData() {
            try {
                const savedData = localStorage.getItem('riceVillageData');
                console.log('Êú¨Âú∞Á®ªÈ¶ôÊùëÊï∞ÊçÆ:', savedData); // Ë∞ÉËØïÊó•Âøó

                if (savedData) {
                    const data = JSON.parse(savedData);
                    console.log('Ëß£ÊûêÂêéÁöÑÁ®ªÈ¶ôÊùëÊï∞ÊçÆ:', data); // Ë∞ÉËØïÊó•Âøó

                    // Ê∑±Â∫¶ÂêàÂπ∂‰øùÂ≠òÁöÑÊï∞ÊçÆÔºå‰øùÁïôÂΩìÂâçÁöÑÈªòËÆ§ÂÄºÁªìÊûÑ
                    riceVillageData.player = { ...riceVillageData.player, ...data.player };
                    riceVillageData.cat = { ...riceVillageData.cat, ...data.cat };
                    riceVillageData.npcs = { ...riceVillageData.npcs, ...data.npcs };
                    riceVillageData.plants = { ...riceVillageData.plants, ...data.plants };
                    riceVillageData.monsters = { ...riceVillageData.monsters, ...data.monsters };
                    riceVillageData.inventory = { ...riceVillageData.inventory, ...data.inventory };

                    if (data.currentQuest) riceVillageData.currentQuest = data.currentQuest;
                    if (data.questProgress !== undefined) riceVillageData.questProgress = data.questProgress;
                    if (data.questTarget !== undefined) riceVillageData.questTarget = data.questTarget;
                    if (data.questCompleted) riceVillageData.questCompleted = data.questCompleted;

                    console.log('Á®ªÈ¶ôÊùëÊï∞ÊçÆÂ∑≤‰ªéÊú¨Âú∞Âä†ËΩΩÔºåÂΩìÂâçÁ≠âÁ∫ß:', riceVillageData.player.level);
                } else {
                    console.log('Ê≤°ÊúâÊâæÂà∞Êú¨Âú∞Á®ªÈ¶ôÊùëÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ®ªÈ¶ôÊùëÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òÂà∞GitHub Gist
        function saveToGitHubGist() {
            try {
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                console.log('‰∫ëÁ´Ø‰øùÂ≠òÈÖçÁΩÆ:', cloudSaveConfig); // Ë∞ÉËØïÊó•Âøó

                if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                    console.log('Ê≤°ÊúâGitHub TokenÊàñGist IDÔºåË∑≥Ëøá‰∫ëÁ´Ø‰øùÂ≠ò');
                    return;
                }

                const saveData = {
                    riceVillageData: riceVillageData,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };

                const gistData = {
                    description: "Á®ªÈ¶ôÊùëRPGÂ≠òÊ°£Êï∞ÊçÆ",
                    files: {
                        "rice_village_save.json": {
                            content: JSON.stringify(saveData, null, 2)
                        }
                    }
                };

                console.log('Ê≠£Âú®‰øùÂ≠òÂà∞GitHub Gist...'); // Ë∞ÉËØïÊó•Âøó

                fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(gistData)
                }).then(response => {
                    if (response.ok) {
                        console.log('Á®ªÈ¶ôÊùëÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞GitHub Gist');
                        return response.json();
                    } else {
                        console.error('‰øùÂ≠òÂà∞GitHub GistÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                        return response.text().then(text => {
                            console.error('ÈîôËØØËØ¶ÊÉÖ:', text);
                        });
                    }
                }).catch(error => {
                    console.error('GitHub Gist‰øùÂ≠òÈîôËØØ:', error);
                });
            } catch (error) {
                console.error('GitHub Gist‰øùÂ≠òÂºÇÂ∏∏:', error);
            }
        }

        // ‰ªéGitHub GistÂä†ËΩΩÊï∞ÊçÆ
        function loadFromGitHubGist() {
            try {
                const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');
                if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                    console.log('Ê≤°ÊúâGitHub TokenÊàñGist IDÔºåË∑≥Ëøá‰∫ëÁ´ØÂä†ËΩΩ');
                    return;
                }

                console.log('Ê≠£Âú®‰ªéGitHub GistÂä†ËΩΩÊï∞ÊçÆ...');

                fetch(`https://api.github.com/gists/${cloudSaveConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${cloudSaveConfig.githubToken}`,
                    }
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('‰ªéGitHub GistÂä†ËΩΩÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                        return null;
                    }
                }).then(gist => {
                    if (gist && gist.files && gist.files['rice_village_save.json']) {
                        const content = gist.files['rice_village_save.json'].content;
                        const saveData = JSON.parse(content);

                        if (saveData.riceVillageData) {
                            // ÂêàÂπ∂‰∫ëÁ´ØÊï∞ÊçÆ
                            const cloudData = saveData.riceVillageData;
                            riceVillageData.player = { ...riceVillageData.player, ...cloudData.player };
                            riceVillageData.cat = { ...riceVillageData.cat, ...cloudData.cat };
                            riceVillageData.npcs = { ...riceVillageData.npcs, ...cloudData.npcs };
                            riceVillageData.plants = { ...riceVillageData.plants, ...cloudData.plants };
                            riceVillageData.monsters = { ...riceVillageData.monsters, ...cloudData.monsters };
                            riceVillageData.inventory = { ...riceVillageData.inventory, ...cloudData.inventory };

                            if (cloudData.currentQuest) riceVillageData.currentQuest = cloudData.currentQuest;
                            if (cloudData.questProgress !== undefined) riceVillageData.questProgress = cloudData.questProgress;
                            if (cloudData.questTarget !== undefined) riceVillageData.questTarget = cloudData.questTarget;
                            if (cloudData.questCompleted) riceVillageData.questCompleted = cloudData.questCompleted;

                            console.log('‰ªéGitHub GistÂä†ËΩΩÊï∞ÊçÆÊàêÂäüÔºåÁ≠âÁ∫ß:', riceVillageData.player.level);
                            updateDisplay();
                            updateFloatingQuestDisplay();
                        }
                    }
                }).catch(error => {
                    console.error('GitHub GistÂä†ËΩΩÈîôËØØ:', error);
                });
            } catch (error) {
                console.error('GitHub GistÂä†ËΩΩÂºÇÂ∏∏:', error);
            }
        }

        // ‰ªéËå∂Èì∫Ëé∑ÂèñÂü∫Á°ÄÊï∞ÊçÆ
        function loadTeaShopData() {
            try {
                console.log('ÂºÄÂßãÂä†ËΩΩËå∂Èì∫Êï∞ÊçÆ...');
                console.log('localStorageÊâÄÊúâÈîÆ:', Object.keys(localStorage));

                // Â∞ùËØïÂ§öÁßçÂèØËÉΩÁöÑlocalStorageÈîÆÂêç
                const possibleKeys = ['teaGameData', 'gameData', 'cuteTeaShop_save', 'teaGameSave_1', 'teaShopData'];
                let teaShopData = null;
                let usedKey = null;

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`Ê£ÄÊü•${key}:`, parsed); // Ë∞ÉËØïÔºöÁúãÁúãÊØè‰∏™ÈîÆÁöÑÊï∞ÊçÆÁªìÊûÑ

                            if (parsed && (parsed.funds !== undefined || parsed.day !== undefined)) {
                                teaShopData = data;
                                usedKey = key;
                                console.log(`‰ªé${key}ÊâæÂà∞Ëå∂Èì∫Êï∞ÊçÆÔºåÈáëÂ∏Å:${parsed.funds}, Â§©Êï∞:${parsed.day}`);
                                break;
                            }
                        } catch (e) {
                            console.log(`${key}Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•:`, e);
                        }
                    } else {
                        console.log(`${key}: Êó†Êï∞ÊçÆ`);
                    }
                }

                console.log('Ëå∂Èì∫Êï∞ÊçÆÊü•ÊâæÁªìÊûú:', teaShopData ? `Â∑≤ÊâæÂà∞(${usedKey})` : 'Êú™ÊâæÂà∞');

                if (teaShopData) {
                    const data = JSON.parse(teaShopData);
                    console.log('Ëß£ÊûêÂêéÁöÑËå∂Èì∫Êï∞ÊçÆ - Â§©Êï∞:', data.day, 'ÈáëÂ∏Å:', data.funds, 'Â§©Ê∞î:', data.weather); // Ë∞ÉËØïÊó•Âøó

                    // Êõ¥Êñ∞ËøêËê•Êï∞ÊçÆÊòæÁ§∫
                    const operationDays = document.getElementById('operation-days');
                    const currentSeason = document.getElementById('current-season');
                    const weatherStatus = document.getElementById('weather-status');
                    const weatherEffect = document.getElementById('weather-effect');
                    const operationFunds = document.getElementById('operation-funds');

                    if (operationDays) {
                        const dayNum = data.day || data.currentDay || 1;
                        operationDays.textContent = `Á¨¨${dayNum}Â§©`;
                        console.log('Êõ¥Êñ∞ËøêËê•Â§©Êï∞:', operationDays.textContent);
                    }

                    // Â≠£ËäÇÊòæÁ§∫
                    const seasons = ['Êò•Â§©', 'Â§èÂ§©', 'ÁßãÂ§©', 'ÂÜ¨Â§©'];
                    const seasonName = seasons[data.season] || 'Êò•Â§©';
                    if (currentSeason) {
                        currentSeason.textContent = `${seasonName} (Á¨¨${data.seasonDay || 1}Â§©)`;
                        console.log('Êõ¥Êñ∞Â≠£ËäÇ:', currentSeason.textContent);
                    }

                    // Â§©Ê∞îÊòæÁ§∫
                    const weatherIcons = {
                        'Êô¥Â§©': '‚òÄÔ∏è',
                        'Â§ö‰∫ë': '‚òÅÔ∏è',
                        'Èõ®Â§©': 'üåßÔ∏è',
                        'Êö¥È£éÈõ®': '‚õàÔ∏è',
                        'Èõ™Â§©': '‚ùÑÔ∏è'
                    };

                    // Â§ÑÁêÜÂ§©Ê∞îÊï∞ÊçÆÔºàÂèØËÉΩÊòØÊï∞Â≠óÊàñÂ≠óÁ¨¶‰∏≤Ôºâ
                    let weatherName = 'Êô¥Â§©';
                    if (data.currentWeather) {
                        weatherName = data.currentWeather;
                    } else if (typeof data.weather === 'number') {
                        const weatherNames = ['Êô¥Â§©', 'Â§ö‰∫ë', 'Èõ®Â§©', 'Êö¥È£éÈõ®', 'Èõ™Â§©'];
                        weatherName = weatherNames[data.weather] || 'Êô¥Â§©';
                    } else if (data.weather) {
                        weatherName = data.weather;
                    }

                    const weatherIcon = weatherIcons[weatherName] || '‚òÄÔ∏è';
                    if (weatherStatus) {
                        weatherStatus.textContent = `${weatherIcon} ${weatherName}`;
                        console.log('Êõ¥Êñ∞Â§©Ê∞î:', weatherStatus.textContent);
                    }

                    // Â§©Ê∞îÊïàÊûú
                    let weatherEffectText = '‰ΩúÁâ©ÁîüÈïø Ê≠£Â∏∏';
                    if (data.weather === 'Èõ®Â§©') {
                        weatherEffectText = '‰ΩúÁâ©ÁîüÈïø +10%';
                    } else if (data.weather === 'Êö¥È£éÈõ®') {
                        weatherEffectText = '‰ΩúÁâ©ÁîüÈïø -10%';
                    } else if (data.weather === 'Èõ™Â§©') {
                        weatherEffectText = '‰ΩúÁâ©ÁîüÈïø -20%';
                    }
                    if (weatherEffect) {
                        weatherEffect.textContent = weatherEffectText;
                        console.log('Êõ¥Êñ∞Â§©Ê∞îÊïàÊûú:', weatherEffect.textContent);
                    }

                    if (operationFunds) {
                        const funds = data.funds || 0;
                        operationFunds.textContent = `${funds} ÈáëÂ∏Å`;
                        console.log('Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫:', operationFunds.textContent);

                        // ÂêåÊó∂Êõ¥Êñ∞ËÉåÂåÖ‰∏≠ÁöÑÈáëÂ∏ÅÊòæÁ§∫
                        updateFloatingBagDisplay();
                    }

                    console.log('Ëå∂Èì∫Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê'); // Ë∞ÉËØïÊó•Âøó
                } else {
                    console.log('Ê≤°ÊúâÊâæÂà∞Ëå∂Èì∫Êï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº'); // Ë∞ÉËØïÊó•Âøó
                    // ËÆæÁΩÆÈªòËÆ§ÂÄº
                    const operationDays = document.getElementById('operation-days');
                    const currentSeason = document.getElementById('current-season');
                    const weatherStatus = document.getElementById('weather-status');
                    const weatherEffect = document.getElementById('weather-effect');
                    const operationFunds = document.getElementById('operation-funds');

                    if (operationDays) operationDays.textContent = 'Á¨¨1Â§©';
                    if (currentSeason) currentSeason.textContent = 'Êò•Â§© (Á¨¨1Â§©)';
                    if (weatherStatus) weatherStatus.textContent = '‚òÄÔ∏è Êô¥Â§©';
                    if (weatherEffect) weatherEffect.textContent = '‰ΩúÁâ©ÁîüÈïø Ê≠£Â∏∏';
                    if (operationFunds) operationFunds.textContent = '0 ÈáëÂ∏Å';
                }
            } catch (error) {
                console.error('Âä†ËΩΩËå∂Èì∫Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // ËøîÂõûËå∂Èì∫
        function returnToTeaShop() {
            if (confirm('Á°ÆÂÆöË¶ÅËøîÂõûËå∂Èì∫ÂêóÔºüÂΩìÂâçËøõÂ∫¶‰ºö‰øùÂ≠ò„ÄÇ')) {
                // ‰øùÂ≠òÁ®ªÈ¶ôÊùëÊï∞ÊçÆ
                saveRiceVillageData();
                window.location.href = 'index.html';
            }
        }

        // ËÆ°ÁÆóÂçáÁ∫ßÊâÄÈúÄÁªèÈ™å
        function getExpRequiredForLevel(level) {
            return 50 + (level - 1) * 50; // 1Á∫ß‚Üí2Á∫ßÈúÄË¶Å100ÁªèÈ™åÔºåÊØèÁ∫ßÂ¢ûÂä†50
        }

        // Ëé∑ÂæóÁªèÈ™åÂÄº
        function gainExp(amount) {
            riceVillageData.player.exp += amount;

            // Ê£ÄÊü•ÂçáÁ∫ß
            let leveledUp = false;
            while (true) {
                const requiredExp = getExpRequiredForLevel(riceVillageData.player.level);
                if (riceVillageData.player.exp >= requiredExp) {
                    riceVillageData.player.exp -= requiredExp;
                    riceVillageData.player.level++;
                    leveledUp = true;

                    // ÂçáÁ∫ßÂ•ñÂä±ÔºöÊØèÁ∫ßÂ¢ûÂä†5Ë°ÄÈáè‰∏äÈôêÔºå1ÁÇπÂäõÈáèÔºàÊØè5Á∫ßÔºâ
                    riceVillageData.player.maxHp += 5;
                    riceVillageData.player.hp = riceVillageData.player.maxHp; // ÂçáÁ∫ßÂõûÊª°Ë°Ä

                    if (riceVillageData.player.level % 5 === 0) {
                        riceVillageData.player.power++;
                    }

                    // Ê£ÄÊü•Á≠âÁ∫ß‰∏äÈôê
                    if (riceVillageData.player.level >= 130) {
                        riceVillageData.player.level = 130;
                        riceVillageData.player.exp = 0;
                        break;
                    }
                } else {
                    break;
                }
            }

            if (leveledUp) {
                console.log(`üéâ ÊÅ≠ÂñúÂçáÁ∫ßÔºÅÂΩìÂâçÁ≠âÁ∫ßÔºö${riceVillageData.player.level}Á∫ßÔºåË°ÄÈáè‰∏äÈôêÂ¢ûÂä†ÔºÅ${riceVillageData.player.level % 5 === 0 ? 'ÂäõÈáèÂ¢ûÂä†ÔºÅ' : ''}`);

                // Âª∂ËøüÂçáÁ∫ßÁå´Âí™ÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÁ™óÂè£ÂÜ≤Á™Å
                setTimeout(() => {
                    upgradeCat();
                }, 1000);
            }

            updateDisplay();
        }

        // Áå´Âí™ÂçáÁ∫ßÁ≥ªÁªü
        function upgradeCat() {
            // Â¶ÇÊûúÁå´Âí™ËøòÊ≤°ÊúâÈÄâÊã©ÂçáÁ∫ßÊñπÂêëÔºåÂä†ÂÖ•Á™óÂè£ÈòüÂàó
            if (!riceVillageData.cat.type) {
                const choiceContent = `
                    <div style="text-align: center; line-height: 1.6;">
                        <h3 style="color: #0040c0; margin: 0 0 15px 0;">üê± Áå´Âí™ÂçáÁ∫ß</h3>
                        <div style="margin-bottom: 15px; padding: 12px; background: #f0f0f0; border: 1px inset #c0c0c0;">
                            <div style="color: #666; margin-bottom: 15px;">ÈÄâÊã©${riceVillageData.cat.name}ÁöÑÂçáÁ∫ßÊñπÂêëÔºö</div>
                            <button class="action-btn" onclick="chooseCatType('tank')" style="margin: 5px; padding: 10px 15px;">
                                üõ°Ô∏è Âù¶ÂÖãÂûã<br><small>ÊØèÁ∫ß Ë°ÄÈáè+20, ÊîªÂáª+1</small>
                            </button>
                            <button class="action-btn" onclick="chooseCatType('damage')" style="margin: 5px; padding: 10px 15px;">
                                ‚öîÔ∏è ËæìÂá∫Âûã<br><small>ÊØèÁ∫ß Ë°ÄÈáè+5, ÊîªÂáª+10</small>
                            </button>
                        </div>
                    </div>
                `;
                queueModal('Áå´Âí™ÂçáÁ∫ßÈÄâÊã©', choiceContent, 'üê±');
                return;
            }

            // Ê†πÊçÆÁ±ªÂûãÂçáÁ∫ß
            riceVillageData.cat.level = riceVillageData.player.level;

            if (riceVillageData.cat.type === 'tank') {
                // Âù¶ÂÖãÂûãÔºöË°ÄÈáè+20ÔºåÊîªÂáª+1
                riceVillageData.cat.maxHp += 20;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp; // ÂçáÁ∫ßÂõûÊª°Ë°Ä
                riceVillageData.cat.power += 1;
                console.log(`üê± ${riceVillageData.cat.name}ÂçáÁ∫ßÔºÅÂù¶ÂÖãÂûã Ë°ÄÈáè+20, ÊîªÂáª+1`);
            } else if (riceVillageData.cat.type === 'damage') {
                // ËæìÂá∫ÂûãÔºöË°ÄÈáè+5ÔºåÊîªÂáª+10
                riceVillageData.cat.maxHp += 5;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp; // ÂçáÁ∫ßÂõûÊª°Ë°Ä
                riceVillageData.cat.power += 10;
                console.log(`üê± ${riceVillageData.cat.name}ÂçáÁ∫ßÔºÅËæìÂá∫Âûã Ë°ÄÈáè+5, ÊîªÂáª+10`);
            }
        }

        // ÈÄâÊã©Áå´Âí™ÂçáÁ∫ßÁ±ªÂûã
        function chooseCatType(type) {
            riceVillageData.cat.type = type;
            closeWin95Modal();

            // Á´ãÂç≥ÂçáÁ∫ßÂà∞ÂΩìÂâçÁé©ÂÆ∂Á≠âÁ∫ß
            const levelDiff = riceVillageData.player.level - riceVillageData.cat.level;
            for (let i = 0; i < levelDiff; i++) {
                if (type === 'tank') {
                    riceVillageData.cat.maxHp += 20;
                    riceVillageData.cat.power += 1;
                } else if (type === 'damage') {
                    riceVillageData.cat.maxHp += 5;
                    riceVillageData.cat.power += 10;
                }
            }

            riceVillageData.cat.level = riceVillageData.player.level;
            riceVillageData.cat.hp = riceVillageData.cat.maxHp; // ÂõûÊª°Ë°Ä

            const typeName = type === 'tank' ? 'Âù¶ÂÖãÂûã' : 'ËæìÂá∫Âûã';
            showWin95Modal('ÂçáÁ∫ßÂÆåÊàê', `${riceVillageData.cat.name}ÈÄâÊã©‰∫Ü${typeName}ÂçáÁ∫ßË∑ØÁ∫øÔºÅ<br>Á≠âÁ∫ßÂ∑≤ÂêåÊ≠•Âà∞${riceVillageData.cat.level}Á∫ß`, 'üéâ');

            updateDisplay();
            saveRiceVillageData();
        }

        // Êõ¥Êñ∞ÊòæÁ§∫
        function updateDisplay() {
            // Êõ¥Êñ∞Áé©ÂÆ∂Áä∂ÊÄÅ
            document.getElementById('player-level').textContent = `${riceVillageData.player.level}Á∫ß`;
            document.getElementById('player-hp').textContent = `${riceVillageData.player.hp}/${riceVillageData.player.maxHp}`;
            document.getElementById('player-power').textContent = riceVillageData.player.power;
            document.getElementById('player-stamina').textContent = `${riceVillageData.player.stamina}/${riceVillageData.player.maxStamina}`;

            // Êõ¥Êñ∞ÁªèÈ™åÊù°
            const requiredExp = getExpRequiredForLevel(riceVillageData.player.level);
            const expPercent = Math.min(100, (riceVillageData.player.exp / requiredExp) * 100);
            document.getElementById('exp-fill').style.width = `${expPercent}%`;
            document.getElementById('exp-text').textContent = `${riceVillageData.player.exp}/${requiredExp} ÁªèÈ™å`;

            // Êõ¥Êñ∞Áå´Âí™Áä∂ÊÄÅ
            document.getElementById('cat-level').textContent = `${riceVillageData.cat.level}Á∫ß`;
            document.getElementById('cat-hp').textContent = `${riceVillageData.cat.hp}/${riceVillageData.cat.maxHp}`;
            document.getElementById('cat-power').textContent = riceVillageData.cat.power;

            // Êõ¥Êñ∞Áå´Âí™Á±ªÂûãÊòæÁ§∫
            const catTypeElement = document.getElementById('cat-type');
            if (catTypeElement) {
                if (riceVillageData.cat.type === 'tank') {
                    catTypeElement.textContent = 'üõ°Ô∏èÂù¶ÂÖã';
                } else if (riceVillageData.cat.type === 'damage') {
                    catTypeElement.textContent = '‚öîÔ∏èËæìÂá∫';
                } else {
                    catTypeElement.textContent = 'Êú™ÈÄâÊã©';
                }
            }

            // Êõ¥Êñ∞Ë£ÖÂ§áÊòæÁ§∫
            let equipmentText = "Êó†Ë£ÖÂ§á";
            if (riceVillageData.player.weapon || riceVillageData.player.armor) {
                let parts = [];
                if (riceVillageData.player.weapon) parts.push(riceVillageData.player.weapon.name);
                if (riceVillageData.player.armor) parts.push(riceVillageData.player.armor.name);
                equipmentText = parts.join(", ");
            }
            document.getElementById('player-equipment').textContent = equipmentText;
        }

        // ‰ΩìÂäõËá™Âä®ÊÅ¢Â§ç
        function startStaminaRegeneration() {
            setInterval(() => {
                if (riceVillageData.player.stamina < riceVillageData.player.maxStamina) {
                    riceVillageData.player.stamina = Math.min(
                        riceVillageData.player.maxStamina, 
                        riceVillageData.player.stamina + 1
                    );
                    updateDisplay();
                }
            }, 30000); // ÊØè30ÁßíÊÅ¢Â§ç1ÁÇπ‰ΩìÂäõ
        }

        // ÊâìÂùêÊÅ¢Â§çÂäüËÉΩ
        let meditationTimer = null;
        let meditationStartTime = 0;

        function meditate() {
            if (meditationTimer) {
                alert('Â∑≤Âú®ÊâìÂùê‰∏≠ÔºåËØ∑Á≠âÂæÖÂÆåÊàêÔºÅ');
                return;
            }

            if (riceVillageData.player.hp >= riceVillageData.player.maxHp) {
                alert('Ë°ÄÈáèÂ∑≤Êª°ÔºåÊó†ÈúÄÊâìÂùêÔºÅ');
                return;
            }

            // ÂºÄÂßãÊâìÂùê
            meditationStartTime = Date.now();
            meditationTimer = setTimeout(() => {
                // 20ÁßíÂêéÊÅ¢Â§çÊª°Ë°Ä
                riceVillageData.player.hp = riceVillageData.player.maxHp;
                riceVillageData.cat.hp = riceVillageData.cat.maxHp;
                meditationTimer = null;
                updateDisplay();
                alert('ÊâìÂùêÂÆåÊàêÔºÅË°ÄÈáèÂ∑≤ÊÅ¢Â§çÔºÅ');
            }, 20000);

            updateMeditationDisplay();
        }

        function updateMeditationDisplay() {
            const meditateBtn = document.querySelector('button[onclick="meditate()"]');
            if (meditationTimer) {
                const elapsed = Date.now() - meditationStartTime;
                const remaining = Math.max(0, 20000 - elapsed);
                const seconds = Math.ceil(remaining / 1000);

                if (seconds > 0) {
                    meditateBtn.textContent = `ÊâìÂùê‰∏≠... ${seconds}Áßí`;
                    meditateBtn.disabled = true;
                    setTimeout(updateMeditationDisplay, 1000);
                } else {
                    meditateBtn.textContent = 'ÊâìÂùêÊÅ¢Â§ç';
                    meditateBtn.disabled = false;
                }
            } else {
                meditateBtn.textContent = 'ÊâìÂùêÊÅ¢Â§ç';
                meditateBtn.disabled = false;
            }
        }

        // ÊÇ¨ÊµÆËÉåÂåÖÂäüËÉΩ - ÁÆÄÂåñÁâàÊú¨
        function toggleFloatingBag() {
            console.log('ËÉåÂåÖÊåâÈíÆË¢´ÁÇπÂáª');

            const panel = document.getElementById('floating-bag-panel');
            if (!panel) {
                console.error('Êâæ‰∏çÂà∞ËÉåÂåÖÈù¢Êùø');
                return;
            }

            // Áõ¥Êé•ÂàáÊç¢ÊòæÁ§∫Áä∂ÊÄÅ
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                console.log('ÈöêËóèËÉåÂåÖ');
            } else {
                panel.style.display = 'block';
                console.log('ÊòæÁ§∫ËÉåÂåÖ');
                updateFloatingBagDisplay();
            }
        }

        // Êõ¥Êñ∞ÊÇ¨ÊµÆËÉåÂåÖÊòæÁ§∫
        function updateFloatingBagDisplay() {
            const floatingBagContent = document.getElementById('floating-bag-content');

            // Áõ¥Êé•‰ªélocalStorageËé∑ÂèñÊúÄÊñ∞ÈáëÂ∏ÅÊï∞
            let currentFunds = 0;
            try {
                const gameData = localStorage.getItem('gameData');
                if (gameData) {
                    const data = JSON.parse(gameData);
                    currentFunds = data.funds || 0;
                    console.log('ËÉåÂåÖÊòæÁ§∫: Ëé∑ÂèñÂà∞ÈáëÂ∏ÅÊï∞:', currentFunds);
                }
            } catch (error) {
                console.error('ËÉåÂåÖÊòæÁ§∫: Ëé∑ÂèñÈáëÂ∏ÅÂ§±Ë¥•:', error);
            }

            let bagContent = `
                <div style="margin-bottom: 15px; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px;">
                    <div style="font-weight: 500; color: #374151; margin-bottom: 4px;">üí∞ ÈáëÂ∏Å</div>
                    <div style="color: #6b7280; font-size: 11px;">${currentFunds} ÈáëÂ∏Å</div>
                </div>
            `;

            // ÊòæÁ§∫ËÉåÂåÖÁâ©ÂìÅ
            const hasItems = Object.keys(riceVillageData.inventory).some(item => riceVillageData.inventory[item] > 0);

            if (hasItems) {
                bagContent += '<div style="margin-bottom: 10px; font-weight: 500; color: #374151;">Áâ©ÂìÅÔºö</div>';

                for (const [itemName, quantity] of Object.entries(riceVillageData.inventory)) {
                    if (quantity > 0) {
                        bagContent += `
                            <div style="margin-bottom: 8px; padding: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <div style="font-weight: 500; color: #374151; font-size: 11px;">${itemName}</div>
                                <div style="color: #6b7280; font-size: 10px;">Êï∞Èáè: ${quantity}</div>
                            </div>
                        `;
                    }
                }
            } else {
                bagContent += '<div style="text-align: center; color: #6b7280; font-size: 11px; margin-top: 10px;">ÊöÇÊó†ÂÖ∂‰ªñÁâ©ÂìÅ</div>';
            }

            floatingBagContent.innerHTML = bagContent;
        }

        // ËÉåÂåÖÂíå‰ªªÂä°Êó•ÂøóÂäüËÉΩÔºà‰øùÁïôÂéüÊúâÊ®°ÊÄÅÊ°ÜÂäüËÉΩÔºâ
        function openBag() {
            console.log('ÂØºËà™Ê†èËÉåÂåÖÊåâÈíÆË¢´ÁÇπÂáª');
            toggleFloatingBag();
        }

        function closeBag() {
            const panel = document.getElementById('floating-bag-panel');
            if (panel) {
                panel.style.display = 'none';
                console.log('ËÉåÂåÖÂ∑≤ÂÖ≥Èó≠');
            }
        }

        function openQuestLog() {
            const modal = document.getElementById('quest-modal');
            if (modal) {
                modal.style.display = 'block';
                updateQuestDisplay();
            } else {
                console.error('‰ªªÂä°Êó•ÂøóÊ®°ÊÄÅÊ°ÜÊú™ÊâæÂà∞');
            }
        }

        function closeQuestLog() {
            const modal = document.getElementById('quest-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateBagDisplay() {
            const bagItems = document.getElementById('bag-items');
            bagItems.innerHTML = '';
            
            if (Object.keys(riceVillageData.inventory).length === 0) {
                bagItems.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">ËÉåÂåÖ‰∏∫Á©∫</td></tr>';
                return;
            }
            
            for (const [item, count] of Object.entries(riceVillageData.inventory)) {
                if (count > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item}</td>
                        <td>${count}</td>
                        <td>-</td>
                    `;
                    bagItems.appendChild(row);
                }
            }
        }

        function updateQuestDisplay() {
            const questContent = document.getElementById('quest-content');
            if (riceVillageData.currentQuest) {
                questContent.innerHTML = `
                    <h4>ÂΩìÂâç‰ªªÂä°: ${riceVillageData.currentQuest}</h4>
                    <p>ËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}</p>
                `;
            } else {
                questContent.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†‰ªªÂä°</p>';
            }

            // ÂêåÊó∂Êõ¥Êñ∞ÊÇ¨ÊµÆ‰ªªÂä°Èù¢Êùø
            updateFloatingQuestDisplay();
        }

        // ÊÇ¨ÊµÆ‰ªªÂä°ÁêÉÂäüËÉΩ
        function toggleFloatingQuest() {
            const panel = document.getElementById('floating-quest-panel');
            const isVisible = panel.classList.contains('show');

            if (isVisible) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                updateFloatingQuestDisplay();
            }
        }

        // Êõ¥Êñ∞ÊÇ¨ÊµÆ‰ªªÂä°ÊòæÁ§∫
        function updateFloatingQuestDisplay() {
            const floatingContent = document.getElementById('floating-quest-content');
            const questBall = document.getElementById('floating-quest-ball');

            console.log(`Êõ¥Êñ∞‰ªªÂä°ÊòæÁ§∫: currentQuest=${riceVillageData.currentQuest}, progress=${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // Ë∞ÉËØïÊó•Âøó

            if (riceVillageData.currentQuest) {
                const isCompleted = riceVillageData.questProgress >= riceVillageData.questTarget;

                // Êõ¥Êñ∞‰ªªÂä°ÁêÉÊòæÁ§∫
                if (isCompleted) {
                    questBall.textContent = '‚úì';
                    questBall.style.background = '#dcfce7';
                    questBall.style.borderColor = '#16a34a';
                    questBall.style.color = '#15803d';
                } else {
                    questBall.textContent = '!';
                    questBall.style.background = '#fef3c7';
                    questBall.style.borderColor = '#f59e0b';
                    questBall.style.color = '#92400e';
                }

                // Êõ¥Êñ∞ÊÇ¨ÊµÆÈù¢ÊùøÂÜÖÂÆπ
                floatingContent.innerHTML = `
                    <div class="quest-item">
                        <div class="quest-title">${riceVillageData.currentQuest} ${isCompleted ? '‚úÖ' : ''}</div>
                        <div class="quest-progress">ËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}</div>
                        <div style="margin-top: 4px;">
                            <div class="progress-bar" style="height: 12px;">
                                <div class="progress-fill" style="width: ${(riceVillageData.questProgress / riceVillageData.questTarget) * 100}%"></div>
                                <div class="progress-text" style="font-size: 10px;">${Math.round((riceVillageData.questProgress / riceVillageData.questTarget) * 100)}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Ê∑ªÂä†‰ªªÂä°ÊèêÁ§∫
                if (isCompleted) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #16a34a; margin-top: 8px; font-weight: 500;">
                            üéâ ‰ªªÂä°ÂÆåÊàêÔºÅËØ∑‰∏éÁéãÂ©ÜÂ©ÜÂØπËØù‰∫§‰ªò‰ªªÂä°
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('ÈááÈõÜ')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            üí° ÊèêÁ§∫ÔºöÁÇπÂáªÊ§çÁâ©ËµÑÊ∫ê‰∏≠ÁöÑ"ÈááÈõÜ"ÊåâÈíÆ
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('ÂáªË¥•')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            üí° ÊèêÁ§∫ÔºöÁÇπÂáªÈáéÁîüÂä®Áâ©‰∏≠ÁöÑ"ÊîªÂáª"ÊåâÈíÆ
                        </div>
                    `;
                } else if (riceVillageData.currentQuest.includes('È¶íÂ§¥')) {
                    floatingContent.innerHTML += `
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            üí° ÊèêÁ§∫Ôºö‰∏éÁéãÂ§ßÁü≥ÂØπËØù‰∫§‰ªòÈ¶íÂ§¥
                        </div>
                    `;
                }
            } else {
                // Êó†‰ªªÂä°Áä∂ÊÄÅ
                questBall.textContent = '‰ªªÂä°';
                questBall.style.background = '#f3f4f6';
                questBall.style.borderColor = '#d1d5db';
                questBall.style.color = '#374151';

                floatingContent.innerHTML = `
                    <div style="text-align: center; color: #6b7280; font-size: 11px;">ÊöÇÊó†‰ªªÂä°</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                        üí° ÊèêÁ§∫Ôºö‰∏éÁéãÂ©ÜÂ©ÜÂØπËØùÂºÄÂßã‰ªªÂä°Èìæ
                    </div>
                `;
            }
        }

        // ÊâãÂä®‰∫ëÁ´ØÂêåÊ≠•
        function manualCloudSync() {
            const cloudSaveConfig = JSON.parse(localStorage.getItem('cloudSaveConfig') || '{}');

            if (!cloudSaveConfig.githubToken || !cloudSaveConfig.gistId) {
                showWin95Modal('‰∫ëÁ´ØÂêåÊ≠•', 'ËØ∑ÂÖàÂú®Ëå∂Èì∫‰∏ªÈ°µËÆæÁΩÆGitHub TokenÂíåGist ID', '‚òÅÔ∏è');
                return;
            }

            showWin95Modal('‰∫ëÁ´ØÂêåÊ≠•', 'Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆÂà∞‰∫ëÁ´Ø...', '‚òÅÔ∏è');

            // ‰øùÂ≠òÂà∞‰∫ëÁ´Ø
            saveToGitHubGist();

            // 1ÁßíÂêé‰ªé‰∫ëÁ´ØÂä†ËΩΩ
            setTimeout(() => {
                loadFromGitHubGist();
                showWin95Modal('‰∫ëÁ´ØÂêåÊ≠•', 'Êï∞ÊçÆÂêåÊ≠•ÂÆåÊàêÔºÅ', '‚úÖ');
            }, 2000);
        }

        // Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ
        function forceRefreshData() {
            console.log('Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆÂºÄÂßã...');

            // ÈáçÁΩÆÊâÄÊúâÊÄ™Áâ©Áä∂ÊÄÅ
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                const monster = riceVillageData.monsters[monsterName];
                monster.available = true;
                monster.hp = monster.maxHp;
                console.log(`ÈáçÁΩÆ${monsterName}: available=${monster.available}, hp=${monster.hp}/${monster.maxHp}`);
                updateMonsterStatus(monsterName, 'ÂèØÊîªÂáª', '');
                updateMonsterHP(monsterName);
            });

            // ÈáçÊñ∞Âä†ËΩΩËå∂Èì∫Êï∞ÊçÆ
            loadTeaShopData();

            // Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
            updateDisplay();
            updateFloatingQuestDisplay();
            updateFloatingBagDisplay();

            // Ê£ÄÊü•localStorage‰∏≠ÁöÑÊï∞ÊçÆ
            const teaShopData = localStorage.getItem('gameData');
            console.log('ÂΩìÂâçlocalStorage‰∏≠ÁöÑËå∂Èì∫Êï∞ÊçÆ:', teaShopData ? JSON.parse(teaShopData) : 'Êó†Êï∞ÊçÆ');

            showWin95Modal('Êï∞ÊçÆÂà∑Êñ∞', 'Êï∞ÊçÆÂ∑≤Âº∫Âà∂Âà∑Êñ∞ÔºÅÊâÄÊúâÊÄ™Áâ©Â∑≤ÈáçÁΩÆ‰∏∫ÂèØÊîªÂáªÁä∂ÊÄÅ„ÄÇ', 'üîÑ');
        }

        // ÊµãËØïËÉåÂåÖÂäüËÉΩ
        function testBag() {
            console.log('ÊµãËØïËÉåÂåÖÂäüËÉΩÂºÄÂßã...');

            const panel = document.getElementById('floating-bag-panel');
            const ball = document.getElementById('floating-bag-ball');

            console.log('ËÉåÂåÖÈù¢ÊùøÂÖÉÁ¥†:', panel);
            console.log('ËÉåÂåÖÁêÉÂÖÉÁ¥†:', ball);

            if (panel) {
                console.log('Âº∫Âà∂ÊòæÁ§∫ËÉåÂåÖÈù¢Êùø...');
                panel.style.display = 'block';
                panel.classList.add('show');
                updateFloatingBagDisplay();
                console.log('ËÉåÂåÖÈù¢ÊùøÂ∑≤Âº∫Âà∂ÊòæÁ§∫');
            } else {
                console.error('Êâæ‰∏çÂà∞ËÉåÂåÖÈù¢ÊùøÔºÅ');
            }
        }

        // Âº∫Âà∂Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫
        function forceUpdateFunds() {
            console.log('Âº∫Âà∂Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫...');

            // Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑlocalStorageÈîÆÂêç
            const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];
            let foundData = false;

            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                console.log(`Ê£ÄÊü•${key}:`, data ? 'ÊúâÊï∞ÊçÆ' : 'Êó†Êï∞ÊçÆ');

                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (parsed && parsed.funds !== undefined) {
                            const funds = parsed.funds || 0;
                            console.log(`‰ªé${key}Ëß£ÊûêÂá∫ÈáëÂ∏ÅÊï∞:`, funds);

                            // Âº∫Âà∂Êõ¥Êñ∞È°∂ÈÉ®ÊòæÁ§∫
                            const operationFunds = document.getElementById('operation-funds');
                            if (operationFunds) {
                                operationFunds.textContent = `${funds} ÈáëÂ∏Å`;
                                console.log('Â∑≤Êõ¥Êñ∞È°∂ÈÉ®ÈáëÂ∏ÅÊòæÁ§∫');
                            }

                            // Âº∫Âà∂Êõ¥Êñ∞ËÉåÂåÖÊòæÁ§∫
                            updateFloatingBagDisplay();

                            showWin95Modal('ÈáëÂ∏ÅÊõ¥Êñ∞', `Â∑≤‰ªé${key}Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫Ôºö${funds} ÈáëÂ∏Å`, 'üí∞');
                            foundData = true;
                            break;
                        }
                    } catch (e) {
                        console.log(`${key}Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•:`, e);
                    }
                }
            }

            if (!foundData) {
                console.error('ÊâÄÊúâÊï∞ÊçÆÊ∫êÈÉΩÊâæ‰∏çÂà∞ÈáëÂ∏ÅÊï∞ÊçÆ');
                console.log('localStorageÊâÄÊúâÈîÆ:', Object.keys(localStorage));
                showWin95Modal('Êõ¥Êñ∞Â§±Ë¥•', 'Êâæ‰∏çÂà∞‰ªª‰ΩïËå∂Èì∫Êï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÊòØÂê¶‰ªéËå∂Èì∫Ê≠£Á°ÆËøõÂÖ•Á®ªÈ¶ôÊùë', '‚ùå');
            }
        }

        // Ê∏ÖÈô§Á®ªÈ¶ôÊùëËøõÂ∫¶
        function clearRiceVillageProgress() {
            const confirmContent = `
                <div style="text-align: center; line-height: 1.6;">
                    <h3 style="color: #dc2626; margin: 0 0 15px 0;">‚ö†Ô∏è Á°ÆËÆ§Ê∏ÖÈô§</h3>
                    <div style="margin-bottom: 15px; padding: 12px; background: #fef2f2; border: 1px inset #c0c0c0;">
                        <div style="color: #dc2626; margin-bottom: 8px; font-weight: bold;">Âç≥Â∞ÜÊ∏ÖÈô§ÊâÄÊúâÁ®ªÈ¶ôÊùëËøõÂ∫¶Ôºö</div>
                        <div style="color: #666; font-size: 11px; text-align: left;">
                            ‚Ä¢ Áé©ÂÆ∂Á≠âÁ∫ßÈáçÁΩÆ‰∏∫1Á∫ß<br>
                            ‚Ä¢ Áå´Âí™Á≠âÁ∫ßÈáçÁΩÆ‰∏∫1Á∫ß<br>
                            ‚Ä¢ ÊâÄÊúâ‰ªªÂä°ËøõÂ∫¶Ê∏ÖÈô§<br>
                            ‚Ä¢ ËÉåÂåÖÁâ©ÂìÅÊ∏ÖÁ©∫<br>
                            ‚Ä¢ NPCÂØπËØùÈáçÁΩÆ<br>
                            ‚Ä¢ Ë£ÖÂ§áÊ∏ÖÈô§
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="confirmClearProgress()" style="margin: 5px; padding: 8px 15px; background: #dc2626; color: white; border: 1px outset #dc2626;">Á°ÆËÆ§Ê∏ÖÈô§</button>
                        <button onclick="closeWin95Modal()" style="margin: 5px; padding: 8px 15px; background: #6b7280; color: white; border: 1px outset #6b7280;">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            showWin95Modal('Ê∏ÖÈô§Á®ªÈ¶ôÊùëËøõÂ∫¶', confirmContent, '‚ö†Ô∏è');
        }

        // Á°ÆËÆ§Ê∏ÖÈô§ËøõÂ∫¶
        function confirmClearProgress() {
            console.log('ÂºÄÂßãÊ∏ÖÈô§Á®ªÈ¶ôÊùëËøõÂ∫¶...');

            // ÈáçÁΩÆÁ®ªÈ¶ôÊùëÊï∞ÊçÆ‰∏∫ÂàùÂßãÁä∂ÊÄÅ
            riceVillageData = {
                player: {
                    name: "Áé©ÂÆ∂",
                    hp: 100,
                    maxHp: 100,
                    stamina: 100,
                    maxStamina: 100,
                    power: 5,
                    level: 1,
                    exp: 0,
                    weapon: null,
                    armor: null
                },
                cat: {
                    name: "Áå´Âí™‰ºô‰º¥",
                    hp: 100,
                    maxHp: 100,
                    power: 10,
                    level: 1,
                    type: null
                },
                inventory: {},
                npcs: {
                    "ÊùëÈïøÂàòÊ¥ã": { questStage: 0, lastTalkTime: 0 },
                    "ÁéãÂ©ÜÂ©Ü": { questStage: 0, lastTalkTime: 0 },
                    "ÊùéÂ§ç": { questStage: 0, lastTalkTime: 0 },
                    "ÁéãÂ§ßÁü≥": { questStage: 0, lastTalkTime: 0 },
                    "‰ΩôÂçä‰ªô": { questStage: 0, lastTalkTime: 0 },
                    "Ê≠¶Âô®Èì∫ËÄÅÊùø": { questStage: 0, lastTalkTime: 0 }
                },
                currentQuest: null,
                questProgress: 0,
                questTarget: 0,
                plants: {
                    "Ê≠¢Ë°ÄËçâ": { available: true, lastGathered: 0 },
                    "ÈáéËèú": { available: true, lastGathered: 0 },
                    "ÁÅµËäù": { available: true, lastGathered: 0 }
                },
                monsters: {
                    "ÊûúÂ≠êÁã∏": { hp: 10, maxHp: 10, attack: 1, available: true, lastKilled: 0 },
                    "Áå¥Â≠ê": { hp: 15, maxHp: 15, attack: 2, available: true, lastKilled: 0 },
                    "Â±±Ë¥º": { hp: 25, maxHp: 25, attack: 5, available: true, lastKilled: 0 }
                },
                questCompleted: {}
            };

            // ‰øùÂ≠òÈáçÁΩÆÂêéÁöÑÊï∞ÊçÆ
            saveRiceVillageData();

            // Êõ¥Êñ∞ÊòæÁ§∫
            updateDisplay();
            updateFloatingQuestDisplay();
            updateFloatingBagDisplay();

            // ÈáçÁΩÆÊâÄÊúâÊÄ™Áâ©Ë°ÄÈáèÊòæÁ§∫
            Object.keys(riceVillageData.monsters).forEach(monsterName => {
                updateMonsterHP(monsterName);
                updateMonsterStatus(monsterName, 'ÂèØÊîªÂáª', '');
            });

            closeWin95Modal();
            showWin95Modal('Ê∏ÖÈô§ÂÆåÊàê', 'Á®ªÈ¶ôÊùëËøõÂ∫¶Â∑≤ÂÖ®ÈÉ®Ê∏ÖÈô§ÔºÅÂèØ‰ª•ÈáçÊñ∞ÂºÄÂßãÂÜíÈô©‰∫Ü„ÄÇ', '‚úÖ');

            console.log('Á®ªÈ¶ôÊùëËøõÂ∫¶Ê∏ÖÈô§ÂÆåÊàê');
        }

        // ‰∏çËá™Âä®ÂÖ≥Èó≠ÊÇ¨ÊµÆÈù¢ÊùøÔºåÂè™ËÉΩÊâãÂä®ÁÇπÂáªÂÖ≥Èó≠
        // ÁßªÈô§Ëá™Âä®ÂÖ≥Èó≠ÂäüËÉΩÔºåËÆ©Áé©ÂÆ∂ÂèØ‰ª•Â∏∏ÂºÄ‰ªªÂä°Èù¢Êùø

        // Ê£ÄÊü•‰ªªÂä°ËøõÂ∫¶
        function checkQuestProgress(action, target) {
            console.log(`Ê£ÄÊü•‰ªªÂä°ËøõÂ∫¶: action=${action}, target=${target}, currentQuest=${riceVillageData.currentQuest}`); // Ë∞ÉËØïÊó•Âøó

            if (!riceVillageData.currentQuest) {
                console.log('Ê≤°ÊúâÂΩìÂâç‰ªªÂä°ÔºåË∑≥ËøáËøõÂ∫¶Ê£ÄÊü•');
                return;
            }

            let progressMade = false;

            // Ê£ÄÊü•‰∏çÂêåÁ±ªÂûãÁöÑ‰ªªÂä°
            if (riceVillageData.currentQuest === 'ÈááÈõÜÊ≠¢Ë°ÄËçâ' && action === 'ÈááÈõÜ' && target === 'Ê≠¢Ë°ÄËçâ') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`ÈááÈõÜÊ≠¢Ë°ÄËçâ‰ªªÂä°ËøõÂ∫¶+1ÔºåÂΩìÂâçËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'ÂáªË¥•ÊûúÂ≠êÁã∏' && action === 'ÂáªË¥•' && target === 'ÊûúÂ≠êÁã∏') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`ÂáªË¥•ÊûúÂ≠êÁã∏‰ªªÂä°ËøõÂ∫¶+1ÔºåÂΩìÂâçËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'ÂáªË¥•Áå¥Â≠ê' && action === 'ÂáªË¥•' && target === 'Áå¥Â≠ê') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`ÂáªË¥•Áå¥Â≠ê‰ªªÂä°ËøõÂ∫¶+1ÔºåÂΩìÂâçËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else if (riceVillageData.currentQuest === 'ÂáªË¥•Â±±Ë¥º' && action === 'ÂáªË¥•' && target === 'Â±±Ë¥º') {
                riceVillageData.questProgress++;
                progressMade = true;
                console.log(`ÂáªË¥•Â±±Ë¥º‰ªªÂä°ËøõÂ∫¶+1ÔºåÂΩìÂâçËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`);
            } else {
                console.log(`‰ªªÂä°Êù°‰ª∂‰∏çÂåπÈÖç: ÂΩìÂâç‰ªªÂä°="${riceVillageData.currentQuest}", Âä®‰Ωú="${action}", ÁõÆÊ†á="${target}"`);
            }

            if (progressMade) {
                // Á´ãÂç≥‰øùÂ≠òÊï∞ÊçÆ
                saveRiceVillageData();

                // Êõ¥Êñ∞ÊÇ¨ÊµÆ‰ªªÂä°ÊòæÁ§∫
                updateFloatingQuestDisplay();

                // ‰∏çËá™Âä®ÂÆåÊàê‰ªªÂä°ÔºåÂè™Êõ¥Êñ∞ËøõÂ∫¶
                // ‰ªªÂä°ÂÆåÊàêÈúÄË¶ÅÁé©ÂÆ∂‰∏ªÂä®‰∏éNPC‰∫§‰∫í
                if (riceVillageData.questProgress >= riceVillageData.questTarget) {
                    // Ê†áËÆ∞‰ªªÂä°ÂèØ‰ª•‰∫§‰ªòÔºå‰ΩÜ‰∏çËá™Âä®ÂÆåÊàê
                    console.log(`üìã ‰ªªÂä°ËøõÂ∫¶Â∑≤ÂÆåÊàêÔºÅËØ∑ÂõûÂéªÊâæNPC‰∫§‰ªò‰ªªÂä°„ÄÇ`);
                }
            }
        }

        // NPC‰∫§‰ªò‰ªªÂä°ÂÆåÊàê
        function completeQuestWithNPC(questName) {
            console.log(`ÂÆåÊàê‰ªªÂä°: ${questName}`); // Ë∞ÉËØïÊó•Âøó

            // Ê∏ÖÈô§ÂΩìÂâç‰ªªÂä°
            riceVillageData.currentQuest = null;
            riceVillageData.questProgress = 0;
            riceVillageData.questTarget = 0;

            let message = '';
            // Ê†πÊçÆ‰ªªÂä°Á±ªÂûãÁªô‰∫àÂ•ñÂä±ÂíåÊé®ËøõNPC‰ªªÂä°Èò∂ÊÆµ
            if (questName === 'ÈááÈõÜÊ≠¢Ë°ÄËçâ') {
                riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage = 5;
                gainExp(150);
                message = 'ÈááÈõÜ‰ªªÂä°ÂÆåÊàêÔºÅËé∑Âæó150ÁªèÈ™åÔºÅ';
            } else if (questName === 'ÂáªË¥•ÊûúÂ≠êÁã∏') {
                riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage = 7;
                gainExp(200);
                message = 'ÊûúÂ≠êÁã∏ËÆ®‰ºêÂÆåÊàêÔºÅËé∑Âæó200ÁªèÈ™åÔºÅ';
            } else if (questName === 'ÂáªË¥•Áå¥Â≠ê') {
                riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage = 9;
                gainExp(250);
                message = 'Áå¥Â≠êËÆ®‰ºêÂÆåÊàêÔºÅËé∑Âæó250ÁªèÈ™åÔºÅ';
            } else if (questName === 'ÂáªË¥•Â±±Ë¥º') {
                riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage = 11;
                gainExp(300);
                message = 'Â±±Ë¥ºËÆ®‰ºêÂÆåÊàêÔºÅËé∑Âæó300ÁªèÈ™åÔºÅËøôÊòØÊúÄÂêéÁöÑ‰ªªÂä°ÔºÅ';
            } else {
                message = '‰ªªÂä°ÂÆåÊàêÔºÅ';
            }

            // Á´ãÂç≥Êõ¥Êñ∞ÊÇ¨ÊµÆ‰ªªÂä°ÊòæÁ§∫
            updateFloatingQuestDisplay();
            console.log(`‰ªªÂä°ÂÆåÊàêÂêéÁä∂ÊÄÅ: currentQuest=${riceVillageData.currentQuest}, questStage=${riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage}`); // Ë∞ÉËØïÊó•Âøó

            return message;
        }

        // ÈááÈõÜÊ§çÁâ©ÂäüËÉΩ
        function gatherPlant(plantName) {
            const plant = riceVillageData.plants[plantName];
            if (!plant || !plant.available) {
                alert(`${plantName}ÊöÇÊó∂Êó†Ê≥ïÈááÈõÜÔºÅ`);
                return;
            }

            if (riceVillageData.player.stamina < 1) {
                alert('‰ΩìÂäõ‰∏çË∂≥ÔºÅËØ∑Á≠âÂæÖ‰ΩìÂäõÊÅ¢Â§çÊàñÊâìÂùêÊÅ¢Â§ç„ÄÇ');
                return;
            }

            // Ê∂àËÄó‰ΩìÂäõ
            riceVillageData.player.stamina--;

            // ËÆæÁΩÆÈááÈõÜÁä∂ÊÄÅ
            plant.available = false;
            plant.lastGathered = Date.now();

            // ÊòæÁ§∫ÈááÈõÜËøõÂ∫¶
            updatePlantStatus(plantName, 'ÈááÈõÜ‰∏≠...', 'progress');

            setTimeout(() => {
                // ÈááÈõÜÂÆåÊàê
                if (!riceVillageData.inventory[plantName]) {
                    riceVillageData.inventory[plantName] = 0;
                }
                riceVillageData.inventory[plantName]++;

                // Ëé∑ÂæóÂ∞ëÈáèÁªèÈ™å
                gainExp(2);

                // Á´ãÂç≥Âà∑Êñ∞ËÉåÂåÖÊòæÁ§∫
                updateFloatingBagDisplay();

                // Ê£ÄÊü•‰ªªÂä°ËøõÂ∫¶
                checkQuestProgress('ÈááÈõÜ', plantName);

                // 3ÁßíÂêéÂà∑Êñ∞
                setTimeout(() => {
                    plant.available = true;
                    updatePlantStatus(plantName, 'ÂèØÈááÈõÜ', '');
                }, 3000);

                // Á´ãÂç≥ÊòæÁ§∫Âà∑Êñ∞Áä∂ÊÄÅ
                updatePlantStatus(plantName, 'Âà∑Êñ∞‰∏≠...', '');

                updateDisplay();
                saveRiceVillageData(); // ‰øùÂ≠òÊï∞ÊçÆ
                // ‰∏çÊòæÁ§∫ÂºπÁ™óÔºåÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                console.log(`ÈááÈõÜÂà∞ ${plantName} x1ÔºÅËé∑Âæó 2 ÁªèÈ™åÔºÅ`);
            }, 3000);

            updateDisplay();
        }

        // ÊîªÂáªÊÄ™Áâ©ÂäüËÉΩ
        function attackMonster(monsterName) {
            const monster = riceVillageData.monsters[monsterName];
            console.log(`ÊîªÂáª${monsterName}: ÊÄ™Áâ©Êï∞ÊçÆ=`, monster); // Ë∞ÉËØïÊó•Âøó

            if (!monster) {
                alert(`Êâæ‰∏çÂà∞ÊÄ™Áâ©Ôºö${monsterName}ÔºÅ`);
                return;
            }

            // ÁßªÈô§availableÊ£ÄÊü•ÔºåËÆ©ÊâÄÊúâÊÄ™Áâ©ÈÉΩÂèØ‰ª•ÊîªÂáª
            console.log(`ÂºÄÂßãÊîªÂáª${monsterName}ÔºåÂΩìÂâçË°ÄÈáè: ${monster.hp}/${monster.maxHp}`); // Ë∞ÉËØïÊó•Âøó

            if (riceVillageData.player.stamina < 2) {
                alert('‰ΩìÂäõ‰∏çË∂≥ÔºÅÊîªÂáªÈúÄË¶Å2ÁÇπ‰ΩìÂäõ„ÄÇ');
                return;
            }

            // Ê∂àËÄó‰ΩìÂäõ
            riceVillageData.player.stamina -= 2;

            // ËÆæÁΩÆÊàòÊñóÁä∂ÊÄÅ
            monster.available = false;

            // ÊòæÁ§∫ÊàòÊñóËøõÂ∫¶
            updateMonsterStatus(monsterName, 'ÊàòÊñó‰∏≠...', 'progress');

            setTimeout(() => {
                // ÊàòÊñóÁªìÁÆó
                const playerAttack = riceVillageData.player.power + (riceVillageData.player.weapon ? riceVillageData.player.weapon.attack : 0);
                const catAttack = riceVillageData.cat.power;
                const totalDamage = playerAttack + catAttack;

                // ÊÄ™Áâ©Âèó‰º§
                console.log(`${monsterName} ÂèóÂà∞ ${totalDamage} ÁÇπ‰º§ÂÆ≥ÔºåË°ÄÈáè‰ªé ${monster.hp} Âèò‰∏∫ ${monster.hp - totalDamage}`);
                monster.hp -= totalDamage;

                // Á´ãÂç≥Êõ¥Êñ∞Ë°ÄÈáèÊòæÁ§∫
                updateMonsterHP(monsterName);

                if (monster.hp <= 0) {
                    console.log(`${monsterName} Ê≠ª‰∫°ÔºÅÂáÜÂ§áÂ¢ûÂä†‰ªªÂä°ËøõÂ∫¶`);  // Ë∞ÉËØïÊó•Âøó
                    // ÊÄ™Áâ©Ê≠ª‰∫°ÔºåËé∑ÂæóÁªèÈ™å
                    let expGain = 0;
                    switch(monsterName) {
                        case 'ÊûúÂ≠êÁã∏':
                            expGain = 8;
                            break;
                        case 'Áå¥Â≠ê':
                            expGain = 12;
                            break;
                        case 'Â±±Ë¥º':
                            expGain = 20;
                            break;
                    }

                    monster.hp = monster.maxHp; // ÈáçÁΩÆË°ÄÈáè
                    updateMonsterHP(monsterName); // Êõ¥Êñ∞Ë°ÄÈáèÊòæÁ§∫

                    // 3ÁßíÂêéÂà∑Êñ∞ÔºàÁº©Áü≠Âà∑Êñ∞Êó∂Èó¥Ôºâ
                    setTimeout(() => {
                        monster.available = true;
                        updateMonsterStatus(monsterName, 'ÂèØÊîªÂáª', '');
                        updateMonsterHP(monsterName); // Á°Æ‰øùË°ÄÈáèÊòæÁ§∫Ê≠£Á°Æ
                        console.log(`${monsterName}Âà∑Êñ∞ÂÆåÊàêÔºåÂèØ‰ª•ÂÜçÊ¨°ÊîªÂáª`);
                    }, 3000);

                    // Á´ãÂç≥ÊòæÁ§∫Âà∑Êñ∞Áä∂ÊÄÅ
                    updateMonsterStatus(monsterName, 'Âà∑Êñ∞‰∏≠...', '');

                    gainExp(expGain);

                    // Ê£ÄÊü•‰ªªÂä°ËøõÂ∫¶ - Âè™ÊúâÂú®ÊÄ™Áâ©ÁúüÊ≠£Ê≠ª‰∫°Êó∂ÊâçË∞ÉÁî®
                    console.log(`${monsterName} Â∑≤Ê≠ª‰∫°ÔºåÂáÜÂ§áÊ£ÄÊü•‰ªªÂä°ËøõÂ∫¶: ÂáªË¥• ${monsterName}`); // Ë∞ÉËØïÊó•Âøó
                    console.log(`ÂΩìÂâç‰ªªÂä°: ${riceVillageData.currentQuest}, ‰ªªÂä°ËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // Ë∞ÉËØïÊó•Âøó
                    checkQuestProgress('ÂáªË¥•', monsterName);
                    console.log(`‰ªªÂä°ËøõÂ∫¶Ê£ÄÊü•ÂÆåÊàêÔºåÊñ∞ËøõÂ∫¶: ${riceVillageData.questProgress}/${riceVillageData.questTarget}`); // Ë∞ÉËØïÊó•Âøó

                    // ‰∏çÊòæÁ§∫ÂºπÁ™óÔºåÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                    console.log(`ÂáªË¥•‰∫Ü ${monsterName}ÔºÅËé∑Âæó ${expGain} ÁªèÈ™åÔºÅ`);
                } else {
                    // ÊÄ™Áâ©ÂèçÂáª
                    const monsterDamage = monster.attack;
                    let damageMessage = '';

                    // ÈöèÊú∫ÊîªÂáªÁé©ÂÆ∂ÊàñÁå´Âí™
                    if (Math.random() < 0.5) {
                        riceVillageData.player.hp = Math.max(0, riceVillageData.player.hp - monsterDamage);
                        damageMessage = `${monsterName}ÊîªÂáª‰∫Ü‰Ω†ÔºåÈÄ†Êàê${monsterDamage}ÁÇπ‰º§ÂÆ≥ÔºÅ`;

                        if (riceVillageData.player.hp === 0) {
                            damageMessage += '\n‰Ω†Ë¢´ÂáªË¥•‰∫ÜÔºÅËØ∑ÊâìÂùêÊÅ¢Â§ç„ÄÇ';
                            // Ë£ÖÂ§áÊçüÂùè10%
                            if (riceVillageData.player.weapon && Math.random() < 0.1) {
                                damageMessage += '\nÊ≠¶Âô®ÂèóÊçüÔºÅ';
                                riceVillageData.player.weapon.durability--;
                                if (riceVillageData.player.weapon.durability <= 0) {
                                    damageMessage += '\nÊ≠¶Âô®ÊçüÂùè‰∫ÜÔºÅ';
                                    riceVillageData.player.weapon = null;
                                }
                            }
                        }
                    } else {
                        riceVillageData.cat.hp = Math.max(0, riceVillageData.cat.hp - monsterDamage);
                        damageMessage = `${monsterName}ÊîªÂáª‰∫Ü${riceVillageData.cat.name}ÔºåÈÄ†Êàê${monsterDamage}ÁÇπ‰º§ÂÆ≥ÔºÅ`;

                        if (riceVillageData.cat.hp === 0) {
                            damageMessage += `\n${riceVillageData.cat.name}Ë¢´ÂáªË¥•‰∫ÜÔºÅËØ∑ÊâìÂùêÊÅ¢Â§ç„ÄÇ`;
                        }
                    }

                    // Âè™Âú®Ê≠ª‰∫°Êó∂ÂºπÁ™óÔºåÂê¶ÂàôÂè™ËÆ∞ÂΩïÊó•Âøó
                    if (riceVillageData.player.hp === 0 || riceVillageData.cat.hp === 0) {
                        showWin95Modal('ÊàòÊñóÁªìÊûú', `ÂØπ${monsterName}ÈÄ†Êàê${totalDamage}ÁÇπ‰º§ÂÆ≥ÔºÅ\n${damageMessage}`, 'üíÄ');
                    } else {
                        console.log(`ÂØπ${monsterName}ÈÄ†Êàê${totalDamage}ÁÇπ‰º§ÂÆ≥ÔºÅ${damageMessage}`);
                    }

                    // ÁªßÁª≠ÊàòÊñóÔºàÊÄ™Áâ©Ê≤°Ê≠ªÔºåÁ´ãÂç≥ÂèØ‰ª•ÂÜçÊ¨°ÊîªÂáªÔºâ
                    monster.available = true;
                    console.log(`${monsterName}Ê≤°Ê≠ªÔºåË°ÄÈáèÂâ©‰Ωô${monster.hp}ÔºåÁ´ãÂç≥ÂèØ‰ª•ÂÜçÊ¨°ÊîªÂáª`); // Ë∞ÉËØïÊó•Âøó
                    updateMonsterStatus(monsterName, 'ÂèØÊîªÂáª', '');

                    // Á°Æ‰øùÊåâÈíÆÂèØ‰ª•ÁÇπÂáª
                    const actionElement = document.getElementById(`monster-action-${monsterName}`);
                    if (actionElement) {
                        actionElement.innerHTML = `<button class="action-btn" onclick="attackMonster('${monsterName}')">ÊîªÂáª</button>`;
                    }
                }

                updateDisplay();
            }, 5000);

            updateDisplay();
        }

        // Êõ¥Êñ∞Ê§çÁâ©Áä∂ÊÄÅÊòæÁ§∫
        function updatePlantStatus(plantName, status, progress) {
            const plantRows = document.querySelectorAll('#plant-list tr');
            plantRows.forEach(row => {
                const nameCell = row.cells[0];
                if (nameCell && nameCell.textContent === plantName) {
                    const statusCell = row.cells[2];
                    const actionCell = row.cells[3];

                    if (status === 'ÂèØÈááÈõÜ') {
                        statusCell.innerHTML = '<span class="status-indicator status-available">ÂèØÈááÈõÜ</span>';
                        actionCell.innerHTML = `<button class="action-btn" onclick="gatherPlant('${plantName}')">ÈááÈõÜ</button>`;
                    } else if (progress === 'progress') {
                        statusCell.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                        actionCell.innerHTML = `
                            <div class="progress-bar" style="width: 80px; height: 16px;">
                                <div class="progress-fill" id="progress-${plantName}" style="width: 0%"></div>
                                <div class="progress-text">0%</div>
                            </div>
                        `;
                        // ÂêØÂä®ËøõÂ∫¶Êù°Âä®Áîª
                        startProgressAnimation(plantName, 3000);
                    } else {
                        statusCell.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                        actionCell.innerHTML = `<span class="text-progress">${progress}</span>`;
                    }
                }
            });
        }

        // Êõ¥Êñ∞ÊÄ™Áâ©Áä∂ÊÄÅÊòæÁ§∫
        function updateMonsterStatus(monsterName, status, progress) {
            const statusElement = document.getElementById(`monster-status-${monsterName}`);
            const actionElement = document.getElementById(`monster-action-${monsterName}`);

            if (!statusElement || !actionElement) {
                console.error(`Êâæ‰∏çÂà∞ÊÄ™Áâ©ÂÖÉÁ¥†: ${monsterName}`);
                return;
            }

            if (status === 'ÂèØÊîªÂáª') {
                statusElement.innerHTML = '<span class="status-indicator status-available">ÂèØÊîªÂáª</span>';
                actionElement.innerHTML = `<button class="action-btn" onclick="attackMonster('${monsterName}')">ÊîªÂáª</button>`;
            } else if (progress === 'progress') {
                statusElement.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                actionElement.innerHTML = `
                    <div class="progress-bar" style="width: 80px; height: 16px;">
                        <div class="progress-fill" id="progress-${monsterName}" style="width: 0%"></div>
                        <div class="progress-text">0%</div>
                    </div>
                `;
                // ÂêØÂä®ËøõÂ∫¶Êù°Âä®Áîª
                startProgressAnimation(monsterName, 5000);
            } else {
                statusElement.innerHTML = `<span class="status-indicator status-busy">${status}</span>`;
                actionElement.innerHTML = `<span class="text-progress">${progress}</span>`;
            }
        }

        // Êõ¥Êñ∞ÊÄ™Áâ©Ë°ÄÈáèÊòæÁ§∫
        function updateMonsterHP(monsterName) {
            const monster = riceVillageData.monsters[monsterName];
            const hpElement = document.getElementById(`monster-hp-${monsterName}`);

            if (!monster || !hpElement) {
                console.error(`Êâæ‰∏çÂà∞ÊÄ™Áâ©ÊàñË°ÄÈáèÂÖÉÁ¥†: ${monsterName}`);
                return;
            }

            const hpPercent = Math.max(0, (monster.hp / monster.maxHp) * 100);
            const progressFill = hpElement.querySelector('.progress-fill');
            const progressText = hpElement.querySelector('.progress-text');

            if (progressFill && progressText) {
                progressFill.style.width = `${hpPercent}%`;
                progressText.textContent = `${Math.max(0, monster.hp)}/${monster.maxHp}`;

                // Ê†πÊçÆË°ÄÈáèÁôæÂàÜÊØîÊîπÂèòÈ¢úËâ≤
                if (hpPercent > 60) {
                    progressFill.style.backgroundColor = '#9ca3af'; // ÁÅ∞Ëâ≤ - ÂÅ•Â∫∑
                } else if (hpPercent > 30) {
                    progressFill.style.backgroundColor = '#f59e0b'; // ÈªÑËâ≤ - Âèó‰º§
                } else {
                    progressFill.style.backgroundColor = '#ef4444'; // Á∫¢Ëâ≤ - ÊøíÊ≠ª
                }
            }
        }

        // ËøõÂ∫¶Êù°Âä®Áîª
        function startProgressAnimation(id, duration) {
            const progressFill = document.getElementById(`progress-${id}`);
            const progressText = progressFill ? progressFill.nextElementSibling : null;

            if (!progressFill || !progressText) return;

            let startTime = Date.now();

            function updateProgress() {
                const elapsed = Date.now() - startTime;
                const percent = Math.min(100, (elapsed / duration) * 100);

                progressFill.style.width = `${percent}%`;
                progressText.textContent = `${Math.round(percent)}%`;

                if (percent < 100) {
                    requestAnimationFrame(updateProgress);
                }
            }

            updateProgress();
        }

        // NPCÂØπËØùÂäüËÉΩ - Âü∫Á°ÄÁâàÊú¨
        function talkToNPC(npcName) {
            const npc = riceVillageData.npcs[npcName];
            if (!npc) return;

            let dialogue = '';
            switch(npcName) {
                case 'ÊùëÈïøÂàòÊ¥ã':
                    dialogue = 'Ê¨¢ËøéÊù•Âà∞Á®ªÈ¶ôÊùëÔºÅËøôÈáåÊòØ‰∏™ÂíåÂπ≥ÁöÑÂú∞Êñπ„ÄÇ';
                    break;
                case 'ÁéãÂ©ÜÂ©Ü':
                    if (npc.questStage === 0) {
                        dialogue = '‰Ω†Â•ΩÔºåÂπ¥ËΩª‰∫∫ÔºÅÊàëÊòØÁéãÂ©ÜÂ©Ü„ÄÇ';
                        npc.questStage = 1;
                        // ‰∏çÁªôÁªèÈ™åÔºåÂè™ÊòØÂàùÊ¨°ÂØπËØù
                    } else if (npc.questStage === 1) {
                        dialogue = 'Ëøô‰∏™È¶íÂ§¥Áªô‰Ω†ÔºåËØ∑Â∏ÆÊàë‰∫§ÁªôÁéãÂ§ßÁü≥„ÄÇ';
                        if (!riceVillageData.inventory['È¶íÂ§¥']) {
                            riceVillageData.inventory['È¶íÂ§¥'] = 0;
                        }
                        riceVillageData.inventory['È¶íÂ§¥']++;
                        npc.questStage = 2;
                        riceVillageData.currentQuest = 'Â∞ÜÈ¶íÂ§¥‰∫§ÁªôÁéãÂ§ßÁü≥';
                        riceVillageData.questProgress = 0;

                        // Á´ãÂç≥Âà∑Êñ∞ËÉåÂåÖÊòæÁ§∫
                        updateFloatingBagDisplay();
                        riceVillageData.questTarget = 1;
                        // ‰∏çÂú®ËøôÈáåÁªôÁªèÈ™åÔºåÁ≠â‰∫§‰ªªÂä°Êó∂Áªô
                    } else if (npc.questStage === 3) {
                        dialogue = 'ËØ∑Â∏ÆÊàëÈááÈõÜ5‰∏™Ê≠¢Ë°ÄËçâ„ÄÇ';
                        riceVillageData.currentQuest = 'ÈááÈõÜÊ≠¢Ë°ÄËçâ';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 4;
                        // ‰∏çÂú®ËøôÈáåÁªôÁªèÈ™å
                    } else if (npc.questStage === 4) {
                        // Ê£ÄÊü•ÈááÈõÜ‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
                        if (riceVillageData.currentQuest === 'ÈááÈõÜÊ≠¢Ë°ÄËçâ' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('ÈááÈõÜÊ≠¢Ë°ÄËçâ');
                            // ‰ªªÂä°ÂÆåÊàêÂêéÁ´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'ËØ∑ÁªßÁª≠ÈááÈõÜÊ≠¢Ë°ÄËçâÔºåËøòÈúÄË¶Å' + (riceVillageData.questTarget - riceVillageData.questProgress) + '‰∏™„ÄÇ';
                        }
                    } else if (npc.questStage === 5) {
                        dialogue = 'ËØ∑Â∏ÆÊàëÂáªË¥•3Âè™ÊûúÂ≠êÁã∏„ÄÇ';
                        riceVillageData.currentQuest = 'ÂáªË¥•ÊûúÂ≠êÁã∏';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 3;
                        npc.questStage = 6;
                        // Êñ∞‰ªªÂä°ÂºÄÂßãÂêéÁ´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 6) {
                        // Ê£ÄÊü•ÊûúÂ≠êÁã∏‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
                        if (riceVillageData.currentQuest === 'ÂáªË¥•ÊûúÂ≠êÁã∏' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('ÂáªË¥•ÊûúÂ≠êÁã∏');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'ËØ∑ÁªßÁª≠ÂáªË¥•ÊûúÂ≠êÁã∏ÔºåËøòÈúÄË¶ÅÂáªË¥•' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'Âè™„ÄÇ';
                        }
                    } else if (npc.questStage === 7) {
                        dialogue = 'ËØ∑Â∏ÆÊàëÂáªË¥•5Âè™Áå¥Â≠ê„ÄÇ';
                        riceVillageData.currentQuest = 'ÂáªË¥•Áå¥Â≠ê';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 8;
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 8) {
                        // Ê£ÄÊü•Áå¥Â≠ê‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
                        if (riceVillageData.currentQuest === 'ÂáªË¥•Áå¥Â≠ê' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('ÂáªË¥•Áå¥Â≠ê');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'ËØ∑ÁªßÁª≠ÂáªË¥•Áå¥Â≠êÔºåËøòÈúÄË¶ÅÂáªË¥•' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'Âè™„ÄÇ';
                        }
                    } else if (npc.questStage === 9) {
                        dialogue = 'ÊúÄÂêéÁöÑ‰ªªÂä°ÔºöËØ∑ÂéªÊùëÂè£ÂáªË¥•5Âè™Â±±Ë¥º„ÄÇ';
                        riceVillageData.currentQuest = 'ÂáªË¥•Â±±Ë¥º';
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 5;
                        npc.questStage = 10;
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else if (npc.questStage === 10) {
                        // Ê£ÄÊü•Â±±Ë¥º‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
                        if (riceVillageData.currentQuest === 'ÂáªË¥•Â±±Ë¥º' && riceVillageData.questProgress >= riceVillageData.questTarget) {
                            dialogue = completeQuestWithNPC('ÂáªË¥•Â±±Ë¥º');
                            setTimeout(() => updateFloatingQuestDisplay(), 100);
                        } else {
                            dialogue = 'ËØ∑ÁªßÁª≠ÂáªË¥•Â±±Ë¥ºÔºåËøòÈúÄË¶ÅÂáªË¥•' + (riceVillageData.questTarget - riceVillageData.questProgress) + 'Âè™„ÄÇ';
                        }
                    } else if (npc.questStage === 11) {
                        dialogue = 'Ë∞¢Ë∞¢‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâ‰ªªÂä°ÔºÅËøôÊòØÁ≤æËá¥ÁöÑ‰ª§ÁâåÔºåËØ∑Êî∂‰∏ã„ÄÇ';
                        if (!riceVillageData.inventory['Á≤æËá¥‰ª§Áâå']) {
                            riceVillageData.inventory['Á≤æËá¥‰ª§Áâå'] = 0;
                        }
                        riceVillageData.inventory['Á≤æËá¥‰ª§Áâå']++;
                        npc.questStage = 12; // ‰ªªÂä°ÂÆåÊàê
                        riceVillageData.currentQuest = null;
                        gainExp(300); // ÊúÄÁªàÂ•ñÂä±

                        // Ê†áËÆ∞ÁéãÂ©ÜÂ©Ü‰ªªÂä°ÈìæÂÆåÊàê
                        riceVillageData.questCompleted = riceVillageData.questCompleted || {};
                        riceVillageData.questCompleted['ÁéãÂ©ÜÂ©Ü'] = true;

                        // Á´ãÂç≥Âà∑Êñ∞ËÉåÂåÖÊòæÁ§∫
                        console.log('Ëé∑ÂæóÁ≤æËá¥‰ª§ÁâåÔºåÂà∑Êñ∞ËÉåÂåÖÊòæÁ§∫');
                        updateFloatingBagDisplay();

                        // ‰øùÂ≠òÊï∞ÊçÆ
                        saveRiceVillageData();
                    } else if (npc.questStage === 12) {
                        dialogue = 'ÊÑüË∞¢‰Ω†ÁöÑÂ∏ÆÂä©ÔºåÂπ¥ËΩªÁöÑÂÜíÈô©ËÄÖÔºÅ';
                    } else {
                        dialogue = 'ËØ∑ÂÆåÊàêÂΩìÂâç‰ªªÂä°„ÄÇ';
                    }
                    break;
                case 'ÁéãÂ§ßÁü≥':
                    if (riceVillageData.inventory['È¶íÂ§¥'] && riceVillageData.inventory['È¶íÂ§¥'] > 0) {
                        dialogue = 'Ë∞¢Ë∞¢‰Ω†ÁöÑÈ¶íÂ§¥ÔºÅÁéãÂ©ÜÂ©ÜÁúüÊòØÂ§™Â•Ω‰∫Ü„ÄÇËé∑Âæó150ÁªèÈ™åÔºÅ';
                        riceVillageData.inventory['È¶íÂ§¥']--;
                        riceVillageData.currentQuest = null;
                        riceVillageData.questProgress = 0;
                        riceVillageData.questTarget = 0;
                        // Ëß¶ÂèëÁéãÂ©ÜÂ©Ü‰∏ã‰∏Ä‰∏™‰ªªÂä°
                        riceVillageData.npcs['ÁéãÂ©ÜÂ©Ü'].questStage = 3;
                        gainExp(150); // ÂÆåÊàê‰ªªÂä°Â•ñÂä±
                        // Á´ãÂç≥Êõ¥Êñ∞‰ªªÂä°ÊòæÁ§∫
                        setTimeout(() => updateFloatingQuestDisplay(), 100);
                    } else {
                        dialogue = '‰Ω†Â•ΩÔºÅÊàëÊòØÊ∞ëÂÖµÈòüÈïøÁéãÂ§ßÁü≥„ÄÇ';
                        // ÊôÆÈÄöÂØπËØù‰∏çÁªôÁªèÈ™å
                    }
                    break;
                case 'ÊùéÂ§ç':
                    dialogue = 'ÊùéÂ§çÂÜ≤‰Ω†‰∏ÄÁ¨ëÔºåÁ•ûÁßò‰∏çËØ≠„ÄÇ';
                    break;
                case '‰ΩôÂçä‰ªô':
                    const fortunes = [
                        '‰ªäÊó•ÂÆúÈááÈõÜÔºåÂøåÊàòÊñó„ÄÇ',
                        'Ë¥¢Ëøê‰∫®ÈÄöÔºåÈáëÂ∏ÅÂ∞ÜËá≥„ÄÇ',
                        'Â∞èÂøÉÈáéÂÖΩÔºåÊ≥®ÊÑèÂÆâÂÖ®„ÄÇ',
                        'Ë¥µ‰∫∫Áõ∏Âä©Ôºå‰ªªÂä°È°∫Âà©„ÄÇ',
                        'Â§©Êó∂Âú∞Âà©Ôºå‰∏á‰∫ãÂ¶ÇÊÑè„ÄÇ'
                    ];
                    dialogue = fortunes[Math.floor(Math.random() * fortunes.length)];
                    break;
                case 'Ê≠¶Âô®Èì∫ËÄÅÊùø':
                    dialogue = 'Ê¨¢ËøéÂÖâ‰∏¥Ê≠¶Âô®Èì∫ÔºÅÈúÄË¶Å‰ªÄ‰πàË£ÖÂ§áÂêóÔºü';
                    break;
                default:
                    dialogue = '‰Ω†Â•ΩÔºÅ';
            }

            showWin95Modal(`‰∏é${npcName}ÂØπËØù`, dialogue, 'üí¨');
            updateDisplay();
            updateFloatingQuestDisplay(); // Êõ¥Êñ∞‰ªªÂä°ÊòæÁ§∫
            saveRiceVillageData(); // ‰øùÂ≠òÊï∞ÊçÆ
        }

        // Ê≠¶Âô®Èì∫ÂäüËÉΩ
        function openWeaponShop() {
            // ‰ªéËå∂Èì∫Ëé∑ÂèñÂΩìÂâçÈáëÂ∏ÅÊï∞
            loadTeaShopData();
            updateRepairSection();
            document.getElementById('weapon-shop-modal').style.display = 'block';
        }

        function closeWeaponShop() {
            document.getElementById('weapon-shop-modal').style.display = 'none';
        }

        // Ë¥≠‰π∞Ê≠¶Âô®
        function buyWeapon(name, attack, price) {
            // Ê£ÄÊü•ÈáëÂ∏Å
            const currentFunds = getCurrentFunds();
            if (currentFunds < price) {
                showWin95Modal('ÈáëÂ∏Å‰∏çË∂≥', `Ë¥≠‰π∞${name}ÈúÄË¶Å${price}ÈáëÂ∏ÅÔºåÂΩìÂâçÂè™Êúâ${currentFunds}ÈáëÂ∏Å„ÄÇ`, 'üí∞');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÊ≠¶Âô®
            if (riceVillageData.player.weapon) {
                if (!confirm(`Â∑≤Ë£ÖÂ§á${riceVillageData.player.weapon.name}ÔºåÊòØÂê¶ÊõøÊç¢‰∏∫${name}Ôºü\nÊóßÊ≠¶Âô®Â∞Ü‰∏¢Â§±ÔºÅ`)) {
                    return;
                }
            }

            // Êâ£Èô§ÈáëÂ∏Å
            deductFunds(price);

            // Ë£ÖÂ§áÊ≠¶Âô®
            riceVillageData.player.weapon = {
                name: name,
                attack: attack,
                durability: 20,
                maxDurability: 20
            };

            updateDisplay();
            showWin95Modal('Ë¥≠‰π∞ÊàêÂäü', `ÊàêÂäüË¥≠‰π∞Âπ∂Ë£ÖÂ§á${name}ÔºÅ<br>ÊîªÂáªÂäõ+${attack}`, '‚öîÔ∏è');
        }

        // Ë¥≠‰π∞Èò≤ÂÖ∑
        function buyArmor(name, hpBonus, price) {
            // Ê£ÄÊü•ÈáëÂ∏Å
            const currentFunds = getCurrentFunds();
            if (currentFunds < price) {
                showWin95Modal('ÈáëÂ∏Å‰∏çË∂≥', `Ë¥≠‰π∞${name}ÈúÄË¶Å${price}ÈáëÂ∏ÅÔºåÂΩìÂâçÂè™Êúâ${currentFunds}ÈáëÂ∏Å„ÄÇ`, 'üí∞');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÈò≤ÂÖ∑
            if (riceVillageData.player.armor) {
                if (!confirm(`Â∑≤Ë£ÖÂ§á${riceVillageData.player.armor.name}ÔºåÊòØÂê¶ÊõøÊç¢‰∏∫${name}Ôºü\nÊóßÈò≤ÂÖ∑Â∞Ü‰∏¢Â§±ÔºÅ`)) {
                    return;
                }
                // ÁßªÈô§ÊóßÈò≤ÂÖ∑ÁöÑË°ÄÈáèÂä†Êàê
                riceVillageData.player.maxHp -= riceVillageData.player.armor.hpBonus;
                riceVillageData.player.hp = Math.min(riceVillageData.player.hp, riceVillageData.player.maxHp);
            }

            // Êâ£Èô§ÈáëÂ∏Å
            deductFunds(price);

            // Ë£ÖÂ§áÈò≤ÂÖ∑
            riceVillageData.player.armor = {
                name: name,
                hpBonus: hpBonus
            };

            // Â¢ûÂä†Ë°ÄÈáè‰∏äÈôê
            riceVillageData.player.maxHp += hpBonus;
            riceVillageData.player.hp += hpBonus; // Ë£ÖÂ§áÊó∂ÂõûÂ§çÂØπÂ∫îË°ÄÈáè

            updateDisplay();
            showWin95Modal('Ë¥≠‰π∞ÊàêÂäü', `ÊàêÂäüË¥≠‰π∞Âπ∂Ë£ÖÂ§á${name}ÔºÅ<br>Ë°ÄÈáè‰∏äÈôê+${hpBonus}`, 'üõ°Ô∏è');
        }

        // Ëé∑ÂèñÂΩìÂâçÈáëÂ∏ÅÊï∞Ôºà‰ªéÂ§ö‰∏™Êï∞ÊçÆÊ∫êËØªÂèñÔºâ
        function getCurrentFunds() {
            try {
                // Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑlocalStorageÈîÆÂêç
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                console.log(`getCurrentFunds: ‰ªé${key}Ëé∑ÂèñÈáëÂ∏Å:`, parsed.funds);
                                return parsed.funds;
                            }
                        } catch (e) {
                            console.log(`getCurrentFunds: ${key}Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•`);
                        }
                    }
                }
            } catch (error) {
                console.error('getCurrentFunds: Ëé∑ÂèñÈáëÂ∏ÅÂ§±Ë¥•:', error);
            }
            console.log('getCurrentFunds: Ê≤°ÊúâÊâæÂà∞ÈáëÂ∏ÅÊï∞ÊçÆÔºåËøîÂõû0');
            return 0;
        }

        // ‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñÈáëÂ∏Å
        function readFundsFromDatabase() {
            try {
                // Â∞ùËØï‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñ
                const request = indexedDB.open('TeaShopDB', 1);
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    if (db.objectStoreNames.contains('gameData')) {
                        const transaction = db.transaction(['gameData'], 'readonly');
                        const store = transaction.objectStore('gameData');
                        const getRequest = store.get('currentGame');

                        getRequest.onsuccess = function() {
                            if (getRequest.result && getRequest.result.data) {
                                const funds = getRequest.result.data.funds || 0;
                                console.log('‰ªéIndexedDBËé∑ÂèñÈáëÂ∏Å:', funds);
                                // Êõ¥Êñ∞ÊòæÁ§∫
                                updateFundsDisplay(funds);
                                return funds;
                            }
                        };
                    }
                };
            } catch (error) {
                console.error('‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñÈáëÂ∏ÅÂ§±Ë¥•:', error);
            }
            return 0;
        }

        // Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫
        function updateFundsDisplay(funds) {
            const operationFunds = document.getElementById('operation-funds');
            if (operationFunds) {
                operationFunds.textContent = `${funds} ÈáëÂ∏Å`;
                console.log('Êõ¥Êñ∞ÈáëÂ∏ÅÊòæÁ§∫:', funds);
            }

            // ÂêåÊó∂Êõ¥Êñ∞ËÉåÂåÖÊòæÁ§∫
            updateFloatingBagDisplay();
        }

        // Êâ£Èô§ÈáëÂ∏ÅÔºàÂêåÊ≠•Âà∞Ëå∂Èì∫Ôºâ
        function deductFunds(amount) {
            console.log(`Êâ£Èô§ÈáëÂ∏Å: ${amount}`);

            try {
                // Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑlocalStorageÈîÆÂêç
                const possibleKeys = ['teaGameData', 'cuteTeaShop_save', 'teaGameSave_1', 'gameData'];

                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed && parsed.funds !== undefined) {
                                const oldFunds = parsed.funds || 0;
                                parsed.funds = Math.max(0, oldFunds - amount);
                                localStorage.setItem(key, JSON.stringify(parsed));
                                console.log(`‰ªé${key}Êâ£Èô§ÈáëÂ∏Å: ${oldFunds} -> ${parsed.funds}`);

                                // Êõ¥Êñ∞Á®ªÈ¶ôÊùëÊòæÁ§∫
                                updateFundsDisplay(parsed.funds);
                                return;
                            }
                        } catch (e) {
                            console.log(`Êâ£Èô§ÈáëÂ∏Å: ${key}Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•`);
                        }
                    }
                }

                console.error('Êâæ‰∏çÂà∞Ëå∂Èì∫Êï∞ÊçÆÔºåÊó†Ê≥ïÊâ£Èô§ÈáëÂ∏Å');
                showWin95Modal('Êâ£Èô§Â§±Ë¥•', 'Êâæ‰∏çÂà∞Ëå∂Èì∫Êï∞ÊçÆÔºåÊó†Ê≥ïÊâ£Èô§ÈáëÂ∏Å', '‚ùå');

            } catch (error) {
                console.error('Êâ£Èô§ÈáëÂ∏ÅÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞‰øÆÁêÜÂå∫Âüü
        function updateRepairSection() {
            const repairSection = document.getElementById('repair-section');
            const repairList = document.getElementById('repair-list');

            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!repairSection || !repairList) {
                console.log('‰øÆÁêÜÂå∫ÂüüÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊõ¥Êñ∞');
                return;
            }

            if (riceVillageData.player.weapon && riceVillageData.player.weapon.durability < riceVillageData.player.weapon.maxDurability) {
                repairSection.style.display = 'block';
                const weapon = riceVillageData.player.weapon;
                const repairCost = Math.ceil((weapon.maxDurability - weapon.durability) * 2); // ÊØèÁÇπËÄê‰πÖ2ÈáëÂ∏Å

                repairList.innerHTML = `
                    <tr>
                        <td>ÂΩìÂâçÊ≠¶Âô®: ${weapon.name}</td>
                        <td>ËÄê‰πÖ: ${weapon.durability}/${weapon.maxDurability}</td>
                        <td>‰øÆÁêÜË¥πÁî®: ${repairCost}ÈáëÂ∏Å</td>
                        <td><button class="action-btn" onclick="repairWeapon(${repairCost})">‰øÆÁêÜ</button></td>
                    </tr>
                `;
            } else {
                repairSection.style.display = 'none';
            }
        }

        // ‰øÆÁêÜÊ≠¶Âô®
        function repairWeapon(cost) {
            const currentFunds = getCurrentFunds();
            if (currentFunds < cost) {
                showWin95Modal('ÈáëÂ∏Å‰∏çË∂≥', `‰øÆÁêÜÈúÄË¶Å${cost}ÈáëÂ∏ÅÔºåÂΩìÂâçÂè™Êúâ${currentFunds}ÈáëÂ∏Å„ÄÇ`, 'üí∞');
                return;
            }

            deductFunds(cost);
            riceVillageData.player.weapon.durability = riceVillageData.player.weapon.maxDurability;

            updateDisplay();
            updateRepairSection();
            showWin95Modal('‰øÆÁêÜÂÆåÊàê', `${riceVillageData.player.weapon.name}Â∑≤‰øÆÁêÜÂÆåÊàêÔºÅ`, 'üîß');
        }
    </script>
</body>
</html>
